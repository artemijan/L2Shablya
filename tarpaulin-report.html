<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","dao","char_info.rs"],"content":"use crate::entities::{character, item};\nuse chrono::Utc;\nuse sea_orm::DbErr;\nuse serde_json::Value;\n\n#[derive(Debug, Clone)]\npub enum CharVariables {\n    VisualHairId,\n    VisualHairColorId,\n    VisualFaceId,\n}\nimpl CharVariables {\n    #[must_use]\n    pub fn as_key(\u0026self) -\u003e \u0026'static str {\n        match self {\n            CharVariables::VisualHairId =\u003e \"visualHairId\",\n            CharVariables::VisualHairColorId =\u003e \"visualHairColorId\",\n            CharVariables::VisualFaceId =\u003e \"visualFaceId\",\n        }\n    }\n}\n\n#[repr(i32)]\npub enum PaperDoll {\n    Under = 0,\n    Head = 1,\n    Hair = 2,\n    Hair2 = 3,\n    Neck = 4,\n    RHand = 5,\n    Chest = 6,\n    LHand = 7,\n    Rear = 8,\n    Lear = 9,\n    Gloves = 10,\n    Legs = 11,\n    Feet = 12,\n    RFinger = 13,\n    LFinger = 14,\n    LBracelet = 15,\n    RBracelet = 16,\n    Deco1 = 17,\n    Deco2 = 18,\n    Deco3 = 19,\n    Deco4 = 20,\n    Deco5 = 21,\n    Deco6 = 22,\n    Cloak = 23,\n    Belt = 24,\n    Brooch = 25,\n    BroochJewel1 = 26,\n    BroochJewel2 = 27,\n    BroochJewel3 = 28,\n    BroochJewel4 = 29,\n    BroochJewel5 = 30,\n    BroochJewel6 = 31,\n    TotalSlots = 32,\n}\n\nimpl PaperDoll {\n    #[must_use]\n    pub fn ordered_ids() -\u003e [PaperDoll; 33] {\n        [\n            Self::Under,\n            Self::Rear,\n            Self::Lear,\n            Self::Neck,\n            Self::RFinger,\n            Self::LFinger,\n            Self::Head,\n            Self::RHand,\n            Self::LHand,\n            Self::Gloves,\n            Self::Chest,\n            Self::Legs,\n            Self::Feet,\n            Self::Cloak,\n            Self::RHand, // I don't give a fuck why Rhand declared twice, copied as is from L2j\n            Self::Hair,\n            Self::Hair2,\n            Self::RBracelet,\n            Self::LBracelet,\n            Self::Deco1,\n            Self::Deco2,\n            Self::Deco3,\n            Self::Deco4,\n            Self::Deco5,\n            Self::Deco6,\n            Self::Belt,\n            Self::Brooch,\n            Self::BroochJewel1,\n            Self::BroochJewel2,\n            Self::BroochJewel3,\n            Self::BroochJewel4,\n            Self::BroochJewel5,\n            Self::BroochJewel6,\n        ]\n    }\n\n    #[must_use]\n    pub fn visual_ids() -\u003e [PaperDoll; 9] {\n        [\n            Self::RHand,\n            Self::LHand,\n            Self::Gloves,\n            Self::Chest,\n            Self::Legs,\n            Self::Feet,\n            Self::RHand, // I don't give a fuck why Rhand declared twice, copied as is from L2j\n            Self::Hair,\n            Self::Hair2,\n        ]\n    }\n}\n#[derive(Debug, Clone)]\npub struct CharacterInfo {\n    pub char_model: character::Model,\n    pub items: Vec\u003citem::Model\u003e,\n    pub paperdoll: [[i32; 4]; 33],\n}\n\n#[allow(clippy::missing_errors_doc)]\nimpl CharacterInfo {\n    const VITALITY_ITEMS_USED_VARIABLE_NAME: \u0026'static str = \"VITALITY_ITEMS_USED\";\n    const HAIR_ACCESSORY_VARIABLE_NAME: \u0026'static str = \"HAIR_ACCESSORY_ENABLED\";\n    pub fn new(char_model: character::Model, items: Vec\u003citem::Model\u003e) -\u003e Result\u003cSelf, DbErr\u003e {\n        let paperdoll = char_model.restore_visible_inventory(\u0026items)?;\n        Ok(Self {\n            char_model,\n            items,\n            paperdoll,\n        })\n    }\n    #[must_use]\n    pub fn paper_doll_item_id(\u0026self, slot: PaperDoll) -\u003e i32 {\n        self.paperdoll[slot as usize][1]\n    }\n\n    #[must_use]\n    pub fn get_item(\u0026self, item_id: i32) -\u003e Option\u003c\u0026item::Model\u003e {\n        self.items.iter().find(|i| i.item_id == item_id)\n    }\n\n    #[must_use]\n    pub fn get_weapon(\u0026self) -\u003e Option\u003c\u0026item::Model\u003e {\n        let r_hand = self.get_paper_doll_object_id(PaperDoll::RHand);\n        if r_hand \u003e 0 {\n            return self.get_item(r_hand);\n        }\n        None\n    }\n    pub fn try_get_race(\u0026self)-\u003e anyhow::Result\u003cRace\u003e {\n        Race::try_from(self.char_model.race_id)\n    }\n\n    #[must_use]\n    pub fn get_paper_doll_object_id(\u0026self, slot: PaperDoll) -\u003e i32 {\n        self.paperdoll[slot as usize][0]\n    }\n\n    #[must_use]\n    pub fn get_paper_doll_visual_id(\u0026self, slot: PaperDoll) -\u003e i32 {\n        self.paperdoll[slot as usize][3]\n    }\n    #[must_use]\n    #[allow(clippy::cast_sign_loss)]\n    #[allow(clippy::cast_possible_truncation)]\n    pub fn get_enchant_effect(\u0026self, slot: PaperDoll) -\u003e i16 {\n        self.paperdoll[slot as usize][3] as i16\n    }\n    #[must_use]\n    #[allow(clippy::cast_sign_loss)]\n    #[allow(clippy::cast_possible_truncation)]\n    pub fn get_enchant_effect_as_byte(\u0026self, slot: PaperDoll) -\u003e u8 {\n        let effect = self.get_enchant_effect(slot);\n        if effect \u003e 127 {\n            127\n        } else {\n            effect as u8\n        }\n    }\n\n    pub fn get_hair_style(\u0026self) -\u003e i32 {\n        self.char_model\n            .variables\n            .get(CharVariables::VisualHairId.as_key())\n            .and_then(Value::as_i64) // Convert to i64 (Json numbers are i64 in Serde)\n            .and_then(|v| v.try_into().ok()) // Convert to i32 safely\n            .unwrap_or(0)\n    }\n\n    pub fn get_hair_color(\u0026self) -\u003e i32 {\n        self.char_model\n            .variables\n            .get(CharVariables::VisualHairColorId.as_key())\n            .and_then(Value::as_i64) // Convert to i64 (Json numbers are i64 in Serde)\n            .and_then(|v| v.try_into().ok()) // Convert to i32 safely\n            .unwrap_or(0)\n    }\n\n    pub fn get_face(\u0026self) -\u003e i32 {\n        self.char_model\n            .variables\n            .get(CharVariables::VisualFaceId.as_key())\n            .and_then(Value::as_i64) // Convert to i64 (Json numbers are i64 in Serde)\n            .and_then(|v| v.try_into().ok()) // Convert to i32 safely\n            .unwrap_or(0)\n    }\n\n    #[must_use]\n    pub fn get_max_hp(\u0026self) -\u003e f64 {\n        self.char_model.max_hp\n    }\n    #[must_use]\n    pub fn get_max_mp(\u0026self) -\u003e f64 {\n        self.char_model.max_mp\n    }\n    #[must_use]\n    #[allow(clippy::cast_possible_truncation)]\n    pub fn get_delete_timer(\u0026self) -\u003e i32 {\n        if let Some(delete_at) = self.char_model.delete_at {\n            let now = Utc::now();\n            let delta = delete_at.with_timezone(\u0026Utc).signed_duration_since(now);\n            delta.num_seconds() as i32\n        } else {\n            0\n        }\n    }\n    #[must_use]\n    pub fn get_vitality_used(\u0026self) -\u003e i32 {\n        self.char_model\n            .variables\n            .get(Self::VITALITY_ITEMS_USED_VARIABLE_NAME)\n            .and_then(Value::as_i64)\n            .and_then(|v| v.try_into().ok())\n            .unwrap_or(0)\n    }\n    #[must_use]\n    pub fn is_hair_accessory_enabled(\u0026self) -\u003e bool {\n        self.char_model\n            .variables\n            .get(Self::HAIR_ACCESSORY_VARIABLE_NAME)\n            .and_then(Value::as_bool)\n            .unwrap_or(true)\n    }\n    #[must_use]\n    pub fn get_transform_id(\u0026self) -\u003e i32 {\n        i32::from(self.char_model.transform_id)\n    }\n}\n\n#[repr(i32)]\n#[derive(Clone, Debug, Copy, Hash, PartialOrd, Ord, Eq, PartialEq)]\npub enum Race {\n    Human,\n    Elf,\n    DarkElf,\n    Orc,\n    Dwarf,\n    Kamael,\n    Ertheia,\n    Animal,\n    Beast,\n    Bug,\n    CastleGuard,\n    Construct,\n    Demonic,\n    Divine,\n    Dragon,\n    Elemental,\n    Etc,\n    Fairy,\n    Giant,\n    Humanoid,\n    Mercenary,\n    None,\n    Plant,\n    SiegeWeapon,\n    Undead,\n    Friend,\n}\n\nfn try_from(value: i32) -\u003e anyhow::Result\u003cRace\u003e {\n    use anyhow::bail;\n    #[allow(clippy::enum_glob_use)]\n    use Race::*;\n    match value {\n        0 =\u003e Ok(Human),\n        1 =\u003e Ok(Elf),\n        2 =\u003e Ok(DarkElf),\n        3 =\u003e Ok(Orc),\n        4 =\u003e Ok(Dwarf),\n        5 =\u003e Ok(Kamael),\n        6 =\u003e Ok(Ertheia),\n        7 =\u003e Ok(Animal),\n        8 =\u003e Ok(Beast),\n        9 =\u003e Ok(Bug),\n        10 =\u003e Ok(CastleGuard),\n        11 =\u003e Ok(Construct),\n        12 =\u003e Ok(Demonic),\n        13 =\u003e Ok(Divine),\n        14 =\u003e Ok(Dragon),\n        15 =\u003e Ok(Elemental),\n        16 =\u003e Ok(Etc),\n        17 =\u003e Ok(Fairy),\n        18 =\u003e Ok(Giant),\n        19 =\u003e Ok(Humanoid),\n        20 =\u003e Ok(Mercenary),\n        21 =\u003e Ok(None),\n        22 =\u003e Ok(Plant),\n        23 =\u003e Ok(SiegeWeapon),\n        24 =\u003e Ok(Undead),\n        _ =\u003e bail!(\"Unknown race value: {}\", value),\n    }\n}\n\nimpl TryFrom\u003ci32\u003e for Race {\n    type Error = anyhow::Error;\n    fn try_from(value: i32) -\u003e anyhow::Result\u003cSelf\u003e {\n        try_from(value)\n    }\n}\n\nimpl TryFrom\u003ci8\u003e for Race {\n    type Error = anyhow::Error;\n    fn try_from(value: i8) -\u003e anyhow::Result\u003cSelf\u003e {\n        try_from(value.into())\n    }\n}\n\nimpl TryFrom\u003cu8\u003e for Race {\n    type Error = anyhow::Error;\n    fn try_from(value: u8) -\u003e anyhow::Result\u003cSelf\u003e {\n        try_from(value.into())\n    }\n}","traces":[{"line":14,"address":[13966880],"length":1,"stats":{"Line":0}},{"line":15,"address":[14143253],"length":1,"stats":{"Line":0}},{"line":16,"address":[13966917],"length":1,"stats":{"Line":0}},{"line":17,"address":[2535292],"length":1,"stats":{"Line":0}},{"line":18,"address":[2535315],"length":1,"stats":{"Line":0}},{"line":62,"address":[14143376],"length":1,"stats":{"Line":0}},{"line":64,"address":[2535367],"length":1,"stats":{"Line":0}},{"line":65,"address":[2535375],"length":1,"stats":{"Line":0}},{"line":66,"address":[13967031],"length":1,"stats":{"Line":0}},{"line":67,"address":[2535391],"length":1,"stats":{"Line":0}},{"line":68,"address":[13967047],"length":1,"stats":{"Line":0}},{"line":69,"address":[13967055],"length":1,"stats":{"Line":0}},{"line":70,"address":[13967063],"length":1,"stats":{"Line":0}},{"line":71,"address":[13967071],"length":1,"stats":{"Line":0}},{"line":72,"address":[13967079],"length":1,"stats":{"Line":0}},{"line":73,"address":[2535439],"length":1,"stats":{"Line":0}},{"line":74,"address":[13967095],"length":1,"stats":{"Line":0}},{"line":75,"address":[14143471],"length":1,"stats":{"Line":0}},{"line":76,"address":[2535463],"length":1,"stats":{"Line":0}},{"line":77,"address":[2535471],"length":1,"stats":{"Line":0}},{"line":78,"address":[13967127],"length":1,"stats":{"Line":0}},{"line":79,"address":[14143503],"length":1,"stats":{"Line":0}},{"line":80,"address":[2535495],"length":1,"stats":{"Line":0}},{"line":81,"address":[13967151],"length":1,"stats":{"Line":0}},{"line":82,"address":[14143527],"length":1,"stats":{"Line":0}},{"line":83,"address":[13967167],"length":1,"stats":{"Line":0}},{"line":84,"address":[2535527],"length":1,"stats":{"Line":0}},{"line":85,"address":[14143551],"length":1,"stats":{"Line":0}},{"line":86,"address":[13967191],"length":1,"stats":{"Line":0}},{"line":87,"address":[13967199],"length":1,"stats":{"Line":0}},{"line":88,"address":[2535559],"length":1,"stats":{"Line":0}},{"line":89,"address":[2535567],"length":1,"stats":{"Line":0}},{"line":90,"address":[14143591],"length":1,"stats":{"Line":0}},{"line":91,"address":[14143599],"length":1,"stats":{"Line":0}},{"line":92,"address":[2535591],"length":1,"stats":{"Line":0}},{"line":93,"address":[13967247],"length":1,"stats":{"Line":0}},{"line":94,"address":[14143623],"length":1,"stats":{"Line":0}},{"line":95,"address":[2535615],"length":1,"stats":{"Line":0}},{"line":96,"address":[13967271],"length":1,"stats":{"Line":0}},{"line":101,"address":[13967520],"length":1,"stats":{"Line":0}},{"line":103,"address":[13967523],"length":1,"stats":{"Line":0}},{"line":104,"address":[2535883],"length":1,"stats":{"Line":0}},{"line":105,"address":[13967539],"length":1,"stats":{"Line":0}},{"line":106,"address":[13967547],"length":1,"stats":{"Line":0}},{"line":107,"address":[13967555],"length":1,"stats":{"Line":0}},{"line":108,"address":[13967563],"length":1,"stats":{"Line":0}},{"line":109,"address":[13967571],"length":1,"stats":{"Line":0}},{"line":110,"address":[13967579],"length":1,"stats":{"Line":0}},{"line":111,"address":[2535939],"length":1,"stats":{"Line":0}},{"line":126,"address":[13968170,13967664],"length":1,"stats":{"Line":0}},{"line":127,"address":[14144381,14144058,14144117],"length":1,"stats":{"Line":0}},{"line":128,"address":[13967876],"length":1,"stats":{"Line":0}},{"line":129,"address":[14144187],"length":1,"stats":{"Line":0}},{"line":130,"address":[2536181],"length":1,"stats":{"Line":0}},{"line":135,"address":[2536528],"length":1,"stats":{"Line":0}},{"line":136,"address":[13968210,13968263],"length":1,"stats":{"Line":0}},{"line":140,"address":[2536624],"length":1,"stats":{"Line":0}},{"line":141,"address":[14144669],"length":1,"stats":{"Line":0}},{"line":145,"address":[14144736],"length":1,"stats":{"Line":0}},{"line":146,"address":[14144750],"length":1,"stats":{"Line":0}},{"line":147,"address":[13968408],"length":1,"stats":{"Line":0}},{"line":148,"address":[14144801],"length":1,"stats":{"Line":0}},{"line":150,"address":[13968413],"length":1,"stats":{"Line":0}},{"line":152,"address":[2536800],"length":1,"stats":{"Line":0}},{"line":153,"address":[14144849],"length":1,"stats":{"Line":0}},{"line":157,"address":[2536848],"length":1,"stats":{"Line":0}},{"line":158,"address":[13968530,13968582],"length":1,"stats":{"Line":0}},{"line":162,"address":[13968608],"length":1,"stats":{"Line":0}},{"line":163,"address":[2537015,2536962],"length":1,"stats":{"Line":0}},{"line":168,"address":[2537040],"length":1,"stats":{"Line":0}},{"line":169,"address":[2537111,2537058],"length":1,"stats":{"Line":0}},{"line":174,"address":[13968800],"length":1,"stats":{"Line":0}},{"line":175,"address":[13968813],"length":1,"stats":{"Line":0}},{"line":176,"address":[13968829,13968844],"length":1,"stats":{"Line":0}},{"line":177,"address":[2537181],"length":1,"stats":{"Line":0}},{"line":179,"address":[13968840],"length":1,"stats":{"Line":0}},{"line":183,"address":[13968864],"length":1,"stats":{"Line":0}},{"line":184,"address":[14145241,14145271],"length":1,"stats":{"Line":0}},{"line":186,"address":[14145250],"length":1,"stats":{"Line":0}},{"line":188,"address":[13830640,13830649],"length":1,"stats":{"Line":0}},{"line":192,"address":[13968960],"length":1,"stats":{"Line":0}},{"line":193,"address":[2537289,2537318],"length":1,"stats":{"Line":0}},{"line":195,"address":[13968978],"length":1,"stats":{"Line":0}},{"line":197,"address":[13830688,13830697],"length":1,"stats":{"Line":0}},{"line":201,"address":[14145424],"length":1,"stats":{"Line":0}},{"line":202,"address":[14145433,14145463],"length":1,"stats":{"Line":0}},{"line":204,"address":[13969074],"length":1,"stats":{"Line":0}},{"line":206,"address":[13830745,13830736],"length":1,"stats":{"Line":0}},{"line":211,"address":[14145520],"length":1,"stats":{"Line":0}},{"line":212,"address":[2537445],"length":1,"stats":{"Line":0}},{"line":215,"address":[13969168],"length":1,"stats":{"Line":0}},{"line":216,"address":[13969173],"length":1,"stats":{"Line":0}},{"line":220,"address":[14145552],"length":1,"stats":{"Line":0}},{"line":221,"address":[2537486,2537628],"length":1,"stats":{"Line":0}},{"line":222,"address":[2537539],"length":1,"stats":{"Line":0}},{"line":223,"address":[14145630],"length":1,"stats":{"Line":0}},{"line":224,"address":[2537613],"length":1,"stats":{"Line":0}},{"line":226,"address":[13969343],"length":1,"stats":{"Line":0}},{"line":230,"address":[2537648],"length":1,"stats":{"Line":0}},{"line":231,"address":[14145733],"length":1,"stats":{"Line":0}},{"line":235,"address":[14161017,14161008],"length":1,"stats":{"Line":0}},{"line":239,"address":[2537712],"length":1,"stats":{"Line":0}},{"line":240,"address":[14145797],"length":1,"stats":{"Line":0}},{"line":247,"address":[2537776],"length":1,"stats":{"Line":0}},{"line":248,"address":[2537781],"length":1,"stats":{"Line":0}},{"line":283,"address":[14145888],"length":1,"stats":{"Line":0}},{"line":287,"address":[13969540],"length":1,"stats":{"Line":0}},{"line":288,"address":[2538135],"length":1,"stats":{"Line":0}},{"line":289,"address":[2538165],"length":1,"stats":{"Line":0}},{"line":290,"address":[13969907],"length":1,"stats":{"Line":0}},{"line":291,"address":[13969937],"length":1,"stats":{"Line":0}},{"line":292,"address":[2538255],"length":1,"stats":{"Line":0}},{"line":293,"address":[13969997],"length":1,"stats":{"Line":0}},{"line":294,"address":[13970027],"length":1,"stats":{"Line":0}},{"line":295,"address":[13970057],"length":1,"stats":{"Line":0}},{"line":296,"address":[14146455],"length":1,"stats":{"Line":0}},{"line":297,"address":[2538405],"length":1,"stats":{"Line":0}},{"line":298,"address":[14146515],"length":1,"stats":{"Line":0}},{"line":299,"address":[2538465],"length":1,"stats":{"Line":0}},{"line":300,"address":[13970207],"length":1,"stats":{"Line":0}},{"line":301,"address":[14146605],"length":1,"stats":{"Line":0}},{"line":302,"address":[13970267],"length":1,"stats":{"Line":0}},{"line":303,"address":[13970297],"length":1,"stats":{"Line":0}},{"line":304,"address":[2538615],"length":1,"stats":{"Line":0}},{"line":305,"address":[13970357],"length":1,"stats":{"Line":0}},{"line":306,"address":[14146755],"length":1,"stats":{"Line":0}},{"line":307,"address":[13970417],"length":1,"stats":{"Line":0}},{"line":308,"address":[2538735],"length":1,"stats":{"Line":0}},{"line":309,"address":[13970474],"length":1,"stats":{"Line":0}},{"line":310,"address":[2538789],"length":1,"stats":{"Line":0}},{"line":311,"address":[13970528],"length":1,"stats":{"Line":0}},{"line":312,"address":[13970555],"length":1,"stats":{"Line":0}},{"line":313,"address":[2538095,2537965],"length":1,"stats":{"Line":0}},{"line":319,"address":[2538880],"length":1,"stats":{"Line":0}},{"line":320,"address":[2538896],"length":1,"stats":{"Line":0}},{"line":326,"address":[2538912],"length":1,"stats":{"Line":0}},{"line":327,"address":[2538932],"length":1,"stats":{"Line":0}},{"line":333,"address":[2538976],"length":1,"stats":{"Line":0}},{"line":334,"address":[2538996],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":139},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","dao","character.rs"],"content":"use crate::dao::char_info::CharacterInfo;\nuse crate::dao::item::LocType;\nuse crate::entities::{character, item, user};\nuse crate::DBPool;\nuse chrono::{Duration, Utc};\nuse sea_orm::entity::prelude::*;\nuse sea_orm::{ActiveValue, DbErr, JoinType, Order, QueryOrder, QuerySelect};\n\n#[allow(clippy::missing_errors_doc)]\nimpl character::Model {\n    pub async fn char_exists(db_pool: \u0026DBPool, name: \u0026str) -\u003e Result\u003cbool, DbErr\u003e {\n        Ok(character::Entity::find()\n            .filter(character::Column::Name.eq(name))\n            .one(db_pool)\n            .await?\n            .is_some())\n    }\n\n    pub async fn create_char(\n        db_pool: \u0026DBPool,\n        c: character::Model,\n    ) -\u003e Result\u003ccharacter::Model, DbErr\u003e {\n        let mut active_model: character::ActiveModel = c.into();\n        active_model.id = ActiveValue::NotSet;\n        active_model.last_access = ActiveValue::Set(Some(Utc::now().into()));\n        active_model.insert(db_pool).await\n    }\n    pub async fn delete_char(\n        db_pool: \u0026DBPool,\n        c: character::Model,\n    ) -\u003e Result\u003ccharacter::Model, DbErr\u003e {\n        let mut active_model: character::ActiveModel = c.into();\n        active_model.delete_at = ActiveValue::Set(Some((Utc::now() + Duration::days(7)).into()));\n        active_model.update(db_pool).await\n    }\n    pub async fn restore_char(\n        db_pool: \u0026DBPool,\n        c: character::Model,\n    ) -\u003e Result\u003ccharacter::Model, DbErr\u003e {\n        let mut active_model: character::ActiveModel = c.into();\n        active_model.delete_at = ActiveValue::Set(None);\n        active_model.update(db_pool).await\n    }\n    pub async fn find_by_username(\n        db_pool: \u0026DBPool,\n        username: \u0026str,\n    ) -\u003e Result\u003cVec\u003ccharacter::Model\u003e, DbErr\u003e {\n        let characters = character::Entity::find()\n            .join(\n                JoinType::InnerJoin,\n                character::Entity::has_many(user::Entity).into(),\n            )\n            .filter(user::Column::Username.eq(username))\n            .all(db_pool)\n            .await?;\n        Ok(characters)\n    }\n\n    pub async fn get_with_items_and_vars(\n        db_pool: \u0026DBPool,\n        username: \u0026str,\n        loc_type: LocType,\n    ) -\u003e Result\u003cVec\u003cCharacterInfo\u003e, DbErr\u003e {\n        let characters = character::Entity::find()\n            .order_by(character::Column::DeleteAt, Order::Asc)\n            .order_by(character::Column::CreatedAt, Order::Asc)\n            .join(JoinType::InnerJoin, character::Relation::User.def())\n            .filter(user::Column::Username.eq(username))\n            .find_with_related(item::Entity)\n            .all(db_pool)\n            .await?;\n\n        characters\n            .into_iter()\n            .map(|(char, items)| {\n                CharacterInfo::new(\n                    char,\n                    //todo optimize query maybe there is a way to do filtering on DB level for items\n                    items.into_iter().filter(|i| i.loc == loc_type).collect(),\n                )\n            })\n            .collect()\n    }\n\n    #[must_use]\n    #[allow(clippy::cast_sign_loss)]\n    pub fn get_lvl(\u0026self) -\u003e u8 {\n        self.level as u8\n    }\n\n    #[allow(clippy::cast_sign_loss)]\n    pub fn restore_visible_inventory(\n        \u0026self,\n        items: \u0026Vec\u003citem::Model\u003e,\n    ) -\u003e Result\u003c[[i32; 4]; 33], DbErr\u003e {\n        let mut result = [[0; 4]; 33];\n        for item in items {\n            if item.loc == LocType::Paperdoll {\n                let slot = item.loc_data;\n                result[slot as usize][0] = item.id;\n                result[slot as usize][1] = item.item_id;\n                result[slot as usize][2] = item.enchant_level;\n                // todo: result[slot as usize][3] = vars\n                //     .get(item_variable::Model::VISUAL_ID)\n                //     .unwrap_or(\u0026\"0\".to_string())\n                //     .parse()\n                //     .unwrap_or(0);\n                if result[slot as usize][3] \u003e 0 {\n                    // fix for hair appearance conflicting with original model\n                    result[slot as usize][1] = result[slot as usize][3];\n                }\n            }\n        }\n        Ok(result)\n    }\n}\n","traces":[{"line":11,"address":[5413024,5413598,5413074,5413445,5413214],"length":1,"stats":{"Line":0}},{"line":12,"address":[5413370,5413829,5414165,5413438,5414017,5413762,5414088,5413195,5413515],"length":1,"stats":{"Line":0}},{"line":13,"address":[5413566,5413254,5413414],"length":1,"stats":{"Line":0}},{"line":15,"address":[4281303],"length":1,"stats":{"Line":0}},{"line":19,"address":[14005216],"length":1,"stats":{"Line":0}},{"line":23,"address":[5414323],"length":1,"stats":{"Line":0}},{"line":24,"address":[5414436],"length":1,"stats":{"Line":0}},{"line":25,"address":[5414475,5414535],"length":1,"stats":{"Line":0}},{"line":26,"address":[4281441],"length":1,"stats":{"Line":0}},{"line":28,"address":[14005296],"length":1,"stats":{"Line":0}},{"line":32,"address":[5415219],"length":1,"stats":{"Line":0}},{"line":33,"address":[5415332,5415397],"length":1,"stats":{"Line":0}},{"line":34,"address":[4281585],"length":1,"stats":{"Line":0}},{"line":36,"address":[13680960],"length":1,"stats":{"Line":0}},{"line":40,"address":[5416115],"length":1,"stats":{"Line":0}},{"line":41,"address":[5416228],"length":1,"stats":{"Line":0}},{"line":42,"address":[4282305],"length":1,"stats":{"Line":0}},{"line":44,"address":[14005456],"length":1,"stats":{"Line":0}},{"line":48,"address":[5417104,5416899,5417385,5417752,5417930,5417626,5417308,5417240,5418008],"length":1,"stats":{"Line":0}},{"line":50,"address":[5417001],"length":1,"stats":{"Line":0}},{"line":51,"address":[5417025,5417070],"length":1,"stats":{"Line":0}},{"line":53,"address":[5417284,5416966,5417177,5417438],"length":1,"stats":{"Line":0}},{"line":55,"address":[4283095],"length":1,"stats":{"Line":0}},{"line":56,"address":[5417820],"length":1,"stats":{"Line":0}},{"line":59,"address":[2377952],"length":1,"stats":{"Line":1}},{"line":64,"address":[5419106,5418545,5419228,5418230,5418423,5418744,5419441,5418681,5418857,5418358,5418827],"length":1,"stats":{"Line":10}},{"line":65,"address":[5418332],"length":1,"stats":{"Line":1}},{"line":66,"address":[5418397,5418462],"length":1,"stats":{"Line":2}},{"line":67,"address":[5418470,5418602,5418289,5418944,5418965],"length":1,"stats":{"Line":2}},{"line":68,"address":[5418720,5418297,5418618,5418952,5418903],"length":1,"stats":{"Line":2}},{"line":71,"address":[4286631],"length":1,"stats":{"Line":4}},{"line":73,"address":[5419320,5419543],"length":1,"stats":{"Line":2}},{"line":75,"address":[5419996,5420028,5419664,5419707,5419515],"length":1,"stats":{"Line":1}},{"line":76,"address":[5419940],"length":1,"stats":{"Line":0}},{"line":77,"address":[5419799],"length":1,"stats":{"Line":0}},{"line":79,"address":[5419886,5420048,5419833,5420073],"length":1,"stats":{"Line":0}},{"line":87,"address":[2378048],"length":1,"stats":{"Line":0}},{"line":88,"address":[13681189],"length":1,"stats":{"Line":0}},{"line":92,"address":[2378064],"length":1,"stats":{"Line":0}},{"line":96,"address":[13681238],"length":1,"stats":{"Line":0}},{"line":97,"address":[2378355,2378207],"length":1,"stats":{"Line":0}},{"line":98,"address":[2378376],"length":1,"stats":{"Line":0}},{"line":99,"address":[2378409],"length":1,"stats":{"Line":0}},{"line":100,"address":[13681561,13681643],"length":1,"stats":{"Line":0}},{"line":101,"address":[2378544,2378589,2378478],"length":1,"stats":{"Line":0}},{"line":102,"address":[2378623,2378562,2378661],"length":1,"stats":{"Line":0}},{"line":108,"address":[2378687,2378855,2378641],"length":1,"stats":{"Line":0}},{"line":110,"address":[2378865,2378743],"length":1,"stats":{"Line":0}},{"line":114,"address":[2378278],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":49},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","dao","item.rs"],"content":"use crate::entities::item;\nuse sea_orm::{DeriveActiveEnum, EnumIter};\nuse serde_json::Value;\n\n#[derive(EnumIter, DeriveActiveEnum, Clone, Debug, Copy, PartialEq, Eq)]\n#[sea_orm(rs_type = \"String\", db_type = \"Enum\", enum_name = \"LocType\")]\npub enum LocType {\n    #[sea_orm(string_value = \"INVENTORY\")]\n    Inventory,\n    #[sea_orm(string_value = \"PAPERDOLL\")]\n    Paperdoll,\n    #[sea_orm(string_value = \"NPC\")]\n    Npc,\n    #[sea_orm(string_value = \"CLANWH\")]\n    ClanWh,\n    #[sea_orm(string_value = \"PET\")]\n    Pet,\n    #[sea_orm(string_value = \"WAREHOUSE\")]\n    Warehouse,\n    #[sea_orm(string_value = \"VOID\")]\n    Void,\n    #[sea_orm(string_value = \"PET_EQUIP\")]\n    PetEquip,\n    #[sea_orm(string_value = \"LEASE\")]\n    Lease,\n    #[sea_orm(string_value = \"REFUND\")]\n    Refund,\n    #[sea_orm(string_value = \"MAIL\")]\n    Mail,\n    #[sea_orm(string_value = \"FREIGHT\")]\n    Freight,\n    #[sea_orm(string_value = \"COMMISSION\")]\n    Commission,\n}\n\n#[allow(clippy::missing_errors_doc)]\nimpl item::Model {\n    pub const VISUAL_ID: \u0026'static str = \"visualId\";\n    pub const VISUAL_APPEARANCE_STONE_ID: \u0026'static str = \"visualAppearanceStoneId\";\n    pub const VISUAL_APPEARANCE_LIFE_TIME: \u0026'static str = \"visualAppearanceLifetime\";\n    ///\n    /// # returns\n    ///  tuple where:\n    ///  1. mineral id\n    ///  2. option 1\n    ///  3. option 2\n    #[allow(clippy::cast_possible_truncation)]\n    pub fn get_augmentation(\u0026self) -\u003e Option\u003c(i32, i32, i32)\u003e {\n        let option_1 = self.variations.get(\"option_1\").and_then(Value::as_i64)?;\n        let option_2 = self.variations.get(\"option_2\").and_then(Value::as_i64)?;\n        let mineral_id = self\n            .variations\n            .get(\"mineralId\")\n            .and_then(Value::as_i64)\n            .unwrap_or(0) as i32;\n        if option_1 \u003e -1 \u0026\u0026 option_2 \u003e -1 {\n            return Some((mineral_id, option_1 as i32, option_2 as i32));\n        }\n        None\n    }\n}\n","traces":[{"line":48,"address":[2252144],"length":1,"stats":{"Line":0}},{"line":49,"address":[2252179,2252324],"length":1,"stats":{"Line":0}},{"line":50,"address":[2252430,2252258,2252339],"length":1,"stats":{"Line":0}},{"line":51,"address":[2252353],"length":1,"stats":{"Line":0}},{"line":56,"address":[2252417,2252454],"length":1,"stats":{"Line":0}},{"line":57,"address":[2252478],"length":1,"stats":{"Line":0}},{"line":59,"address":[2252442],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","dao","mod.rs"],"content":"pub mod character;\npub mod user;\npub mod item;\npub mod char_info;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","dao","user.rs"],"content":"use anyhow::anyhow;\nuse argon2::{Argon2, PasswordHash, PasswordVerifier};\nuse sea_orm::entity::prelude::*;\nuse tokio::task::spawn_blocking;\nuse tracing::error;\nuse crate::entities::user::{Column, Entity, Model};\n\nimpl Model {\n    pub async fn verify_password(\u0026self, password: \u0026str) -\u003e bool {\n        let pwd = password.to_owned();\n        let pwd_hash = self.password.clone();\n        let res = spawn_blocking(move || {\n            let Ok(parsed_hash) = PasswordHash::new(\u0026pwd_hash) else {\n                error!(\"Can not generate a hash for password\");\n                return false;\n            };\n            Argon2::default()\n                .verify_password(pwd.as_bytes(), \u0026parsed_hash)\n                .is_ok()\n        })\n            .await;\n        res.unwrap_or_else(|err| {\n            error!(\"Failed to spawn blocking thread to generate hash: {err}\");\n            false\n        })\n    }\n    ///\n    ///\n    /// # Arguments\n    ///\n    /// * `db_pool`:\n    /// * `username`:\n    ///\n    /// returns: Result\u003cOption\u003cModel\u003e, Error\u003e\n    /// # Errors\n    pub async fn find_some_by_username(\n        db_pool: \u0026DatabaseConnection,\n        username: \u0026str,\n    ) -\u003e anyhow::Result\u003cOption\u003cModel\u003e\u003e {\n        Ok(Entity::find()\n            .filter(Column::Username.contains(username))\n            .one(db_pool)\n            .await?)\n    }\n    ///\n    ///\n    /// # Arguments\n    ///\n    /// * `db_pool`:\n    /// * `username`:\n    ///\n    /// returns: Result\u003cOption\u003cModel\u003e, Error\u003e\n    /// # Errors\n    pub async fn find_by_username(\n        db_pool: \u0026DatabaseConnection,\n        username: \u0026str,\n    ) -\u003e anyhow::Result\u003cModel\u003e {\n        Entity::find()\n            .filter(Column::Username.contains(username))\n            .one(db_pool)\n            .await?\n            .ok_or_else(|| anyhow!(\"User not found {username}\"))\n    }\n}","traces":[{"line":9,"address":[13592000,13592018],"length":1,"stats":{"Line":0}},{"line":10,"address":[4328276,4328171],"length":1,"stats":{"Line":0}},{"line":11,"address":[4328285],"length":1,"stats":{"Line":0}},{"line":12,"address":[4334490,4328454,4328344,4328599,4333016,4331616],"length":1,"stats":{"Line":0}},{"line":13,"address":[4331710,4331631],"length":1,"stats":{"Line":0}},{"line":14,"address":[4333378,4332728,4332861,4333477,4332529,4333018,4333741,4334183,4334567,4333204,4333808,4332113,4334724],"length":1,"stats":{"Line":0}},{"line":15,"address":[4333140],"length":1,"stats":{"Line":0}},{"line":17,"address":[4331784,4332031],"length":1,"stats":{"Line":0}},{"line":18,"address":[4331964],"length":1,"stats":{"Line":0}},{"line":21,"address":[4328463,4328519,4328205,4328437,4328631],"length":1,"stats":{"Line":0}},{"line":22,"address":[4331586,4328673,4329884,4328768],"length":1,"stats":{"Line":0}},{"line":23,"address":[4335300,4330670,4329596,4335143,4329729,4329397,4331163,4330603,4331337,4328981,4330345,4329886,4330845,4330072,4330246],"length":1,"stats":{"Line":0}},{"line":36,"address":[2501984],"length":1,"stats":{"Line":0}},{"line":40,"address":[4337451,4338044,4337131,4337966,4337668,4337306,4337830,4337374],"length":1,"stats":{"Line":0}},{"line":41,"address":[4337350,4337501,4337190],"length":1,"stats":{"Line":0}},{"line":43,"address":[4462087],"length":1,"stats":{"Line":0}},{"line":54,"address":[2502032],"length":1,"stats":{"Line":1}},{"line":58,"address":[4336714,4336655,4335817,4336794,4336519,4335995,4336063,4336140,4336357],"length":1,"stats":{"Line":7}},{"line":59,"address":[4336039,4336190,4335876],"length":1,"stats":{"Line":1}},{"line":61,"address":[4336453,4335863,4336167,4336662,4336263,4336133],"length":1,"stats":{"Line":4}},{"line":62,"address":[4336800,4336811,4336877,4336630],"length":1,"stats":{"Line":1}}],"covered":5,"coverable":21},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","entities","character.rs"],"content":"//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.3\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, Default, DeriveEntityModel)]\n#[sea_orm(table_name = \"character\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub name: String,\n    pub level: i8,\n    pub delete_at: Option\u003cDateTimeWithTimeZone\u003e,\n    pub user_id: i32,\n    #[sea_orm(column_type = \"Double\")]\n    pub max_hp: f64,\n    #[sea_orm(column_type = \"Double\")]\n    pub cur_hp: f64,\n    #[sea_orm(column_type = \"Double\")]\n    pub max_cp: f64,\n    #[sea_orm(column_type = \"Double\")]\n    pub cur_cp: f64,\n    #[sea_orm(column_type = \"Double\")]\n    pub cur_mp: f64,\n    #[sea_orm(column_type = \"Double\")]\n    pub max_mp: f64,\n    pub face: u8,\n    pub hair_style: u8,\n    pub hair_color: u8,\n    pub is_female: bool,\n    pub heading: Option\u003ci32\u003e,\n    pub x: i32,\n    pub y: i32,\n    pub z: i32,\n    pub exp: i64,\n    pub exp_before_death: Option\u003ci64\u003e,\n    pub sp: i64,\n    pub reputation: i32,\n    pub fame: i32,\n    pub rb_points: i32,\n    pub pvp_kills: i32,\n    pub pk_kills: i32,\n    pub race_id: i8,\n    pub class_id: i8,\n    pub base_class_id: i8,\n    pub transform_id: i16,\n    pub can_craft: Option\u003cbool\u003e,\n    pub title: Option\u003cString\u003e,\n    pub title_color: Option\u003ci32\u003e,\n    pub access_level: i32,\n    pub online: Option\u003ci8\u003e,\n    pub online_time: Option\u003ci32\u003e,\n    pub char_slot: Option\u003ci8\u003e,\n    pub last_access: Option\u003cDateTimeWithTimeZone\u003e,\n    pub clan_privs: Option\u003ci32\u003e,\n    pub wants_peace: Option\u003ci8\u003e,\n    pub power_grade: Option\u003ci8\u003e,\n    pub nobless: bool,\n    pub sub_pledge: Option\u003ci16\u003e,\n    pub lvl_joined_academy: i8,\n    pub apprentice: i32,\n    pub sponsor: i32,\n    pub clan_join_expiry_time: Option\u003cDateTimeWithTimeZone\u003e,\n    #[sea_orm(column_type = \"JsonBinary\")]\n    pub variables: Json,\n    pub clan_create_expiry_time: Option\u003cDateTimeWithTimeZone\u003e,\n    pub bookmark_slot: i16,\n    pub vitality_points: i32,\n    pub created_at: Option\u003cDateTimeWithTimeZone\u003e,\n    pub language: Option\u003cString\u003e,\n    pub faction: i8,\n    pub pc_cafe_points: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = \"super::item::Entity\")]\n    Item,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\",\n        on_update = \"NoAction\",\n        on_delete = \"NoAction\"\n    )]\n    User,\n}\n\nimpl Related\u003csuper::item::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Item.def()\n    }\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":89,"address":[2377552],"length":1,"stats":{"Line":1}},{"line":90,"address":[2377560],"length":1,"stats":{"Line":1}},{"line":95,"address":[2377584],"length":1,"stats":{"Line":0}},{"line":96,"address":[2377592],"length":1,"stats":{"Line":0}}],"covered":2,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","entities","item.rs"],"content":"//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.3\n\nuse sea_orm::entity::prelude::*;\nuse crate::dao::item::LocType;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"item\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub owner: i32,\n    pub item_id: i32,\n    pub count: i64,\n    pub enchant_level: i32,\n    pub loc: LocType,\n    #[sea_orm(column_type = \"JsonBinary\")]\n    pub variables: Json,\n    #[sea_orm(column_type = \"JsonBinary\")]\n    pub variations: Json,\n    pub loc_data: i32,\n    pub time_of_use: i32,\n    pub custom_type1: i32,\n    pub custom_type2: i32,\n    #[sea_orm(column_type = \"Decimal(Some((5, 0)))\")]\n    pub mana_left: Decimal,\n    #[sea_orm(column_type = \"Decimal(Some((13, 0)))\")]\n    pub time: Decimal,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::character::Entity\",\n        from = \"Column::Owner\",\n        to = \"super::character::Column::Id\",\n        on_update = \"NoAction\",\n        on_delete = \"NoAction\"\n    )]\n    Character,\n}\n\nimpl Related\u003csuper::character::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Character.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":43,"address":[2252112],"length":1,"stats":{"Line":1}},{"line":44,"address":[2252120],"length":1,"stats":{"Line":1}}],"covered":2,"coverable":2},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","entities","mod.rs"],"content":"//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.3\n\npub mod prelude;\n\npub mod character;\npub mod item;\npub mod user;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","entities","prelude.rs"],"content":"//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.3\n\npub use super::character::Entity as Character;\npub use super::item::Entity as Item;\npub use super::user::Entity as User;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","entities","user.rs"],"content":"//! `SeaORM` Entity, @generated by sea-orm-codegen 1.1.3\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"user\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub username: String,\n    pub access_level: i32,\n    pub ban_ip: Option\u003cString\u003e,\n    pub password: String,\n    pub ban_duration: Option\u003ci64\u003e,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = \"super::character::Entity\")]\n    Character,\n}\n\nimpl Related\u003csuper::character::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Character.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":24,"address":[2501904],"length":1,"stats":{"Line":0}},{"line":25,"address":[2501912],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","runner","work","L2Shablya","L2Shablya","entities","src","lib.rs"],"content":"use sea_orm::DatabaseConnection;\n\npub mod entities;\npub mod dao;\n\npub type DBPool = DatabaseConnection;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","client_thread","handler.rs"],"content":"use crate::controller::Controller;\nuse crate::cp_factory::build_client_packet;\nuse crate::ls_thread::LoginHandler;\nuse anyhow::{bail, Error};\nuse async_trait::async_trait;\nuse entities::dao::char_info::CharacterInfo;\nuse entities::entities::{character, user};\nuse entities::DBPool;\nuse l2_core::config::gs::GSServer;\nuse l2_core::crypt::game::GameClientEncryption;\nuse l2_core::crypt::generate_blowfish_key;\nuse l2_core::crypt::login::Encryption;\nuse l2_core::dto::InboundConnection;\nuse l2_core::session::SessionKey;\nuse l2_core::shared_packets::gs_2_ls::PlayerLogout;\nuse l2_core::traits::handlers::{InboundHandler, PacketHandler, PacketSender};\nuse l2_core::traits::Shutdown;\nuse std::fmt;\nuse std::future::Future;\nuse std::net::Ipv4Addr;\nuse std::sync::Arc;\nuse tokio::io::{AsyncRead, AsyncWrite};\nuse tokio::sync::{Mutex, Notify};\nuse tracing::{error, info, instrument};\n\n#[derive(Debug, Clone, PartialEq)]\n#[allow(unused)]\npub enum ClientStatus {\n    Connected,\n    Closing,\n    Entering,\n    Authenticated,\n    Disconnected,\n    InGame,\n}\n#[allow(clippy::module_name_repetitions)]\npub struct ClientHandler {\n    tcp_reader: Arc\u003cMutex\u003cdyn AsyncRead + Unpin + Send\u003e\u003e,\n    tcp_writer: Arc\u003cMutex\u003cdyn AsyncWrite + Unpin + Send\u003e\u003e,\n    db_pool: DBPool,\n    controller: Arc\u003cController\u003e,\n    shutdown_notifier: Arc\u003cNotify\u003e,\n    timeout: u8,\n    ip: Ipv4Addr,\n    blowfish: Option\u003cArc\u003cMutex\u003cGameClientEncryption\u003e\u003e\u003e,\n    protocol: Option\u003ci32\u003e,\n    status: ClientStatus,\n    account_chars: Option\u003cVec\u003cCharacterInfo\u003e\u003e,\n    selected_char: Option\u003ci32\u003e,\n    session_key: Option\u003cSessionKey\u003e,\n    user: Option\u003cuser::Model\u003e,\n}\nimpl fmt::Debug for ClientHandler {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        f.debug_struct(\"Client\")\n            .field(\"ip\", \u0026self.ip)\n            .field(\"protocol\", \u0026self.protocol)\n            .field(\"status\", \u0026self.status)\n            .field(\"selected_char\", \u0026self.selected_char)\n            .field(\"user\", \u0026self.user)\n            .finish_non_exhaustive()\n    }\n}\n\nimpl ClientHandler {\n    pub fn get_protocol(\u0026self) -\u003e Option\u003ci32\u003e {\n        self.protocol\n    }\n    pub fn set_protocol(\u0026mut self, protocol: i32) -\u003e anyhow::Result\u003c()\u003e {\n        let cfg = self.controller.get_cfg();\n        if self.status != ClientStatus::Connected {\n            bail!(\"Invalid client status\");\n        }\n        if !cfg.allowed_revisions.contains(\u0026protocol) {\n            bail!(\"Invalid protocol version {}\", protocol);\n        }\n        self.protocol = Some(protocol);\n        Ok(())\n    }\n    pub fn set_session_key(\u0026mut self, session_key: SessionKey) {\n        self.session_key = Some(session_key);\n    }\n\n    pub fn try_get_user(\u0026self) -\u003e anyhow::Result\u003c\u0026user::Model\u003e {\n        self.user.as_ref().ok_or(anyhow::anyhow!(\"User not set\"))\n    }\n    pub fn get_user(\u0026self) -\u003e Option\u003c\u0026user::Model\u003e {\n        self.user.as_ref()\n    }\n    pub fn set_user(\u0026mut self, user: user::Model) {\n        self.user = Some(user);\n    }\n\n    pub fn get_session_key(\u0026self) -\u003e Option\u003c\u0026SessionKey\u003e {\n        self.session_key.as_ref()\n    }\n    pub fn try_get_session_key(\u0026self) -\u003e anyhow::Result\u003c\u0026SessionKey\u003e {\n        self.session_key\n            .as_ref()\n            .ok_or(anyhow::anyhow!(\"Programming error - Session is missing\"))\n    }\n    pub fn set_status(\u0026mut self, status: ClientStatus) {\n        self.status = status;\n    }\n\n    pub fn set_account_chars(\u0026mut self, chars: Vec\u003cCharacterInfo\u003e) {\n        self.account_chars = Some(chars);\n    }\n\n    pub fn get_account_chars(\u0026self) -\u003e Option\u003c\u0026Vec\u003cCharacterInfo\u003e\u003e {\n        self.account_chars.as_ref()\n    }\n    pub fn try_get_account_chars(\u0026self) -\u003e anyhow::Result\u003c\u0026Vec\u003cCharacterInfo\u003e\u003e {\n        self.account_chars.as_ref().ok_or(anyhow::anyhow!(\n            \"Programming error, missing account characters\"\n        ))\n    }\n\n    pub fn select_char(\u0026mut self, char_slot: i32) {\n        self.selected_char = Some(char_slot);\n    }\n\n    pub fn get_selected_char_slot(\u0026self) -\u003e Option\u003ci32\u003e {\n        self.selected_char\n    }\n\n    pub fn add_character(\u0026mut self, character: CharacterInfo) -\u003e anyhow::Result\u003c()\u003e {\n        self.account_chars\n            .as_mut()\n            .ok_or(anyhow::anyhow!(\n                \"Programming error, or possible cheating - missing characters.\"\n            ))?\n            .push(character);\n        Ok(())\n    }\n\n    #[allow(clippy::cast_sign_loss)]\n    pub async fn with_char_by_slot_id\u003cF, Fut\u003e(\n        \u0026mut self,\n        slot_id: i32,\n        modify_fn: F,\n    ) -\u003e anyhow::Result\u003c()\u003e\n    where\n        F: FnOnce(character::Model) -\u003e Fut,\n        Fut: Future\u003cOutput = anyhow::Result\u003ccharacter::Model\u003e\u003e + Send,\n    {\n        if let Some(chars) = self.account_chars.as_mut() {\n            if slot_id \u003e= i32::try_from(chars.len())? || slot_id \u003c 0 {\n                bail!(\"Missing character at slot: {slot_id}\")\n            }\n            let mut char_info: CharacterInfo = chars.remove(slot_id as usize);\n            let model = char_info.char_model.clone();\n            let updated_char = modify_fn(model).await?;\n            char_info.char_model = updated_char;\n            chars.insert(slot_id as usize, char_info);\n        }\n        Ok(())\n    }\n\n    #[allow(clippy::cast_sign_loss)]\n    pub fn try_get_char_by_slot_id(\u0026self, slot_id: i32) -\u003e anyhow::Result\u003c\u0026CharacterInfo\u003e {\n        self.account_chars\n            .as_ref()\n            .ok_or(anyhow::anyhow!(\n                \"Possible programming error or cheating: Characters not set\"\n            ))?\n            .get(slot_id as usize)\n            .ok_or(anyhow::anyhow!(\"Missing character at slot {slot_id}\"))\n    }\n\n    pub fn set_encryption(\u0026mut self, bf_key: Option\u003cGameClientEncryption\u003e) {\n        if let Some(key) = bf_key {\n            self.blowfish = Some(Arc::new(Mutex::new(key)));\n        } else {\n            self.blowfish = None;\n        }\n    }\n    pub fn generate_key() -\u003e Vec\u003cu8\u003e {\n        let mut key = generate_blowfish_key(None);\n        key[8] = 0xc8;\n        key[9] = 0x27;\n        key[10] = 0x93;\n        key[11] = 0x01;\n        key[12] = 0xa1;\n        key[13] = 0x6c;\n        key[14] = 0x31;\n        key[15] = 0x97;\n        key\n    }\n}\nimpl Shutdown for ClientHandler {\n    fn get_shutdown_listener(\u0026self) -\u003e Arc\u003cNotify\u003e {\n        self.shutdown_notifier.clone()\n    }\n}\n\n#[async_trait]\nimpl PacketSender for ClientHandler {\n    async fn encrypt(\u0026self, bytes: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n        if let Some(bf) = self.blowfish.as_ref() {\n            let size = bytes.len();\n            Encryption::append_checksum(\u0026mut bytes[2..size]);\n            bf.lock().await.encrypt(\u0026mut bytes[2..size])?;\n        }\n        Ok(())\n    }\n\n    fn is_encryption_enabled(\u0026self) -\u003e bool {\n        self.blowfish.is_some()\n    }\n\n    async fn get_stream_writer_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncWrite + Unpin + Send\u003e\u003e {\n        \u0026self.tcp_writer\n    }\n}\n\n#[async_trait]\nimpl PacketHandler for ClientHandler {\n    type ConfigType = GSServer;\n    type ControllerType = Controller;\n\n    fn get_handler_name() -\u003e \u0026'static str {\n        \"Client handler\"\n    }\n\n    fn get_controller(\u0026self) -\u003e \u0026Arc\u003cSelf::ControllerType\u003e {\n        \u0026self.controller\n    }\n\n    fn new\u003cR, W\u003e(\n        r: R,\n        w: W,\n        ip: Ipv4Addr,\n        db_pool: DBPool,\n        controller: Arc\u003cSelf::ControllerType\u003e,\n    ) -\u003e Self\n    where\n        R: AsyncRead + Unpin + Send + 'static,\n        W: AsyncWrite + Unpin + Send + 'static,\n    {\n        let cfg = controller.get_cfg();\n        Self {\n            tcp_reader: Arc::new(Mutex::new(r)),\n            tcp_writer: Arc::new(Mutex::new(w)),\n            shutdown_notifier: Arc::new(Notify::new()),\n            timeout: cfg.client.timeout,\n            status: ClientStatus::Connected,\n            controller,\n            db_pool,\n            ip,\n            blowfish: None,\n            account_chars: None,\n            protocol: None,\n            user: None,\n            session_key: None,\n            selected_char: None,\n        }\n    }\n\n    #[instrument(skip(self))]\n    async fn on_connect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        info!(\"Client connected.\");\n        Ok(())\n    }\n\n    async fn on_disconnect(\u0026mut self) {\n        info!(\"Disconnecting Client...\");\n        let Some(user) = self.user.as_ref() else {\n            return;\n        };\n        self.controller.logout_account(\u0026user.username);\n        let packet = match PlayerLogout::new(\u0026user.username) {\n            Err(e) =\u003e {\n                error!(\"Cannot build logout packet: {}\", e);\n                //exit function\n                return;\n            }\n            Ok(p) =\u003e p,\n        };\n\n        if let Err(err) = self\n            .controller\n            .message_broker\n            .notify(LoginHandler::HANDLER_ID, Box::new(packet))\n            .await\n        {\n            error!(\n                \"Error while sending logout to login server, cause: {:?}\",\n                err\n            );\n        }\n    }\n\n    fn get_stream_reader_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e {\n        \u0026self.tcp_reader\n    }\n\n    fn get_timeout(\u0026self) -\u003e Option\u003cu64\u003e {\n        Some(u64::from(self.timeout))\n    }\n\n    fn get_db_pool(\u0026self) -\u003e \u0026DBPool {\n        \u0026self.db_pool\n    }\n\n    #[instrument(skip(self, bytes))]\n    async fn on_receive_bytes(\u0026mut self, _: usize, bytes: \u0026mut [u8]) -\u003e Result\u003c(), Error\u003e {\n        if let Some(blowfish) = self.blowfish.as_ref() {\n            blowfish.lock().await.decrypt(bytes)?;\n        }\n        let handler = build_client_packet(bytes)?;\n        handler.handle(self).await\n    }\n}\n\nimpl InboundHandler for ClientHandler {\n    type ConfigType = GSServer;\n\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026InboundConnection {\n        \u0026cfg.listeners.clients.connection\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::packets::from_client::auth::AuthLogin;\n    use crate::packets::from_client::protocol::ProtocolVersion;\n    use crate::packets::to_client::PlayerLoginResponse;\n    use l2_core::shared_packets::common::{PacketType, ReadablePacket, SendablePacket};\n    use l2_core::shared_packets::gs_2_ls::{PlayerAuthRequest, PlayerInGame};\n    use l2_core::shared_packets::ls_2_gs::PlayerAuthResponse;\n    use l2_core::shared_packets::read::ReadablePacketBuffer;\n    use l2_core::shared_packets::write::SendablePacketBuffer;\n    use l2_core::traits::ServerConfig;\n    use ntest::timeout;\n    use sea_orm::{ActiveModelTrait, ActiveValue, TryIntoModel};\n    use test_utils::utils::get_test_db;\n    use tokio::io::{split, AsyncReadExt, AsyncWriteExt, DuplexStream};\n    use tokio::task::JoinHandle;\n    struct TestPacketSender {\n        writer: Arc\u003cMutex\u003cdyn AsyncWrite + Unpin + Send\u003e\u003e,\n    }\n    impl fmt::Debug for TestPacketSender {\n        fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n            write!(f, \"TestPacketSender\")\n        }\n    }\n\n    #[async_trait]\n    impl PacketSender for TestPacketSender {\n        async fn encrypt(\u0026self, _: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n            Ok(())\n        }\n\n        fn is_encryption_enabled(\u0026self) -\u003e bool {\n            false\n        }\n\n        async fn get_stream_writer_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncWrite + Send + Unpin\u003e\u003e {\n            \u0026self.writer\n        }\n    }\n\n    impl ProtocolVersion {\n        pub fn new(version: i32) -\u003e anyhow::Result\u003cSelf\u003e {\n            let mut inst = Self {\n                version,\n                buffer: SendablePacketBuffer::new(),\n            };\n            inst.buffer.write(Self::PACKET_ID)?;\n            inst.buffer.write_i32(inst.version)?;\n            Ok(inst)\n        }\n    }\n    impl AuthLogin {\n        pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n            let mut inst = Self {\n                login_name: \"test\".to_string(),\n                play_key_1: 0,\n                play_key_2: 1,\n                login_key_1: 2,\n                login_key_2: 3,\n                buffer: SendablePacketBuffer::new(),\n            };\n            inst.buffer.write(Self::PACKET_ID)?;\n            inst.buffer.write_c_utf16le_string(Some(\u0026inst.login_name))?;\n            inst.buffer.write_i32(inst.play_key_1)?;\n            inst.buffer.write_i32(inst.play_key_2)?;\n            inst.buffer.write_i32(inst.login_key_1)?;\n            inst.buffer.write_i32(inst.login_key_2)?;\n            Ok(inst)\n        }\n    }\n\n    fn build_client_handler(\n        server: DuplexStream,\n        db_pool: DBPool,\n        controller_opt: Option\u003cArc\u003cController\u003e\u003e,\n    ) -\u003e JoinHandle\u003c(ClientHandler, anyhow::Result\u003c()\u003e)\u003e {\n        let controller = controller_opt.unwrap_or_else(|| {\n            let cfg = Arc::new(GSServer::from_string(include_str!(\n                \"../../test_data/game.yaml\"\n            )));\n            Arc::new(Controller::new(cfg))\n        });\n        let cloned_controller = controller.clone();\n        // Spawn a server task to handle a single connection\n        tokio::spawn(async move {\n            let ip = Ipv4Addr::new(127, 0, 0, 1);\n            let (r, w) = split(server);\n            let mut ch = ClientHandler::new(r, w, ip, db_pool, cloned_controller);\n            let r = ch.handle_client().await;\n            (ch, r)\n        })\n    }\n\n    #[tokio::test]\n    #[timeout(2000)]\n    async fn test_protocol_version_fail() {\n        // Create a listener on a local port\n        let (mut client, server) = tokio::io::duplex(1024);\n        let pool = get_test_db().await;\n        let h = build_client_handler(server, pool, None);\n        let mut login_packet = ProtocolVersion::new(6_553_697).unwrap();\n        let bytes = login_packet.get_bytes(false);\n        bytes[3] = 1;\n        bytes[4] = 2;\n        client.write_all(bytes).await.unwrap();\n        client.shutdown().await.unwrap();\n        let (_, err) = h.await.unwrap();\n        assert!(err.is_err());\n        let err_str = err.err().unwrap().to_string();\n        assert!(err_str.contains(\"Invalid protocol version\"));\n    }\n\n    #[tokio::test]\n    #[timeout(2000)]\n    async fn test_protocol_version_success() {\n        // Create a listener on a local port\n        let (mut client, server) = tokio::io::duplex(2024);\n        let pool = get_test_db().await;\n        let h = build_client_handler(server, pool, None);\n        let mut login_packet = ProtocolVersion::new(6_553_697).unwrap();\n        let bytes = login_packet.get_bytes(false);\n        client.write_all(bytes).await.unwrap();\n        let mut resp = [0; 24];\n        // Read the response from the server\n        client.read_exact(\u0026mut resp).await.unwrap();\n        client.shutdown().await.unwrap();\n        let (ch, _) = h.await.unwrap();\n        assert_eq!(ch.protocol, Some(6_553_697));\n        assert_eq!(resp[0..4], [26, 0, 46, 1]);\n    }\n\n    #[tokio::test]\n    #[timeout(2000)]\n    async fn test_auth_fail() {\n        // Create a listener on a local port\n        let (mut client, server) = tokio::io::duplex(2024);\n        let pool = get_test_db().await;\n        let h = build_client_handler(server, pool, None);\n        let mut auth = AuthLogin::new().unwrap();\n        client.write_all(auth.get_bytes(false)).await.unwrap();\n        client.shutdown().await.unwrap();\n        let (_, err) = h.await.unwrap();\n        assert!(err.is_err());\n        let err_str = err.err().unwrap().to_string();\n        assert!(err_str.contains(\"Protocol version not set\"));\n    }\n    /// This test is testing whole logic for authenticating user from Protocol version\n    /// and authenticating on login server.\n    /// I decided to do integration test instead of small unit tests just to be able to change\n    /// internals while still not braking functionality.\n    #[tokio::test]\n    #[timeout(2000)]\n    async fn test_integration_auth_ok() {\n        // Create a listener on a local port\n        let (mut client, server) = tokio::io::duplex(1024);\n        let (login_client, mut login_server) = tokio::io::duplex(1024);\n        let cfg = Arc::new(GSServer::from_string(include_str!(\n            \"../../test_data/game.yaml\"\n        )));\n        let user_record = user::ActiveModel {\n            id: ActiveValue::NotSet,\n            username: ActiveValue::Set(\"test\".to_string()),\n            password: ActiveValue::Set(\"password_hash\".to_string()),\n            access_level: ActiveValue::Set(0),\n            ban_duration: ActiveValue::NotSet,\n            ban_ip: ActiveValue::NotSet,\n        };\n        let pool = get_test_db().await;\n        let user_model = user_record.save(\u0026pool).await.unwrap();\n        let controller = Arc::new(Controller::new(cfg));\n        let test_packet_sender = Arc::new(TestPacketSender {\n            writer: Arc::new(Mutex::new(login_client)),\n        });\n        controller\n            .message_broker\n            .register_packet_handler(LoginHandler::HANDLER_ID, test_packet_sender.clone());\n        let handle = build_client_handler(server, pool, Some(controller.clone()));\n        let mut login_packet = ProtocolVersion::new(6_553_697).unwrap();\n        let bytes = login_packet.get_bytes(false);\n        client.write_all(bytes).await.unwrap();\n        let mut protocol_response = [0; 26];\n        client.read_exact(\u0026mut protocol_response).await.unwrap();\n        assert_eq!(protocol_response[0], 26);\n        let mut auth = AuthLogin::new().unwrap();\n        client.write_all(auth.get_bytes(false)).await.unwrap();\n        let mut auth_login_packet = [0; 29];\n        login_server\n            .read_exact(\u0026mut auth_login_packet)\n            .await\n            .unwrap();\n        let p = PlayerAuthRequest::read(\u0026auth_login_packet[2..]).unwrap();\n        assert_eq!(p.account_name, \"test\");\n        assert_eq!(p.session.play_ok1, 1); //it should be vice versa\n        assert_eq!(p.session.play_ok2, 0);\n        assert_eq!(p.session.login_ok1, 2);\n        assert_eq!(p.session.login_ok2, 3);\n        let auth_ok_packet = PlayerAuthResponse::new(\"test\", true);\n        //login ok\n        controller.message_broker.respond_to_message(\n            Some(LoginHandler::HANDLER_ID),\n            \"test\",\n            PacketType::PlayerAuthResp(auth_ok_packet),\n        );\n        let mut player_in_game = [0; 15];\n        login_server.read_exact(\u0026mut player_in_game).await.unwrap();\n        let pig = PlayerInGame::read(\u0026player_in_game[2..]).unwrap();\n        assert_eq!(pig.accounts, [\"test\"]);\n        let mut auth_ok_resp = [0; 11];\n        client.read_exact(\u0026mut auth_ok_resp).await.unwrap();\n        let mut buffer = ReadablePacketBuffer::new(\u0026auth_ok_resp[2..]);\n        let p_id = buffer.read_byte().unwrap();\n        let is_ok = buffer.read_i32().unwrap();\n        let reason = buffer.read_u32().unwrap();\n        assert_eq!(PlayerLoginResponse::PACKET_ID, p_id);\n        assert_eq!(is_ok, -1);\n        assert_eq!(reason, 0);\n        client.shutdown().await.unwrap();\n        let (ch, _) = handle.await.unwrap();\n        assert_eq!(ch.protocol, Some(6_553_697));\n        assert_eq!(ch.session_key.unwrap(), p.session);\n        assert_eq!(ch.user.unwrap(), user_model.try_into_model().unwrap());\n    }\n}\n","traces":[{"line":54,"address":[3865728],"length":1,"stats":{"Line":0}},{"line":55,"address":[3865938,3865746,3865780,3865824,3865902,3865863],"length":1,"stats":{"Line":0}},{"line":56,"address":[3865773],"length":1,"stats":{"Line":0}},{"line":57,"address":[3865817],"length":1,"stats":{"Line":0}},{"line":58,"address":[3865856],"length":1,"stats":{"Line":0}},{"line":59,"address":[3865895],"length":1,"stats":{"Line":0}},{"line":60,"address":[3865934],"length":1,"stats":{"Line":0}},{"line":66,"address":[3865984],"length":1,"stats":{"Line":1}},{"line":67,"address":[3865989],"length":1,"stats":{"Line":1}},{"line":69,"address":[3866016,3866647],"length":1,"stats":{"Line":3}},{"line":70,"address":[3866040],"length":1,"stats":{"Line":3}},{"line":71,"address":[3866136,3866070],"length":1,"stats":{"Line":6}},{"line":72,"address":[3866159,3866617],"length":1,"stats":{"Line":0}},{"line":74,"address":[3866147,3866190],"length":1,"stats":{"Line":6}},{"line":75,"address":[3866434,3866555],"length":1,"stats":{"Line":2}},{"line":77,"address":[3866362],"length":1,"stats":{"Line":2}},{"line":78,"address":[3866410],"length":1,"stats":{"Line":2}},{"line":80,"address":[3866672],"length":1,"stats":{"Line":1}},{"line":81,"address":[3866677],"length":1,"stats":{"Line":1}},{"line":84,"address":[3866752],"length":1,"stats":{"Line":0}},{"line":85,"address":[3866761],"length":1,"stats":{"Line":0}},{"line":87,"address":[3866848],"length":1,"stats":{"Line":1}},{"line":88,"address":[3866853],"length":1,"stats":{"Line":1}},{"line":90,"address":[3866864,3867004],"length":1,"stats":{"Line":1}},{"line":91,"address":[3867038,3866881],"length":1,"stats":{"Line":2}},{"line":94,"address":[3867072],"length":1,"stats":{"Line":0}},{"line":95,"address":[3867077],"length":1,"stats":{"Line":0}},{"line":97,"address":[3867104],"length":1,"stats":{"Line":0}},{"line":98,"address":[3867113,3867187],"length":1,"stats":{"Line":0}},{"line":100,"address":[3867130],"length":1,"stats":{"Line":0}},{"line":102,"address":[3867200],"length":1,"stats":{"Line":1}},{"line":103,"address":[3867212],"length":1,"stats":{"Line":1}},{"line":106,"address":[3867232,3867303],"length":1,"stats":{"Line":1}},{"line":107,"address":[3867246,3867334],"length":1,"stats":{"Line":2}},{"line":110,"address":[3867376],"length":1,"stats":{"Line":0}},{"line":111,"address":[3867381],"length":1,"stats":{"Line":0}},{"line":113,"address":[3867408],"length":1,"stats":{"Line":0}},{"line":114,"address":[3867417],"length":1,"stats":{"Line":0}},{"line":119,"address":[3867504],"length":1,"stats":{"Line":0}},{"line":120,"address":[3867513],"length":1,"stats":{"Line":0}},{"line":123,"address":[3867552],"length":1,"stats":{"Line":0}},{"line":124,"address":[3867557],"length":1,"stats":{"Line":0}},{"line":127,"address":[3867584,3867987,3868016],"length":1,"stats":{"Line":0}},{"line":128,"address":[3867604,3867752,3867892,3867919,3867974],"length":1,"stats":{"Line":0}},{"line":130,"address":[3867677],"length":1,"stats":{"Line":0}},{"line":133,"address":[3867847],"length":1,"stats":{"Line":0}},{"line":134,"address":[3867942],"length":1,"stats":{"Line":0}},{"line":138,"address":[4865584,4865648],"length":1,"stats":{"Line":0}},{"line":147,"address":[4867837,4868506,4870381,4865962,4866080,4868624],"length":1,"stats":{"Line":0}},{"line":148,"address":[4867035,4869579,4868767,4866137,4868681,4866223],"length":1,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[4338112,4337840],"length":1,"stats":{"Line":0}},{"line":154,"address":[4867432,4870059,4867515,4869976],"length":1,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[3868032],"length":1,"stats":{"Line":0}},{"line":162,"address":[3868120,3868051,3868388,3868187,3868418],"length":1,"stats":{"Line":0}},{"line":164,"address":[3868068],"length":1,"stats":{"Line":0}},{"line":167,"address":[3868182],"length":1,"stats":{"Line":0}},{"line":168,"address":[3868297],"length":1,"stats":{"Line":0}},{"line":171,"address":[3868696,3868464],"length":1,"stats":{"Line":0}},{"line":172,"address":[3868489,3868773],"length":1,"stats":{"Line":0}},{"line":173,"address":[3868635,3868538],"length":1,"stats":{"Line":0}},{"line":175,"address":[3868604,3868714],"length":1,"stats":{"Line":0}},{"line":178,"address":[3868784,3869255],"length":1,"stats":{"Line":2}},{"line":179,"address":[3868801],"length":1,"stats":{"Line":2}},{"line":180,"address":[3868847,3868921],"length":1,"stats":{"Line":4}},{"line":181,"address":[3868924],"length":1,"stats":{"Line":2}},{"line":182,"address":[3868965],"length":1,"stats":{"Line":2}},{"line":183,"address":[3869006],"length":1,"stats":{"Line":2}},{"line":184,"address":[3869047],"length":1,"stats":{"Line":2}},{"line":185,"address":[3869088],"length":1,"stats":{"Line":2}},{"line":186,"address":[3869129],"length":1,"stats":{"Line":2}},{"line":187,"address":[3869170],"length":1,"stats":{"Line":2}},{"line":188,"address":[3869221],"length":1,"stats":{"Line":1}},{"line":192,"address":[3869280],"length":1,"stats":{"Line":4}},{"line":193,"address":[3869285],"length":1,"stats":{"Line":3}},{"line":199,"address":[4870800,4871048,4872013,4870825,4871459,4870903],"length":1,"stats":{"Line":0}},{"line":200,"address":[4871111],"length":1,"stats":{"Line":0}},{"line":201,"address":[4871193],"length":1,"stats":{"Line":0}},{"line":202,"address":[4871206,4871337],"length":1,"stats":{"Line":0}},{"line":203,"address":[4289913],"length":1,"stats":{"Line":0}},{"line":205,"address":[4871294],"length":1,"stats":{"Line":0}},{"line":208,"address":[3869888],"length":1,"stats":{"Line":1}},{"line":209,"address":[3869893],"length":1,"stats":{"Line":1}},{"line":212,"address":[3869929],"length":1,"stats":{"Line":7}},{"line":213,"address":[4872135],"length":1,"stats":{"Line":1}},{"line":226,"address":[3870064],"length":1,"stats":{"Line":3}},{"line":227,"address":[3870072],"length":1,"stats":{"Line":3}},{"line":230,"address":[4874586,4872208,4874494,4873392,4873358,4873273],"length":1,"stats":{"Line":4}},{"line":241,"address":[],"length":0,"stats":{"Line":8}},{"line":243,"address":[],"length":0,"stats":{"Line":4}},{"line":244,"address":[],"length":0,"stats":{"Line":7}},{"line":245,"address":[],"length":0,"stats":{"Line":4}},{"line":246,"address":[],"length":0,"stats":{"Line":8}},{"line":261,"address":[4887607,4887802,4887675,4890384,4886402,4887584],"length":1,"stats":{"Line":12}},{"line":262,"address":[4890632,4888635,4888917,4889288,4889112,4888020,4890475,4888436,4888765,4889707,4890079,4889386,4889643],"length":1,"stats":{"Line":20}},{"line":263,"address":[4889072],"length":1,"stats":{"Line":4}},{"line":266,"address":[3870095],"length":1,"stats":{"Line":3}},{"line":267,"address":[4875770,4876388,4875640,4877171,4891051,4876699,4891208,4875025,4876114,4875922,4876775,4876290,4875441],"length":1,"stats":{"Line":5}},{"line":268,"address":[4877492,4876085],"length":1,"stats":{"Line":2}},{"line":269,"address":[4877583],"length":1,"stats":{"Line":1}},{"line":271,"address":[4877596,4877561],"length":1,"stats":{"Line":2}},{"line":272,"address":[4877662,4877740],"length":1,"stats":{"Line":2}},{"line":273,"address":[4877967],"length":1,"stats":{"Line":0}},{"line":274,"address":[4878673,4891784,4879570,4879418,4881139,4879089,4880028,4880415,4879930,4880609,4891627,4879288,4879754,4880945,4880339],"length":1,"stats":{"Line":0}},{"line":278,"address":[4877806],"length":1,"stats":{"Line":1}},{"line":281,"address":[4881598,4881724,4878458,4878508,4878214,4877942],"length":1,"stats":{"Line":6}},{"line":284,"address":[4878236],"length":1,"stats":{"Line":1}},{"line":285,"address":[4295463],"length":1,"stats":{"Line":3}},{"line":287,"address":[4892360,4882640,4883707,4883282,4883643,4883106,4884404,4882922,4882441,4882025,4882770,4883380,4884213,4883898,4892203],"length":1,"stats":{"Line":0}},{"line":294,"address":[3870240],"length":1,"stats":{"Line":1}},{"line":295,"address":[3870248],"length":1,"stats":{"Line":3}},{"line":298,"address":[3870256],"length":1,"stats":{"Line":1}},{"line":299,"address":[3870261],"length":1,"stats":{"Line":3}},{"line":302,"address":[3870304],"length":1,"stats":{"Line":1}},{"line":307,"address":[4896191,4896447,4896160,4894664,4896278,4896770,4897528],"length":1,"stats":{"Line":7}},{"line":308,"address":[4896529],"length":1,"stats":{"Line":1}},{"line":309,"address":[4306945],"length":1,"stats":{"Line":0}},{"line":311,"address":[4897362,4897542,4896636,4897240],"length":1,"stats":{"Line":6}},{"line":312,"address":[4306961],"length":1,"stats":{"Line":7}},{"line":319,"address":[3869312],"length":1,"stats":{"Line":0}},{"line":320,"address":[3869320],"length":1,"stats":{"Line":0}}],"covered":66,"coverable":125},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","client_thread","mod.rs"],"content":"mod handler;\npub use handler::*;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","controller.rs"],"content":"use crate::data::base_stat::BaseStat;\nuse crate::data::char_template::ClassTemplates;\nuse crate::data::exp_table::ExpTable;\nuse dashmap::DashMap;\nuse entities::entities::prelude::Character;\nuse l2_core::config::gs::GSServer;\nuse l2_core::config::traits::{ConfigDirLoader, ConfigFileLoader};\nuse l2_core::dto::Player;\nuse l2_core::message_broker::MessageBroker;\nuse l2_core::shared_packets::common::PacketType;\nuse l2_core::traits::IpBan;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tracing::info;\n\n#[derive(Clone, Debug)]\npub struct Controller {\n    cfg: Arc\u003cGSServer\u003e,\n    pub exp_table: ExpTable,\n    pub class_templates: Arc\u003cClassTemplates\u003e,\n    online_accounts: DashMap\u003cString, Player\u003e,\n    pub base_stats_table: BaseStat,\n    pub hero_list: DashMap\u003ci32, Character\u003e,\n    pub message_broker: Arc\u003cMessageBroker\u003cu8, PacketType\u003e\u003e,\n}\n\nimpl Controller {\n    pub fn new(cfg: Arc\u003cGSServer\u003e) -\u003e Self {\n        let threshold = Duration::from_secs(u64::from(cfg.listeners.login_server.messages.timeout));\n        let exp_table = ExpTable::load();\n        let class_templates = ClassTemplates::load();\n        let base_stats = BaseStat::load();\n        Controller {\n            exp_table,\n            cfg,\n            base_stats_table: base_stats,\n            class_templates: Arc::new(class_templates),\n            hero_list: DashMap::new(),\n            message_broker: MessageBroker::new(threshold),\n            online_accounts: DashMap::new(),\n        }\n    }\n    pub fn get_cfg(\u0026self) -\u003e Arc\u003cGSServer\u003e {\n        self.cfg.clone()\n    }\n    #[allow(clippy::unused_self)]\n    pub fn get_game_time(\u0026self) -\u003e i32 {\n        //todo game time\n        9999\n    }\n    pub fn get_online_accounts(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.online_accounts\n            .iter()\n            .map(|entry| entry.key().clone())\n            .collect()\n    }\n    pub fn add_online_account(\u0026self, account: String) -\u003e Option\u003cPlayer\u003e {\n        let key = account.clone();\n        self.online_accounts.insert(\n            key,\n            Player {\n                login_name: account,\n            },\n        )\n    }\n    pub fn logout_account(\u0026self, account: \u0026str) {\n        self.online_accounts.remove(account);\n        info!(\"Logged out online account: {}\", account);\n    }\n}\n\nimpl IpBan for Controller {\n    fn is_ip_banned(\u0026self, _: \u0026str) -\u003e bool {\n        false\n    }\n}\n","traces":[{"line":28,"address":[3729008,3730075,3730000],"length":1,"stats":{"Line":2}},{"line":29,"address":[3729125,3729030,3729151],"length":1,"stats":{"Line":3}},{"line":30,"address":[3729210],"length":1,"stats":{"Line":1}},{"line":31,"address":[3729217],"length":1,"stats":{"Line":3}},{"line":32,"address":[3729281],"length":1,"stats":{"Line":2}},{"line":37,"address":[3729504,3729625],"length":1,"stats":{"Line":6}},{"line":38,"address":[3729641],"length":1,"stats":{"Line":4}},{"line":39,"address":[3729748,3729694],"length":1,"stats":{"Line":8}},{"line":40,"address":[3729764],"length":1,"stats":{"Line":4}},{"line":43,"address":[3730112],"length":1,"stats":{"Line":4}},{"line":44,"address":[3730117],"length":1,"stats":{"Line":3}},{"line":47,"address":[3730144],"length":1,"stats":{"Line":0}},{"line":51,"address":[3730160],"length":1,"stats":{"Line":0}},{"line":52,"address":[3730184],"length":1,"stats":{"Line":0}},{"line":54,"address":[5301712,5301742],"length":1,"stats":{"Line":0}},{"line":57,"address":[3730483,3730256,3730454],"length":1,"stats":{"Line":1}},{"line":58,"address":[3730299],"length":1,"stats":{"Line":1}},{"line":59,"address":[3730434,3730375],"length":1,"stats":{"Line":2}},{"line":61,"address":[3730404],"length":1,"stats":{"Line":1}},{"line":62,"address":[3730382],"length":1,"stats":{"Line":1}},{"line":66,"address":[3730496,3731863],"length":1,"stats":{"Line":1}},{"line":67,"address":[3730527],"length":1,"stats":{"Line":1}},{"line":68,"address":[3732140,3732206,3731865,3732413,3731183,3732370,3732585,3731994,3731017,3731364,3730683,3731580,3731261,3731407],"length":1,"stats":{"Line":5}},{"line":73,"address":[3732848],"length":1,"stats":{"Line":0}}],"covered":19,"coverable":24},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","cp_factory.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::from_client::auth::AuthLogin;\nuse crate::packets::from_client::char_create::CreateCharRequest;\nuse crate::packets::from_client::char_restore::RestoreChar;\nuse crate::packets::from_client::char_select::SelectChar;\nuse crate::packets::from_client::delete_char::DeleteChar;\nuse crate::packets::from_client::extended::{\n    CheckCharName, GoLobby, RequestUserBanInfo, SendClientIni,\n};\nuse crate::packets::from_client::logout::Logout;\nuse crate::packets::from_client::new_char_request::NewCharacterRequest;\nuse crate::packets::from_client::noop::NoOp;\nuse crate::packets::from_client::protocol::ProtocolVersion;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse tracing::error;\n\npub fn build_client_packet(\n    data: \u0026[u8],\n) -\u003e anyhow::Result\u003cBox\u003cdyn HandleablePacket\u003cHandlerType = ClientHandler\u003e\u003e\u003e {\n    if data.is_empty() {\n        bail!(\"Empty packet\");\n    }\n    let packet_body = \u0026data[1..]; // skip 1st byte, because it's packet id\n    match data[0] {\n        ProtocolVersion::PACKET_ID =\u003e Ok(Box::new(ProtocolVersion::read(packet_body)?)),\n        AuthLogin::PACKET_ID =\u003e Ok(Box::new(AuthLogin::read(packet_body)?)),\n        NewCharacterRequest::PACKET_ID =\u003e Ok(Box::new(NewCharacterRequest::read(packet_body)?)),\n        CreateCharRequest::PACKET_ID =\u003e Ok(Box::new(CreateCharRequest::read(packet_body)?)),\n        Logout::PACKET_ID =\u003e Ok(Box::new(Logout::read(packet_body)?)),\n        DeleteChar::PACKET_ID =\u003e Ok(Box::new(DeleteChar::read(packet_body)?)),\n        RestoreChar::PACKET_ID =\u003e Ok(Box::new(RestoreChar::read(packet_body)?)),\n        SelectChar::PACKET_ID =\u003e Ok(Box::new(SelectChar::read(packet_body)?)),\n        0xD0 =\u003e build_ex_client_packet(packet_body),\n        _ =\u003e {\n            error!(\"Unknown GS packet ID: 0x{:02X}\", data[0]);\n            Ok(Box::new(NoOp::read(data)?))\n        }\n    }\n}\n\npub fn build_ex_client_packet(\n    data: \u0026[u8],\n) -\u003e anyhow::Result\u003cBox\u003cdyn HandleablePacket\u003cHandlerType = ClientHandler\u003e\u003e\u003e {\n    if data.len() \u003c 2 {\n        bail!(\"Empty extended packet {data:?}\");\n    }\n    let packet_id = u16::from_le_bytes([data[0], data[1]]);\n    let packet_body = \u0026data[2..];\n    match Some(packet_id) {\n        GoLobby::EX_PACKET_ID =\u003e Ok(Box::new(GoLobby::read(packet_body)?)),\n        CheckCharName::EX_PACKET_ID =\u003e Ok(Box::new(CheckCharName::read(packet_body)?)),\n        SendClientIni::EX_PACKET_ID =\u003e Ok(Box::new(SendClientIni::read(packet_body)?)),\n        RequestUserBanInfo::EX_PACKET_ID =\u003e Ok(Box::new(RequestUserBanInfo::read(packet_body)?)),\n        _ =\u003e {\n            error!(\n                \"Unknown extended GS packet ID: 0x{:X}\",\n                u16::from_le_bytes([data[0], data[1]])\n            );\n            Ok(Box::new(NoOp::read(data)?))\n        }\n    }\n}\n","traces":[{"line":19,"address":[4561616],"length":1,"stats":{"Line":1}},{"line":22,"address":[4561693],"length":1,"stats":{"Line":3}},{"line":23,"address":[4561817],"length":1,"stats":{"Line":0}},{"line":25,"address":[4561789],"length":1,"stats":{"Line":4}},{"line":26,"address":[4561805,4561894],"length":1,"stats":{"Line":8}},{"line":27,"address":[4562223,4562883,4563063],"length":1,"stats":{"Line":9}},{"line":28,"address":[4563131,4562311,4563343],"length":1,"stats":{"Line":3}},{"line":29,"address":[4562405,4563484],"length":1,"stats":{"Line":0}},{"line":30,"address":[4563544,4563724,4562480],"length":1,"stats":{"Line":0}},{"line":31,"address":[4562574,4563865],"length":1,"stats":{"Line":0}},{"line":32,"address":[4562649,4563925,4564042],"length":1,"stats":{"Line":0}},{"line":33,"address":[4564102,4562721,4564213],"length":1,"stats":{"Line":0}},{"line":34,"address":[4564273,4564378,4562793],"length":1,"stats":{"Line":0}},{"line":35,"address":[4562873],"length":1,"stats":{"Line":0}},{"line":37,"address":[4238248,4238091],"length":1,"stats":{"Line":0}},{"line":38,"address":[4565367,4567387,4567414],"length":1,"stats":{"Line":0}},{"line":43,"address":[4567472],"length":1,"stats":{"Line":0}},{"line":46,"address":[4567511],"length":1,"stats":{"Line":0}},{"line":47,"address":[4567664],"length":1,"stats":{"Line":0}},{"line":49,"address":[4568076,4567522,4567773],"length":1,"stats":{"Line":0}},{"line":50,"address":[4567926,4568015],"length":1,"stats":{"Line":0}},{"line":51,"address":[4568031,4568097],"length":1,"stats":{"Line":0}},{"line":52,"address":[4568343,4568727],"length":1,"stats":{"Line":0}},{"line":53,"address":[4568418,4568795,4568968],"length":1,"stats":{"Line":0}},{"line":54,"address":[4568512,4569109],"length":1,"stats":{"Line":0}},{"line":55,"address":[4568587,4569250],"length":1,"stats":{"Line":0}},{"line":57,"address":[4238667,4238824],"length":1,"stats":{"Line":0}},{"line":61,"address":[4572040,4572013,4570246],"length":1,"stats":{"Line":0}}],"covered":6,"coverable":28},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","base_stat.rs"],"content":"use anyhow::anyhow;\nuse macro_common::config_file;\nuse serde::Deserialize;\n\n#[allow(unused)]\n#[derive(Clone, Debug)]\npub enum CreatureStat {\n    Con,\n    Dex,\n    Wit,\n    Men,\n    Str,\n    Int,\n}\n\n#[derive(Clone, Debug)]\npub enum CreatureParameter {\n    HP,\n    MP,\n    CP,\n}\n\n#[allow(unused)]\n#[derive(Debug, Clone, Deserialize)]\npub struct StatData {\n    value: u8,\n    bonus: f64,\n}\n\n#[derive(Debug, Clone, Deserialize)]\n#[serde(rename_all = \"UPPERCASE\")]\n#[config_file(path = \"config/data/stats/stat_bonus.yaml\", msg = \"Base stats loaded\")]\npub struct BaseStat {\n    pub con: Vec\u003cStatData\u003e,\n    pub dex: Vec\u003cStatData\u003e,\n    pub wit: Vec\u003cStatData\u003e,\n    pub men: Vec\u003cStatData\u003e,\n    pub str: Vec\u003cStatData\u003e,\n    pub int: Vec\u003cStatData\u003e,\n}\n\nimpl BaseStat {\n    /// # Errors\n    /// - when con lvl is too big\n    pub fn con_bonus(\u0026self, con_lvl: u8) -\u003e anyhow::Result\u003cf64\u003e {\n        let con_stat = \u0026self\n            .con\n            .get(con_lvl as usize)\n            .ok_or(anyhow!(\"Con lvl is out of static data range {con_lvl}\"))?;\n        Ok(con_stat.bonus)\n    }\n}\n","traces":[{"line":45,"address":[4156960],"length":1,"stats":{"Line":0}},{"line":46,"address":[4157004,4157022,4157330,4157219],"length":1,"stats":{"Line":0}},{"line":48,"address":[4157015],"length":1,"stats":{"Line":0}},{"line":49,"address":[4157133,4157317],"length":1,"stats":{"Line":0}},{"line":50,"address":[4157289],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":5},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","char_template.rs"],"content":"use crate::data::base_stat::{BaseStat, CreatureParameter};\nuse crate::data::classes::mapping::Class;\nuse anyhow::bail;\nuse entities::dao::char_info::CharVariables;\nuse entities::entities::character;\nuse l2_core::config::traits::{LoadFileHandler, Loadable};\nuse macro_common::config_dir;\nuse rand::prelude::SliceRandom;\nuse rand::thread_rng;\nuse serde::{Deserialize, Deserializer};\nuse serde_json::json;\nuse std::collections::HashMap;\nuse tracing::info;\n\n#[derive(Clone, Debug, Default)]\n#[config_dir(path = \"config/data/stats/chars/base_stats\", post_load)]\npub struct ClassTemplates {\n    templates: HashMap\u003cClass, CharTemplate\u003e,\n}\n\nimpl Loadable for ClassTemplates {\n    fn post_load(\u0026self) {\n        info!(\"Loaded {} class templates.\", self.templates.len());\n        for t in Self::registration_classes() {\n            assert!(\n                self.templates.contains_key(t),\n                \"Missing class template for class id: {t:?}\"\n            );\n        }\n    }\n}\n\nimpl LoadFileHandler for ClassTemplates {\n    type TargetConfigType = CharTemplate;\n    fn for_each(\u0026mut self, item: Self::TargetConfigType) {\n        if let Some(i) = self.templates.insert(item.class_id, item) {\n            panic!(\"Duplicate template id: {:?}\", i.class_id);\n        }\n    }\n}\nimpl ClassTemplates {\n    #[must_use]\n    pub fn get_template(\u0026self, template_id: Class) -\u003e Option\u003c\u0026CharTemplate\u003e {\n        self.templates.get(\u0026template_id)\n    }\n\n    /// # Errors\n    /// - when template is not found\n    pub fn try_get_template(\u0026self, template_id: Class) -\u003e anyhow::Result\u003c\u0026CharTemplate\u003e {\n        self.templates.get(\u0026template_id).ok_or(anyhow::anyhow!(\n            \"Invalid class template: {:?}.\",\n            template_id\n        ))\n    }\n    #[must_use]\n    pub fn has_template(\u0026self, template_id: Class) -\u003e bool {\n        self.templates.contains_key(\u0026template_id)\n    }\n\n    fn registration_classes() -\u003e \u0026'static [Class] {\n        \u0026[\n            Class::Fighter,\n            Class::Mage,\n            Class::ElvenFighter,\n            Class::ElvenMage,\n            Class::DarkFighter,\n            Class::DarkMage,\n            Class::OrcFighter,\n            Class::OrcMage,\n            Class::DwarvenFighter,\n        ]\n    }\n    /// # Panics\n    /// - when registration classes mismatch with available classes\n    #[must_use]\n    pub fn get_available_templates_for_registration(\u0026self) -\u003e Vec\u003c\u0026CharTemplate\u003e {\n        Self::registration_classes()\n            .iter()\n            .map(|i| {\n                self.templates.get(i).expect(\n                    r\"\n                         It seems like you misconfigured registration templates,\n                         so they contain classes that are not available at all.\",\n                )\n            })\n            .collect()\n    }\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct CharTemplate {\n    pub class_id: Class,\n    pub static_data: CharTemplateStaticData,\n\n    #[serde(deserialize_with = \"deserialize_lvl_up_gain_data\")]\n    pub lvl_up_gain_data: HashMap\u003cu8, LvlUpGainData\u003e,\n}\n\nfn deserialize_lvl_up_gain_data\u003c'de, D\u003e(\n    deserializer: D,\n) -\u003e Result\u003cHashMap\u003cu8, LvlUpGainData\u003e, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    // Deserialize into a Vec\u003cLvlUpGainData\u003e\n    let vec: Vec\u003cLvlUpGainData\u003e = Deserialize::deserialize(deserializer)?;\n\n    // Convert the Vec into a HashMap\n    let map: HashMap\u003cu8, LvlUpGainData\u003e = vec.into_iter().map(|data| (data.lvl, data)).collect();\n\n    Ok(map)\n}\n\nimpl CharTemplate {\n    /// # Errors\n    /// - when something wrong with templates\n    #[allow(clippy::cast_sign_loss, clippy::similar_names)]\n    pub fn initialize_character(\n        \u0026self,\n        target: \u0026mut character::Model,\n        base_stats: \u0026BaseStat,\n    ) -\u003e anyhow::Result\u003c()\u003e {\n        target.class_id = self.class_id as i8;\n        let p = self.get_random_loc()?;\n        //todo custom starting loc\n        target.x = p.x;\n        target.y = p.y;\n        target.z = p.z;\n        target.base_class_id = self.class_id as i8;\n        target.access_level = 0;\n        target.race_id = self.class_id.get_class().race as i8;\n        let base_max_hp =\n            self.get_base_max_parameter(target.level as u8, \u0026CreatureParameter::HP)?;\n        let base_max_mp =\n            self.get_base_max_parameter(target.level as u8, \u0026CreatureParameter::MP)?;\n        let base_max_cp =\n            self.get_base_max_parameter(target.level as u8, \u0026CreatureParameter::CP)?;\n        let base_con = base_stats.con_bonus(u8::try_from(self.static_data.base_con)?)?;\n        let base_men = base_stats.con_bonus(u8::try_from(self.static_data.base_men)?)?;\n        target.max_hp = f64::from(base_max_hp) * base_con;\n        target.max_mp = f64::from(base_max_mp) * base_men;\n        target.max_cp = f64::from(base_max_cp) * base_con;\n        target.cur_hp = target.max_hp;\n        target.cur_mp = target.max_mp;\n        target.cur_cp = target.max_cp;\n        target.variables = json!({\n            CharVariables::VisualHairId.as_key(): target.hair_style,\n            CharVariables::VisualHairColorId.as_key(): target.hair_color,\n            CharVariables::VisualFaceId.as_key(): target.face\n        });\n        //todo skill tree\n        //todo shortcut panel initialization\n        //todo initial items\n        //todo vitality\n        //todo starting level\n        //todo starting adena\n        Ok(())\n    }\n    /// # Errors\n    /// - when lvl is higher than we have data for it in th template.\n    pub fn get_base_max_parameter(\n        \u0026self,\n        lvl: u8,\n        parameter: \u0026CreatureParameter,\n    ) -\u003e anyhow::Result\u003cf32\u003e {\n        if let Some(val) = self.lvl_up_gain_data.get(\u0026lvl) {\n            return match parameter {\n                CreatureParameter::CP =\u003e Ok(val.cp),\n                CreatureParameter::HP =\u003e Ok(val.hp),\n                CreatureParameter::MP =\u003e Ok(val.mp),\n            };\n        }\n        bail!(\"No max {:?} found for lvl {lvl}\", parameter);\n    }\n    /// # Errors\n    /// - when no creation points are specified in the template\n    pub fn get_random_loc(\u0026self) -\u003e anyhow::Result\u003c\u0026Point\u003e {\n        let mut rng = thread_rng();\n        if let Some(random_item) = self.static_data.creation_points.choose(\u0026mut rng) {\n            Ok(random_item)\n        } else {\n            bail!(\n                \"Creation points are not specified in template {:?}!\",\n                self.class_id\n            );\n        }\n    }\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct CharTemplateStaticData {\n    pub base_int: i32,\n    pub base_str: i32,\n    pub base_con: i32,\n    pub base_men: i32,\n    pub base_dex: i32,\n    pub base_wit: i32,\n    pub physical_abnormal_resist: i32,\n    pub magic_abnormal_resist: i32,\n    pub creation_points: Vec\u003cPoint\u003e,\n    pub base_p_atk: i32,\n    pub base_crit_rate: i32,\n    pub base_m_crit_rate: i32,\n    pub base_atk_type: BaseAtkType,\n    pub base_p_atk_spd: i32,\n    pub base_m_atk_spd: i32,\n    pub base_p_def: BasePDef,\n    pub base_m_atk: i32,\n    pub base_m_def: BaseMDef,\n    pub base_can_penetrate: i32,\n    pub base_atk_range: i32,\n    pub base_dam_range: BaseDamRange,\n    pub base_rnd_dam: i32,\n    pub base_move_spd: BaseMoveSpeed,\n    pub base_breath: i32,\n    pub base_safe_fall: i32,\n    pub collision_male: CharCollision,\n    pub collision_female: CharCollision,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct LvlUpGainData {\n    pub lvl: u8,\n    pub hp: f32,\n    pub mp: f32,\n    pub cp: f32,\n    pub hp_regen: f32,\n    pub mp_regen: f32,\n    pub cp_regen: f32,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct CharCollision {\n    pub radius: f32,\n    pub height: f32,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct BaseMoveSpeed {\n    pub walk: i32,\n    pub run: i32,\n    pub slow_swim: i32,\n    pub fast_swim: i32,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct BaseDamRange {\n    pub vertical_direction: i32,\n    pub horizontal_direction: i32,\n    pub distance: i32,\n    pub width: i32,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct BaseMDef {\n    pub r_ear: i32,\n    pub l_ear: i32,\n    pub r_finger: i32,\n    pub l_finger: i32,\n    pub neck: i32,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct BasePDef {\n    pub chest: i32,\n    pub legs: i32,\n    pub head: i32,\n    pub feet: i32,\n    pub gloves: i32,\n    pub underwear: i32,\n    pub cloak: i32,\n}\n\nimpl BasePDef {\n    #[must_use]\n    pub fn total(\u0026self) -\u003e i32 {\n        self.chest + self.legs + self.head + self.feet + self.gloves + self.underwear + self.cloak\n    }\n}\n\nimpl BaseMDef {\n    #[must_use]\n    pub fn total(\u0026self) -\u003e i32 {\n        self.r_ear + self.l_ear + self.l_finger + self.neck\n    }\n}\n\n#[derive(Debug, Clone, Deserialize)]\n#[serde(rename_all = \"UPPERCASE\")]\npub enum BaseAtkType {\n    Fist,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct Point {\n    pub x: i32,\n    pub y: i32,\n    pub z: i32,\n}\n","traces":[{"line":22,"address":[3679616],"length":1,"stats":{"Line":2}},{"line":23,"address":[3681229,3681295,3681702,3681459,3679755,3680234,3681502,3680440,3680086,3680925,3680397,3681083,3680640,3680303],"length":1,"stats":{"Line":10}},{"line":24,"address":[3681959,3682022,3680923,3681018],"length":1,"stats":{"Line":6}},{"line":25,"address":[3682038],"length":1,"stats":{"Line":2}},{"line":35,"address":[3682208,3682529],"length":1,"stats":{"Line":4}},{"line":36,"address":[3682229],"length":1,"stats":{"Line":4}},{"line":37,"address":[3682296,3682451],"length":1,"stats":{"Line":0}},{"line":43,"address":[3682560],"length":1,"stats":{"Line":0}},{"line":44,"address":[3682576],"length":1,"stats":{"Line":0}},{"line":49,"address":[3682592],"length":1,"stats":{"Line":0}},{"line":50,"address":[3682700,3682623,3682785],"length":1,"stats":{"Line":0}},{"line":56,"address":[3682832],"length":1,"stats":{"Line":0}},{"line":57,"address":[3682848],"length":1,"stats":{"Line":0}},{"line":76,"address":[3682896],"length":1,"stats":{"Line":0}},{"line":77,"address":[3682919],"length":1,"stats":{"Line":0}},{"line":79,"address":[5222368],"length":1,"stats":{"Line":0}},{"line":80,"address":[5222382],"length":1,"stats":{"Line":0}},{"line":99,"address":[5222813,5222432,5222788],"length":1,"stats":{"Line":4}},{"line":106,"address":[],"length":0,"stats":{"Line":4}},{"line":109,"address":[],"length":0,"stats":{"Line":16}},{"line":111,"address":[],"length":0,"stats":{"Line":4}},{"line":118,"address":[3686177,3682992,3686142],"length":1,"stats":{"Line":0}},{"line":123,"address":[3683044],"length":1,"stats":{"Line":0}},{"line":124,"address":[3683377,3683094],"length":1,"stats":{"Line":0}},{"line":126,"address":[3683170],"length":1,"stats":{"Line":0}},{"line":127,"address":[3683178],"length":1,"stats":{"Line":0}},{"line":128,"address":[3683187],"length":1,"stats":{"Line":0}},{"line":129,"address":[3683196],"length":1,"stats":{"Line":0}},{"line":130,"address":[3683222],"length":1,"stats":{"Line":0}},{"line":131,"address":[3683232],"length":1,"stats":{"Line":0}},{"line":132,"address":[3683432,3683522,3683311],"length":1,"stats":{"Line":0}},{"line":134,"address":[3683456,3683667,3683577],"length":1,"stats":{"Line":0}},{"line":136,"address":[3683714,3683601,3683800],"length":1,"stats":{"Line":0}},{"line":138,"address":[3683850,3683738,3684031],"length":1,"stats":{"Line":0}},{"line":139,"address":[3684081,3684388,3683969],"length":1,"stats":{"Line":0}},{"line":140,"address":[3684237],"length":1,"stats":{"Line":0}},{"line":141,"address":[3684262],"length":1,"stats":{"Line":0}},{"line":142,"address":[3684287],"length":1,"stats":{"Line":0}},{"line":143,"address":[3684299],"length":1,"stats":{"Line":0}},{"line":144,"address":[3684315],"length":1,"stats":{"Line":0}},{"line":145,"address":[3684331],"length":1,"stats":{"Line":0}},{"line":146,"address":[3684958,3684430,3685320,3686155,3685791,3684846,3685432,3686186,3684355],"length":1,"stats":{"Line":0}},{"line":147,"address":[3684360],"length":1,"stats":{"Line":0}},{"line":148,"address":[3684920],"length":1,"stats":{"Line":0}},{"line":149,"address":[3685394],"length":1,"stats":{"Line":0}},{"line":157,"address":[3686114],"length":1,"stats":{"Line":0}},{"line":161,"address":[3686240],"length":1,"stats":{"Line":0}},{"line":166,"address":[3686289],"length":1,"stats":{"Line":0}},{"line":167,"address":[3686355,3686769],"length":1,"stats":{"Line":0}},{"line":168,"address":[3686836],"length":1,"stats":{"Line":0}},{"line":169,"address":[3686781],"length":1,"stats":{"Line":0}},{"line":170,"address":[3686808],"length":1,"stats":{"Line":0}},{"line":173,"address":[3686738,3686603],"length":1,"stats":{"Line":0}},{"line":177,"address":[3686880,3687353],"length":1,"stats":{"Line":0}},{"line":178,"address":[3686900],"length":1,"stats":{"Line":0}},{"line":179,"address":[3686919,3686992],"length":1,"stats":{"Line":0}},{"line":180,"address":[3687053],"length":1,"stats":{"Line":0}},{"line":182,"address":[3687197,3687085,3687297],"length":1,"stats":{"Line":0}},{"line":271,"address":[3687376],"length":1,"stats":{"Line":0}},{"line":272,"address":[3687390,3687608],"length":1,"stats":{"Line":0}},{"line":278,"address":[3687632],"length":1,"stats":{"Line":0}},{"line":279,"address":[3687646,3687747],"length":1,"stats":{"Line":0}}],"covered":10,"coverable":62},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","classes","mapping.rs"],"content":"use anyhow::bail;\nuse entities::dao::char_info::Race;\nuse serde::{Deserialize, Deserializer};\n\n#[derive(Clone, Debug, Copy, Eq, PartialEq)]\npub struct CharClass {\n    pub id: Class,\n    pub is_mage: bool,\n    pub is_summoner: bool,\n    pub parent: Option\u003cClass\u003e,\n    pub race: Race,\n}\n\nimpl CharClass {\n    #[must_use]\n    pub const fn new(\n        id: Class,\n        is_mage: bool,\n        is_summoner: bool,\n        race: Race,\n        parent: Option\u003cClass\u003e,\n    ) -\u003e Self {\n        Self {\n            id,\n            is_mage,\n            is_summoner,\n            parent,\n            race,\n        }\n    }\n    #[must_use]\n    pub const fn mage(id: Class, race: Race, parent: Option\u003cClass\u003e) -\u003e Self {\n        Self {\n            id,\n            is_mage: true,\n            race,\n            is_summoner: false,\n            parent,\n        }\n    }\n    #[must_use]\n    pub const fn summoner(id: Class, race: Race, parent: Option\u003cClass\u003e) -\u003e Self {\n        Self {\n            id,\n            is_mage: true,\n            race,\n            is_summoner: true,\n            parent,\n        }\n    }\n    #[must_use]\n    pub const fn fighter(id: Class, race: Race, parent: Option\u003cClass\u003e) -\u003e Self {\n        Self {\n            id,\n            is_mage: false,\n            race,\n            is_summoner: false,\n            parent,\n        }\n    }\n}\n\n#[repr(u8)]\n#[derive(Clone, Debug, Copy, Hash, PartialOrd, Ord, Eq, PartialEq)]\npub enum Class {\n    Fighter = 0,\n    Warrior = 1,\n    Gladiator = 2,\n    Warlord = 3,\n    Knight = 4,\n    Paladin = 5,\n    DarkAvenger = 6,\n    Rogue = 7,\n    TreasureHunter = 8,\n    Hawkeye = 9,\n    Mage = 10,\n    Wizard = 11,\n    Sorcerer = 12,\n    Necromancer = 13,\n    Warlock = 14,\n    Cleric = 15,\n    Bishop = 16,\n    Prophet = 17,\n    ElvenFighter = 18,\n    ElvenKnight = 19,\n    TempleKnight = 20,\n    Swordsinger = 21,\n    ElvenScout = 22,\n    PlainsWalker = 23,\n    SilverRanger = 24,\n    ElvenMage = 25,\n    ElvenWizard = 26,\n    Spellsinger = 27,\n    ElementalSummoner = 28,\n    Oracle = 29,\n    Elder = 30,\n    DarkFighter = 31,\n    PalusKnight = 32,\n    ShillienKnight = 33,\n    Bladedancer = 34,\n    Assassin = 35,\n    AbyssWalker = 36,\n    PhantomRanger = 37,\n    DarkMage = 38,\n    DarkWizard = 39,\n    Spellhowler = 40,\n    PhantomSummoner = 41,\n    ShillienOracle = 42,\n    ShillienElder = 43,\n    OrcFighter = 44,\n    OrcRaider = 45,\n    Destroyer = 46,\n    OrcMonk = 47,\n    Tyrant = 48,\n    OrcMage = 49,\n    OrcShaman = 50,\n    Overlord = 51,\n    Warcryer = 52,\n    DwarvenFighter = 53,\n    Scavenger = 54,\n    BountyHunter = 55,\n    Artisan = 56,\n    Warsmith = 57,\n    Duelist = 88,\n    Dreadnought = 89,\n    PhoenixKnight = 90,\n    HellKnight = 91,\n    Sagittarius = 92,\n    Adventurer = 93,\n    Archmage = 94,\n    Soultaker = 95,\n    ArcanaLord = 96,\n    Cardinal = 97,\n    Hierophant = 98,\n    EvaTemplar = 99,\n    SwordMuse = 100,\n    WindRider = 101,\n    MoonlightSentinel = 102,\n    MysticMuse = 103,\n    ElementalMaster = 104,\n    EvaSaint = 105,\n    ShillienTemplar = 106,\n    SpectralDancer = 107,\n    GhostHunter = 108,\n    GhostSentinel = 109,\n    StormScreamer = 110,\n    SpectralMaster = 111,\n    ShillienSaint = 112,\n    Titan = 113,\n    GrandKhavatari = 114,\n    Dominator = 115,\n    Doomcryer = 116,\n    FortuneSeeker = 117,\n    Maestro = 118,\n    MaleSoldier = 123,\n    FemaleSoldier = 124,\n    Trooper = 125,\n    Warder = 126,\n    Berserker = 127,\n    MaleSoulbreaker = 128,\n    FemaleSoulbreaker = 129,\n    Arbalester = 130,\n    Doombringer = 131,\n    MaleSoulHound = 132,\n    FemaleSoulHound = 133,\n    Trickster = 134,\n    Inspector = 135,\n    Judicator = 136,\n}\n\nimpl TryFrom\u003cu8\u003e for Class {\n    type Error = anyhow::Error;\n    #[allow(clippy::too_many_lines)]\n    fn try_from(value: u8) -\u003e anyhow::Result\u003cSelf\u003e {\n        #[allow(clippy::enum_glob_use)]\n        use Class::*;\n        match value {\n            0 =\u003e Ok(Fighter),\n            1 =\u003e Ok(Warrior),\n            2 =\u003e Ok(Gladiator),\n            3 =\u003e Ok(Warlord),\n            4 =\u003e Ok(Knight),\n            5 =\u003e Ok(Paladin),\n            6 =\u003e Ok(DarkAvenger),\n            7 =\u003e Ok(Rogue),\n            8 =\u003e Ok(TreasureHunter),\n            9 =\u003e Ok(Hawkeye),\n            10 =\u003e Ok(Mage),\n            11 =\u003e Ok(Wizard),\n            12 =\u003e Ok(Sorcerer),\n            13 =\u003e Ok(Necromancer),\n            14 =\u003e Ok(Warlock),\n            15 =\u003e Ok(Cleric),\n            16 =\u003e Ok(Bishop),\n            17 =\u003e Ok(Prophet),\n            18 =\u003e Ok(ElvenFighter),\n            19 =\u003e Ok(ElvenKnight),\n            20 =\u003e Ok(TempleKnight),\n            21 =\u003e Ok(Swordsinger),\n            22 =\u003e Ok(ElvenScout),\n            23 =\u003e Ok(PlainsWalker),\n            24 =\u003e Ok(SilverRanger),\n            25 =\u003e Ok(ElvenMage),\n            26 =\u003e Ok(ElvenWizard),\n            27 =\u003e Ok(Spellsinger),\n            28 =\u003e Ok(ElementalSummoner),\n            29 =\u003e Ok(Oracle),\n            30 =\u003e Ok(Elder),\n            31 =\u003e Ok(DarkFighter),\n            32 =\u003e Ok(PalusKnight),\n            33 =\u003e Ok(ShillienKnight),\n            34 =\u003e Ok(Bladedancer),\n            35 =\u003e Ok(Assassin),\n            36 =\u003e Ok(AbyssWalker),\n            37 =\u003e Ok(PhantomRanger),\n            38 =\u003e Ok(DarkMage),\n            39 =\u003e Ok(DarkWizard),\n            40 =\u003e Ok(Spellhowler),\n            41 =\u003e Ok(PhantomSummoner),\n            42 =\u003e Ok(ShillienOracle),\n            43 =\u003e Ok(ShillienElder),\n            44 =\u003e Ok(OrcFighter),\n            45 =\u003e Ok(OrcRaider),\n            46 =\u003e Ok(Destroyer),\n            47 =\u003e Ok(OrcMonk),\n            48 =\u003e Ok(Tyrant),\n            49 =\u003e Ok(OrcMage),\n            50 =\u003e Ok(OrcShaman),\n            51 =\u003e Ok(Overlord),\n            52 =\u003e Ok(Warcryer),\n            53 =\u003e Ok(DwarvenFighter),\n            54 =\u003e Ok(Scavenger),\n            55 =\u003e Ok(BountyHunter),\n            56 =\u003e Ok(Artisan),\n            57 =\u003e Ok(Warsmith),\n            88 =\u003e Ok(Duelist),\n            89 =\u003e Ok(Dreadnought),\n            90 =\u003e Ok(PhoenixKnight),\n            91 =\u003e Ok(HellKnight),\n            92 =\u003e Ok(Sagittarius),\n            93 =\u003e Ok(Adventurer),\n            94 =\u003e Ok(Archmage),\n            95 =\u003e Ok(Soultaker),\n            96 =\u003e Ok(ArcanaLord),\n            97 =\u003e Ok(Cardinal),\n            98 =\u003e Ok(Hierophant),\n            99 =\u003e Ok(EvaTemplar),\n            100 =\u003e Ok(SwordMuse),\n            101 =\u003e Ok(WindRider),\n            102 =\u003e Ok(MoonlightSentinel),\n            103 =\u003e Ok(MysticMuse),\n            104 =\u003e Ok(ElementalMaster),\n            105 =\u003e Ok(EvaSaint),\n            106 =\u003e Ok(ShillienTemplar),\n            107 =\u003e Ok(SpectralDancer),\n            108 =\u003e Ok(GhostHunter),\n            109 =\u003e Ok(GhostSentinel),\n            110 =\u003e Ok(StormScreamer),\n            111 =\u003e Ok(SpectralMaster),\n            112 =\u003e Ok(ShillienSaint),\n            113 =\u003e Ok(Titan),\n            114 =\u003e Ok(GrandKhavatari),\n            115 =\u003e Ok(Dominator),\n            116 =\u003e Ok(Doomcryer),\n            117 =\u003e Ok(FortuneSeeker),\n            118 =\u003e Ok(Maestro),\n            123 =\u003e Ok(MaleSoldier),\n            124 =\u003e Ok(FemaleSoldier),\n            125 =\u003e Ok(Trooper),\n            126 =\u003e Ok(Warder),\n            127 =\u003e Ok(Berserker),\n            128 =\u003e Ok(MaleSoulbreaker),\n            129 =\u003e Ok(FemaleSoulbreaker),\n            130 =\u003e Ok(Arbalester),\n            131 =\u003e Ok(Doombringer),\n            132 =\u003e Ok(MaleSoulHound),\n            133 =\u003e Ok(FemaleSoulHound),\n            134 =\u003e Ok(Trickster),\n            135 =\u003e Ok(Inspector),\n            136 =\u003e Ok(Judicator),\n            _ =\u003e bail!(\"Invalid class ID\"),\n        }\n    }\n}\n\nimpl Class {\n    #[must_use]\n    #[allow(clippy::too_many_lines)]\n    pub fn get_class(self) -\u003e CharClass {\n        #[allow(clippy::enum_glob_use)]\n        use Class::*;\n        #[allow(clippy::match_same_arms)]\n        match self {\n            Fighter =\u003e CharClass::fighter(self, Race::Human, None),\n            Warrior =\u003e CharClass::fighter(self, Race::Human, Some(Fighter)),\n            Gladiator =\u003e CharClass::fighter(self, Race::Human, Some(Warrior)),\n            Warlord =\u003e CharClass::fighter(self, Race::Human, Some(Warrior)),\n            Knight =\u003e CharClass::fighter(self, Race::Human, Some(Fighter)),\n            Paladin =\u003e CharClass::fighter(self, Race::Human, Some(Knight)),\n            DarkAvenger =\u003e CharClass::fighter(self, Race::Human, Some(Knight)),\n            Rogue =\u003e CharClass::fighter(self, Race::Human, Some(Fighter)),\n            TreasureHunter =\u003e CharClass::fighter(self, Race::Human, Some(Rogue)),\n            Hawkeye =\u003e CharClass::fighter(self, Race::Human, Some(Rogue)),\n            Mage =\u003e CharClass::mage(self, Race::Human, None),\n            Wizard =\u003e CharClass::mage(self, Race::Human, Some(Mage)),\n            Sorcerer =\u003e CharClass::mage(self, Race::Human, Some(Wizard)),\n            Necromancer =\u003e CharClass::mage(self, Race::Human, Some(Wizard)),\n            Warlock =\u003e CharClass::summoner(self, Race::Human, Some(Wizard)),\n            Cleric =\u003e CharClass::mage(self, Race::Human, Some(Mage)),\n            Bishop =\u003e CharClass::mage(self, Race::Human, Some(Cleric)),\n            Prophet =\u003e CharClass::mage(self, Race::Human, Some(Cleric)),\n            ElvenFighter =\u003e CharClass::fighter(self, Race::Elf, None),\n            ElvenKnight =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenFighter)),\n            TempleKnight =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenKnight)),\n            Swordsinger =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenKnight)),\n            ElvenScout =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenFighter)),\n            PlainsWalker =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenScout)),\n            SilverRanger =\u003e CharClass::fighter(self, Race::Elf, Some(ElvenScout)),\n            ElvenMage =\u003e CharClass::mage(self, Race::Elf, None),\n            ElvenWizard =\u003e CharClass::mage(self, Race::Elf, Some(ElvenMage)),\n            Spellsinger =\u003e CharClass::mage(self, Race::Elf, Some(ElvenWizard)),\n            ElementalSummoner =\u003e CharClass::summoner(self, Race::Elf, Some(ElvenWizard)),\n            Oracle =\u003e CharClass::mage(self, Race::Elf, Some(ElvenMage)),\n            Elder =\u003e CharClass::mage(self, Race::Elf, Some(Oracle)),\n            DarkFighter =\u003e CharClass::fighter(self, Race::DarkElf, None),\n            PalusKnight =\u003e CharClass::fighter(self, Race::DarkElf, Some(DarkFighter)),\n            ShillienKnight =\u003e CharClass::fighter(self, Race::DarkElf, Some(PalusKnight)),\n            Bladedancer =\u003e CharClass::fighter(self, Race::DarkElf, Some(PalusKnight)),\n            Assassin =\u003e CharClass::fighter(self, Race::DarkElf, Some(DarkFighter)),\n            AbyssWalker =\u003e CharClass::fighter(self, Race::DarkElf, None),\n            PhantomRanger =\u003e CharClass::fighter(self, Race::DarkElf, Some(Assassin)),\n            DarkMage =\u003e CharClass::mage(self, Race::DarkElf, None),\n            DarkWizard =\u003e CharClass::mage(self, Race::DarkElf, Some(DarkMage)),\n            Spellhowler =\u003e CharClass::mage(self, Race::DarkElf, Some(DarkWizard)),\n            PhantomSummoner =\u003e CharClass::summoner(self, Race::DarkElf, Some(DarkWizard)),\n            ShillienOracle =\u003e CharClass::mage(self, Race::DarkElf, Some(DarkMage)),\n            ShillienElder =\u003e CharClass::mage(self, Race::DarkElf, Some(ShillienOracle)),\n            OrcFighter =\u003e CharClass::fighter(self, Race::Orc, None),\n            OrcRaider =\u003e CharClass::fighter(self, Race::Orc, Some(OrcFighter)),\n            Destroyer =\u003e CharClass::fighter(self, Race::Orc, Some(OrcRaider)),\n            OrcMonk =\u003e CharClass::fighter(self, Race::Orc, Some(OrcFighter)),\n            Tyrant =\u003e CharClass::fighter(self, Race::Orc, Some(OrcMonk)),\n            OrcMage =\u003e CharClass::mage(self, Race::Orc, None),\n            OrcShaman =\u003e CharClass::mage(self, Race::Orc, Some(OrcMage)),\n            Overlord =\u003e CharClass::mage(self, Race::Orc, Some(OrcShaman)),\n            Warcryer =\u003e CharClass::mage(self, Race::Orc, Some(OrcShaman)),\n            DwarvenFighter =\u003e CharClass::fighter(self, Race::Dwarf, None),\n            Scavenger =\u003e CharClass::fighter(self, Race::Dwarf, Some(DwarvenFighter)),\n            BountyHunter =\u003e CharClass::fighter(self, Race::Dwarf, Some(Scavenger)),\n            Artisan =\u003e CharClass::fighter(self, Race::Dwarf, Some(DwarvenFighter)),\n            Warsmith =\u003e CharClass::fighter(self, Race::Dwarf, Some(Artisan)),\n            Duelist =\u003e CharClass::fighter(self, Race::Human, Some(Gladiator)),\n            Dreadnought =\u003e CharClass::fighter(self, Race::Human, Some(Warlord)),\n            PhoenixKnight =\u003e CharClass::fighter(self, Race::Human, Some(Paladin)),\n            HellKnight =\u003e CharClass::fighter(self, Race::Human, Some(DarkAvenger)),\n            Sagittarius =\u003e CharClass::fighter(self, Race::Human, Some(Hawkeye)),\n            Adventurer =\u003e CharClass::fighter(self, Race::Human, Some(TreasureHunter)),\n            Archmage =\u003e CharClass::mage(self, Race::Human, Some(Sorcerer)),\n            Soultaker =\u003e CharClass::mage(self, Race::Human, Some(Necromancer)),\n            ArcanaLord =\u003e CharClass::summoner(self, Race::Human, Some(Warlock)),\n            Cardinal =\u003e CharClass::mage(self, Race::Human, Some(Bishop)),\n            Hierophant =\u003e CharClass::mage(self, Race::Human, Some(Prophet)),\n            EvaTemplar =\u003e CharClass::fighter(self, Race::Elf, Some(TempleKnight)),\n            SwordMuse =\u003e CharClass::fighter(self, Race::Elf, Some(Swordsinger)),\n            WindRider =\u003e CharClass::fighter(self, Race::Elf, Some(PlainsWalker)),\n            MoonlightSentinel =\u003e CharClass::fighter(self, Race::Elf, Some(SilverRanger)),\n            MysticMuse =\u003e CharClass::mage(self, Race::Elf, Some(Spellsinger)),\n            ElementalMaster =\u003e CharClass::summoner(self, Race::Elf, Some(ElementalSummoner)),\n            EvaSaint =\u003e CharClass::mage(self, Race::Elf, Some(Elder)),\n            ShillienTemplar =\u003e CharClass::fighter(self, Race::DarkElf, Some(ShillienKnight)),\n            SpectralDancer =\u003e CharClass::fighter(self, Race::DarkElf, Some(Bladedancer)),\n            GhostHunter =\u003e CharClass::fighter(self, Race::DarkElf, Some(AbyssWalker)),\n            GhostSentinel =\u003e CharClass::fighter(self, Race::DarkElf, Some(PhantomRanger)),\n            StormScreamer =\u003e CharClass::mage(self, Race::DarkElf, Some(Spellhowler)),\n            SpectralMaster =\u003e CharClass::summoner(self, Race::DarkElf, Some(PhantomSummoner)),\n            ShillienSaint =\u003e CharClass::mage(self, Race::DarkElf, Some(ShillienElder)),\n            Titan =\u003e CharClass::fighter(self, Race::Orc, Some(Destroyer)),\n            GrandKhavatari =\u003e CharClass::fighter(self, Race::Orc, Some(Tyrant)),\n            Dominator =\u003e CharClass::mage(self, Race::Orc, Some(Overlord)),\n            Doomcryer =\u003e CharClass::mage(self, Race::Orc, Some(Warcryer)),\n            FortuneSeeker =\u003e CharClass::fighter(self, Race::Dwarf, Some(BountyHunter)),\n            Maestro =\u003e CharClass::fighter(self, Race::Dwarf, Some(Warsmith)),\n            MaleSoldier =\u003e CharClass::fighter(self, Race::Kamael, None),\n            FemaleSoldier =\u003e CharClass::fighter(self, Race::Kamael, None),\n            Trooper =\u003e CharClass::fighter(self, Race::Kamael, Some(MaleSoldier)),\n            Warder =\u003e CharClass::fighter(self, Race::Kamael, Some(FemaleSoldier)),\n            Berserker =\u003e CharClass::fighter(self, Race::Kamael, Some(Trooper)),\n            MaleSoulbreaker =\u003e CharClass::fighter(self, Race::Kamael, Some(Trooper)),\n            FemaleSoulbreaker =\u003e CharClass::fighter(self, Race::Kamael, Some(Warder)),\n            Arbalester =\u003e CharClass::fighter(self, Race::Kamael, Some(Warder)),\n            Doombringer =\u003e CharClass::fighter(self, Race::Kamael, Some(Berserker)),\n            MaleSoulHound =\u003e CharClass::fighter(self, Race::Kamael, Some(MaleSoulbreaker)),\n            FemaleSoulHound =\u003e CharClass::fighter(self, Race::Kamael, Some(FemaleSoulbreaker)),\n            Trickster =\u003e CharClass::fighter(self, Race::Kamael, Some(Arbalester)),\n            Inspector =\u003e CharClass::fighter(self, Race::Kamael, Some(Warder)),\n            Judicator =\u003e CharClass::fighter(self, Race::Kamael, Some(Inspector)),\n        }\n    }\n}\n// Implement Deserialize for ClassId\nimpl\u003c'de\u003e Deserialize\u003c'de\u003e for Class {\n    fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        let value = u8::deserialize(deserializer)?;\n        Class::try_from(value).map_err(|_| {\n            serde::de::Error::custom(format!(\"Invalid class ID: {value}, it is not implemented.\"))\n        })\n    }\n}\n","traces":[{"line":16,"address":[4042016],"length":1,"stats":{"Line":0}},{"line":32,"address":[4042096],"length":1,"stats":{"Line":0}},{"line":42,"address":[4042144],"length":1,"stats":{"Line":0}},{"line":52,"address":[4042192],"length":1,"stats":{"Line":0}},{"line":174,"address":[4042240],"length":1,"stats":{"Line":4}},{"line":177,"address":[4042267],"length":1,"stats":{"Line":4}},{"line":178,"address":[4042371],"length":1,"stats":{"Line":1}},{"line":179,"address":[4042396],"length":1,"stats":{"Line":1}},{"line":180,"address":[4042421],"length":1,"stats":{"Line":2}},{"line":181,"address":[4042446],"length":1,"stats":{"Line":2}},{"line":182,"address":[4042471],"length":1,"stats":{"Line":1}},{"line":183,"address":[4042496],"length":1,"stats":{"Line":1}},{"line":184,"address":[4042521],"length":1,"stats":{"Line":4}},{"line":185,"address":[4042546],"length":1,"stats":{"Line":2}},{"line":186,"address":[4042571],"length":1,"stats":{"Line":1}},{"line":187,"address":[4042596],"length":1,"stats":{"Line":4}},{"line":188,"address":[4042621],"length":1,"stats":{"Line":3}},{"line":189,"address":[4042646],"length":1,"stats":{"Line":2}},{"line":190,"address":[4042671],"length":1,"stats":{"Line":1}},{"line":191,"address":[4042696],"length":1,"stats":{"Line":1}},{"line":192,"address":[4042721],"length":1,"stats":{"Line":1}},{"line":193,"address":[4042746],"length":1,"stats":{"Line":1}},{"line":194,"address":[4042771],"length":1,"stats":{"Line":1}},{"line":195,"address":[4042796],"length":1,"stats":{"Line":2}},{"line":196,"address":[4042821],"length":1,"stats":{"Line":1}},{"line":197,"address":[4042846],"length":1,"stats":{"Line":1}},{"line":198,"address":[4042871],"length":1,"stats":{"Line":4}},{"line":199,"address":[4042896],"length":1,"stats":{"Line":2}},{"line":200,"address":[4042921],"length":1,"stats":{"Line":1}},{"line":201,"address":[4042946],"length":1,"stats":{"Line":2}},{"line":202,"address":[4042971],"length":1,"stats":{"Line":2}},{"line":203,"address":[4042996],"length":1,"stats":{"Line":3}},{"line":204,"address":[4043021],"length":1,"stats":{"Line":1}},{"line":205,"address":[4043046],"length":1,"stats":{"Line":2}},{"line":206,"address":[4043071],"length":1,"stats":{"Line":4}},{"line":207,"address":[4043096],"length":1,"stats":{"Line":1}},{"line":208,"address":[4043121],"length":1,"stats":{"Line":1}},{"line":209,"address":[4043146],"length":1,"stats":{"Line":1}},{"line":210,"address":[4043171],"length":1,"stats":{"Line":1}},{"line":211,"address":[4043196],"length":1,"stats":{"Line":1}},{"line":212,"address":[4043221],"length":1,"stats":{"Line":1}},{"line":213,"address":[4043246],"length":1,"stats":{"Line":2}},{"line":214,"address":[4043271],"length":1,"stats":{"Line":2}},{"line":215,"address":[4043296],"length":1,"stats":{"Line":1}},{"line":216,"address":[4043321],"length":1,"stats":{"Line":2}},{"line":217,"address":[4043346],"length":1,"stats":{"Line":1}},{"line":218,"address":[4043371],"length":1,"stats":{"Line":2}},{"line":219,"address":[4043396],"length":1,"stats":{"Line":2}},{"line":220,"address":[4043421],"length":1,"stats":{"Line":1}},{"line":221,"address":[4043446],"length":1,"stats":{"Line":2}},{"line":222,"address":[4043471],"length":1,"stats":{"Line":2}},{"line":223,"address":[4043496],"length":1,"stats":{"Line":2}},{"line":224,"address":[4043521],"length":1,"stats":{"Line":1}},{"line":225,"address":[4043546],"length":1,"stats":{"Line":1}},{"line":226,"address":[4043571],"length":1,"stats":{"Line":4}},{"line":227,"address":[4043596],"length":1,"stats":{"Line":1}},{"line":228,"address":[4043621],"length":1,"stats":{"Line":1}},{"line":229,"address":[4043646],"length":1,"stats":{"Line":4}},{"line":230,"address":[4043671],"length":1,"stats":{"Line":1}},{"line":231,"address":[4043696],"length":1,"stats":{"Line":1}},{"line":232,"address":[4043721],"length":1,"stats":{"Line":1}},{"line":233,"address":[4043746],"length":1,"stats":{"Line":2}},{"line":234,"address":[4043771],"length":1,"stats":{"Line":1}},{"line":235,"address":[4043796],"length":1,"stats":{"Line":1}},{"line":236,"address":[4043821],"length":1,"stats":{"Line":1}},{"line":237,"address":[4043846],"length":1,"stats":{"Line":1}},{"line":238,"address":[4043871],"length":1,"stats":{"Line":1}},{"line":239,"address":[4043896],"length":1,"stats":{"Line":1}},{"line":240,"address":[4043921],"length":1,"stats":{"Line":1}},{"line":241,"address":[4043946],"length":1,"stats":{"Line":1}},{"line":242,"address":[4043971],"length":1,"stats":{"Line":2}},{"line":243,"address":[4043996],"length":1,"stats":{"Line":4}},{"line":244,"address":[4044021],"length":1,"stats":{"Line":2}},{"line":245,"address":[4044046],"length":1,"stats":{"Line":2}},{"line":246,"address":[4044071],"length":1,"stats":{"Line":2}},{"line":247,"address":[4044096],"length":1,"stats":{"Line":1}},{"line":248,"address":[4044121],"length":1,"stats":{"Line":4}},{"line":249,"address":[4044146],"length":1,"stats":{"Line":1}},{"line":250,"address":[4044171],"length":1,"stats":{"Line":1}},{"line":251,"address":[4044196],"length":1,"stats":{"Line":2}},{"line":252,"address":[4044221],"length":1,"stats":{"Line":1}},{"line":253,"address":[4044246],"length":1,"stats":{"Line":3}},{"line":254,"address":[4044271],"length":1,"stats":{"Line":1}},{"line":255,"address":[4044296],"length":1,"stats":{"Line":1}},{"line":256,"address":[4044321],"length":1,"stats":{"Line":3}},{"line":257,"address":[4044346],"length":1,"stats":{"Line":2}},{"line":258,"address":[4044371],"length":1,"stats":{"Line":1}},{"line":259,"address":[4044396],"length":1,"stats":{"Line":1}},{"line":260,"address":[4044421],"length":1,"stats":{"Line":1}},{"line":261,"address":[4044446],"length":1,"stats":{"Line":4}},{"line":262,"address":[4044471],"length":1,"stats":{"Line":1}},{"line":263,"address":[4044496],"length":1,"stats":{"Line":1}},{"line":264,"address":[4044521],"length":1,"stats":{"Line":1}},{"line":265,"address":[4044546],"length":1,"stats":{"Line":2}},{"line":266,"address":[4044571],"length":1,"stats":{"Line":1}},{"line":267,"address":[4044596],"length":1,"stats":{"Line":4}},{"line":268,"address":[4044621],"length":1,"stats":{"Line":1}},{"line":269,"address":[4044646],"length":1,"stats":{"Line":0}},{"line":270,"address":[4044671],"length":1,"stats":{"Line":0}},{"line":271,"address":[4044696],"length":1,"stats":{"Line":0}},{"line":272,"address":[4044721],"length":1,"stats":{"Line":0}},{"line":273,"address":[4044746],"length":1,"stats":{"Line":0}},{"line":274,"address":[4044777],"length":1,"stats":{"Line":0}},{"line":275,"address":[4044808],"length":1,"stats":{"Line":0}},{"line":276,"address":[4044839],"length":1,"stats":{"Line":0}},{"line":277,"address":[4044867],"length":1,"stats":{"Line":0}},{"line":278,"address":[4044895],"length":1,"stats":{"Line":0}},{"line":279,"address":[4044923],"length":1,"stats":{"Line":0}},{"line":280,"address":[4044951],"length":1,"stats":{"Line":0}},{"line":281,"address":[4042304],"length":1,"stats":{"Line":0}},{"line":289,"address":[4044992],"length":1,"stats":{"Line":0}},{"line":293,"address":[4045006],"length":1,"stats":{"Line":0}},{"line":294,"address":[4045041],"length":1,"stats":{"Line":0}},{"line":295,"address":[4045101],"length":1,"stats":{"Line":0}},{"line":296,"address":[4045169],"length":1,"stats":{"Line":0}},{"line":297,"address":[4045237],"length":1,"stats":{"Line":0}},{"line":298,"address":[4045305],"length":1,"stats":{"Line":0}},{"line":299,"address":[4045373],"length":1,"stats":{"Line":0}},{"line":300,"address":[4045441],"length":1,"stats":{"Line":0}},{"line":301,"address":[4045509],"length":1,"stats":{"Line":0}},{"line":302,"address":[4045577],"length":1,"stats":{"Line":0}},{"line":303,"address":[4045645],"length":1,"stats":{"Line":0}},{"line":304,"address":[4045713],"length":1,"stats":{"Line":0}},{"line":305,"address":[4045773],"length":1,"stats":{"Line":0}},{"line":306,"address":[4045841],"length":1,"stats":{"Line":0}},{"line":307,"address":[4045909],"length":1,"stats":{"Line":0}},{"line":308,"address":[4045995],"length":1,"stats":{"Line":0}},{"line":309,"address":[4046081],"length":1,"stats":{"Line":0}},{"line":310,"address":[4046167],"length":1,"stats":{"Line":0}},{"line":311,"address":[4046253],"length":1,"stats":{"Line":0}},{"line":312,"address":[4046339],"length":1,"stats":{"Line":0}},{"line":313,"address":[4046411],"length":1,"stats":{"Line":0}},{"line":314,"address":[4046497],"length":1,"stats":{"Line":0}},{"line":315,"address":[4046583],"length":1,"stats":{"Line":0}},{"line":316,"address":[4046669],"length":1,"stats":{"Line":0}},{"line":317,"address":[4046755],"length":1,"stats":{"Line":0}},{"line":318,"address":[4046841],"length":1,"stats":{"Line":0}},{"line":319,"address":[4046927],"length":1,"stats":{"Line":0}},{"line":320,"address":[4046999],"length":1,"stats":{"Line":0}},{"line":321,"address":[4047085],"length":1,"stats":{"Line":0}},{"line":322,"address":[4047171],"length":1,"stats":{"Line":0}},{"line":323,"address":[4047257],"length":1,"stats":{"Line":0}},{"line":324,"address":[4047343],"length":1,"stats":{"Line":0}},{"line":325,"address":[4047429],"length":1,"stats":{"Line":0}},{"line":326,"address":[4047501],"length":1,"stats":{"Line":0}},{"line":327,"address":[4047587],"length":1,"stats":{"Line":0}},{"line":328,"address":[4047673],"length":1,"stats":{"Line":0}},{"line":329,"address":[4047759],"length":1,"stats":{"Line":0}},{"line":330,"address":[4047845],"length":1,"stats":{"Line":0}},{"line":331,"address":[4047917],"length":1,"stats":{"Line":0}},{"line":332,"address":[4048003],"length":1,"stats":{"Line":0}},{"line":333,"address":[4048075],"length":1,"stats":{"Line":0}},{"line":334,"address":[4048161],"length":1,"stats":{"Line":0}},{"line":335,"address":[4048247],"length":1,"stats":{"Line":0}},{"line":336,"address":[4048333],"length":1,"stats":{"Line":0}},{"line":337,"address":[4048419],"length":1,"stats":{"Line":0}},{"line":338,"address":[4048505],"length":1,"stats":{"Line":0}},{"line":339,"address":[4048577],"length":1,"stats":{"Line":0}},{"line":340,"address":[4048663],"length":1,"stats":{"Line":0}},{"line":341,"address":[4048749],"length":1,"stats":{"Line":0}},{"line":342,"address":[4048835],"length":1,"stats":{"Line":0}},{"line":343,"address":[4048921],"length":1,"stats":{"Line":0}},{"line":344,"address":[4048993],"length":1,"stats":{"Line":0}},{"line":345,"address":[4049079],"length":1,"stats":{"Line":0}},{"line":346,"address":[4049165],"length":1,"stats":{"Line":0}},{"line":347,"address":[4049251],"length":1,"stats":{"Line":0}},{"line":348,"address":[4049323],"length":1,"stats":{"Line":0}},{"line":349,"address":[4049409],"length":1,"stats":{"Line":0}},{"line":350,"address":[4049495],"length":1,"stats":{"Line":0}},{"line":351,"address":[4049581],"length":1,"stats":{"Line":0}},{"line":352,"address":[4049667],"length":1,"stats":{"Line":0}},{"line":353,"address":[4049753],"length":1,"stats":{"Line":0}},{"line":354,"address":[4049839],"length":1,"stats":{"Line":0}},{"line":355,"address":[4049925],"length":1,"stats":{"Line":0}},{"line":356,"address":[4050011],"length":1,"stats":{"Line":0}},{"line":357,"address":[4050097],"length":1,"stats":{"Line":0}},{"line":358,"address":[4050183],"length":1,"stats":{"Line":0}},{"line":359,"address":[4050269],"length":1,"stats":{"Line":0}},{"line":360,"address":[4050355],"length":1,"stats":{"Line":0}},{"line":361,"address":[4050441],"length":1,"stats":{"Line":0}},{"line":362,"address":[4050527],"length":1,"stats":{"Line":0}},{"line":363,"address":[4050613],"length":1,"stats":{"Line":0}},{"line":364,"address":[4050699],"length":1,"stats":{"Line":0}},{"line":365,"address":[4050785],"length":1,"stats":{"Line":0}},{"line":366,"address":[4050871],"length":1,"stats":{"Line":0}},{"line":367,"address":[4050957],"length":1,"stats":{"Line":0}},{"line":368,"address":[4051043],"length":1,"stats":{"Line":0}},{"line":369,"address":[4051129],"length":1,"stats":{"Line":0}},{"line":370,"address":[4051215],"length":1,"stats":{"Line":0}},{"line":371,"address":[4051301],"length":1,"stats":{"Line":0}},{"line":372,"address":[4051387],"length":1,"stats":{"Line":0}},{"line":373,"address":[4051473],"length":1,"stats":{"Line":0}},{"line":374,"address":[4051559],"length":1,"stats":{"Line":0}},{"line":375,"address":[4051645],"length":1,"stats":{"Line":0}},{"line":376,"address":[4051731],"length":1,"stats":{"Line":0}},{"line":377,"address":[4051817],"length":1,"stats":{"Line":0}},{"line":378,"address":[4051903],"length":1,"stats":{"Line":0}},{"line":379,"address":[4051989],"length":1,"stats":{"Line":0}},{"line":380,"address":[4052075],"length":1,"stats":{"Line":0}},{"line":381,"address":[4052161],"length":1,"stats":{"Line":0}},{"line":382,"address":[4052247],"length":1,"stats":{"Line":0}},{"line":383,"address":[4052333],"length":1,"stats":{"Line":0}},{"line":384,"address":[4052405],"length":1,"stats":{"Line":0}},{"line":385,"address":[4052477],"length":1,"stats":{"Line":0}},{"line":386,"address":[4052563],"length":1,"stats":{"Line":0}},{"line":387,"address":[4052649],"length":1,"stats":{"Line":0}},{"line":388,"address":[4052735],"length":1,"stats":{"Line":0}},{"line":389,"address":[4052821],"length":1,"stats":{"Line":0}},{"line":390,"address":[4052907],"length":1,"stats":{"Line":0}},{"line":391,"address":[4052993],"length":1,"stats":{"Line":0}},{"line":392,"address":[4053079],"length":1,"stats":{"Line":0}},{"line":393,"address":[4053165],"length":1,"stats":{"Line":0}},{"line":394,"address":[4053251],"length":1,"stats":{"Line":0}},{"line":395,"address":[4053337],"length":1,"stats":{"Line":0}},{"line":396,"address":[4053420],"length":1,"stats":{"Line":0}},{"line":402,"address":[4027552,4027728],"length":1,"stats":{"Line":3}},{"line":406,"address":[],"length":0,"stats":{"Line":1}},{"line":407,"address":[],"length":0,"stats":{"Line":4}},{"line":408,"address":[],"length":0,"stats":{"Line":0}}],"covered":96,"coverable":219},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","classes","mod.rs"],"content":"pub mod mapping;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","exp_table.rs"],"content":"use macro_common::config_file;\nuse serde::{de, Deserialize, Deserializer};\nuse std::collections::HashMap;\nuse tracing::info;\n\n#[derive(Debug, Clone)]\n#[config_file(path=\"config/data/stats/exp_table.yaml\")]\npub struct ExpTable {\n    pub max_level: u8,\n    exp_data: HashMap\u003cu8, i64\u003e,\n    training_data: HashMap\u003cu8, f64\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\nstruct LevelData {\n    level: u8,\n    exp: i64,\n    training_rate: f64,\n}\n\nimpl\u003c'de\u003e Deserialize\u003c'de\u003e for ExpTable {\n    fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        #[derive(Deserialize)]\n        struct RawExpTable {\n            max_level: u8,\n            data: Vec\u003cLevelData\u003e,\n        }\n\n        let raw: RawExpTable = RawExpTable::deserialize(deserializer)?;\n\n        let mut exp_data = HashMap::new();\n        let mut training_data = HashMap::new();\n\n        for entry in raw.data {\n            exp_data.insert(entry.level, entry.exp);\n            training_data.insert(entry.level, entry.training_rate);\n        }\n\n        // Validation: Ensure max_level is valid\n        if raw.max_level != *exp_data.keys().max().unwrap_or(\u00260) {\n            return Err(de::Error::custom(format!(\n                \"max_level ({}) does not match the highest level ({}) in the data\",\n                raw.max_level,\n                exp_data.keys().max().unwrap_or(\u00260)\n            )));\n        }\n\n        let exp_table = ExpTable {\n            max_level: raw.max_level,\n            exp_data,\n            training_data,\n        };\n\n        // Log a message\n        info!(\n            \"ExpTable loaded with max_level: {} and {} levels of data\",\n            exp_table.max_level,\n            exp_table.exp_data.len()\n        );\n\n        Ok(exp_table)\n    }\n}\n\nimpl ExpTable {\n    #[must_use]\n    pub fn get_exp(\u0026self, level: u8) -\u003e i64 {\n        if level \u003e self.max_level {\n            return *self.exp_data.get(\u0026self.max_level).unwrap_or(\u00260);\n        }\n        *self.exp_data.get(\u0026level).unwrap_or(\u00260)\n    }\n    #[must_use]\n    pub fn get_exp_for_next_lvl(\u0026self, level: u8) -\u003e i64 {\n        if level == u8::MAX {\n            return self.get_exp(level);\n        }\n        self.get_exp(level + 1)\n    }\n    #[must_use]\n    pub fn get_training_exp(\u0026self, level: u8) -\u003e f64 {\n        if level \u003e self.max_level {\n            return *self\n                .training_data\n                .get(\u0026self.max_level)\n                .unwrap_or(\u0026f64::from(0));\n        }\n        *self.training_data.get(\u0026level).unwrap_or(\u0026f64::from(0))\n    }\n}\n","traces":[{"line":22,"address":[3777323,3776806,3772544],"length":1,"stats":{"Line":2}},{"line":32,"address":[],"length":0,"stats":{"Line":2}},{"line":34,"address":[],"length":0,"stats":{"Line":2}},{"line":35,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[3773152,3772890,3773126,3772999],"length":1,"stats":{"Line":6}},{"line":38,"address":[],"length":0,"stats":{"Line":3}},{"line":39,"address":[3777251],"length":1,"stats":{"Line":1}},{"line":43,"address":[],"length":0,"stats":{"Line":3}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[3776831],"length":1,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":11}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[4647248],"length":1,"stats":{"Line":0}},{"line":71,"address":[4647269],"length":1,"stats":{"Line":0}},{"line":72,"address":[4647323],"length":1,"stats":{"Line":0}},{"line":74,"address":[4647283],"length":1,"stats":{"Line":0}},{"line":77,"address":[4647376],"length":1,"stats":{"Line":0}},{"line":78,"address":[4647401],"length":1,"stats":{"Line":0}},{"line":79,"address":[4647433],"length":1,"stats":{"Line":0}},{"line":81,"address":[4647457,4647409],"length":1,"stats":{"Line":0}},{"line":84,"address":[4647504],"length":1,"stats":{"Line":0}},{"line":85,"address":[4647524],"length":1,"stats":{"Line":0}},{"line":86,"address":[4647597,4647608,4647633],"length":1,"stats":{"Line":0}},{"line":88,"address":[4647604],"length":1,"stats":{"Line":0}},{"line":89,"address":[4647624],"length":1,"stats":{"Line":0}},{"line":91,"address":[4647537],"length":1,"stats":{"Line":0}}],"covered":11,"coverable":32},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","data","mod.rs"],"content":"pub mod exp_table;\npub mod char_template;\npub mod classes;\npub mod base_stat;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","ls_thread","handler.rs"],"content":"use crate::controller::Controller;\nuse crate::lsp_factory::build_ls_packet;\nuse anyhow::{bail, Error};\nuse async_trait::async_trait;\nuse entities::DBPool;\nuse l2_core::config::gs::GSServer;\nuse l2_core::crypt::login::Encryption;\nuse l2_core::dto::OutboundConnection;\nuse l2_core::traits::handlers::{OutboundHandler, PacketHandler};\nuse l2_core::traits::Shutdown;\nuse std::fmt;\nuse std::net::Ipv4Addr;\nuse std::sync::Arc;\nuse tokio::io::{AsyncRead, AsyncWrite};\nuse tokio::sync::{Mutex, Notify};\nuse tracing::{info, instrument};\nuse macro_common::LoginPacketSenderImpl;\n\n#[derive(Clone, LoginPacketSenderImpl)]\n#[allow(clippy::module_name_repetitions, unused)]\npub struct LoginHandler {\n    tcp_reader: Arc\u003cMutex\u003cdyn AsyncRead + Unpin + Send\u003e\u003e,\n    tcp_writer: Arc\u003cMutex\u003cdyn AsyncWrite + Unpin + Send\u003e\u003e,\n    db_pool: DBPool,\n    ip: Ipv4Addr,\n    controller: Arc\u003cController\u003e,\n    shutdown_notifier: Arc\u003cNotify\u003e,\n    timeout: u8,\n    blowfish: Encryption,\n}\nimpl fmt::Debug for LoginHandler {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        f.debug_struct(\"Client\")\n            .field(\"ip\", \u0026self.ip)\n            .finish_non_exhaustive()\n    }\n}\nimpl LoginHandler {\n    pub const HANDLER_ID: u8 = 1;\n    pub fn set_blowfish(\u0026mut self, blowfish: Encryption) {\n        self.blowfish = blowfish;\n    }\n}\nimpl Shutdown for LoginHandler {\n    fn get_shutdown_listener(\u0026self) -\u003e Arc\u003cNotify\u003e {\n        self.shutdown_notifier.clone()\n    }\n}\n\n\n#[async_trait::async_trait]\nimpl PacketHandler for LoginHandler {\n    type ConfigType = GSServer;\n    type ControllerType = Controller;\n\n    fn get_handler_name() -\u003e \u0026'static str {\n        \"Login handler\"\n    }\n\n    fn get_controller(\u0026self) -\u003e \u0026Arc\u003cSelf::ControllerType\u003e {\n        \u0026self.controller\n    }\n\n    fn new\u003cR, W\u003e(\n        r: R,\n        w: W,\n        ip: Ipv4Addr,\n        db_pool: DBPool,\n        controller: Arc\u003cSelf::ControllerType\u003e,\n    ) -\u003e Self\n    where\n        R: AsyncRead + Unpin + Send + 'static,\n        W: AsyncWrite + Unpin + Send + 'static,\n    {\n        let cfg = controller.get_cfg();\n        Self {\n            tcp_reader: Arc::new(Mutex::new(r)),\n            tcp_writer: Arc::new(Mutex::new(w)),\n            shutdown_notifier: Arc::new(Notify::new()),\n            controller,\n            ip,\n            db_pool,\n            blowfish: Encryption::from_u8_key(cfg.blowfish_key.as_bytes()),\n            timeout: cfg.client.timeout,\n        }\n    }\n\n    #[instrument(skip(self))]\n    async fn on_connect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        info!(\"Connected to Login server. Trying to Authenticate.\");\n        Ok(())\n    }\n\n    async fn on_disconnect(\u0026mut self) {\n        self.controller\n            .message_broker\n            .unregister_packet_handler(Self::HANDLER_ID);\n        info!(\"Login server disconnected\");\n    }\n\n    fn get_stream_reader_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncRead + Unpin + Send\u003e\u003e {\n        \u0026self.tcp_reader\n    }\n\n    fn get_timeout(\u0026self) -\u003e Option\u003cu64\u003e {\n        None\n    }\n\n    fn get_db_pool(\u0026self) -\u003e \u0026DBPool {\n        \u0026self.db_pool\n    }\n\n    #[instrument(skip(self, bytes))]\n    async fn on_receive_bytes(\u0026mut self, _: usize, bytes: \u0026mut [u8]) -\u003e Result\u003c(), Error\u003e {\n        self.blowfish.decrypt(bytes)?;\n        if !Encryption::verify_checksum(bytes) {\n            bail!(\"Can not verify check sum.\");\n        }\n        let handler = build_ls_packet(bytes)?;\n        handler.handle(self).await\n    }\n}\n\nimpl OutboundHandler for LoginHandler {\n    type ConfigType = GSServer;\n\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026OutboundConnection {\n        \u0026cfg.listeners.login_server.connection\n    }\n}\n","traces":[{"line":32,"address":[4615616],"length":1,"stats":{"Line":0}},{"line":33,"address":[4615668,4615634],"length":1,"stats":{"Line":0}},{"line":34,"address":[4615661],"length":1,"stats":{"Line":0}},{"line":40,"address":[4615728],"length":1,"stats":{"Line":0}},{"line":41,"address":[4615733],"length":1,"stats":{"Line":0}},{"line":45,"address":[4615760],"length":1,"stats":{"Line":0}},{"line":46,"address":[4615765],"length":1,"stats":{"Line":0}},{"line":60,"address":[4616768],"length":1,"stats":{"Line":0}},{"line":61,"address":[4616776],"length":1,"stats":{"Line":0}},{"line":64,"address":[4986466,4986341,4985392],"length":1,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[4990914,4992314,4992119,4992096,4992187,4994896],"length":1,"stats":{"Line":0}},{"line":90,"address":[4993429,4992948,4994155,4993898,4993800,4994591,4994987,4993277,4995144,4993624,4992532,4993147,4994219],"length":1,"stats":{"Line":0}},{"line":91,"address":[4993584],"length":1,"stats":{"Line":0}},{"line":94,"address":[4616793],"length":1,"stats":{"Line":0}},{"line":95,"address":[4986581,4986677],"length":1,"stats":{"Line":0}},{"line":98,"address":[4986871,4988241,4995720,4987616,4987768,4988940,4987287,4987486,4987967,4988568,4988143,4988504,4995563],"length":1,"stats":{"Line":0}},{"line":101,"address":[4616912],"length":1,"stats":{"Line":0}},{"line":102,"address":[4616920],"length":1,"stats":{"Line":0}},{"line":105,"address":[4616928],"length":1,"stats":{"Line":0}},{"line":106,"address":[4616933],"length":1,"stats":{"Line":0}},{"line":109,"address":[4616960],"length":1,"stats":{"Line":0}},{"line":114,"address":[5000500,4999625,4999700,5000545,4999600,4998006,4999842],"length":1,"stats":{"Line":0}},{"line":115,"address":[5000532,4999924,5000037],"length":1,"stats":{"Line":0}},{"line":116,"address":[5000009,5000107],"length":1,"stats":{"Line":0}},{"line":117,"address":[5000175,5000113],"length":1,"stats":{"Line":0}},{"line":119,"address":[5000346,5000514,5000229,5000139],"length":1,"stats":{"Line":0}},{"line":120,"address":[4303718],"length":1,"stats":{"Line":0}},{"line":127,"address":[4615776],"length":1,"stats":{"Line":0}},{"line":128,"address":[4615784],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","ls_thread","mod.rs"],"content":"mod handler;\npub use handler::*;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","lsp_factory.rs"],"content":"use anyhow::bail;\nuse crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\nuse l2_core::shared_packets::common::{GSLoginFail, ReadablePacket};\nuse l2_core::shared_packets::ls_2_gs::{AuthGS, InitLS, KickPlayer, PlayerAuthResponse, RequestChars};\n\npub fn build_ls_packet(\n    data: \u0026[u8],\n) -\u003e anyhow::Result\u003cBox\u003cdyn HandleablePacket\u003cHandlerType = LoginHandler\u003e\u003e\u003e {\n    if data.is_empty() {\n        bail!(\"Empty packet\");\n    }\n    match data[0] {\n        InitLS::PACKET_ID  =\u003e Ok(Box::new(InitLS::read(data)?)),\n        GSLoginFail::PACKET_ID =\u003e Ok(Box::new(GSLoginFail::read(data)?)),\n        AuthGS::PACKET_ID =\u003e Ok(Box::new(AuthGS::read(data)?)),\n        PlayerAuthResponse::PACKET_ID =\u003e Ok(Box::new(PlayerAuthResponse::read(data)?)),\n        KickPlayer::PACKET_ID =\u003e Ok(Box::new(KickPlayer::read(data)?)),\n        RequestChars::PACKET_ID =\u003e Ok(Box::new(RequestChars::read(data)?)),\n        _ =\u003e {\n            bail!(\"Unknown GS packet ID:0x{:02X}\", data[0]);\n        }\n    }\n}\n","traces":[{"line":7,"address":[5546368],"length":1,"stats":{"Line":0}},{"line":10,"address":[5546427],"length":1,"stats":{"Line":0}},{"line":11,"address":[5546451],"length":1,"stats":{"Line":0}},{"line":13,"address":[5546516,5546442],"length":1,"stats":{"Line":0}},{"line":14,"address":[5546607,5547121,5547306],"length":1,"stats":{"Line":0}},{"line":15,"address":[5547368,5547537,5546696],"length":1,"stats":{"Line":0}},{"line":16,"address":[5546775,5547779,5547594],"length":1,"stats":{"Line":0}},{"line":17,"address":[5548021,5546864,5547836],"length":1,"stats":{"Line":0}},{"line":18,"address":[5548263,5548078,5546953],"length":1,"stats":{"Line":0}},{"line":19,"address":[5548505,5547042,5548320],"length":1,"stats":{"Line":0}},{"line":21,"address":[5546581,5548653,5548917,5549065],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","main.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::controller::Controller;\nuse l2_core::config::gs::GSServer;\nuse l2_core::traits::server::Server;\nuse std::sync::Arc;\nuse tracing::error;\nuse crate::ls_thread::LoginHandler;\n\nmod client_thread;\nmod controller;\nmod cp_factory;\nmod lsp_factory;\nmod packets;\nmod ls_thread;\npub mod data;\n\npub struct GameServer;\n\nimpl Server for GameServer {\n    type ConfigType = GSServer;\n    type ControllerType = Controller;\n}\n\n///\n/// # Panics\n/// - when can't open a socket\n/// - when config file not found\n/// - when DB is not accessible\n/// - when can't run migrations\n///\npub fn main() {\n    tracing_subscriber::fmt()\n        .compact()\n        .with_file(true)\n        .with_line_number(true)\n        .with_thread_ids(true)\n        .with_target(false)\n        .init();\n    GameServer::bootstrap(\"config/game.yaml\", |cfg, db_pool| async move {\n        let controller = Arc::new(Controller::new(cfg.clone()));\n        let mut ls_handle = GameServer::connector_loop::\u003cLoginHandler\u003e(\n            cfg.clone(),\n            controller.clone(),\n            db_pool.clone(),\n        );\n        let mut client_handle =\n            GameServer::listener_loop::\u003cClientHandler\u003e(cfg, controller, db_pool);\n        tokio::select!(\n            _ = \u0026mut ls_handle =\u003e {\n                error!(\"Login server thread exited unexpectedly\");\n            },\n            _ = \u0026mut client_handle =\u003e {\n                error!(\"Client thread exited unexpectedly\");\n            },\n        );\n        if !ls_handle.is_finished() {\n            ls_handle.abort();\n        }\n        if !client_handle.is_finished() {\n            client_handle.abort();\n        }\n    });\n}\n","traces":[{"line":31,"address":[4615088],"length":1,"stats":{"Line":0}},{"line":32,"address":[4615095],"length":1,"stats":{"Line":0}},{"line":39,"address":[4146224,4146484,4147585,4146288,4146237,4146319,4147635,4153363],"length":1,"stats":{"Line":0}},{"line":40,"address":[4146381,4146600],"length":1,"stats":{"Line":0}},{"line":41,"address":[4146925],"length":1,"stats":{"Line":0}},{"line":42,"address":[4146751,4146681],"length":1,"stats":{"Line":0}},{"line":43,"address":[4146767,4146848],"length":1,"stats":{"Line":0}},{"line":44,"address":[4146864],"length":1,"stats":{"Line":0}},{"line":47,"address":[4147035,4147217],"length":1,"stats":{"Line":0}},{"line":48,"address":[4153278,4153456,4148173,4146514,4147325,4147295,4147675,4149309,4147220],"length":1,"stats":{"Line":0}},{"line":49,"address":[4147298],"length":1,"stats":{"Line":0}},{"line":50,"address":[4148249,4149600,4148864,4149911,4149987,4150383,4148994,4149146,4149502,4154491,4149326,4148665,4154648],"length":1,"stats":{"Line":0}},{"line":52,"address":[4147313],"length":1,"stats":{"Line":0}},{"line":53,"address":[4150703,4151119,4151600,4151944,4151448,4152042,4152305,4152369,4152741,4155224,4155067,4151318,4151765],"length":1,"stats":{"Line":0}},{"line":56,"address":[4153048],"length":1,"stats":{"Line":0}},{"line":57,"address":[4153081,4153123],"length":1,"stats":{"Line":0}},{"line":59,"address":[4153154,4153100,4153129],"length":1,"stats":{"Line":0}},{"line":60,"address":[4153135],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","enums.rs"],"content":"#[repr(i32)]\n#[allow(unused)]\n#[derive(Debug, Clone, Eq, PartialEq)]\npub enum CharNameResponseVariant {\n    Ok = -1,\n    CharCreationFailed = 0,\n    TooManyChars = 1,\n    AlreadyExists = 2,\n    InvalidLength = 3,\n    InvalidName = 4,\n    NotAllowed = 5,\n    ChooseAnotherSvr = 6,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","auth.rs"],"content":"use crate::client_thread::{ClientHandler, ClientStatus};\nuse crate::ls_thread::LoginHandler;\nuse crate::packets::to_client::{CharSelectionInfo, PlayerLoginResponse};\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::dao::item::LocType;\nuse entities::entities::{character, user};\nuse l2_core::session::SessionKey;\nuse l2_core::shared_packets::common::{PacketType, ReadablePacket};\nuse l2_core::shared_packets::gs_2_ls::{PlayerAuthRequest, PlayerInGame};\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct AuthLogin {\n    pub login_name: String,\n    pub play_key_1: i32,\n    pub play_key_2: i32,\n    pub login_key_1: i32,\n    pub login_key_2: i32,\n    pub buffer: SendablePacketBuffer,\n}\n\nimpl ReadablePacket for AuthLogin {\n    const PACKET_ID: u8 = 0x2B;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        let login_name = buffer.read_c_utf16le_string()?.to_lowercase();\n        let play_key_2 = buffer.read_i32()?; // wtf? client decided to send first play_key_2 and not play_key_1\n        let play_key_1 = buffer.read_i32()?;\n        let login_key_1 = buffer.read_i32()?;\n        let login_key_2 = buffer.read_i32()?;\n        Ok(Self {\n            login_name,\n            play_key_1,\n            play_key_2,\n            login_key_1,\n            login_key_2,\n            buffer: SendablePacketBuffer::empty(),\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for AuthLogin {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = handler.get_controller().clone();\n        let _cfg = controller.get_cfg();\n        if handler.get_protocol().is_none() || self.login_name.is_empty() {\n            bail!(\"Protocol version not set\");\n        }\n        if handler.get_user().is_none() {\n            if controller\n                .add_online_account(self.login_name.clone())\n                .is_none()\n            {\n                let _session_key = SessionKey {\n                    play_ok1: self.play_key_1,\n                    play_ok2: self.play_key_2,\n                    login_ok1: self.login_key_1,\n                    login_ok2: self.login_key_2,\n                };\n                let resp = controller\n                    .message_broker\n                    .send_message(\n                        LoginHandler::HANDLER_ID,\n                        \u0026self.login_name,\n                        Box::new(PlayerAuthRequest::new(\n                            \u0026self.login_name,\n                            _session_key.clone(),\n                        )?),\n                    )\n                    .await?;\n                match resp {\n                    Some((_, PacketType::PlayerAuthResp(p))) if p.is_ok =\u003e {\n                        controller\n                            .message_broker\n                            .notify(\n                                LoginHandler::HANDLER_ID,\n                                Box::new(PlayerInGame::new(\u0026[self.login_name.clone()])?),\n                            )\n                            .await?;\n                        handler.set_status(ClientStatus::Authenticated);\n                        handler.set_session_key(_session_key);\n                        handler\n                            .send_packet(Box::new(PlayerLoginResponse::ok()?))\n                            .await?;\n                        let db_pool = handler.get_db_pool().clone();\n                        let chars = character::Model::get_with_items_and_vars(\n                            \u0026db_pool,\n                            \u0026self.login_name,\n                            LocType::Paperdoll,\n                        )\n                        .await?;\n                        let p = CharSelectionInfo::new(\n                            \u0026self.login_name,\n                            self.play_key_1,\n                            \u0026controller,\n                            \u0026chars,\n                        )?;\n                        handler.set_account_chars(chars);\n                        let user =\n                            user::Model::find_by_username(\u0026db_pool, \u0026self.login_name).await?;\n                        handler.set_user(user);\n                        handler.send_packet(Box::new(p)).await?;\n                    }\n                    _ =\u003e {\n                        handler\n                            .send_packet(Box::new(PlayerLoginResponse::fail(\n                                PlayerLoginResponse::SYSTEM_ERROR_LOGIN_LATER,\n                            )?))\n                            .await?;\n                        controller.logout_account(\u0026self.login_name);\n                        bail!(\"Login failed {}\", self.login_name);\n                    }\n                }\n            } else {\n                controller.logout_account(\u0026self.login_name);\n                bail!(\"Account already in game {}\", self.login_name);\n            }\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":30,"address":[4688880,4690033,4690073],"length":1,"stats":{"Line":1}},{"line":31,"address":[4688913],"length":1,"stats":{"Line":1}},{"line":32,"address":[4688932],"length":1,"stats":{"Line":1}},{"line":33,"address":[4690061,4689369,4689258],"length":1,"stats":{"Line":1}},{"line":34,"address":[4689340,4689402,4689489,4690059],"length":1,"stats":{"Line":2}},{"line":35,"address":[4689522,4689460,4690057,4689609],"length":1,"stats":{"Line":2}},{"line":36,"address":[4689642,4689580,4689757,4690042],"length":1,"stats":{"Line":2}},{"line":37,"address":[4689854],"length":1,"stats":{"Line":1}},{"line":38,"address":[4689699],"length":1,"stats":{"Line":1}},{"line":43,"address":[4689733],"length":1,"stats":{"Line":1}},{"line":51,"address":[4690727],"length":1,"stats":{"Line":3}},{"line":52,"address":[5205847],"length":1,"stats":{"Line":1}},{"line":53,"address":[5206026,5205941],"length":1,"stats":{"Line":2}},{"line":54,"address":[5206179,5206293,5206082],"length":1,"stats":{"Line":3}},{"line":55,"address":[5207963,5206257],"length":1,"stats":{"Line":2}},{"line":57,"address":[5206299,5215054],"length":1,"stats":{"Line":2}},{"line":58,"address":[5206505,5206417,5206581],"length":1,"stats":{"Line":3}},{"line":59,"address":[5206447],"length":1,"stats":{"Line":1}},{"line":63,"address":[5207009],"length":1,"stats":{"Line":1}},{"line":64,"address":[5207027],"length":1,"stats":{"Line":1}},{"line":65,"address":[5207030],"length":1,"stats":{"Line":1}},{"line":66,"address":[5207033],"length":1,"stats":{"Line":1}},{"line":68,"address":[5207842,5210202,5207786,5207172,5208337,5208152,5208507,5207060],"length":1,"stats":{"Line":6}},{"line":72,"address":[5207194],"length":1,"stats":{"Line":1}},{"line":73,"address":[5207918,5207380,5207725],"length":1,"stats":{"Line":1}},{"line":74,"address":[5207264],"length":1,"stats":{"Line":1}},{"line":75,"address":[5207334],"length":1,"stats":{"Line":1}},{"line":78,"address":[5207835,5205528,5208039,5207875,5208491,5208248],"length":1,"stats":{"Line":4}},{"line":79,"address":[5208536,5208450],"length":1,"stats":{"Line":2}},{"line":80,"address":[5208621],"length":1,"stats":{"Line":1}},{"line":81,"address":[5211209,5208726,5210344,5209454,5209404,5208840,5210555,5210449],"length":1,"stats":{"Line":6}},{"line":85,"address":[5209530,5209056,5209336,5208862],"length":1,"stats":{"Line":2}},{"line":87,"address":[4285031,4285210,4284727],"length":1,"stats":{"Line":4}},{"line":88,"address":[5210584],"length":1,"stats":{"Line":1}},{"line":89,"address":[5210622],"length":1,"stats":{"Line":1}},{"line":90,"address":[5210667,5211456,5211351,5211109,5211566,5211903,5211024],"length":1,"stats":{"Line":5}},{"line":91,"address":[5211171,5210698,5210956],"length":1,"stats":{"Line":1}},{"line":92,"address":[5211222,5211375,5211550,5205570,5211070,5211131],"length":1,"stats":{"Line":3}},{"line":93,"address":[5211520,5211603],"length":1,"stats":{"Line":2}},{"line":95,"address":[5211625],"length":1,"stats":{"Line":1}},{"line":96,"address":[5211651],"length":1,"stats":{"Line":1}},{"line":97,"address":[5211771],"length":1,"stats":{"Line":1}},{"line":99,"address":[4284769],"length":1,"stats":{"Line":4}},{"line":101,"address":[5212289],"length":1,"stats":{"Line":1}},{"line":102,"address":[5212522],"length":1,"stats":{"Line":1}},{"line":103,"address":[5212547],"length":1,"stats":{"Line":1}},{"line":104,"address":[5212564],"length":1,"stats":{"Line":1}},{"line":106,"address":[5212834],"length":1,"stats":{"Line":1}},{"line":107,"address":[4284790],"length":1,"stats":{"Line":3}},{"line":109,"address":[5213878],"length":1,"stats":{"Line":1}},{"line":110,"address":[4284811],"length":1,"stats":{"Line":2}},{"line":113,"address":[5210073,5215382,5215582,5208575,5209988,5215481,5215931],"length":1,"stats":{"Line":0}},{"line":114,"address":[5209943,5210138,5209669,5208611],"length":1,"stats":{"Line":0}},{"line":117,"address":[4286066,4284832,4285769],"length":1,"stats":{"Line":0}},{"line":118,"address":[5215539,5215608],"length":1,"stats":{"Line":0}},{"line":119,"address":[5215763,5215884,5215662],"length":1,"stats":{"Line":0}},{"line":123,"address":[5206620],"length":1,"stats":{"Line":0}},{"line":124,"address":[5206941,5206820,5206719],"length":1,"stats":{"Line":0}},{"line":127,"address":[5206380],"length":1,"stats":{"Line":1}}],"covered":52,"coverable":59},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","char_create.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::data::char_template::CharTemplate;\nuse crate::data::classes::mapping::Class;\nuse crate::packets::enums::CharNameResponseVariant;\nuse crate::packets::to_client::{CreateCharFailed, CreateCharOk};\nuse crate::packets::utils::validate_can_create_char;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::dao::char_info::CharacterInfo;\nuse entities::entities::character;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse sea_orm::DbErr;\nuse tracing::error;\n\n#[allow(unused)]\n#[derive(Debug, Clone)]\npub struct CreateCharRequest {\n    name: String,\n    is_female: bool,\n    class_id: Class,\n    hair_style: u8,\n    hair_color: u8,\n    int: u8,\n    str: u8,\n    con: u8,\n    men: u8,\n    dex: u8,\n    wit: u8,\n    face: u8,\n    race: u8,\n}\nimpl CreateCharRequest {\n    pub fn validate(\u0026self, _: \u0026CharTemplate) -\u003e anyhow::Result\u003c()\u003e {\n        if !(0..=2).contains(\u0026self.face) {\n            bail!(\"Invalid face value: {}.\", self.face);\n        }\n        if (!self.is_female \u0026\u0026 (self.hair_style \u003e 4)) || (self.is_female \u0026\u0026 (self.hair_style \u003e 6)) {\n            bail!(\n                \"Invalid hair style value: {}. For is_female({})\",\n                self.hair_style,\n                self.is_female\n            );\n        }\n        if self.hair_color \u003e 3 {\n            bail!(\"Invalid hair color value: {}.\", self.hair_color);\n        }\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for CreateCharRequest {\n    const PACKET_ID: u8 = 0x0C;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    #[allow(clippy::cast_possible_truncation, clippy::cast_sign_loss)]\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n\n        let inst = Self {\n            name: buffer.read_c_utf16le_string()?,\n            race: buffer.read_i32()? as u8, //ignored\n            is_female: buffer.read_u32()? != 0,\n            class_id: Class::try_from(u8::try_from(buffer.read_i32()?)?)?,\n            int: buffer.read_u32()? as u8, //ignored\n            str: buffer.read_u32()? as u8, //ignored\n            con: buffer.read_u32()? as u8, //ignored\n            men: buffer.read_u32()? as u8, //ignored\n            dex: buffer.read_u32()? as u8, //ignored\n            wit: buffer.read_u32()? as u8, //ignored\n            hair_style: u8::try_from(buffer.read_u32()?)?,\n            hair_color: u8::try_from(buffer.read_u32()?)?,\n            face: u8::try_from(buffer.read_u32()?)?,\n        };\n        Ok(inst)\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for CreateCharRequest {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = handler.get_controller().clone();\n        let template = controller.class_templates.try_get_template(self.class_id)?;\n        self.validate(template)?;\n        let db_pool = handler.get_db_pool();\n        let response = validate_can_create_char(db_pool, \u0026self.name).await?;\n        if response == CharNameResponseVariant::Ok {\n            let mut char = character::Model {\n                name: self.name.clone(),\n                level: 1,\n                face: self.face,\n                hair_style: self.hair_style,\n                hair_color: self.hair_color,\n                is_female: self.is_female,\n                delete_at: None,\n                user_id: handler.try_get_user()?.id,\n                ..Default::default()\n            };\n            template.initialize_character(\u0026mut char, \u0026controller.base_stats_table)?;\n            match character::Model::create_char(db_pool, char).await {\n                Ok(inst) =\u003e {\n                    handler.add_character(CharacterInfo::new(inst, vec![])?)?;\n                    handler.send_packet(Box::new(CreateCharOk::new()?)).await\n                }\n                Err(DbErr::RecordNotInserted) =\u003e {\n                    handler\n                        .send_packet(Box::new(CreateCharFailed::new(\n                            CharNameResponseVariant::AlreadyExists,\n                        )?))\n                        .await\n                }\n                e =\u003e {\n                    error!(?e, \"Failed to create char\");\n                    handler\n                        .send_packet(Box::new(CreateCharFailed::new(\n                            CharNameResponseVariant::CharCreationFailed,\n                        )?))\n                        .await\n                }\n            }\n        } else {\n            handler\n                .send_packet(Box::new(CreateCharFailed::new(response)?))\n                .await\n        }\n    }\n}\n","traces":[{"line":36,"address":[4960976],"length":1,"stats":{"Line":0}},{"line":37,"address":[4961010],"length":1,"stats":{"Line":0}},{"line":38,"address":[4961130,4961040,4961227],"length":1,"stats":{"Line":0}},{"line":40,"address":[4961250,4961276,4961694],"length":1,"stats":{"Line":0}},{"line":41,"address":[4961307,4961400,4961490,4961652],"length":1,"stats":{"Line":0}},{"line":47,"address":[4961681],"length":1,"stats":{"Line":0}},{"line":48,"address":[4961725,4961815,4961945],"length":1,"stats":{"Line":0}},{"line":50,"address":[4961706],"length":1,"stats":{"Line":0}},{"line":59,"address":[4965064,4961984],"length":1,"stats":{"Line":0}},{"line":60,"address":[4962025],"length":1,"stats":{"Line":0}},{"line":63,"address":[4962202,4962036],"length":1,"stats":{"Line":0}},{"line":64,"address":[4962173,4962276,4962363],"length":1,"stats":{"Line":0}},{"line":65,"address":[4962437,4962334,4962529],"length":1,"stats":{"Line":0}},{"line":66,"address":[4965244,4962759,4962973,4965226,4962603,4962500],"length":1,"stats":{"Line":0}},{"line":67,"address":[4962944,4963047,4963134],"length":1,"stats":{"Line":0}},{"line":68,"address":[4963295,4963208,4963105],"length":1,"stats":{"Line":0}},{"line":69,"address":[4963266,4963369,4963456],"length":1,"stats":{"Line":0}},{"line":70,"address":[4963530,4963427,4963617],"length":1,"stats":{"Line":0}},{"line":71,"address":[4963778,4963691,4963588],"length":1,"stats":{"Line":0}},{"line":72,"address":[4963939,4963749,4963852],"length":1,"stats":{"Line":0}},{"line":73,"address":[4963910,4965103,4964169,4965118,4964013,4964287],"length":1,"stats":{"Line":0}},{"line":74,"address":[4965086,4964460,4964258,4964304,4964578,4965101],"length":1,"stats":{"Line":0}},{"line":75,"address":[4965062,4965047,4964751,4964549,4964595,4965012],"length":1,"stats":{"Line":0}},{"line":77,"address":[4964990],"length":1,"stats":{"Line":0}},{"line":84,"address":[4764169,4764289,4764096,4764545,4765517,4768317],"length":1,"stats":{"Line":0}},{"line":85,"address":[4764617],"length":1,"stats":{"Line":0}},{"line":86,"address":[4764711,4764828,4765050,4765507],"length":1,"stats":{"Line":0}},{"line":87,"address":[4765466,4765103,4765013,4765211],"length":1,"stats":{"Line":0}},{"line":88,"address":[4765167,4765272],"length":1,"stats":{"Line":0}},{"line":89,"address":[4765549,4765841,4764319,4765275,4768416],"length":1,"stats":{"Line":0}},{"line":90,"address":[4775160,4765893,4765805],"length":1,"stats":{"Line":0}},{"line":92,"address":[4765943],"length":1,"stats":{"Line":0}},{"line":94,"address":[4766466],"length":1,"stats":{"Line":0}},{"line":95,"address":[4766501],"length":1,"stats":{"Line":0}},{"line":96,"address":[4766511],"length":1,"stats":{"Line":0}},{"line":97,"address":[4766491],"length":1,"stats":{"Line":0}},{"line":99,"address":[4766630,4766737,4766532,4768378],"length":1,"stats":{"Line":0}},{"line":102,"address":[4767849,4768101,4768287],"length":1,"stats":{"Line":0}},{"line":103,"address":[4768204,4764340,4768013,4768429,4768898],"length":1,"stats":{"Line":0}},{"line":104,"address":[4768757],"length":1,"stats":{"Line":0}},{"line":105,"address":[4768928,4768842,4769155,4769457,4770031],"length":1,"stats":{"Line":0}},{"line":106,"address":[4293888],"length":1,"stats":{"Line":0}},{"line":109,"address":[4770678,4774790,4770763,4770091],"length":1,"stats":{"Line":0}},{"line":110,"address":[4770828,4770355,4770125,4770633],"length":1,"stats":{"Line":0}},{"line":111,"address":[4770114],"length":1,"stats":{"Line":0}},{"line":113,"address":[4293910],"length":1,"stats":{"Line":0}},{"line":115,"address":[4770150],"length":1,"stats":{"Line":0}},{"line":116,"address":[4771828,4771546,4772049,4772225,4775611,4772323,4770931,4772710,4773332,4771347,4772634,4775768,4771676],"length":1,"stats":{"Line":0}},{"line":117,"address":[4771983,4774182,4774243,4775004],"length":1,"stats":{"Line":0}},{"line":118,"address":[4774302,4772017,4773871,4774143],"length":1,"stats":{"Line":0}},{"line":119,"address":[4772006],"length":1,"stats":{"Line":0}},{"line":121,"address":[4293932],"length":1,"stats":{"Line":0}},{"line":125,"address":[4766303,4765899,4775429,4766388],"length":1,"stats":{"Line":0}},{"line":126,"address":[4766453,4765922,4765980,4766235],"length":1,"stats":{"Line":0}},{"line":127,"address":[4293954],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":55},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","char_restore.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::CharSelectionInfo;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::entities::character;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\n\n#[derive(Debug, Clone)]\npub struct RestoreChar {\n    char_slot: i32,\n}\n\nimpl ReadablePacket for RestoreChar {\n    const PACKET_ID: u8 = 0x7B;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            char_slot: buffer.read_i32()?,\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for RestoreChar {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo flood protection\n        let db_pool = handler.get_db_pool().clone();\n        handler\n            .with_char_by_slot_id(self.char_slot, |model| async move {\n                if model.delete_at.is_none() {\n                    bail!(\"Possible cheat: The char can't be restored as it is not deleted\");\n                }\n                let new_char = character::Model::restore_char(\u0026db_pool, model).await?;\n                Ok(new_char)\n            })\n            .await?;\n        let sk = handler.try_get_session_key()?;\n        let chars = handler.try_get_account_chars()?;\n        let controller = handler.get_controller();\n        let user_name = \u0026handler.try_get_user()?.username;\n        let p = CharSelectionInfo::new(user_name, sk.get_play_session_id(), controller, chars)?;\n        handler.send_packet(Box::new(p)).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":19,"address":[4057328],"length":1,"stats":{"Line":0}},{"line":20,"address":[4057351],"length":1,"stats":{"Line":0}},{"line":21,"address":[4057416],"length":1,"stats":{"Line":0}},{"line":22,"address":[4057362,4057431],"length":1,"stats":{"Line":0}},{"line":30,"address":[4057607],"length":1,"stats":{"Line":0}},{"line":32,"address":[4857444],"length":1,"stats":{"Line":0}},{"line":33,"address":[4857911,4858026,4857594,4857502,4859519,4857812,4857564],"length":1,"stats":{"Line":0}},{"line":34,"address":[4859936,4860099,4857514,4859971,4861015,4860560,4861202,4860199,4860064],"length":1,"stats":{"Line":0}},{"line":35,"address":[4860288,4860152],"length":1,"stats":{"Line":0}},{"line":36,"address":[4860382,4860492],"length":1,"stats":{"Line":0}},{"line":38,"address":[4860294,4860226,4861110,4860421,4860592,4860921],"length":1,"stats":{"Line":0}},{"line":39,"address":[4860893],"length":1,"stats":{"Line":0}},{"line":41,"address":[4290305],"length":1,"stats":{"Line":0}},{"line":42,"address":[4857975,4858071,4858196,4859498],"length":1,"stats":{"Line":0}},{"line":43,"address":[4858161,4858257,4859477,4858374],"length":1,"stats":{"Line":0}},{"line":44,"address":[4858347,4858427],"length":1,"stats":{"Line":0}},{"line":45,"address":[4858603,4859456,4858435],"length":1,"stats":{"Line":0}},{"line":46,"address":[4859423,4859194,4858727,4858580],"length":1,"stats":{"Line":0}},{"line":47,"address":[4290321],"length":1,"stats":{"Line":0}},{"line":48,"address":[4859803],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","char_select.rs"],"content":"use crate::client_thread::{ClientHandler, ClientStatus};\nuse crate::packets::to_client::CharSelected;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\n\n#[derive(Debug, Clone)]\npub struct SelectChar {\n    char_slot: i32,\n}\n\nimpl ReadablePacket for SelectChar {\n    const PACKET_ID: u8 = 0x12;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            char_slot: buffer.read_i32()?,\n        })\n        //unknown part\n        //buffer.read_i16()\n        //buffer.read_i32()\n        //buffer.read_i32()\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for SelectChar {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo flood protection, ban check, maybe set online status in DB?\n        if handler.get_selected_char_slot().is_some() {\n            bail!(\"Char already selected\")\n        }\n        let game_time = handler.get_controller().get_game_time();\n        handler.set_status(ClientStatus::Entering);\n        handler.select_char(self.char_slot);\n        let char_info = handler.try_get_char_by_slot_id(self.char_slot)?;\n        handler\n            .send_packet(Box::new(CharSelected::new(\n                char_info,\n                handler.try_get_session_key()?.get_play_session_id(),\n                game_time\n            )?))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":18,"address":[4954896],"length":1,"stats":{"Line":0}},{"line":19,"address":[4954919],"length":1,"stats":{"Line":0}},{"line":20,"address":[4954984],"length":1,"stats":{"Line":0}},{"line":21,"address":[4954930,4954999],"length":1,"stats":{"Line":0}},{"line":33,"address":[4955169],"length":1,"stats":{"Line":0}},{"line":35,"address":[5341319],"length":1,"stats":{"Line":0}},{"line":36,"address":[5341446,5342530],"length":1,"stats":{"Line":0}},{"line":38,"address":[5341483,5341419],"length":1,"stats":{"Line":0}},{"line":39,"address":[5341534],"length":1,"stats":{"Line":0}},{"line":40,"address":[5341577],"length":1,"stats":{"Line":0}},{"line":41,"address":[5341792,5341606,5342509],"length":1,"stats":{"Line":0}},{"line":42,"address":[5342804,5342358,5342419,5341749,5342911,5342711],"length":1,"stats":{"Line":0}},{"line":43,"address":[5342044,5342322,5342470],"length":1,"stats":{"Line":0}},{"line":45,"address":[5342488,5341769,5341853],"length":1,"stats":{"Line":0}},{"line":48,"address":[4289014,4289143],"length":1,"stats":{"Line":0}},{"line":49,"address":[5342862],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","delete_char.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::{CharDeleteFail, CharSelectionInfo};\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::entities::character;\nuse l2_core::enums::CharDeletionFailReasons;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse sea_orm::DbErr;\nuse tracing::error;\n\n#[derive(Debug, Clone)]\npub struct DeleteChar {\n    char_slot: i32,\n}\n\nimpl ReadablePacket for DeleteChar {\n    const PACKET_ID: u8 = 0x0D;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            char_slot: buffer.read_i32()?,\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for DeleteChar {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo handle proper deletion checks, e.g. check in clan, war, and so on\n        let db_pool = handler.get_db_pool().clone();\n        let deletion_result = handler\n            .with_char_by_slot_id(self.char_slot, |model| async move {\n                if model.delete_at.is_some() {\n                    bail!(\"Possible cheating: Char already set to be deleted\")\n                }\n                let new_char = character::Model::delete_char(\u0026db_pool, model).await?;\n                Ok(new_char)\n            })\n            .await;\n        if let Err(err) = deletion_result {\n            return if let Some(db_err) = err.downcast_ref::\u003cDbErr\u003e() {\n                let packet = CharDeleteFail::new(CharDeletionFailReasons::Unknown)?;\n                error!(\"DB error while deleting a character {db_err:?}\");\n                handler.send_packet(Box::new(packet)).await\n            } else {\n                Err(err)\n            };\n        }\n        let sk = handler.try_get_session_key()?;\n        let chars = handler.try_get_account_chars()?;\n        let controller = handler.get_controller();\n        let user_name = \u0026handler.try_get_user()?.username;\n        let p = CharSelectionInfo::new(user_name, sk.get_play_session_id(), controller, chars)?;\n        handler.send_packet(Box::new(p)).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":22,"address":[4614944],"length":1,"stats":{"Line":0}},{"line":23,"address":[4614967],"length":1,"stats":{"Line":0}},{"line":24,"address":[4615032],"length":1,"stats":{"Line":0}},{"line":25,"address":[4615047,4614978],"length":1,"stats":{"Line":0}},{"line":33,"address":[4239449,4239326,4239639,4239963,4244046,4239280],"length":1,"stats":{"Line":0}},{"line":35,"address":[4239714],"length":1,"stats":{"Line":0}},{"line":36,"address":[4239772,4240121,4239903,4239834],"length":1,"stats":{"Line":0}},{"line":37,"address":[4246464,4247088,4239784,4247730,4246592,4246627,4246499,4246727,4247543],"length":1,"stats":{"Line":0}},{"line":38,"address":[4246816,4246680],"length":1,"stats":{"Line":0}},{"line":39,"address":[4246910,4247020],"length":1,"stats":{"Line":0}},{"line":41,"address":[4247449,4246754,4246822,4246949,4247638,4247120],"length":1,"stats":{"Line":0}},{"line":42,"address":[4247421],"length":1,"stats":{"Line":0}},{"line":44,"address":[4289265],"length":1,"stats":{"Line":0}},{"line":45,"address":[4240227],"length":1,"stats":{"Line":0}},{"line":46,"address":[4240451,4240573,4240298],"length":1,"stats":{"Line":0}},{"line":47,"address":[4240594,4244063,4240909,4240508],"length":1,"stats":{"Line":0}},{"line":48,"address":[4241898,4243643,4242867,4241417,4241746,4242556,4247851,4242943,4242458,4248008,4241001,4242279,4241616,4243125,4243461],"length":1,"stats":{"Line":0}},{"line":49,"address":[4239500,4245664,4242056,4243912],"length":1,"stats":{"Line":0}},{"line":51,"address":[4240541],"length":1,"stats":{"Line":0}},{"line":54,"address":[4244298,4245654,4240325,4244173],"length":1,"stats":{"Line":0}},{"line":55,"address":[4244359,4244263,4244476,4245636],"length":1,"stats":{"Line":0}},{"line":56,"address":[4244449,4244529],"length":1,"stats":{"Line":0}},{"line":57,"address":[4244705,4245579,4244537],"length":1,"stats":{"Line":0}},{"line":58,"address":[4245549,4245308,4244829,4244682],"length":1,"stats":{"Line":0}},{"line":59,"address":[4245951,4246256,4246333,4239521,4245110,4245437],"length":1,"stats":{"Line":0}},{"line":60,"address":[4246213],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":26},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","extended","check_char_name.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::extended::CharExistsResponse;\nuse crate::packets::utils::validate_can_create_char;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\n\n#[derive(Debug, Clone)]\npub struct CheckCharName {\n    name: String,\n}\n\nimpl ReadablePacket for CheckCharName {\n    const PACKET_ID: u8 = 0xD0;\n    const EX_PACKET_ID: Option\u003cu16\u003e = Some(0xA9);\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buff = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            name: buff.read_c_utf16le_string()?,\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for CheckCharName {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let pool = handler.get_db_pool();\n        let reason = validate_can_create_char(pool, \u0026self.name).await?;\n        handler\n            .send_packet(Box::new(CharExistsResponse::new(reason as i32)?))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":19,"address":[4576496],"length":1,"stats":{"Line":0}},{"line":20,"address":[4576529],"length":1,"stats":{"Line":0}},{"line":21,"address":[4576645],"length":1,"stats":{"Line":0}},{"line":22,"address":[4576714,4576540],"length":1,"stats":{"Line":0}},{"line":30,"address":[4576951],"length":1,"stats":{"Line":0}},{"line":31,"address":[5424412],"length":1,"stats":{"Line":0}},{"line":32,"address":[4297377],"length":1,"stats":{"Line":0}},{"line":33,"address":[5425235,5425695,5424867,5425588,5425495,5425296],"length":1,"stats":{"Line":0}},{"line":34,"address":[5424948,5425182,5424884,5425344],"length":1,"stats":{"Line":0}},{"line":35,"address":[4297393,4297444],"length":1,"stats":{"Line":0}},{"line":36,"address":[5425646],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","extended","go_to_lobby.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::CharSelectionInfo;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\n\n#[derive(Debug, Clone)]\npub struct GoLobby;\n\nimpl ReadablePacket for GoLobby {\n    const PACKET_ID: u8 = 0xD0;\n    const EX_PACKET_ID: Option\u003cu16\u003e = Some(0x33);\n\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for GoLobby {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let user_name = \u0026handler.try_get_user()?.username;\n        let sk = handler\n            .get_session_key()\n            .ok_or(anyhow::anyhow!(\"Can not go to lobby, Session is missing\"))?;\n        let chars = handler\n            .get_account_chars()\n            .ok_or(anyhow::anyhow!(\"Can not go to lobby, no chars were set\"))?;\n        let controller = handler.get_controller();\n        let p =\n            CharSelectionInfo::new(user_name, sk.get_play_session_id(), controller, chars)?;\n        handler.send_packet(Box::new(p)).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[3736544],"length":1,"stats":{"Line":0}},{"line":16,"address":[3736554],"length":1,"stats":{"Line":0}},{"line":23,"address":[3737134],"length":1,"stats":{"Line":0}},{"line":24,"address":[4967401,4967581,4969112],"length":1,"stats":{"Line":0}},{"line":25,"address":[4967894,4967554,4967722,4969091],"length":1,"stats":{"Line":0}},{"line":27,"address":[4967626,4967878],"length":1,"stats":{"Line":0}},{"line":28,"address":[4968019,4967851,4969070,4968191],"length":1,"stats":{"Line":0}},{"line":30,"address":[4968175,4967923],"length":1,"stats":{"Line":0}},{"line":31,"address":[4968236,4968148],"length":1,"stats":{"Line":0}},{"line":32,"address":[4968244,4969037,4968346,4968813],"length":1,"stats":{"Line":0}},{"line":34,"address":[4294966],"length":1,"stats":{"Line":0}},{"line":35,"address":[4969411],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","extended","mod.rs"],"content":"mod go_to_lobby;\nmod check_char_name;\nmod send_client_ini;\nmod req_user_ban_info;\n\npub use go_to_lobby::*;\npub use check_char_name::*;\npub use send_client_ini::*;\npub use req_user_ban_info::*;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","extended","req_user_ban_info.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\n\n#[derive(Debug, Clone)]\npub struct RequestUserBanInfo;\n\nimpl ReadablePacket for RequestUserBanInfo {\n    const PACKET_ID: u8 = 0xD0;\n    const EX_PACKET_ID: Option\u003cu16\u003e = Some(0x138);\n\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for RequestUserBanInfo {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo: I don't know what this packet is needed for, in L2J it is also not handled\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[4639024],"length":1,"stats":{"Line":0}},{"line":14,"address":[4639034],"length":1,"stats":{"Line":0}},{"line":21,"address":[4639150],"length":1,"stats":{"Line":0}},{"line":23,"address":[5303841],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","extended","send_client_ini.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\n\n#[derive(Debug, Clone)]\npub struct SendClientIni;\n\nimpl ReadablePacket for SendClientIni {\n    const PACKET_ID: u8 = 0xD0;\n    const EX_PACKET_ID: Option\u003cu16\u003e = Some(0x104);\n\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for SendClientIni {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo: I don't know what this packet is needed for, in L2J it is also not handled\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[4064512],"length":1,"stats":{"Line":0}},{"line":14,"address":[4064522],"length":1,"stats":{"Line":0}},{"line":21,"address":[4064638],"length":1,"stats":{"Line":0}},{"line":23,"address":[5421665],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","logout.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::traits::Shutdown;\nuse tracing::info;\n\n#[derive(Debug, Clone)]\npub struct Logout;\n\nimpl ReadablePacket for Logout {\n    const PACKET_ID: u8 = 0x00;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for Logout {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        //todo handle proper logout mechanism: olympiad,\n        // in battle state, on RB and so on, offline trade, etc...\n        info!(\"Player logged out: {:?}\", handler.try_get_user()?);\n        handler.get_shutdown_listener().notify_one();\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[4063904],"length":1,"stats":{"Line":0}},{"line":15,"address":[4063914],"length":1,"stats":{"Line":0}},{"line":22,"address":[4064030],"length":1,"stats":{"Line":0}},{"line":25,"address":[4852037,4852884,4852405,4853893,4851885,4852229,4851556,4852503,4854337,4851140,4854443,4853579,4852814,4851755,4853198,4854600],"length":1,"stats":{"Line":0}},{"line":26,"address":[4852192,4854193],"length":1,"stats":{"Line":0}},{"line":27,"address":[4854290],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","mod.rs"],"content":"pub mod protocol;\npub mod auth;\npub mod noop;\npub mod new_char_request;\npub mod extended;\npub mod char_create;\npub mod logout;\npub mod delete_char;\npub mod char_restore;\npub mod char_select;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","new_char_request.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::NewCharacterResponse;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\n\n#[derive(Debug, Clone)]\npub struct NewCharacterRequest;\n\nimpl ReadablePacket for NewCharacterRequest {\n    const PACKET_ID: u8 = 0x13;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for NewCharacterRequest {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = handler.get_controller();\n        handler\n            .send_packet(Box::new(NewCharacterResponse::new(controller)?))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[5569776],"length":1,"stats":{"Line":0}},{"line":16,"address":[5569786],"length":1,"stats":{"Line":0}},{"line":23,"address":[3695391,3696230,3696612,3695360,3695478,3695629],"length":1,"stats":{"Line":0}},{"line":24,"address":[3695721],"length":1,"stats":{"Line":0}},{"line":25,"address":[3696573,3696466,3695758,3696108,3696169,3696373],"length":1,"stats":{"Line":0}},{"line":26,"address":[3696055,3696217,3695775],"length":1,"stats":{"Line":0}},{"line":27,"address":[3696262,3696142,3696185,3696557,3696394,3695508],"length":1,"stats":{"Line":0}},{"line":28,"address":[3696524],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","noop.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\n\n#[derive(Debug, Clone)]\npub struct NoOp {}\n\nimpl ReadablePacket for NoOp {\n    const PACKET_ID: u8 = 0;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(_: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        Ok(Self {})\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for NoOp {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[4983200],"length":1,"stats":{"Line":0}},{"line":14,"address":[4983210],"length":1,"stats":{"Line":0}},{"line":21,"address":[4983326],"length":1,"stats":{"Line":0}},{"line":22,"address":[5340817],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","from_client","protocol.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packets::to_client::ProtocolResponse;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::crypt::game::GameClientEncryption;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct ProtocolVersion {\n    pub version: i32,\n    pub buffer: SendablePacketBuffer,\n}\n\nimpl ReadablePacket for ProtocolVersion {\n    const PACKET_ID: u8 = 0x0E;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        let version = buffer.read_i32()?;\n        Ok(Self {\n            version,\n            buffer: SendablePacketBuffer::empty(),\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for ProtocolVersion {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, handler: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = handler.get_controller().clone();\n        let cfg = controller.get_cfg();\n        if let Err(e) = handler.set_protocol(self.version) {\n            handler\n                .send_packet(Box::new(ProtocolResponse::fail(\u0026cfg)?))\n                .await?;\n            bail!(e);\n        }\n\n        let key_bytes = ClientHandler::generate_key();\n        if cfg.enable_encryption {\n            let key = GameClientEncryption::new(\u0026key_bytes)?;\n            handler.set_encryption(Some(key));\n        }\n        handler\n            .send_packet(Box::new(ProtocolResponse::new(\u0026key_bytes, true, \u0026cfg)?))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":22,"address":[4645504],"length":1,"stats":{"Line":3}},{"line":23,"address":[4645537],"length":1,"stats":{"Line":3}},{"line":24,"address":[4645700,4645548],"length":1,"stats":{"Line":3}},{"line":25,"address":[4645625],"length":1,"stats":{"Line":3}},{"line":27,"address":[4645605],"length":1,"stats":{"Line":3}},{"line":35,"address":[4646055],"length":1,"stats":{"Line":9}},{"line":36,"address":[5549662],"length":1,"stats":{"Line":3}},{"line":37,"address":[5549818,5549747],"length":1,"stats":{"Line":6}},{"line":38,"address":[5549880,5549982],"length":1,"stats":{"Line":6}},{"line":39,"address":[5551973,5552270,5551880,5552102,5550046,5550512,5550597],"length":1,"stats":{"Line":5}},{"line":40,"address":[5550204,5550654,5550066,5550447],"length":1,"stats":{"Line":2}},{"line":41,"address":[4290733,4290481,4290516],"length":1,"stats":{"Line":3}},{"line":42,"address":[5552128,5552031],"length":1,"stats":{"Line":1}},{"line":45,"address":[5550685],"length":1,"stats":{"Line":2}},{"line":46,"address":[5550704,5550819],"length":1,"stats":{"Line":2}},{"line":47,"address":[5551724,5551116,5550882],"length":1,"stats":{"Line":0}},{"line":48,"address":[5551161,5551043],"length":1,"stats":{"Line":0}},{"line":50,"address":[5552798,5550828,5552515,5552717,5551567,5551628,5552608],"length":1,"stats":{"Line":6}},{"line":51,"address":[5550848,5551198,5551505,5551682],"length":1,"stats":{"Line":2}},{"line":52,"address":[4290809,4291012,4290497],"length":1,"stats":{"Line":5}},{"line":53,"address":[5552666],"length":1,"stats":{"Line":1}}],"covered":19,"coverable":21},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","change_password.rs"],"content":"use l2_core::shared_packets::gs_2_ls::ChangePassword;\nuse async_trait::async_trait;\nuse crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for ChangePassword {\n    type HandlerType = LoginHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        todo!()\n    }\n}\n","traces":[{"line":9,"address":[4617806],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","gs_auth_response.rs"],"content":"use crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::gs_2_ls::{GSStatusUpdate, PlayerInGame};\nuse l2_core::shared_packets::ls_2_gs;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse std::sync::Arc;\nuse tracing::{info, instrument};\n\n#[async_trait]\nimpl HandleablePacket for ls_2_gs::AuthGS {\n    type HandlerType = LoginHandler;\n\n    #[instrument(skip_all)]\n    async fn handle(\u0026self, lh: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = lh.get_controller();\n        let cfg = controller.get_cfg();\n        if self.server_id != cfg.server_id \u0026\u0026 !cfg.accept_alternative_id {\n            bail!(\n                \"Can not accept alternative id from login server. Id is {}\",\n                self.server_id\n            );\n        }\n        let gsu = GSStatusUpdate::new(\u0026cfg)?;\n        lh.send_packet(Box::new(gsu)).await?;\n        info!(\n            \"Registered on Login server: {:} ({:})\",\n            self.server_name, self.server_id\n        );\n        controller\n            .message_broker\n            .register_packet_handler(Self::HandlerType::HANDLER_ID, Arc::new(lh.clone()));\n        let accounts = controller.get_online_accounts();\n        if !accounts.is_empty() {\n            lh.send_packet(Box::new(PlayerInGame::new(\u0026accounts)?))\n                .await?;\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[3887002,3888538,3894280,3888270,3888369,3888224,3889948],"length":1,"stats":{"Line":0}},{"line":17,"address":[3888600],"length":1,"stats":{"Line":0}},{"line":18,"address":[3888658],"length":1,"stats":{"Line":0}},{"line":19,"address":[3888846,3888884,3888747],"length":1,"stats":{"Line":0}},{"line":20,"address":[3889150,3888928,3889029],"length":1,"stats":{"Line":0}},{"line":25,"address":[3889646,3888854,3889262,3889923],"length":1,"stats":{"Line":0}},{"line":26,"address":[3890420,3888399,3889441,3889980,3889784,3894267],"length":1,"stats":{"Line":0}},{"line":27,"address":[3890888,3894904,3893138,3890472,3891835,3892222,3893037,3892856,3891217,3891369,3894747,3891087,3892504,3892146,3892403,3891561,3891737],"length":1,"stats":{"Line":0}},{"line":31,"address":[3893415,3891524,3893503],"length":1,"stats":{"Line":0}},{"line":33,"address":[3893437],"length":1,"stats":{"Line":0}},{"line":34,"address":[3893522],"length":1,"stats":{"Line":0}},{"line":35,"address":[3893687,3894551,3893576],"length":1,"stats":{"Line":0}},{"line":36,"address":[3893783,3894572,3894169,3894055,3894225,3894650,3894400,3894493,3893693],"length":1,"stats":{"Line":0}},{"line":37,"address":[3894289,3894191,3894421,3894142,3894556,3888420],"length":1,"stats":{"Line":0}},{"line":39,"address":[3893735],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":15},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","gs_login_fail.rs"],"content":"use crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::GSLoginFail;\n\n#[async_trait]\nimpl HandleablePacket for GSLoginFail {\n    type HandlerType = LoginHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        bail!(\"Failed to register on Login server{:?}\", self.reason)\n    }\n}\n","traces":[{"line":10,"address":[3768398],"length":1,"stats":{"Line":0}},{"line":11,"address":[5539767,5539583,5539673],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","init_ls.rs"],"content":"use async_trait::async_trait;\nuse l2_core::crypt::generate_blowfish_key;\nuse l2_core::crypt::login::Encryption;\nuse l2_core::crypt::rsa::RSAPublicKey;\nuse l2_core::shared_packets::gs_2_ls::BlowFish;\nuse l2_core::shared_packets::{gs_2_ls::RequestAuthGS, ls_2_gs::InitLS};\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for InitLS {\n    type HandlerType = LoginHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = gs.get_controller();\n        let config = controller.get_cfg();\n        let ra = RequestAuthGS::new(\u0026config)?;\n        let p_key = RSAPublicKey::from_modulus(\u0026self.public_key)?;\n        let new_key = generate_blowfish_key(Some(40));\n        let encrypted_data = p_key.encrypt(\u0026new_key);\n        let bf = BlowFish::new(encrypted_data);\n        gs.send_packet(Box::new(bf)).await?;\n        gs.set_blowfish(Encryption::new(\u0026new_key));\n        gs.send_packet(Box::new(ra)).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[4419200,4419246,4421287,4419351,4422167,4419523],"length":1,"stats":{"Line":0}},{"line":15,"address":[4419604],"length":1,"stats":{"Line":0}},{"line":16,"address":[4419650],"length":1,"stats":{"Line":0}},{"line":17,"address":[4420146,4419727,4419821,4421242],"length":1,"stats":{"Line":0}},{"line":18,"address":[4421203,4420255,4420119,4420565],"length":1,"stats":{"Line":0}},{"line":19,"address":[4420502],"length":1,"stats":{"Line":0}},{"line":20,"address":[4420834,4420654],"length":1,"stats":{"Line":0}},{"line":21,"address":[4420853],"length":1,"stats":{"Line":0}},{"line":22,"address":[4309268],"length":1,"stats":{"Line":0}},{"line":23,"address":[4421617,4421714],"length":1,"stats":{"Line":0}},{"line":24,"address":[4309287],"length":1,"stats":{"Line":0}},{"line":25,"address":[4422447],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","kick_player.rs"],"content":"use crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::ls_2_gs::KickPlayer;\nuse l2_core::traits::handlers::PacketHandler;\n\n#[async_trait]\nimpl HandleablePacket for KickPlayer {\n    type HandlerType = LoginHandler;\n    async fn handle(\u0026self, ph: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = ph.get_controller();\n        controller.logout_account(\u0026self.account_name);\n        Ok(())\n    }\n}\n","traces":[{"line":10,"address":[5408769,5408822,5409090,5408919,5408752],"length":1,"stats":{"Line":0}},{"line":11,"address":[5408978],"length":1,"stats":{"Line":0}},{"line":12,"address":[5409012],"length":1,"stats":{"Line":0}},{"line":13,"address":[5409066],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","mod.rs"],"content":"mod change_password;\nmod gs_auth_response;\nmod gs_login_fail;\nmod init_ls;\nmod kick_player;\nmod player_auth_response;\nmod req_chars;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","player_auth_response.rs"],"content":"use crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::PacketType;\nuse l2_core::shared_packets::ls_2_gs;\nuse l2_core::traits::handlers::PacketHandler;\n\n#[async_trait]\nimpl HandleablePacket for ls_2_gs::PlayerAuthResponse {\n    type HandlerType = LoginHandler;\n    async fn handle(\u0026self, ph: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = ph.get_controller();\n        controller.message_broker.respond_to_message(\n            Some(Self::HandlerType::HANDLER_ID),\n            \u0026self.account,\n            PacketType::PlayerAuthResp(self.clone()),\n        );\n        Ok(())\n    }\n}\n","traces":[{"line":11,"address":[3721982],"length":1,"stats":{"Line":0}},{"line":12,"address":[5042628],"length":1,"stats":{"Line":0}},{"line":13,"address":[5042662,5042873],"length":1,"stats":{"Line":0}},{"line":14,"address":[5042703],"length":1,"stats":{"Line":0}},{"line":15,"address":[5042719],"length":1,"stats":{"Line":0}},{"line":16,"address":[5042769],"length":1,"stats":{"Line":0}},{"line":18,"address":[5042907],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","handleable","req_chars.rs"],"content":"use l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse l2_core::shared_packets::{\n    ls_2_gs::RequestChars,\n    gs_2_ls::ReplyChars,\n};\nuse async_trait::async_trait;\nuse entities::entities::character;\nuse tracing::instrument;\nuse crate::ls_thread::LoginHandler;\nuse crate::packets::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for RequestChars {\n    type HandlerType = LoginHandler;\n\n    #[instrument(skip_all)]\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let db_pool = gs.get_db_pool();\n        let chars =\n            character::Model::find_by_username(db_pool, \u0026self.account_name).await?;\n        let pack = ReplyChars::new(self.account_name.clone(), \u0026chars)?;\n        gs.send_packet(Box::new(pack)).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":17,"address":[4958707,4958538,4958972,4960512,4957177,4958400,4958431],"length":1,"stats":{"Line":0}},{"line":18,"address":[4958769],"length":1,"stats":{"Line":0}},{"line":19,"address":[4321841],"length":1,"stats":{"Line":0}},{"line":21,"address":[4959347,4959728,4959477,4960209,4960438,4960480],"length":1,"stats":{"Line":0}},{"line":22,"address":[4321857],"length":1,"stats":{"Line":0}},{"line":23,"address":[4960804],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","mod.rs"],"content":"use std::fmt::Debug;\nuse async_trait::async_trait;\n\npub mod handleable;\npub mod from_client;\npub mod to_client;\npub mod enums;\npub mod utils;\n\n#[async_trait]\npub trait HandleablePacket: Debug + Send {\n    type HandlerType;\n    async fn handle(\n        \u0026self,\n        ch: \u0026mut Self::HandlerType,\n    ) -\u003e anyhow::Result\u003c()\u003e;\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","char_create_fail.rs"],"content":"use crate::packets::enums::CharNameResponseVariant;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct CreateCharFailed {\n    buffer: SendablePacketBuffer,\n    error: i32,\n}\n\n#[allow(unused)]\nimpl CreateCharFailed {\n    const PACKET_ID: u8 = 0x10;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    pub fn new(error: CharNameResponseVariant) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            error: error as i32,\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_i32(inst.error)?;\n        Ok(inst)\n    }\n}\n","traces":[{"line":16,"address":[3737003,3736576],"length":1,"stats":{"Line":0}},{"line":18,"address":[3736597],"length":1,"stats":{"Line":0}},{"line":19,"address":[3736611],"length":1,"stats":{"Line":0}},{"line":21,"address":[3737001,3736639,3736707,3736795],"length":1,"stats":{"Line":0}},{"line":22,"address":[3736765,3736833,3736944,3736987],"length":1,"stats":{"Line":0}},{"line":23,"address":[3736891],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","char_create_ok.rs"],"content":"use l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct CreateCharOk {\n    buffer: SendablePacketBuffer,\n}\n\n#[allow(unused)]\nimpl CreateCharOk {\n    const PACKET_ID: u8 = 0x0F;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n    pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_i32(1)?;\n        Ok(inst)\n    }\n}\n","traces":[{"line":14,"address":[4975398,4974944],"length":1,"stats":{"Line":0}},{"line":16,"address":[4974961],"length":1,"stats":{"Line":0}},{"line":18,"address":[4975063,4975146,4974995,4975396],"length":1,"stats":{"Line":0}},{"line":19,"address":[4975115,4975342,4975181,4975382],"length":1,"stats":{"Line":0}},{"line":20,"address":[4975236],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":5},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","char_delete_fail.rs"],"content":"use l2_core::enums::CharDeletionFailReasons;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct CharDeleteFail {\n    buffer: SendablePacketBuffer,\n}\n\n#[allow(unused)]\nimpl CharDeleteFail {\n    const PACKET_ID: u8 = 0x1E;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    pub fn new(reason: CharDeletionFailReasons) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_i32(reason as i32)?;\n        Ok(inst)\n    }\n}\n","traces":[{"line":16,"address":[4948045,4947568],"length":1,"stats":{"Line":0}},{"line":18,"address":[4947589],"length":1,"stats":{"Line":0}},{"line":20,"address":[4948043,4947623,4947779,4947691],"length":1,"stats":{"Line":0}},{"line":21,"address":[4948029,4947817,4947749,4947986],"length":1,"stats":{"Line":0}},{"line":22,"address":[4947880],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":5},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","char_selected.rs"],"content":"use entities::dao::char_info::CharacterInfo;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct CharSelected {\n    buffer: SendablePacketBuffer,\n}\n\n#[allow(unused)]\nimpl CharSelected {\n    const PACKET_ID: u8 = 0x0B;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    pub fn new(char_info: \u0026CharacterInfo, session_id: i32, game_time: i32) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_c_utf16le_string(Some(\u0026char_info.char_model.name))?;\n        inst.buffer.write_i32(char_info.char_model.id)?;\n        inst.buffer\n            .write_c_utf16le_string(char_info.char_model.title.as_deref())?;\n        inst.buffer.write_i32(session_id)?;\n        inst.buffer.write_i32(0)?; //todo clan_id\n        inst.buffer.write_i32(0)?; //???\n        inst.buffer\n            .write_i32(i32::from(char_info.char_model.is_female))?;\n        inst.buffer\n            .write_i32(i32::from(char_info.char_model.race_id))?;\n        inst.buffer\n            .write_i32(i32::from(char_info.char_model.class_id))?;\n        inst.buffer.write_i32(1)?; //active?\n        inst.buffer.write_i32(char_info.char_model.x)?;\n        inst.buffer.write_i32(char_info.char_model.y)?;\n        inst.buffer.write_i32(char_info.char_model.z)?;\n        inst.buffer.write_f64(char_info.char_model.cur_hp)?;\n        inst.buffer.write_f64(char_info.char_model.cur_mp)?;\n        inst.buffer.write_i64(char_info.char_model.sp)?;\n        inst.buffer.write_i64(char_info.char_model.exp)?;\n        inst.buffer\n            .write_i32(i32::from(char_info.char_model.level))?;\n        inst.buffer.write_i32(char_info.char_model.reputation)?;\n        inst.buffer.write_i32(char_info.char_model.pk_kills)?;\n        inst.buffer.write_i32(game_time % (24 * 60))?;\n        inst.buffer.write_i32(0)?;\n        inst.buffer\n            .write_i32(i32::from(char_info.char_model.class_id))?; // again? wtf\n        inst.buffer.write_bytes(\u0026[0; 16])?; //?\n        inst.buffer.write_bytes(\u0026[0; 36])?; //? 9 times x 4 bytes (i32)\n        inst.buffer.write_bytes(\u0026[0; 28])?; //?\n        inst.buffer.write_i32(0)?; // last 4 bytes\n        Ok(inst)\n    }\n}\n","traces":[{"line":16,"address":[4028576,4033458],"length":1,"stats":{"Line":0}},{"line":18,"address":[4028643],"length":1,"stats":{"Line":0}},{"line":20,"address":[4033456,4028772,4028692,4028879],"length":1,"stats":{"Line":0}},{"line":21,"address":[4029108,4028928,4033454,4028844],"length":1,"stats":{"Line":0}},{"line":22,"address":[4029067,4029149,4033452,4029260],"length":1,"stats":{"Line":0}},{"line":23,"address":[4029309,4033450,4029466],"length":1,"stats":{"Line":0}},{"line":24,"address":[4029221,4029450],"length":1,"stats":{"Line":0}},{"line":25,"address":[4029415,4029592,4029491,4033448],"length":1,"stats":{"Line":0}},{"line":26,"address":[4033446,4029633,4029734,4029555],"length":1,"stats":{"Line":0}},{"line":27,"address":[4029775,4029887,4033444,4029697],"length":1,"stats":{"Line":0}},{"line":28,"address":[4030083,4033442,4029927],"length":1,"stats":{"Line":0}},{"line":29,"address":[4029847,4030067],"length":1,"stats":{"Line":0}},{"line":30,"address":[4033440,4030107,4030263],"length":1,"stats":{"Line":0}},{"line":31,"address":[4030034,4030247],"length":1,"stats":{"Line":0}},{"line":32,"address":[4033438,4030442,4030287],"length":1,"stats":{"Line":0}},{"line":33,"address":[4030426,4030214],"length":1,"stats":{"Line":0}},{"line":34,"address":[4030467,4030580,4030386,4033436],"length":1,"stats":{"Line":0}},{"line":35,"address":[4030539,4033434,4030734,4030621],"length":1,"stats":{"Line":0}},{"line":36,"address":[4030693,4030775,4033432,4030888],"length":1,"stats":{"Line":0}},{"line":37,"address":[4030847,4031044,4030929,4033430],"length":1,"stats":{"Line":0}},{"line":38,"address":[4031001,4031085,4031200,4033428],"length":1,"stats":{"Line":0}},{"line":39,"address":[4033426,4031157,4031241,4031355],"length":1,"stats":{"Line":0}},{"line":40,"address":[4031313,4031396,4031510,4033424],"length":1,"stats":{"Line":0}},{"line":41,"address":[4031656,4031551,4033422,4031468],"length":1,"stats":{"Line":0}},{"line":42,"address":[4031860,4031696,4033420],"length":1,"stats":{"Line":0}},{"line":43,"address":[4031844,4031623],"length":1,"stats":{"Line":0}},{"line":44,"address":[4033418,4031885,4031998,4031803],"length":1,"stats":{"Line":0}},{"line":45,"address":[4032039,4033416,4031957,4032135],"length":1,"stats":{"Line":0}},{"line":46,"address":[4032406,4032172,4033414,4032103],"length":1,"stats":{"Line":0}},{"line":47,"address":[4032540,4032444,4032372,4033412],"length":1,"stats":{"Line":0}},{"line":48,"address":[4032724,4032577,4033410],"length":1,"stats":{"Line":0}},{"line":49,"address":[4032510,4032708],"length":1,"stats":{"Line":0}},{"line":50,"address":[4032664,4032746,4033408,4032848],"length":1,"stats":{"Line":0}},{"line":51,"address":[4032988,4032886,4033406,4032804],"length":1,"stats":{"Line":0}},{"line":52,"address":[4033404,4033118,4033026,4032944],"length":1,"stats":{"Line":0}},{"line":53,"address":[4033084,4033387,4033341,4033156],"length":1,"stats":{"Line":0}},{"line":54,"address":[4033220],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","char_selection.rs"],"content":"use crate::controller::Controller;\nuse entities::dao::char_info::{CharacterInfo, PaperDoll};\nuse entities::entities::item;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\nuse std::sync::Arc;\n\n#[allow(unused)]\n#[derive(Debug, Clone, Default, SendablePacketImpl)]\npub struct CharSelectionInfo {\n    buffer: SendablePacketBuffer,\n    session_id: i32,\n    active_id: i32,\n}\n\nimpl CharSelectionInfo {\n    pub const PACKET_ID: u8 = 0x09;\n    #[allow(clippy::cast_possible_truncation)]\n    #[allow(clippy::cast_possible_wrap)]\n    #[allow(clippy::too_many_lines)]\n    pub fn new(\n        account_name: \u0026str,\n        session_id: i32,\n        controller: \u0026Arc\u003cController\u003e,\n        chars: \u0026[CharacterInfo],\n    ) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = SendablePacketBuffer::new();\n        buffer.write(Self::PACKET_ID)?;\n        let char_len = chars.len() as u32;\n        buffer.write_u32(char_len)?;\n        let cfg = controller.get_cfg();\n        let exp_table = \u0026controller.exp_table;\n        buffer.write_u32(u32::from(cfg.max_chars_on_account))?;\n        buffer.write_bool(char_len == u32::from(cfg.max_chars_on_account))?;\n        buffer.write(1)?; // 0=can't play, 1=can play free until level 85, 2=100% free play\n        buffer.write_u32(2)?; // if 1, Korean client\n        buffer.write(0)?; // Balthus Knights, if 1 suggests premium account\n        let mut last_access = None;\n        let mut active_id = -1;\n        for (index, char_info) in chars.iter().enumerate() {\n            let char = \u0026char_info.char_model;\n            if char.last_access \u003e last_access \u0026\u0026 char.delete_at.is_none() {\n                last_access = char.last_access;\n                active_id = index as i32;\n            }\n            buffer.write_c_utf16le_string(Some(\u0026char.name))?;\n            buffer.write_i32(char.id)?;\n            buffer.write_c_utf16le_string(Some(account_name))?;\n            buffer.write_i32(session_id)?;\n            buffer.write_i32(0)?; // clan id\n            buffer.write_i32(0)?; // Builder level\n            buffer.write_i32(i32::from(char.is_female))?;\n            buffer.write_i32(i32::from(char.race_id))?; \n            buffer.write_i32(i32::from(char.base_class_id))?;\n            buffer.write_i32(1)?; // GameServerName\n            buffer.write_i32(char.x)?;\n            buffer.write_i32(char.y)?;\n            buffer.write_i32(char.z)?;\n            buffer.write_f64(char.cur_hp)?;\n            buffer.write_f64(char.cur_mp)?;\n            buffer.write_i64(char.sp)?;\n            buffer.write_i64(char.exp)?;\n            let exp_current = exp_table.get_exp(char.get_lvl());\n            let exp_next = exp_table.get_exp_for_next_lvl(char.get_lvl());\n            #[allow(clippy::cast_precision_loss)]\n            buffer.write_f64((char.exp - exp_current) as f64 / (exp_next - exp_current) as f64)?;\n            buffer.write_i32(i32::from(char.level))?;\n            buffer.write_i32(char.reputation)?;\n            buffer.write_i32(char.pk_kills)?;\n            buffer.write_i32(char.pvp_kills)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?;\n            buffer.write_i32(0)?; // Ertheia\n            buffer.write_i32(0)?; // Ertheia\n            for slot in PaperDoll::ordered_ids() {\n                buffer.write_i32(char_info.paper_doll_item_id(slot))?;\n            }\n            for v_slot in PaperDoll::visual_ids() {\n                buffer.write_i32(char_info.get_paper_doll_visual_id(v_slot))?;\n            }\n            buffer.write_i16(char_info.get_enchant_effect(PaperDoll::Chest))?; // Upper Body enchant level\n            buffer.write_i16(char_info.get_enchant_effect(PaperDoll::Legs))?; // Lower Body enchant level\n            buffer.write_i16(char_info.get_enchant_effect(PaperDoll::Head))?; // Headgear enchant level\n            buffer.write_i16(char_info.get_enchant_effect(PaperDoll::Gloves))?; // Gloves enchant level\n            buffer.write_i16(char_info.get_enchant_effect(PaperDoll::Feet))?; // Boots enchant level\n            buffer.write_i32(char_info.get_hair_style())?;\n            buffer.write_i32(char_info.get_hair_color())?;\n            buffer.write_i32(char_info.get_face())?;\n            buffer.write_f64(char_info.get_max_hp())?; // Maximum HP\n            buffer.write_f64(char_info.get_max_mp())?; // Maximum MP\n            buffer.write_i32(char_info.get_delete_timer())?;\n            buffer.write_i32(i32::from(char_info.char_model.class_id))?; // Class ID\n            #[allow(clippy::cast_lossless)]\n            buffer.write_i32((index as i32 == active_id) as i32)?; // is_active\n            buffer.write(char_info.get_enchant_effect_as_byte(PaperDoll::RHand))?;\n            let aug = char_info\n                .get_weapon()\n                .and_then(item::Model::get_augmentation);\n            if let Some(augmentation) = aug {\n                buffer.write_i32(augmentation.1)?;\n                buffer.write_i32(augmentation.2)?;\n            } else {\n                buffer.write_i32(0)?;\n                buffer.write_i32(0)?;\n            };\n            buffer.write_i32(char_info.get_transform_id())?;\n            buffer.write_i32(0)?; // Pet NpcId\n            buffer.write_i32(0)?; // Pet level\n            buffer.write_i32(0)?; // Pet food\n            buffer.write_i32(0)?; // Pet food level\n            buffer.write_f64(0.0)?; // Current pet HP\n            buffer.write_f64(0.0)?; // Current pet MP\n            buffer.write_i32(char_info.char_model.vitality_points)?;\n            buffer.write_i32(cfg.rates.vitality_exp_multiplier * 100)?;\n            buffer.write_i32(char_info.get_vitality_used())?;\n            buffer.write_i32(i32::from(char_info.char_model.access_level != -100))?;\n            buffer.write_bool(char_info.char_model.nobless)?;\n            buffer.write(\n                if controller.hero_list.contains_key(\u0026char_info.char_model.id) {\n                    2\n                } else {\n                    0\n                },\n            )?;\n            buffer.write_bool(char_info.is_hair_accessory_enabled())?;\n        }\n        Ok(Self {\n            buffer,\n            session_id,\n            active_id,\n        })\n    }\n}\n","traces":[{"line":21,"address":[4231936,4231562,4217920],"length":1,"stats":{"Line":1}},{"line":27,"address":[4218045],"length":1,"stats":{"Line":1}},{"line":28,"address":[4218094,4231934,4218167,4218290],"length":1,"stats":{"Line":2}},{"line":29,"address":[4218239],"length":1,"stats":{"Line":1}},{"line":30,"address":[4218331,4218255,4231932,4218426],"length":1,"stats":{"Line":2}},{"line":31,"address":[4218403,4218467],"length":1,"stats":{"Line":2}},{"line":32,"address":[4218569,4218506],"length":1,"stats":{"Line":2}},{"line":33,"address":[4218782,4218652,4231900,4218599],"length":1,"stats":{"Line":2}},{"line":34,"address":[4219007,4218823,4218759,4218860,4231895],"length":1,"stats":{"Line":3}},{"line":35,"address":[4231890,4219152,4219048,4218967],"length":1,"stats":{"Line":2}},{"line":36,"address":[4219112,4219193,4231885,4219294],"length":1,"stats":{"Line":2}},{"line":37,"address":[4219257,4219468,4219335,4231880],"length":1,"stats":{"Line":2}},{"line":38,"address":[4219415],"length":1,"stats":{"Line":1}},{"line":39,"address":[4219426],"length":1,"stats":{"Line":1}},{"line":40,"address":[4219525,4219857,4219437],"length":1,"stats":{"Line":2}},{"line":41,"address":[4219905],"length":1,"stats":{"Line":0}},{"line":42,"address":[4219913,4220144,4220025,4219973],"length":1,"stats":{"Line":0}},{"line":43,"address":[4220075],"length":1,"stats":{"Line":0}},{"line":44,"address":[4220137],"length":1,"stats":{"Line":0}},{"line":46,"address":[4220165,4219987,4231875,4220345],"length":1,"stats":{"Line":0}},{"line":47,"address":[4220386,4220304,4220533,4231870],"length":1,"stats":{"Line":0}},{"line":48,"address":[4220466,4220574,4231865,4220680],"length":1,"stats":{"Line":0}},{"line":49,"address":[4231860,4220822,4220645,4220721],"length":1,"stats":{"Line":0}},{"line":50,"address":[4220785,4231855,4220863,4220964],"length":1,"stats":{"Line":0}},{"line":51,"address":[4221117,4221005,4220927,4231850],"length":1,"stats":{"Line":0}},{"line":52,"address":[4231845,4221077,4221157,4221297],"length":1,"stats":{"Line":0}},{"line":53,"address":[4221264,4231840,4221337,4221477],"length":1,"stats":{"Line":0}},{"line":54,"address":[4221517,4221444,4221656,4231835],"length":1,"stats":{"Line":0}},{"line":55,"address":[4221810,4221697,4231830,4221616],"length":1,"stats":{"Line":0}},{"line":56,"address":[4221964,4221851,4221769,4231825],"length":1,"stats":{"Line":0}},{"line":57,"address":[4231820,4222118,4222005,4221923],"length":1,"stats":{"Line":0}},{"line":58,"address":[4222077,4222274,4231815,4222159],"length":1,"stats":{"Line":0}},{"line":59,"address":[4222231,4231810,4222430,4222315],"length":1,"stats":{"Line":0}},{"line":60,"address":[4222387,4222471,4222585,4231805],"length":1,"stats":{"Line":0}},{"line":61,"address":[4231800,4222543,4222626,4222740],"length":1,"stats":{"Line":0}},{"line":62,"address":[4231795,4222781,4222879,4222698],"length":1,"stats":{"Line":0}},{"line":63,"address":[4222927,4222853],"length":1,"stats":{"Line":0}},{"line":64,"address":[4222969],"length":1,"stats":{"Line":0}},{"line":66,"address":[4223052,4231790,4223335],"length":1,"stats":{"Line":0}},{"line":67,"address":[4223523,4223375,4223302,4231785],"length":1,"stats":{"Line":0}},{"line":68,"address":[4223564,4223677,4231780,4223482],"length":1,"stats":{"Line":0}},{"line":69,"address":[4223831,4223636,4231775,4223718],"length":1,"stats":{"Line":0}},{"line":70,"address":[4223872,4231770,4223790,4223973],"length":1,"stats":{"Line":0}},{"line":71,"address":[4224014,4224115,4231765,4223936],"length":1,"stats":{"Line":0}},{"line":72,"address":[4224156,4224257,4224078,4231760],"length":1,"stats":{"Line":0}},{"line":73,"address":[4224399,4224220,4231755,4224298],"length":1,"stats":{"Line":0}},{"line":74,"address":[4224362,4224541,4224440,4231750],"length":1,"stats":{"Line":0}},{"line":75,"address":[4231745,4224582,4224683,4224504],"length":1,"stats":{"Line":0}},{"line":76,"address":[4231740,4224646,4224825,4224724],"length":1,"stats":{"Line":0}},{"line":77,"address":[4224967,4224866,4231735,4224788],"length":1,"stats":{"Line":0}},{"line":78,"address":[4225109,4231730,4224930,4225008],"length":1,"stats":{"Line":0}},{"line":79,"address":[4225241,4231725,4225072,4225150],"length":1,"stats":{"Line":0}},{"line":80,"address":[4225290,4225447,4225214,4225392],"length":1,"stats":{"Line":0}},{"line":81,"address":[4225461,4231578],"length":1,"stats":{"Line":0}},{"line":83,"address":[4225619,4225482,4225674],"length":1,"stats":{"Line":0}},{"line":84,"address":[4231415,4225688],"length":1,"stats":{"Line":0}},{"line":86,"address":[4231403,4225717,4225917],"length":1,"stats":{"Line":0}},{"line":87,"address":[4225958,4226113,4231398,4225872],"length":1,"stats":{"Line":0}},{"line":88,"address":[4226154,4226068,4231393,4226309],"length":1,"stats":{"Line":0}},{"line":89,"address":[4226264,4226350,4226505,4231388],"length":1,"stats":{"Line":0}},{"line":90,"address":[4226460,4231383,4226546,4226682],"length":1,"stats":{"Line":0}},{"line":91,"address":[4226722,4231378,4226855,4226656],"length":1,"stats":{"Line":0}},{"line":92,"address":[4226895,4227028,4231373,4226829],"length":1,"stats":{"Line":0}},{"line":93,"address":[4227002,4227068,4227203,4231368],"length":1,"stats":{"Line":0}},{"line":94,"address":[4227175,4231363,4227245,4227380],"length":1,"stats":{"Line":0}},{"line":95,"address":[4231358,4227555,4227352,4227422],"length":1,"stats":{"Line":0}},{"line":96,"address":[4227735,4227595,4227529,4231353],"length":1,"stats":{"Line":0}},{"line":97,"address":[4227932,4227702,4227775,4231348],"length":1,"stats":{"Line":0}},{"line":99,"address":[4227882,4227973,4231343,4228089],"length":1,"stats":{"Line":0}},{"line":100,"address":[4228045,4231338,4228266,4228129],"length":1,"stats":{"Line":0}},{"line":101,"address":[4228315,4228239],"length":1,"stats":{"Line":0}},{"line":104,"address":[4228322],"length":1,"stats":{"Line":0}},{"line":105,"address":[4228545,4228365,4228439,4228737],"length":1,"stats":{"Line":0}},{"line":106,"address":[4228687,4228503,4228586],"length":1,"stats":{"Line":0}},{"line":108,"address":[4228399,4228848,4228747,4231333],"length":1,"stats":{"Line":0}},{"line":109,"address":[4228811,4228889,4231328],"length":1,"stats":{"Line":0}},{"line":111,"address":[4231323,4229141,4229005,4228658],"length":1,"stats":{"Line":0}},{"line":112,"address":[4229104,4229182,4229283,4231318],"length":1,"stats":{"Line":0}},{"line":113,"address":[4231313,4229246,4229324,4229425],"length":1,"stats":{"Line":0}},{"line":114,"address":[4229388,4229567,4231308,4229466],"length":1,"stats":{"Line":0}},{"line":115,"address":[4231303,4229608,4229710,4229530],"length":1,"stats":{"Line":0}},{"line":116,"address":[4229672,4229853,4231298,4229751],"length":1,"stats":{"Line":0}},{"line":117,"address":[4229815,4230007,4229894,4231293],"length":1,"stats":{"Line":0}},{"line":118,"address":[4230143,4229966,4231288,4230048],"length":1,"stats":{"Line":0}},{"line":119,"address":[4231283,4230120,4230369,4230184],"length":1,"stats":{"Line":0}},{"line":120,"address":[4230409,4231278,4230343,4230560],"length":1,"stats":{"Line":0}},{"line":121,"address":[4231273,4230737,4230516,4230600],"length":1,"stats":{"Line":0}},{"line":122,"address":[4230775,4230861,4231268,4230695],"length":1,"stats":{"Line":0}},{"line":123,"address":[4231263,4230960,4231102],"length":1,"stats":{"Line":0}},{"line":124,"address":[4230841,4230907,4230950],"length":1,"stats":{"Line":0}},{"line":125,"address":[4230952],"length":1,"stats":{"Line":0}},{"line":127,"address":[4230942],"length":1,"stats":{"Line":0}},{"line":130,"address":[4231063,4231123],"length":1,"stats":{"Line":0}},{"line":132,"address":[4219761],"length":1,"stats":{"Line":1}},{"line":133,"address":[4219714],"length":1,"stats":{"Line":1}},{"line":135,"address":[4219754],"length":1,"stats":{"Line":1}}],"covered":18,"coverable":96},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","extended","char_exists_response.rs"],"content":"use l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct CharExistsResponse {\n    buffer: SendablePacketBuffer,\n    allow_response: i32,\n}\n\nimpl CharExistsResponse {\n    const PACKET_ID: u8 = 0xFE;\n    const EX_PACKET_ID: u16 = 0x10B;\n    pub fn new(allow_response: i32) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            allow_response,\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_u16(Self::EX_PACKET_ID)?;\n        inst.buffer.write_i32(inst.allow_response)?;\n        Ok(inst)\n    }\n}\n","traces":[{"line":14,"address":[4002432,4002998],"length":1,"stats":{"Line":0}},{"line":16,"address":[4002460],"length":1,"stats":{"Line":0}},{"line":19,"address":[4002662,4002996,4002505,4002573],"length":1,"stats":{"Line":0}},{"line":20,"address":[4002994,4002788,4002700,4002631],"length":1,"stats":{"Line":0}},{"line":21,"address":[4002826,4002758,4002937,4002980],"length":1,"stats":{"Line":0}},{"line":22,"address":[4002884],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","extended","mod.rs"],"content":"mod char_exists_response;\npub use self::char_exists_response::*;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","login_response.rs"],"content":"use l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\n#[allow(unused)]\npub struct PlayerLoginResponse {\n    buffer: SendablePacketBuffer,\n    reason: u32,\n    is_ok: bool,\n}\n\nimpl PlayerLoginResponse {\n    pub const PACKET_ID: u8 = 0x0A;\n    pub const SYSTEM_ERROR_LOGIN_LATER: u32 = 1;\n    pub fn ok() -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = SendablePacketBuffer::new();\n        buffer.write(Self::PACKET_ID)?;\n        buffer.write_i32(-1)?;\n        buffer.write_u32(0)?;\n        Ok(Self {\n            buffer,\n            reason: 0,\n            is_ok: true,\n        })\n    }\n    pub fn fail(reason: u32) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = SendablePacketBuffer::new();\n        buffer.write(Self::PACKET_ID)?;\n        buffer.write_i32(0)?;\n        buffer.write_u32(reason)?;\n        Ok(Self {\n            buffer,\n            reason,\n            is_ok: false,\n        })\n    }\n}\n","traces":[{"line":15,"address":[3697392,3698011],"length":1,"stats":{"Line":1}},{"line":16,"address":[3697409],"length":1,"stats":{"Line":1}},{"line":17,"address":[3697433,3698009,3697583,3697500],"length":1,"stats":{"Line":2}},{"line":18,"address":[3697618,3697698,3697552,3698007],"length":1,"stats":{"Line":2}},{"line":19,"address":[3697992,3697670,3697733,3697952],"length":1,"stats":{"Line":2}},{"line":20,"address":[3697844],"length":1,"stats":{"Line":1}},{"line":21,"address":[3697792],"length":1,"stats":{"Line":1}},{"line":26,"address":[3698048,3698697],"length":1,"stats":{"Line":0}},{"line":27,"address":[3698076],"length":1,"stats":{"Line":0}},{"line":28,"address":[3698100,3698167,3698695,3698247],"length":1,"stats":{"Line":0}},{"line":29,"address":[3698693,3698370,3698282,3698219],"length":1,"stats":{"Line":0}},{"line":30,"address":[3698344,3698678,3698408,3698635],"length":1,"stats":{"Line":0}},{"line":31,"address":[3698531],"length":1,"stats":{"Line":0}},{"line":32,"address":[3698479],"length":1,"stats":{"Line":0}}],"covered":7,"coverable":14},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","mod.rs"],"content":"mod protocol_response;\nmod login_response;\nmod char_selection;\nmod new_char_response;\npub mod extended;\nmod char_create_fail;\nmod char_create_ok;\nmod char_delete_fail;\nmod char_selected;\n\npub use protocol_response::*;\npub use login_response::*;\npub use char_selection::*;\npub use new_char_response::*;\npub use char_create_fail::*;\npub use char_create_ok::*;\npub use char_delete_fail::*;\npub use char_selected::*;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","new_char_response.rs"],"content":"use crate::controller::Controller;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct NewCharacterResponse {\n    buffer: SendablePacketBuffer,\n}\n\nimpl NewCharacterResponse {\n    const PACKET_ID: i32 = 0x0D;\n    #[allow(clippy::cast_possible_truncation)]\n    #[allow(clippy::cast_possible_wrap)]\n    pub fn new(controller: \u0026Controller) -\u003e anyhow::Result\u003cSelf\u003e {\n        let templates = controller\n            .class_templates\n            .get_available_templates_for_registration();\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write_i32(Self::PACKET_ID)?;\n        inst.buffer.write_i32(templates.len() as i32)?;\n        for t in \u0026templates {\n            inst.buffer.write_i32(t.class_id.get_class().race as i32)?;\n            inst.buffer.write_i32(t.class_id as i32)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_str)?;\n            inst.buffer.write_i32(1)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_dex)?;\n            inst.buffer.write_i32(1)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_con)?;\n            inst.buffer.write_i32(1)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_int)?;\n            inst.buffer.write_i32(1)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_wit)?;\n            inst.buffer.write_i32(1)?;\n            inst.buffer.write_i32(99)?;\n            inst.buffer.write_i32(t.static_data.base_men)?;\n            inst.buffer.write_i32(1)?;\n        }\n        Ok(inst)\n    }\n}\n","traces":[{"line":14,"address":[5150464,5154327],"length":1,"stats":{"Line":0}},{"line":15,"address":[5150514],"length":1,"stats":{"Line":0}},{"line":19,"address":[5150542],"length":1,"stats":{"Line":0}},{"line":21,"address":[5150710,5150633,5150805,5154307],"length":1,"stats":{"Line":0}},{"line":22,"address":[5150782,5154305,5150986,5150846],"length":1,"stats":{"Line":0}},{"line":23,"address":[5151257,5150955,5151035],"length":1,"stats":{"Line":0}},{"line":24,"address":[5151540,5151329,5151281,5154303],"length":1,"stats":{"Line":0}},{"line":25,"address":[5151685,5154301,5151581,5151481],"length":1,"stats":{"Line":0}},{"line":26,"address":[5151839,5151645,5154299,5151726],"length":1,"stats":{"Line":0}},{"line":27,"address":[5151798,5154297,5151984,5151880],"length":1,"stats":{"Line":0}},{"line":28,"address":[5154295,5151944,5152129,5152025],"length":1,"stats":{"Line":0}},{"line":29,"address":[5152089,5152170,5152283,5154293],"length":1,"stats":{"Line":0}},{"line":30,"address":[5152242,5152324,5154291,5152428],"length":1,"stats":{"Line":0}},{"line":31,"address":[5152388,5152469,5154289,5152573],"length":1,"stats":{"Line":0}},{"line":32,"address":[5152533,5154287,5152614,5152727],"length":1,"stats":{"Line":0}},{"line":33,"address":[5154285,5152872,5152686,5152768],"length":1,"stats":{"Line":0}},{"line":34,"address":[5154283,5152832,5152913,5153017],"length":1,"stats":{"Line":0}},{"line":35,"address":[5153058,5153168,5154281,5152977],"length":1,"stats":{"Line":0}},{"line":36,"address":[5153301,5153206,5153130,5154279],"length":1,"stats":{"Line":0}},{"line":37,"address":[5153264,5153434,5153339,5154277],"length":1,"stats":{"Line":0}},{"line":38,"address":[5153472,5153576,5153397,5154275],"length":1,"stats":{"Line":0}},{"line":39,"address":[5154273,5153614,5153709,5153538],"length":1,"stats":{"Line":0}},{"line":40,"address":[5154271,5153747,5153842,5153672],"length":1,"stats":{"Line":0}},{"line":41,"address":[5153805,5153880,5153984,5154269],"length":1,"stats":{"Line":0}},{"line":42,"address":[5154022,5154117,5154267,5153946],"length":1,"stats":{"Line":0}},{"line":43,"address":[5154080,5154152],"length":1,"stats":{"Line":0}},{"line":45,"address":[5151131],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":27},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","to_client","protocol_response.rs"],"content":"use l2_core::config::gs::GSServer;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[allow(unused)]\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct ProtocolResponse {\n    buffer: SendablePacketBuffer,\n    is_protocol_ok: bool,\n}\n\nimpl ProtocolResponse {\n    const PACKET_ID: u8 = 0x2E;\n    pub fn new(\n        key: \u0026[u8],\n        is_protocol_ok: bool,\n        cfg: \u0026GSServer,\n    ) -\u003e anyhow::Result\u003cProtocolResponse\u003e {\n        let mut buffer = SendablePacketBuffer::new();\n        buffer.write(Self::PACKET_ID)?;\n        buffer.write_bool(is_protocol_ok)?;\n        buffer.write_bytes(\u0026key[0..8])?; // 8 bytes\n        buffer.write_u32(u32::from(cfg.enable_encryption))?; // 0 encryption disabled | 1 enabled\n        buffer.write_u32(u32::from(cfg.server_id))?;\n        buffer.write(1)?; // ???\n        buffer.write_u32(0)?; // obfuscation key\n        buffer.write(1)?; // is_classic\n        Ok(ProtocolResponse {\n            buffer,\n            is_protocol_ok,\n        })\n    }\n    pub fn fail(cfg: \u0026GSServer) -\u003e anyhow::Result\u003cProtocolResponse\u003e {\n        let mut buffer = SendablePacketBuffer::new();\n        buffer.write(Self::PACKET_ID)?;\n        buffer.write_bool(false)?;\n        buffer.write_bytes(\u0026[0; 8])?; // 8 bytes\n        buffer.write_u32(u32::from(cfg.enable_encryption))?; // 0 encryption disabled | 1 enabled\n        buffer.write_u32(u32::from(cfg.server_id))?;\n        buffer.write(1)?; // ???\n        buffer.write_u32(0)?; // obfuscation key\n        buffer.write(1)?; // is_classic\n        Ok(ProtocolResponse {\n            buffer,\n            is_protocol_ok: false,\n        })\n    }\n}\n","traces":[{"line":14,"address":[4427696,4429503],"length":1,"stats":{"Line":1}},{"line":19,"address":[4427785],"length":1,"stats":{"Line":1}},{"line":20,"address":[4428006,4427818,4427894,4429501],"length":1,"stats":{"Line":2}},{"line":21,"address":[4428047,4427965,4428381,4429499],"length":1,"stats":{"Line":2}},{"line":22,"address":[4429497,4428427,4428559],"length":1,"stats":{"Line":1}},{"line":23,"address":[4429495,4428721,4428522,4428596],"length":1,"stats":{"Line":3}},{"line":24,"address":[4428691,4428882,4429493,4428758],"length":1,"stats":{"Line":2}},{"line":25,"address":[4428920,4429012,4428845,4429491],"length":1,"stats":{"Line":2}},{"line":26,"address":[4428978,4429489,4429145,4429050],"length":1,"stats":{"Line":2}},{"line":27,"address":[4429471,4429108,4429425,4429183],"length":1,"stats":{"Line":2}},{"line":28,"address":[4429324],"length":1,"stats":{"Line":1}},{"line":29,"address":[4429260],"length":1,"stats":{"Line":1}},{"line":33,"address":[4429536,4431005],"length":1,"stats":{"Line":1}},{"line":34,"address":[4429575],"length":1,"stats":{"Line":1}},{"line":35,"address":[4429608,4429684,4431003,4429785],"length":1,"stats":{"Line":2}},{"line":36,"address":[4429748,4429928,4431001,4429826],"length":1,"stats":{"Line":2}},{"line":37,"address":[4429884,4430069,4429966,4430999],"length":1,"stats":{"Line":2}},{"line":38,"address":[4430231,4430032,4430106,4430997],"length":1,"stats":{"Line":2}},{"line":39,"address":[4430268,4430201,4430995,4430392],"length":1,"stats":{"Line":2}},{"line":40,"address":[4430355,4430430,4430993,4430522],"length":1,"stats":{"Line":2}},{"line":41,"address":[4430991,4430488,4430655,4430560],"length":1,"stats":{"Line":2}},{"line":42,"address":[4430618,4430693,4430927,4430973],"length":1,"stats":{"Line":2}},{"line":43,"address":[4430827],"length":1,"stats":{"Line":1}},{"line":44,"address":[4430763],"length":1,"stats":{"Line":1}}],"covered":24,"coverable":24},{"path":["/","home","runner","work","L2Shablya","L2Shablya","game","src","packets","utils.rs"],"content":"use crate::packets::enums::CharNameResponseVariant;\nuse entities::entities::character;\nuse entities::DBPool;\n\npub async fn validate_can_create_char(\n    db_pool: \u0026DBPool,\n    char_name: \u0026str,\n) -\u003e anyhow::Result\u003cCharNameResponseVariant\u003e {\n    if char_name.len() \u003e 16 || char_name.len() \u003c 3 {\n        return Ok(CharNameResponseVariant::InvalidLength);\n    } else if !char_name.chars().all(char::is_alphanumeric) {\n        return Ok(CharNameResponseVariant::InvalidName);\n    } else if character::Model::char_exists(db_pool, char_name).await? {\n        return Ok(CharNameResponseVariant::AlreadyExists);\n    }\n    Ok(CharNameResponseVariant::Ok)\n}\n","traces":[{"line":5,"address":[5303584],"length":1,"stats":{"Line":0}},{"line":9,"address":[4156076,4155972,4156144],"length":1,"stats":{"Line":0}},{"line":10,"address":[4156104],"length":1,"stats":{"Line":0}},{"line":11,"address":[4156160],"length":1,"stats":{"Line":0}},{"line":12,"address":[4156226],"length":1,"stats":{"Line":0}},{"line":13,"address":[4156456,4156922,4156367,4156011,4156279],"length":1,"stats":{"Line":0}},{"line":14,"address":[4156881],"length":1,"stats":{"Line":0}},{"line":16,"address":[4156840],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":8},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","config","gs.rs"],"content":"use crate::config::login::GSMessages;\nuse crate::dto::{Database, InboundConnection, OutboundConnection, Runtime, ServerHost};\nuse crate::shared_packets::common::ServerType;\nuse crate::traits::ServerConfig;\nuse log::{error, info};\nuse num::BigInt;\nuse num_traits::Num;\nuse pnet::datalink;\nuse reqwest::blocking;\nuse serde::de::Error;\nuse serde::{Deserialize, Deserializer};\nuse std::fs::File;\nuse std::io::BufReader;\nuse std::net::Ipv4Addr;\nuse std::str::FromStr;\n\n#[allow(clippy::struct_excessive_bools)]\n#[derive(Debug, Clone, Deserialize)]\npub struct GSServer {\n    pub name: String,\n    pub blowfish_key: String,\n    pub runtime: Option\u003cRuntime\u003e,\n    pub listeners: Listeners,\n    pub database: Database,\n    pub client: Client,\n    #[serde(deserialize_with = \"deserialize_hex_to_bigint\")]\n    pub hex_id: BigInt,\n    pub server_id: u8,\n    pub accept_alternative_id: bool,\n    pub allowed_revisions: Vec\u003ci32\u003e,\n    pub enable_encryption: bool,\n    pub host_reserved: bool,\n    pub use_brackets: bool,\n    pub max_players: u32,\n    #[serde(deserialize_with = \"deserialize_server_type\")]\n    pub server_type: ServerType,\n    pub server_age: u8,\n    pub gm_only: bool,\n    #[serde(default)]\n    pub ip_config: Vec\u003cServerHost\u003e,\n    #[serde(default = \"default_chars_on_acc\")]\n    pub max_chars_on_account: u8,\n    pub rates: Rates,\n}\n\nfn default_chars_on_acc() -\u003e u8 {\n    7\n}\n\nfn deserialize_hex_to_bigint\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cBigInt, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    let s = String::deserialize(deserializer)?;\n    BigInt::from_str_radix(\u0026s, 16).map_err(Error::custom)\n}\n\nfn deserialize_server_type\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cServerType, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    let s = String::deserialize(deserializer)?;\n    ServerType::from_str(\u0026s).map_err(Error::custom)\n}\n\nimpl GSServer {\n    #[must_use]\n    pub fn get_hosts(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.ip_config\n            .iter()\n            .flat_map(|h| vec![h.subnet.to_string(), h.ip.to_string()])\n            .collect()\n    }\n    fn auto_ip_config(\u0026mut self) {\n        // Get all network interfaces\n        let interfaces = datalink::interfaces();\n        // Filter and collect pairs of (subnet, IP address)\n        for i_face in \u0026interfaces {\n            for ip in \u0026i_face.ips {\n                if let pnet::ipnetwork::IpNetwork::V4(ipv4) = ip {\n                    self.ip_config.push(ServerHost {\n                        ip: ipv4.ip(),\n                        subnet: *ipv4,\n                    });\n                }\n            }\n        }\n        let Ok(resp) = blocking::get(\"https://checkip.amazonaws.com/\") else {\n            return;\n        };\n        if !resp.status().is_success() {\n            return;\n        }\n        let Ok(external_ip) = resp.text() else {\n            return;\n        };\n        if let Ok(ip) = Ipv4Addr::from_str(external_ip.trim()) {\n            self.ip_config.push(ServerHost {\n                ip,\n                subnet: \"0.0.0.0/0\"\n                    .parse()\n                    .expect(\"WTF: can not parse statically defined ip address\"),\n            });\n        } else {\n            error!(\"Failed to parse external IP address: {}\", external_ip);\n        }\n    }\n}\n\nimpl ServerConfig for GSServer {\n    fn load(file_name: \u0026str) -\u003e Self {\n        let file = File::open(file_name)\n            .unwrap_or_else(|e| panic!(\"Failed to open config file: {file_name}. Error: {e}\"));\n        let reader = BufReader::new(file);\n        let mut config: GSServer = serde_yaml::from_reader(reader).unwrap_or_else(|e| {\n            panic!(\"Unable to parse {file_name}, the format is incorrect, {e}\")\n        });\n        info!(\"Configuration ok, starting application: {}\", config.name);\n        if config.ip_config.is_empty() {\n            info!(\"Missing ip config, using autoconfiguration\");\n            config.auto_ip_config();\n        }\n        config\n    }\n\n    fn from_string(conf: \u0026str) -\u003e Self {\n        serde_yaml::from_str::\u003cGSServer\u003e(conf)\n            .unwrap_or_else(|e| panic!(\"Unable to parse {conf}, the format is incorrect, {e}\"))\n    }\n\n    fn runtime(\u0026self) -\u003e Option\u003c\u0026Runtime\u003e {\n        self.runtime.as_ref()\n    }\n\n    fn database(\u0026self) -\u003e \u0026Database {\n        \u0026self.database\n    }\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct ClientListener {\n    pub connection: InboundConnection,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct LoginServerConnector {\n    pub connection: OutboundConnection,\n    pub messages: GSMessages,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Listeners {\n    pub clients: ClientListener,\n    pub login_server: LoginServerConnector,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Client {\n    pub timeout: u8,\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct Rates {\n    pub vitality_exp_multiplier: i32,\n}\n","traces":[{"line":50,"address":[12155024,12155323],"length":1,"stats":{"Line":1}},{"line":54,"address":[2901770,2901641],"length":1,"stats":{"Line":1}},{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":58,"address":[2902223,2901936],"length":1,"stats":{"Line":1}},{"line":62,"address":[2901961,2902090],"length":1,"stats":{"Line":1}},{"line":63,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[3002032],"length":1,"stats":{"Line":0}},{"line":69,"address":[12503408],"length":1,"stats":{"Line":0}},{"line":71,"address":[12452695,12452656],"length":1,"stats":{"Line":0}},{"line":74,"address":[12505220,12503488,12505699],"length":1,"stats":{"Line":0}},{"line":76,"address":[12503511],"length":1,"stats":{"Line":0}},{"line":78,"address":[12503639,12503552,12503758],"length":1,"stats":{"Line":0}},{"line":79,"address":[12373738,12372190],"length":1,"stats":{"Line":0}},{"line":80,"address":[3004025],"length":1,"stats":{"Line":0}},{"line":81,"address":[12373890,12374042],"length":1,"stats":{"Line":0}},{"line":82,"address":[12505486],"length":1,"stats":{"Line":0}},{"line":83,"address":[12505607],"length":1,"stats":{"Line":0}},{"line":88,"address":[3002432,3002359],"length":1,"stats":{"Line":0}},{"line":89,"address":[12505304],"length":1,"stats":{"Line":0}},{"line":91,"address":[12503926,12504009],"length":1,"stats":{"Line":0}},{"line":94,"address":[3002687],"length":1,"stats":{"Line":0}},{"line":97,"address":[12504390,12504294],"length":1,"stats":{"Line":0}},{"line":98,"address":[3003314,3003134],"length":1,"stats":{"Line":0}},{"line":100,"address":[3003145,3003217],"length":1,"stats":{"Line":0}},{"line":105,"address":[3003406,3003172,3003454,3003613],"length":1,"stats":{"Line":0}},{"line":111,"address":[12375170,12374128],"length":1,"stats":{"Line":0}},{"line":112,"address":[12374161],"length":1,"stats":{"Line":0}},{"line":113,"address":[12156102,12156000,12156016,12156241],"length":1,"stats":{"Line":0}},{"line":114,"address":[12505826],"length":1,"stats":{"Line":0}},{"line":115,"address":[12505853],"length":1,"stats":{"Line":0}},{"line":116,"address":[2903137,2902912],"length":1,"stats":{"Line":0}},{"line":118,"address":[3004641,3004485,3004788,3004571],"length":1,"stats":{"Line":0}},{"line":119,"address":[3004965,3004577],"length":1,"stats":{"Line":0}},{"line":120,"address":[3005119,3005007],"length":1,"stats":{"Line":0}},{"line":121,"address":[3005317,3005067],"length":1,"stats":{"Line":0}},{"line":123,"address":[3004976],"length":1,"stats":{"Line":0}},{"line":126,"address":[3005344],"length":1,"stats":{"Line":1}},{"line":127,"address":[12506810],"length":1,"stats":{"Line":1}},{"line":128,"address":[2903473,2903334,2903232,2903248],"length":1,"stats":{"Line":0}},{"line":131,"address":[3005440],"length":1,"stats":{"Line":0}},{"line":132,"address":[3005445],"length":1,"stats":{"Line":0}},{"line":135,"address":[3005456],"length":1,"stats":{"Line":0}},{"line":136,"address":[3005464],"length":1,"stats":{"Line":0}}],"covered":8,"coverable":43},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","config","login.rs"],"content":"use crate::dto::{Database, InboundConnection, Runtime};\nuse crate::traits::ServerConfig;\nuse num::BigInt;\nuse num_traits::Num;\nuse serde::{Deserialize, Deserializer};\nuse std::fs::File;\nuse std::io::BufReader;\nuse tracing::info;\n\n#[derive(Debug, Clone, Deserialize)]\npub struct LoginServer {\n    pub name: String,\n    pub blowfish_key: String,\n    pub runtime: Option\u003cRuntime\u003e,\n    #[serde(deserialize_with = \"validate_allowed_gs_keys\")]\n    pub allowed_gs: Option\u003cVec\u003cBigInt\u003e\u003e,\n    pub listeners: Listeners,\n    pub database: Database,\n    pub client: Client,\n}\n\nimpl ServerConfig for LoginServer {\n    fn load(file_name: \u0026str) -\u003e Self {\n        let file = File::open(file_name)\n            .unwrap_or_else(|e| panic!(\"Failed to open config file: {file_name}. Error: {e}\"));\n        let reader = BufReader::new(file);\n        let config: LoginServer = serde_yaml::from_reader(reader).unwrap_or_else(|e| {\n            panic!(\"Unable to parse {file_name}, the format is incorrect, {e}\")\n        });\n        info!(\"Configuration ok, starting application: {}\", config.name);\n        config\n    }\n    fn from_string(conf: \u0026str) -\u003e Self {\n        serde_yaml::from_str::\u003cLoginServer\u003e(conf)\n            .unwrap_or_else(|e| panic!(\"Unable to parse {conf}, the format is incorrect, {e}\"))\n    }\n\n    fn runtime(\u0026self) -\u003e Option\u003c\u0026Runtime\u003e {\n        self.runtime.as_ref()\n    }\n    fn database(\u0026self) -\u003e \u0026Database {\n        \u0026self.database\n    }\n}\n\n// Custom deserialization function to validate that all keys in the HashMap are valid hex strings\nfn validate_allowed_gs_keys\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cOption\u003cVec\u003cBigInt\u003e\u003e, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    // Deserialize the list of strings\n    let list: Option\u003cVec\u003cString\u003e\u003e = Option::deserialize(deserializer)?;\n\n    if let Some(severs) = list {\n        // Try to convert the keys into BigInt, returning an error if any are invalid\n        let mut converted = Vec::new();\n        for key in severs {\n            match BigInt::from_str_radix(\u0026key, 16) {\n                Ok(big_int) =\u003e converted.push(big_int),\n                Err(_) =\u003e {\n                    return Err(serde::de::Error::custom(format!(\n                        \"Invalid hex key: '{key}'\"\n                    )));\n                }\n            }\n        }\n        return Ok(Some(converted));\n    }\n\n    Ok(None)\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct GSListener {\n    pub connection: InboundConnection,\n    pub messages: GSMessages,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct ClientListener {\n    pub connection: InboundConnection,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Listeners {\n    pub game_servers: GSListener,\n    pub clients: ClientListener,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Client {\n    pub timeout: u8,\n    pub show_licence: bool,\n    pub enable_cmdline_login: bool,\n    pub auto_create_accounts: bool,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct GSMessages {\n    pub timeout: u8,\n}\n","traces":[{"line":23,"address":[12426555,12425280,12428277],"length":1,"stats":{"Line":0}},{"line":24,"address":[2968231],"length":1,"stats":{"Line":0}},{"line":25,"address":[2699473,2699232,2699248,2699334],"length":1,"stats":{"Line":0}},{"line":26,"address":[12134347],"length":1,"stats":{"Line":0}},{"line":27,"address":[12795472,12795786],"length":1,"stats":{"Line":0}},{"line":28,"address":[12035697,12035472],"length":1,"stats":{"Line":0}},{"line":30,"address":[12425658,12426273,12426933,12426759,12426074,12428027,12427848,12426403,12427029,12427533,12426557,12427290,12427354],"length":1,"stats":{"Line":0}},{"line":31,"address":[2969583],"length":1,"stats":{"Line":0}},{"line":33,"address":[12428304],"length":1,"stats":{"Line":1}},{"line":34,"address":[12428331],"length":1,"stats":{"Line":1}},{"line":35,"address":[12036033,12035792,12035894,12035808],"length":1,"stats":{"Line":0}},{"line":38,"address":[12137360],"length":1,"stats":{"Line":0}},{"line":39,"address":[12428405],"length":1,"stats":{"Line":0}},{"line":41,"address":[2971328],"length":1,"stats":{"Line":0}},{"line":42,"address":[2971336],"length":1,"stats":{"Line":0}},{"line":47,"address":[12036128,12037670,12037742],"length":1,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":1}},{"line":57,"address":[12036878,12036824,12036570,12036689],"length":1,"stats":{"Line":4}},{"line":58,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[12037210],"length":1,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":27},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","config","mod.rs"],"content":"/// All config DTO must be inside common module, \n/// as they might be shared between components as arguments\npub mod gs;\npub mod login;\npub mod traits;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","config","traits.rs"],"content":"use serde::de::DeserializeOwned;\nuse std::any::type_name;\nuse std::fmt::Debug;\nuse std::path::PathBuf;\nuse std::{env, fs};\n\npub trait Loadable: Sized + Debug + Clone {\n    fn load() {}\n    fn post_load(\u0026self) {}\n}\n\npub trait ConfigFileLoader: DeserializeOwned + Loadable {\n    const DATA_FILE: \u0026'static str;\n    #[must_use]\n    fn load() -\u003e Self {\n        let mut full_path = PathBuf::from(Self::DATA_FILE);\n        let mut visited_paths = Vec::new(); // Track visited symlinks to prevent loops\n\n        // Resolve symlinks manually to avoid infinite loops\n        while full_path.is_symlink() {\n            assert!(\n                !visited_paths.contains(\u0026full_path),\n                \"Symlink loop detected: {full_path:?}\"\n            );\n            visited_paths.push(full_path.clone());\n\n            full_path = fs::read_link(\u0026full_path).unwrap_or_else(|e| {\n                panic!(\"Failed to resolve symlink {}: {e}\", full_path.display())\n            });\n        }\n\n        // Ensure we get an absolute path\n        full_path = full_path\n            .canonicalize()\n            .unwrap_or_else(|_| env::current_dir().unwrap().join(Self::DATA_FILE));\n        let file_content = fs::read_to_string(\u0026full_path).unwrap_or_else(|e| {\n            panic!(\n                \"Can't read config file {} (resolved path: {}), because of: {e}\",\n                Self::DATA_FILE,\n                full_path.display()\n            )\n        });\n\n        let config_name = type_name::\u003cSelf\u003e();\n        let inst: Self = serde_yaml::from_str(\u0026file_content)\n            .unwrap_or_else(|e| panic!(\"Can't parse {config_name}, because of: {e}\"));\n\n        inst.post_load();\n        inst\n    }\n}\n\npub trait LoadFileHandler {\n    type TargetConfigType: DeserializeOwned + Debug;\n    fn for_each(\u0026mut self, item: Self::TargetConfigType);\n}\npub trait ConfigDirLoader: Loadable + Default + LoadFileHandler {\n    const DATA_DIR: \u0026'static str;\n    #[must_use]\n    fn load() -\u003e Self {\n        let dir_entries = fs::read_dir(Self::DATA_DIR).unwrap_or_else(|e| {\n            panic!(\n                \"Can't open {} to read config directory. {e}\",\n                Self::DATA_DIR\n            )\n        });\n        let mut config = Self::default();\n        for dir_entry in dir_entries {\n            let path = dir_entry.expect(\"Can not read dir entry\").path();\n            if path.is_file() \u0026\u0026 path.extension().and_then(|ext| ext.to_str()) == Some(\"yaml\") {\n                let file = fs::read_to_string(path).expect(\"Can not read file\");\n                let inst: Self::TargetConfigType =\n                    serde_yaml::from_str(\u0026file).expect(\"Can't read experience table\");\n                config.for_each(inst);\n            }\n        }\n        config.post_load();\n        config\n    }\n}\n","traces":[{"line":8,"address":[3772512],"length":1,"stats":{"Line":0}},{"line":9,"address":[3772533,3772528],"length":1,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":3}},{"line":16,"address":[],"length":0,"stats":{"Line":4}},{"line":17,"address":[3771219,3771267],"length":1,"stats":{"Line":8}},{"line":20,"address":[4434174,4434106,4435179],"length":1,"stats":{"Line":8}},{"line":21,"address":[4435184],"length":1,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[3772196,3772083],"length":1,"stats":{"Line":0}},{"line":27,"address":[4435137,4435010],"length":1,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":11}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[4434418],"length":1,"stats":{"Line":4}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[3771716,3771645],"length":1,"stats":{"Line":7}},{"line":45,"address":[],"length":0,"stats":{"Line":5}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[3771828],"length":1,"stats":{"Line":5}},{"line":49,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":3}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":68,"address":[],"length":0,"stats":{"Line":12}},{"line":69,"address":[],"length":0,"stats":{"Line":4}},{"line":70,"address":[],"length":0,"stats":{"Line":8}},{"line":71,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":4}},{"line":77,"address":[],"length":0,"stats":{"Line":2}},{"line":78,"address":[],"length":0,"stats":{"Line":2}}],"covered":22,"coverable":40},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","constants.rs"],"content":"use anyhow::bail;\n\npub const PROTOCOL_REVISION: i32 = 0x0106;\n/// # Errors\n/// - when server id is not in the list\npub fn try_get_server_name_by_id(server_id: u8) -\u003e anyhow::Result\u003cString\u003e {\n    if (0..127).contains(\u0026server_id) {\n        return Ok(SERVER_NAMES[server_id as usize - 1].to_owned());\n    }\n    bail!(\"Server ID out of range: {}\", server_id);\n}\npub const SERVER_NAMES: \u0026[\u0026str; 127] = \u0026[\n    \"Bartz\",\n    \"Sieghardt\",\n    \"Kain\",\n    \"Lionna\",\n    \"Erica\",\n    \"Gustin\",\n    \"Devianne\",\n    \"Hindemith\",\n    \"Teon (EURO)\",\n    \"Franz (EURO)\",\n    \"Luna (EURO)\",\n    \"Sayha\",\n    \"Aria\",\n    \"Phoenix\",\n    \"Chronos\",\n    \"Naia\",\n    \"Shilen\",\n    \"Magmeld\",\n    \"Bartz (GMT-5)\",\n    \"Event Server\",\n    \"Frikios\",\n    \"Ophylia\",\n    \"Shakdun\",\n    \"Tarziph\",\n    \"Aria\",\n    \"Esenn\",\n    \"Elcardia\",\n    \"Yiana\",\n    \"Seresin\",\n    \"Tarkai\",\n    \"Khadia\",\n    \"Roien\",\n    \"Kallint (Non-PvP)\",\n    \"Baium\",\n    \"Kamael\",\n    \"Beleth\",\n    \"Anakim\",\n    \"Lilith\",\n    \"Thifiel\",\n    \"Lithra\",\n    \"Lockirin\",\n    \"Kakai\",\n    \"Cadmus\",\n    \"Athebaldt\",\n    \"Blackbird\",\n    \"Ramsheart\",\n    \"Esthus\",\n    \"Vasper\",\n    \"Lancer\",\n    \"Ashton\",\n    \"Waytrel\",\n    \"Waltner\",\n    \"Tahnford\",\n    \"Hunter\",\n    \"Dewell\",\n    \"Rodemaye\",\n    \"Ken Rauhel\",\n    \"Ken Abigail\",\n    \"Ken Orwen\",\n    \"Van Holter\",\n    \"Desperion\",\n    \"Einhovant\",\n    \"Schuneimann\",\n    \"Faris\",\n    \"Tor\",\n    \"Carneiar\",\n    \"Dwyllios\",\n    \"Baium\",\n    \"Hallate\",\n    \"Zaken\",\n    \"Core\",\n    \"72\",\n    \"73\",\n    \"74\",\n    \"75\",\n    \"76\",\n    \"77\",\n    \"78\",\n    \"79\",\n    \"80\",\n    \"81\",\n    \"82\",\n    \"83\",\n    \"84\",\n    \"85\",\n    \"86\",\n    \"87\",\n    \"88\",\n    \"89\",\n    \"90\",\n    \"91\",\n    \"92\",\n    \"93\",\n    \"94\",\n    \"95\",\n    \"96\",\n    \"97\",\n    \"98\",\n    \"99\",\n    \"100\",\n    \"101\",\n    \"102\",\n    \"103\",\n    \"104\",\n    \"105\",\n    \"106\",\n    \"107\",\n    \"108\",\n    \"109\",\n    \"110\",\n    \"111\",\n    \"112\",\n    \"113\",\n    \"114\",\n    \"115\",\n    \"116\",\n    \"117\",\n    \"118\",\n    \"119\",\n    \"120\",\n    \"121\",\n    \"122\",\n    \"123\",\n    \"124\",\n    \"125\",\n    \"126\",\n    \"???\",\n];\n","traces":[{"line":6,"address":[3010672],"length":1,"stats":{"Line":0}},{"line":7,"address":[3010696],"length":1,"stats":{"Line":0}},{"line":8,"address":[3010964,3011007],"length":1,"stats":{"Line":0}},{"line":10,"address":[3010926,3010823],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","crypt","game.rs"],"content":"use crate::crypt::BLOWFISH_KEY_SIZE;\nuse crate::errors::Packet;\nuse anyhow::bail;\n\n#[derive(Debug)]\npub struct GameClientEncryption {\n    in_key: [u8; BLOWFISH_KEY_SIZE],\n    out_key: [u8; BLOWFISH_KEY_SIZE],\n    is_enabled: bool,\n}\nimpl GameClientEncryption {\n    /// # Errors\n    /// - when the key is not equal to 16 bytes\n    pub fn new(key: \u0026[u8]) -\u003e anyhow::Result\u003cGameClientEncryption\u003e {\n        if key.len() != BLOWFISH_KEY_SIZE {\n            bail!(Packet::SendPacketError);\n        }\n        let mut key_array: [u8; 16] = [0; 16];\n        key_array.clone_from_slice(\u0026key[..16]);\n        //because of implicit copy, these will be two different arrays\n        Ok(Self {\n            in_key: key_array,  //copy 1\n            out_key: key_array, //copy 2\n            is_enabled: false,\n        })\n    }\n\n    /// # Errors\n    /// - when data size is too big, in this case data.len will try to convert to i32 and fail\n    pub fn decrypt(\u0026mut self, data: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n        if !self.is_enabled {\n            self.is_enabled = true;\n            return Ok(());\n        }\n\n        let mut x_or = 0u8;\n        for (i, byte) in data.iter_mut().enumerate() {\n            let encrypted = *byte;\n            *byte ^= self.in_key[i \u0026 15] ^ x_or;\n            x_or = encrypted;\n        }\n        // Shift key efficiently\n        let old = u32::from_le_bytes(self.in_key[8..12].try_into()?) + u32::try_from(data.len())?;\n        self.in_key[8..12].copy_from_slice(\u0026old.to_le_bytes());\n        Ok(())\n    }\n    /// # Errors\n    /// - when data size is too big, in this case data.len will try to convert to i32 and fail\n    pub fn encrypt(\u0026mut self, data: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n        if !self.is_enabled {\n            self.is_enabled = true;\n            return Ok(());\n        }\n\n        let mut encrypted = 0u8;\n        for (i, byte) in data.iter_mut().enumerate() {\n            encrypted ^= *byte ^ self.out_key[i \u0026 15];\n            *byte = encrypted;\n        }\n\n        // Shift key efficiently\n        let old = u32::from_le_bytes(self.out_key[8..12].try_into()?) + u32::try_from(data.len())?;\n        self.out_key[8..12].copy_from_slice(\u0026old.to_le_bytes());\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::crypt::game::GameClientEncryption;\n\n    #[test]\n    fn encrypt_works() {\n        let the_key = [23, 17, 0, 1, 78, 198, 12, 8, 56, 110, 10, 9, 121, 34, 6, 8];\n        let mut encryption = GameClientEncryption::new(\u0026the_key).unwrap();\n        let mut data = [0, 12, 34, 56, 78, 198, 12, 32, 56, 0, 1, 9, 12, 34, 56];\n        let unchanged = data; //copy\n        encryption.encrypt(\u0026mut data).unwrap();\n        assert_eq!(data, unchanged);\n        encryption.encrypt(\u0026mut data).unwrap();\n        assert_ne!(unchanged, data);\n        assert_eq!(\n            data,\n            [23, 10, 40, 17, 17, 17, 17, 57, 57, 87, 92, 92, 41, 41, 23]\n        );\n        encryption.encrypt(\u0026mut data).unwrap();\n        assert_eq!(\n            data,\n            [0, 27, 51, 35, 124, 171, 182, 135, 249, 192, 150, 195, 147, 152, 137]\n        );\n    }\n    #[test]\n    fn decrypt_works() {\n        let the_key = [23, 17, 0, 1, 78, 198, 12, 8, 56, 110, 10, 9, 121, 34, 6, 8];\n        let mut encryption = GameClientEncryption::new(\u0026the_key).unwrap();\n        let mut data = [0, 12, 34, 56, 78, 198, 12, 32, 56, 0, 1, 9, 12, 34, 56];\n        let unchanged = data; //copy\n        encryption.decrypt(\u0026mut data).unwrap();\n        assert_eq!(data, unchanged);\n        encryption.decrypt(\u0026mut data).unwrap();\n        assert_ne!(unchanged, data);\n        assert_eq!(\n            data,\n            [23, 29, 46, 27, 56, 78, 198, 36, 32, 86, 11, 1, 124, 12, 28]\n        );\n        encryption.decrypt(\u0026mut data).unwrap();\n        assert_eq!(\n            data,\n            [0, 27, 51, 52, 109, 176, 132, 234, 67, 24, 87, 3, 4, 82, 22]\n        );\n    }\n}\n","traces":[{"line":14,"address":[12673200,12673934,12673905],"length":1,"stats":{"Line":1}},{"line":15,"address":[3212539],"length":1,"stats":{"Line":1}},{"line":16,"address":[3213075,3213208,3213013],"length":1,"stats":{"Line":0}},{"line":18,"address":[3212557],"length":1,"stats":{"Line":1}},{"line":19,"address":[12673518],"length":1,"stats":{"Line":1}},{"line":21,"address":[3212909],"length":1,"stats":{"Line":1}},{"line":22,"address":[3212845],"length":1,"stats":{"Line":1}},{"line":23,"address":[3212877],"length":1,"stats":{"Line":1}},{"line":30,"address":[3213232],"length":1,"stats":{"Line":1}},{"line":31,"address":[3213278],"length":1,"stats":{"Line":1}},{"line":32,"address":[3213288],"length":1,"stats":{"Line":1}},{"line":33,"address":[3213291],"length":1,"stats":{"Line":1}},{"line":36,"address":[3213312],"length":1,"stats":{"Line":1}},{"line":37,"address":[3214135,3213317,3213694,3213407],"length":1,"stats":{"Line":4}},{"line":38,"address":[3213731],"length":1,"stats":{"Line":1}},{"line":39,"address":[3214119,3213744,3214145],"length":1,"stats":{"Line":2}},{"line":40,"address":[3214131],"length":1,"stats":{"Line":1}},{"line":43,"address":[3214084,3213475,3213768],"length":1,"stats":{"Line":2}},{"line":44,"address":[12674696],"length":1,"stats":{"Line":1}},{"line":45,"address":[3214070],"length":1,"stats":{"Line":1}},{"line":49,"address":[12674896],"length":1,"stats":{"Line":1}},{"line":50,"address":[3214222],"length":1,"stats":{"Line":1}},{"line":51,"address":[3214232],"length":1,"stats":{"Line":1}},{"line":52,"address":[3214235],"length":1,"stats":{"Line":1}},{"line":55,"address":[12674976],"length":1,"stats":{"Line":1}},{"line":56,"address":[3214639,3214261,3215077,3214351],"length":1,"stats":{"Line":4}},{"line":57,"address":[3215087,3214676,3215059],"length":1,"stats":{"Line":2}},{"line":58,"address":[3215071],"length":1,"stats":{"Line":1}},{"line":62,"address":[3215024,3214419,3214706],"length":1,"stats":{"Line":2}},{"line":63,"address":[3214908],"length":1,"stats":{"Line":1}},{"line":64,"address":[3215010],"length":1,"stats":{"Line":1}}],"covered":30,"coverable":31},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","crypt","login.rs"],"content":"use crate::errors::Packet;\nuse blowfish::cipher::{BlockDecrypt, BlockEncrypt, KeyInit};\nuse blowfish::BlowfishLE;\n\n#[derive(Debug, Clone)]\npub struct Encryption {\n    cipher: BlowfishLE,\n}\n\nimpl Encryption {\n    #[must_use]\n    pub fn new(key: \u0026[u8]) -\u003e Self {\n        Self::from_u8_key(key)\n    }\n\n    #[must_use]\n    #[allow(clippy::missing_panics_doc)]\n    pub fn from_u8_key(key: \u0026[u8]) -\u003e Self {\n        let cipher = BlowfishLE::new_from_slice(key).expect(\"Received invalid blowfish key\");\n        Encryption { cipher }\n    }\n\n    fn calculate_checksum_block(raw: \u0026[u8]) -\u003e (u32, u32) {\n        let mut checksum: u32 = 0;\n        let count = raw.len();\n        let mut check: u32 = 0;\n        let mut offset = 0;\n        while offset \u003c count {\n            check = u32::from(raw[offset]) \u0026 0xff;\n            check |= (u32::from(raw[offset + 1]) \u003c\u003c 0x08) \u0026 0xff00;\n            check |= (u32::from(raw[offset + 2]) \u003c\u003c 0x10) \u0026 0x00ff_0000;\n            check |= (u32::from(raw[offset + 3]) \u003c\u003c 0x18) \u0026 0xff00_0000;\n            offset += 4;\n            if offset \u003c count {\n                checksum ^= check;\n            }\n        }\n        (check, checksum)\n    }\n\n    #[must_use]\n    pub fn verify_checksum(raw: \u0026[u8]) -\u003e bool {\n        let size = raw.len();\n        if size \u0026 3 != 0 || size \u003c= 4 {\n            return false;\n        }\n        let (check, checksum) = Self::calculate_checksum_block(raw);\n        check == checksum\n    }\n\n    pub fn append_checksum(raw: \u0026mut [u8]) {\n        let (_, checksum) = Self::calculate_checksum_block(raw);\n        let last = raw.len() - 4; //modify last 4 bytes, starting from offset\n        raw[last] = (checksum \u0026 0xff) as u8;\n        raw[last + 1] = ((checksum \u003e\u003e 0x08) \u0026 0xff) as u8;\n        raw[last + 2] = ((checksum \u003e\u003e 0x10) \u0026 0xff) as u8;\n        raw[last + 3] = ((checksum \u003e\u003e 0x18) \u0026 0xff) as u8;\n    }\n    #[allow(clippy::similar_names)]\n    pub fn enc_xor_pass(raw: \u0026mut [u8], offset: usize, size: usize, key: u32) {\n        let stop = size - 8;\n        let mut pos = 4 + offset;\n        let mut ecx = key; // Initial xor key\n\n        while pos \u003c stop {\n            let edx = u32::from(raw[pos]) \u0026 0xFF\n                | (u32::from(raw[pos + 1]) \u0026 0xFF) \u003c\u003c 8\n                | (u32::from(raw[pos + 2]) \u0026 0xFF) \u003c\u003c 16\n                | (u32::from(raw[pos + 3]) \u0026 0xFF) \u003c\u003c 24;\n\n            ecx = ecx.wrapping_add(edx);\n            let edx_xor = edx ^ ecx;\n\n            raw[pos] = (edx_xor \u0026 0xFF) as u8;\n            raw[pos + 1] = ((edx_xor \u003e\u003e 8) \u0026 0xFF) as u8;\n            raw[pos + 2] = ((edx_xor \u003e\u003e 16) \u0026 0xFF) as u8;\n            raw[pos + 3] = ((edx_xor \u003e\u003e 24) \u0026 0xFF) as u8;\n\n            pos += 4;\n        }\n\n        raw[pos] = (ecx \u0026 0xFF) as u8;\n        raw[pos + 1] = ((ecx \u003e\u003e 8) \u0026 0xFF) as u8;\n        raw[pos + 2] = ((ecx \u003e\u003e 16) \u0026 0xFF) as u8;\n        raw[pos + 3] = ((ecx \u003e\u003e 24) \u0026 0xFF) as u8;\n    }\n\n    #[allow(clippy::missing_errors_doc)]\n    pub fn decrypt(\u0026self, raw: \u0026mut [u8]) -\u003e Result\u003c(), Packet\u003e {\n        let size = raw.len();\n        let offset = 0;\n        if size % 8 \u003e 0 || offset + size \u003e raw.len() {\n            return Err(Packet::DecryptBlowfishError);\n        }\n        for chunk in raw.chunks_mut(8) {\n            self.cipher.decrypt_block(chunk.into());\n        }\n        Ok(())\n    }\n    pub fn encrypt(\u0026self, raw: \u0026mut [u8]) {\n        for chunk in raw.chunks_mut(8) {\n            self.cipher.encrypt_block(chunk.into());\n        }\n    }\n}\n\n#[cfg(test)]\nmod test {\n    use crate::crypt::login::Encryption;\n\n    #[test]\n    fn test_decrypt_auth_gg() {\n        let mut data = [\n            123, 127, 180, 251, 24, 25, 187, 239, 212, 216, 154, 37, 43, 197, 224, 71, 212, 216,\n            154, 37, 43, 197, 224, 71, 207, 203, 144, 187, 61, 185, 36, 74, 212, 216, 154, 37, 43,\n            197, 224, 71,\n        ];\n        let key = [\n            62, 246, 48, 159, 201, 154, 143, 146, 235, 160, 96, 51, 237, 105, 97, 227,\n        ];\n        let decrypted = [\n            7, 219, 128, 157, 70, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65, 219,\n            128, 157, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n        ];\n        let decryptor = Encryption::from_u8_key(\u0026key);\n        let res = decryptor.decrypt(\u0026mut data);\n        assert!(res.is_ok(), \"Result must be ok\");\n        assert_eq!(\n            data, decrypted,\n            \"Auth gg packet should be decrypted correctly\"\n        );\n    }\n\n    #[test]\n    fn test_decrypt_auth_gg_2() {\n        let mut data = [\n            77, 76, 88, 220, 187, 217, 93, 78, 12, 173, 190, 109, 220, 201, 213, 212, 12, 173, 190,\n            109, 220, 201, 213, 212, 203, 11, 135, 129, 151, 169, 216, 152, 12, 173, 190, 109, 220,\n            201, 213, 212,\n        ];\n        let decrypted = [\n            7, 30, 251, 17, 214, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 209, 30,\n            251, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n        ];\n        let key = [\n            12, 84, 204, 79, 78, 136, 249, 67, 63, 70, 44, 61, 28, 224, 9, 31,\n        ];\n        let decryptor = Encryption::from_u8_key(\u0026key);\n        let res = decryptor.decrypt(\u0026mut data);\n        assert!(res.is_ok(), \"Result must be ok\");\n        assert_eq!(\n            data, decrypted,\n            \"Auth gg packet should be decrypted correctly\"\n        );\n    }\n\n    #[test]\n    fn test_append_checksum() {\n        let mut data: Vec\u003cu8\u003e = vec![\n            146, 0, 0, 6, 1, 0, 0, 129, 0, 0, 0, 0, 128, 29, 57, 69, 167, 240, 165, 98, 143, 2,\n            173, 193, 96, 200, 229, 53, 241, 30, 179, 153, 133, 105, 24, 207, 36, 201, 102, 38,\n            231, 177, 44, 77, 156, 76, 85, 99, 160, 111, 109, 104, 151, 52, 255, 76, 13, 130, 181,\n            185, 211, 74, 209, 215, 161, 14, 17, 203, 141, 145, 114, 132, 18, 185, 219, 116, 81,\n            14, 140, 64, 54, 154, 48, 160, 25, 213, 189, 75, 197, 103, 222, 53, 105, 218, 123, 75,\n            103, 208, 251, 47, 44, 21, 14, 178, 62, 117, 188, 171, 87, 32, 211, 79, 42, 27, 152,\n            96, 66, 111, 110, 238, 133, 142, 127, 76, 38, 85, 38, 27, 252, 58, 165, 51, 164, 88,\n            87, 93, 205, 91, 240, 249, 0, 0, 0, 0, 0, 0,\n        ];\n        let data_expected = expected_checksum();\n        let size = data.len();\n        Encryption::append_checksum(\u0026mut data[2..size]);\n        assert_eq!(data, data_expected, \"Append checksum must work\");\n    }\n\n    #[test]\n    fn test_verify_checksum() {\n        let data = expected_checksum();\n        let result = Encryption::verify_checksum(\u0026data[2..data.len()]);\n        assert!(result, \"Verify checksum must work\");\n    }\n\n    #[test]\n    fn verify_checksum_2() {\n        let data = [\n            1, 1, 0, 0, 97, 30, 208, 7, 0, 0, 16, 0, 0, 0, 213, 41, 148, 192, 183, 195, 221, 65,\n            246, 143, 230, 10, 163, 117, 66, 16, 5, 0, 0, 0, 49, 0, 48, 0, 46, 0, 51, 0, 55, 0, 46,\n            0, 49, 0, 50, 0, 57, 0, 46, 0, 48, 0, 47, 0, 50, 0, 52, 0, 0, 0, 49, 0, 48, 0, 46, 0,\n            51, 0, 55, 0, 46, 0, 49, 0, 50, 0, 57, 0, 46, 0, 50, 0, 0, 0, 49, 0, 48, 0, 46, 0, 50,\n            0, 49, 0, 49, 0, 46, 0, 53, 0, 53, 0, 46, 0, 48, 0, 47, 0, 50, 0, 52, 0, 0, 0, 49, 0,\n            48, 0, 46, 0, 50, 0, 49, 0, 49, 0, 46, 0, 53, 0, 53, 0, 46, 0, 50, 0, 0, 0, 49, 0, 57,\n            0, 50, 0, 46, 0, 49, 0, 54, 0, 56, 0, 46, 0, 50, 0, 48, 0, 46, 0, 48, 0, 47, 0, 50, 0,\n            52, 0, 0, 0, 49, 0, 57, 0, 50, 0, 46, 0, 49, 0, 54, 0, 56, 0, 46, 0, 50, 0, 48, 0, 46,\n            0, 49, 0, 48, 0, 50, 0, 0, 0, 49, 0, 50, 0, 55, 0, 46, 0, 48, 0, 46, 0, 48, 0, 46, 0,\n            48, 0, 47, 0, 56, 0, 0, 0, 49, 0, 50, 0, 55, 0, 46, 0, 48, 0, 46, 0, 48, 0, 46, 0, 49,\n            0, 0, 0, 48, 0, 46, 0, 48, 0, 46, 0, 48, 0, 46, 0, 48, 0, 47, 0, 48, 0, 0, 0, 56, 0,\n            57, 0, 46, 0, 50, 0, 51, 0, 52, 0, 46, 0, 50, 0, 52, 0, 53, 0, 46, 0, 49, 0, 54, 0, 0,\n            0, 0, 0, 0, 0, 133, 132, 217, 23,\n        ];\n        let result = Encryption::verify_checksum(\u0026data);\n        assert!(result, \"Verify checksum must work\");\n    }\n\n    #[test]\n    fn test_decrypt_auth_login() {\n        let mut data = [\n            137, 139, 65, 222, 56, 149, 202, 165, 122, 16, 248, 96, 30, 90, 217, 42, 255, 206, 151,\n            22, 238, 153, 189, 236, 206, 179, 95, 83, 48, 120, 66, 158, 220, 186, 172, 73, 190,\n            249, 49, 87, 41, 167, 163, 23, 78, 146, 252, 51, 192, 252, 122, 110, 35, 79, 39, 129,\n            128, 60, 191, 153, 41, 238, 195, 77, 15, 87, 71, 165, 33, 146, 137, 125, 239, 119, 42,\n            140, 118, 110, 77, 121, 146, 111, 191, 173, 196, 11, 22, 220, 164, 237, 18, 124, 110,\n            70, 53, 168, 168, 209, 252, 199, 6, 202, 62, 145, 28, 215, 190, 52, 45, 58, 125, 2, 4,\n            47, 8, 78, 92, 195, 78, 238, 138, 249, 115, 133, 218, 240, 67, 68, 71, 148, 152, 222,\n            160, 225, 146, 119, 31, 222, 176, 6, 206, 222, 160, 207, 91, 194, 138, 75, 137, 0, 84,\n            43, 110, 80, 78, 102, 109, 58, 227, 160, 186, 19, 98, 121, 140, 244, 235, 96, 105, 196,\n            125, 18, 48, 188, 145, 107, 205, 127, 114, 213, 189, 104, 248, 179, 59, 110, 87, 226,\n            37, 189, 15, 239, 31, 202, 20, 105, 51, 143, 139, 102, 76, 19, 166, 26, 86, 255, 220,\n            197, 6, 111, 116, 198, 231, 92, 249, 253, 123, 247, 90, 69, 140, 145, 43, 84, 156, 144,\n            16, 133, 177, 18, 85, 235, 234, 172, 169, 76, 228, 231, 80, 196, 114, 151, 46, 130, 89,\n            135, 162, 245, 40, 139, 200, 100, 200, 183, 216, 32, 88, 174, 255, 24, 8, 117, 225,\n            209, 7, 244, 251, 149, 192, 150, 213, 254, 104, 251, 92, 86, 64, 15, 226, 157, 16, 190,\n            100, 10, 69, 45, 183, 82, 171, 96, 192, 121, 153, 111, 24, 140, 74, 168, 45, 83, 231,\n            7, 209, 67, 191, 2, 56, 110, 216, 208, 149, 72, 7, 244, 251, 149, 192, 150, 213, 254,\n        ];\n        let key = [\n            61, 103, 234, 138, 3, 212, 186, 146, 11, 149, 0, 133, 31, 49, 119, 198,\n        ];\n        let decrypted = [\n            0, 80, 79, 135, 38, 17, 91, 97, 10, 48, 225, 116, 84, 137, 249, 99, 172, 52, 157, 202,\n            67, 62, 189, 136, 165, 137, 162, 199, 119, 49, 39, 76, 16, 53, 113, 196, 180, 131, 254,\n            130, 77, 237, 122, 38, 153, 102, 152, 71, 175, 209, 221, 75, 32, 4, 163, 170, 189, 109,\n            218, 233, 116, 187, 24, 213, 5, 106, 174, 7, 112, 253, 122, 203, 222, 196, 122, 64,\n            145, 164, 156, 247, 92, 150, 242, 255, 46, 133, 235, 32, 176, 186, 84, 250, 33, 46,\n            166, 166, 207, 219, 213, 179, 189, 100, 219, 218, 133, 103, 220, 200, 111, 27, 116,\n            236, 73, 196, 99, 109, 12, 149, 103, 81, 60, 36, 202, 171, 58, 229, 97, 58, 169, 113,\n            76, 252, 102, 219, 50, 173, 237, 57, 176, 9, 166, 210, 149, 4, 98, 118, 89, 153, 92,\n            86, 84, 79, 176, 176, 68, 221, 146, 100, 69, 126, 207, 51, 27, 104, 211, 56, 230, 209,\n            218, 76, 51, 119, 108, 80, 70, 53, 121, 134, 95, 148, 182, 135, 182, 20, 245, 120, 76,\n            135, 119, 235, 13, 164, 225, 201, 213, 8, 238, 191, 230, 49, 5, 125, 250, 159, 197,\n            214, 232, 222, 208, 195, 213, 4, 183, 210, 85, 169, 181, 29, 190, 106, 189, 252, 164,\n            112, 222, 184, 18, 223, 10, 156, 64, 182, 95, 150, 6, 231, 76, 65, 81, 195, 254, 16,\n            201, 221, 11, 13, 115, 131, 108, 160, 196, 156, 199, 116, 45, 159, 132, 131, 94, 215,\n            128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 201, 60, 201,\n            172, 185, 36, 197, 189, 152, 64, 89, 234, 166, 34, 61, 246, 0, 0, 0, 0, 125, 129, 4,\n            174, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n        ];\n        let decryptor = Encryption::from_u8_key(\u0026key);\n        let res = decryptor.decrypt(\u0026mut data);\n        assert!(res.is_ok(), \"Result must be ok\");\n        assert_eq!(\n            data, decrypted,\n            \"Auth gg packet should be decrypted correctly\"\n        );\n    }\n    fn expected_checksum() -\u003e [u8; 146] {\n        [\n            146, 0, 0, 6, 1, 0, 0, 129, 0, 0, 0, 0, 128, 29, 57, 69, 167, 240, 165, 98, 143, 2,\n            173, 193, 96, 200, 229, 53, 241, 30, 179, 153, 133, 105, 24, 207, 36, 201, 102, 38,\n            231, 177, 44, 77, 156, 76, 85, 99, 160, 111, 109, 104, 151, 52, 255, 76, 13, 130, 181,\n            185, 211, 74, 209, 215, 161, 14, 17, 203, 141, 145, 114, 132, 18, 185, 219, 116, 81,\n            14, 140, 64, 54, 154, 48, 160, 25, 213, 189, 75, 197, 103, 222, 53, 105, 218, 123, 75,\n            103, 208, 251, 47, 44, 21, 14, 178, 62, 117, 188, 171, 87, 32, 211, 79, 42, 27, 152,\n            96, 66, 111, 110, 238, 133, 142, 127, 76, 38, 85, 38, 27, 252, 58, 165, 51, 164, 88,\n            87, 93, 205, 91, 240, 249, 0, 0, 189, 153, 155, 43,\n        ]\n    }\n}\n","traces":[{"line":12,"address":[3201616],"length":1,"stats":{"Line":1}},{"line":13,"address":[12340357],"length":1,"stats":{"Line":1}},{"line":18,"address":[3201664],"length":1,"stats":{"Line":2}},{"line":19,"address":[12340446],"length":1,"stats":{"Line":2}},{"line":23,"address":[12340544],"length":1,"stats":{"Line":1}},{"line":24,"address":[12011896],"length":1,"stats":{"Line":1}},{"line":25,"address":[3201840],"length":1,"stats":{"Line":1}},{"line":26,"address":[12340581],"length":1,"stats":{"Line":1}},{"line":27,"address":[12340589],"length":1,"stats":{"Line":1}},{"line":28,"address":[12340603],"length":1,"stats":{"Line":1}},{"line":29,"address":[12340628,12340663,12340703],"length":1,"stats":{"Line":2}},{"line":30,"address":[12012100,12012000,12012057,12012147],"length":1,"stats":{"Line":3}},{"line":31,"address":[12012263,12012216,12012116,12012173],"length":1,"stats":{"Line":4}},{"line":32,"address":[12341050,12340904,12341004,12340961],"length":1,"stats":{"Line":7}},{"line":33,"address":[12341092,12341020,12341075],"length":1,"stats":{"Line":6}},{"line":34,"address":[12341080,12341120],"length":1,"stats":{"Line":6}},{"line":35,"address":[12012436],"length":1,"stats":{"Line":3}},{"line":38,"address":[12340610],"length":1,"stats":{"Line":3}},{"line":42,"address":[3202400],"length":1,"stats":{"Line":1}},{"line":43,"address":[3202423],"length":1,"stats":{"Line":1}},{"line":44,"address":[12012492],"length":1,"stats":{"Line":1}},{"line":45,"address":[3202449],"length":1,"stats":{"Line":0}},{"line":47,"address":[12341201],"length":1,"stats":{"Line":1}},{"line":48,"address":[12341214],"length":1,"stats":{"Line":2}},{"line":51,"address":[12012576],"length":1,"stats":{"Line":1}},{"line":52,"address":[12341272],"length":1,"stats":{"Line":1}},{"line":53,"address":[12341344,12341290],"length":1,"stats":{"Line":1}},{"line":54,"address":[12341327,12341378,12341421],"length":1,"stats":{"Line":2}},{"line":55,"address":[3202711,3202800,3202646],"length":1,"stats":{"Line":2}},{"line":56,"address":[12012890,12012825,12012979],"length":1,"stats":{"Line":2}},{"line":57,"address":[12013060,12012940,12013005],"length":1,"stats":{"Line":2}},{"line":60,"address":[3203024],"length":1,"stats":{"Line":0}},{"line":61,"address":[3203167,3203103],"length":1,"stats":{"Line":0}},{"line":62,"address":[3203148,3203215,3203198],"length":1,"stats":{"Line":0}},{"line":63,"address":[12341942],"length":1,"stats":{"Line":0}},{"line":65,"address":[12013303,12014924,12013277],"length":1,"stats":{"Line":0}},{"line":66,"address":[12013915,12013371,12013928,12014068,12014347,12014202,12013977],"length":1,"stats":{"Line":0}},{"line":67,"address":[3203995,3203873,3203942,3204047],"length":1,"stats":{"Line":0}},{"line":68,"address":[12014193,12014074,12014140,12014245],"length":1,"stats":{"Line":0}},{"line":69,"address":[3204144,3204382,3204210,3204274],"length":1,"stats":{"Line":0}},{"line":71,"address":[12343028,12343051],"length":1,"stats":{"Line":0}},{"line":72,"address":[3204322],"length":1,"stats":{"Line":0}},{"line":74,"address":[12014404,12014483,12014536],"length":1,"stats":{"Line":0}},{"line":75,"address":[12014487,12014565,12014662],"length":1,"stats":{"Line":0}},{"line":76,"address":[12014788,12014613,12014691],"length":1,"stats":{"Line":0}},{"line":77,"address":[12014896,12014739,12014817],"length":1,"stats":{"Line":0}},{"line":79,"address":[12014929,12014860,12014916],"length":1,"stats":{"Line":0}},{"line":82,"address":[12013424,12013492,12013321],"length":1,"stats":{"Line":0}},{"line":83,"address":[12342099,12342196,12342310],"length":1,"stats":{"Line":0}},{"line":84,"address":[3203606,3203509,3203717],"length":1,"stats":{"Line":0}},{"line":85,"address":[12013813,12013719,12013883],"length":1,"stats":{"Line":0}},{"line":89,"address":[12014960],"length":1,"stats":{"Line":1}},{"line":90,"address":[12343700],"length":1,"stats":{"Line":1}},{"line":91,"address":[12343688],"length":1,"stats":{"Line":1}},{"line":92,"address":[3204972,3205067],"length":1,"stats":{"Line":2}},{"line":93,"address":[12015072],"length":1,"stats":{"Line":0}},{"line":95,"address":[12015164,12015315],"length":1,"stats":{"Line":2}},{"line":96,"address":[12015347],"length":1,"stats":{"Line":1}},{"line":98,"address":[3205242],"length":1,"stats":{"Line":1}},{"line":100,"address":[3205328],"length":1,"stats":{"Line":0}},{"line":101,"address":[3205354,3205478],"length":1,"stats":{"Line":0}},{"line":102,"address":[3205501],"length":1,"stats":{"Line":0}}],"covered":37,"coverable":62},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","crypt","mod.rs"],"content":"pub mod login;\npub mod rsa;\npub mod game;\n\npub static STATIC_BLOWFISH_KEY: [u8; 16] = [\n    154, 125, 7, 25, 132, 212, 137, 240, 220, 37, 6, 180, 21, 131, 47, 197,\n];\n\nuse rand::{thread_rng, Rng};\npub const BLOWFISH_KEY_SIZE: usize = 16;\n\n#[must_use]\npub fn generate_blowfish_key(size: Option\u003cusize\u003e) -\u003e Vec\u003cu8\u003e {\n    let the_size = size.unwrap_or(BLOWFISH_KEY_SIZE);\n    let mut key = vec![0u8; the_size];\n    let mut rng = thread_rng();\n    for item in key.iter_mut().take(the_size) {\n        *item = rng.gen();\n    }\n    key\n}\n","traces":[{"line":13,"address":[3001971,3001376],"length":1,"stats":{"Line":2}},{"line":14,"address":[3001435],"length":1,"stats":{"Line":2}},{"line":15,"address":[3001476],"length":1,"stats":{"Line":2}},{"line":16,"address":[3001569,3001507],"length":1,"stats":{"Line":4}},{"line":17,"address":[3001966,3001577,3001654,3001890],"length":1,"stats":{"Line":10}},{"line":18,"address":[3001964,3001911],"length":1,"stats":{"Line":5}},{"line":20,"address":[3001843],"length":1,"stats":{"Line":3}}],"covered":7,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","crypt","rsa.rs"],"content":"use anyhow::{bail, Context};\nuse num_traits::{FromPrimitive, Zero};\nuse pem::parse;\nuse rsa;\nuse rsa::pkcs8::DecodePrivateKey;\nuse rsa::traits::{PrivateKeyParts, PublicKeyParts};\n\n#[derive(Debug, Clone)]\npub struct ScrambledRSAKeyPair {\n    pair: (rsa::RsaPrivateKey, rsa::RsaPublicKey),\n    scrambled_modulus: Vec\u003cu8\u003e,\n    modulus: Vec\u003cu8\u003e,\n}\n\npub struct RSAPublicKey {\n    key: rsa::RsaPublicKey,\n}\n\nimpl RSAPublicKey {\n    #[allow(clippy::missing_errors_doc)]\n    pub fn from_modulus(modulus: \u0026[u8]) -\u003e anyhow::Result\u003cRSAPublicKey\u003e {\n        let modulus = rsa::BigUint::from_bytes_be(modulus);\n        // Use the standard public exponent: 65537 (0x10001)\n        let exponent = rsa::BigUint::from_u32(65537)\n            .context(\"Failed to create BigUint for public exponent\")?;\n\n        // Construct the RSA public key\n        let rsa =\n            rsa::RsaPublicKey::new(modulus, exponent).context(\"Failed to create RSA public key\")?;\n        Ok(RSAPublicKey { key: rsa })\n    }\n\n    ///Encryption with No Padding scheme\n    #[must_use]\n    pub fn encrypt(\u0026self, data: \u0026[u8]) -\u003e Vec\u003cu8\u003e {\n        let m = rsa::BigUint::from_bytes_be(data);\n        m.modpow(self.key.e(), self.key.n()).to_bytes_be()\n    }\n}\n\nimpl ScrambledRSAKeyPair {\n    #[must_use]\n    pub fn new(key: (rsa::RsaPrivateKey, rsa::RsaPublicKey)) -\u003e Self {\n        let (prv, pbc) = key;\n        let modulus = pbc.n();\n        let mut modulus_bytes = modulus.to_bytes_be();\n        //we have to handle the sign -/+ manually\n        if modulus \u003c \u0026rsa::BigUint::zero() {\n            modulus_bytes.insert(0, 0xFF);\n        } else {\n            modulus_bytes.insert(0, 0x00);\n        }\n        ScrambledRSAKeyPair {\n            pair: (prv, pbc),\n            scrambled_modulus: ScrambledRSAKeyPair::scramble_modulus(modulus_bytes.clone()),\n            modulus: modulus_bytes,\n        }\n    }\n    #[must_use]\n    pub fn get_scrambled_modulus(\u0026self) -\u003e Vec\u003cu8\u003e {\n        self.scrambled_modulus.clone()\n    }\n    #[must_use]\n    pub fn get_modulus(\u0026self) -\u003e Vec\u003cu8\u003e {\n        self.modulus.clone()\n    }\n    #[must_use]\n    pub fn scramble_modulus(modulus_bytes: Vec\u003cu8\u003e) -\u003e Vec\u003cu8\u003e {\n        let mut scrambled_mod: Vec\u003cu8\u003e = modulus_bytes;\n\n        if scrambled_mod.len() == 0x81 \u0026\u0026 scrambled_mod[0] == 0x00 {\n            let temp: Vec\u003cu8\u003e = scrambled_mod[1..].to_vec();\n            scrambled_mod = temp;\n        }\n\n        // Step 1: Swap bytes at positions 0x00-0x04 and 0x4d-0x50\n        for i in 0..4 {\n            (scrambled_mod[i], scrambled_mod[0x4d + i]) =\n                (scrambled_mod[0x4d + i], scrambled_mod[i]);\n        }\n\n        // Step 2: XOR first 0x40 bytes with last 0x40 bytes\n        for i in 0..0x40 {\n            scrambled_mod[i] ^= scrambled_mod[0x40 + i];\n        }\n\n        // Step 3: XOR bytes 0x0d-0x10 with bytes 0x34-0x38\n        for i in 0..4 {\n            scrambled_mod[0x0d + i] ^= scrambled_mod[0x34 + i];\n        }\n\n        // Step 4: XOR last 0x40 bytes with first 0x40 bytes\n        for i in 0..0x40 {\n            scrambled_mod[0x40 + i] ^= scrambled_mod[i];\n        }\n        scrambled_mod\n    }\n\n    #[allow(clippy::missing_errors_doc)]\n    pub fn decrypt_data(\u0026self, encrypted_data: \u0026[u8]) -\u003e anyhow::Result\u003cVec\u003cu8\u003e\u003e {\n        let n = self.pair.0.n();\n        let size = self.pair.0.size();\n        let d = self.pair.0.d();\n\n        // Convert ciphertext to BigUint\n        let c = rsa::BigUint::from_bytes_be(encrypted_data);\n\n        // Perform modular exponentiation: c^d mod n\n        let m = c.modpow(d, n);\n        let mut decrypted_bytes = m.to_bytes_be();\n        // padding\n        if decrypted_bytes.len() \u003c size {\n            let pad_length = size - decrypted_bytes.len();\n            decrypted_bytes.splice(0..0, vec![0; pad_length]); // Prepend padding\n        }\n        // Return the decrypted message as bytes\n        Ok(decrypted_bytes)\n    }\n\n    #[allow(clippy::missing_errors_doc)]\n    pub fn from_pem(private_key_pem: \u0026str) -\u003e anyhow::Result\u003crsa::RsaPrivateKey\u003e {\n        // Parse the PEM string\n        let pem = parse(private_key_pem).context(\"Failed to parse PEM string\")?;\n\n        // Ensure the PEM label is for an RSA public key\n        // Ensure the PEM tag is for an RSA PRIVATE KEY\n        if pem.tag() != \"PRIVATE KEY\" {\n            bail!(\"Unexpected PEM tag: {}\", pem.tag());\n        }\n        let private_key_der = rsa::RsaPrivateKey::from_pkcs8_der(pem.contents())\n            .context(\"Failed to parse DER-encoded PKCS#8 private key\")?;\n\n        Ok(private_key_der)\n    }\n}\n\n#[must_use]\n#[allow(clippy::missing_panics_doc)]\npub fn generate_rsa_key_pair() -\u003e (rsa::RsaPrivateKey, rsa::RsaPublicKey) {\n    let bits: usize = 1024;\n    let mut rng = rand::thread_rng();\n    let private_key =\n        rsa::RsaPrivateKey::new(\u0026mut rng, bits).expect(\"Failed to generate RSA private key\");\n    let public_key = rsa::RsaPublicKey::from(\u0026private_key);\n    (private_key, public_key)\n}\n\n#[cfg(test)]\nmod test {\n    use super::*;\n    use crate::str::Trim;\n    use rsa::pkcs1::{EncodeRsaPrivateKey, LineEnding};\n\n    #[test]\n    fn test_rsa_key_generated() {\n        let keypair = generate_rsa_key_pair();\n        let pem = keypair.0.to_pkcs1_pem(LineEnding::LF).unwrap();\n        let formatted = String::from_utf8_lossy(pem.as_bytes());\n        assert!(formatted.starts_with(\"-----BEGIN RSA PRIVATE KEY-----\"));\n    }\n\n    #[test]\n    fn test_encryption_works() {\n        let modulus = [\n            0, 223, 167, 200, 243, 159, 71, 142, 226, 187, 170, 69, 162, 8, 145, 92, 139, 207, 67,\n            189, 1, 35, 109, 221, 188, 209, 20, 151, 56, 79, 70, 169, 46, 43, 166, 136, 99, 234, 1,\n            212, 249, 191, 87, 41, 151, 102, 78, 192, 172, 57, 96, 199, 159, 204, 50, 5, 117, 148,\n            85, 211, 203, 225, 211, 138, 173, 63, 12, 45, 94, 31, 14, 43, 248, 64, 85, 8, 55, 188,\n            74, 101, 232, 218, 224, 185, 181, 248, 245, 201, 69, 133, 89, 95, 186, 28, 72, 54, 0,\n            178, 194, 218, 96, 228, 6, 155, 52, 193, 24, 157, 192, 30, 84, 48, 0, 133, 76, 146, 83,\n            185, 243, 100, 148, 180, 242, 5, 237, 62, 0, 159, 53,\n        ];\n        let unencrypted = [\n            79, 112, 181, 90, 8, 119, 15, 29, 159, 106, 254, 130, 170, 198, 87, 88, 143, 86, 230,\n            61, 98, 228, 151, 38, 253, 34, 225, 55, 105, 250, 215, 98, 30, 78, 104, 221, 149, 6,\n            82, 128,\n        ];\n        let expected = [\n            36, 35, 171, 97, 133, 151, 145, 133, 240, 167, 43, 52, 152, 194, 103, 216, 33, 116, 84,\n            6, 190, 142, 175, 168, 229, 130, 203, 147, 67, 108, 231, 112, 238, 91, 171, 124, 254,\n            82, 15, 244, 96, 58, 145, 240, 144, 91, 33, 247, 109, 186, 252, 4, 197, 62, 80, 172,\n            130, 212, 35, 175, 34, 64, 209, 9, 182, 214, 116, 112, 254, 6, 175, 90, 180, 5, 215,\n            32, 85, 132, 18, 230, 39, 165, 12, 149, 191, 100, 101, 100, 36, 107, 147, 37, 139, 193,\n            145, 60, 93, 96, 156, 78, 103, 11, 3, 112, 243, 146, 241, 21, 6, 139, 5, 88, 144, 249,\n            215, 81, 128, 96, 232, 226, 15, 60, 178, 15, 118, 38, 67, 109,\n        ];\n        let key = RSAPublicKey::from_modulus(\u0026modulus).unwrap();\n        let encrypted = key.encrypt(\u0026unencrypted);\n        assert_eq!(encrypted, expected, \"Should encrypt properly\");\n    }\n\n    #[test]\n    fn test_test_request_auth_login() {\n        let packet_bytes = \u0026[\n            0, 111, 125, 244, 145, 84, 105, 242, 208, 32, 190, 242, 250, 167, 184, 36, 251, 198,\n            229, 162, 94, 164, 79, 87, 68, 170, 166, 176, 59, 40, 47, 27, 21, 25, 124, 150, 77, 89,\n            181, 194, 116, 217, 110, 171, 209, 185, 77, 251, 96, 150, 93, 77, 252, 126, 12, 83,\n            216, 199, 44, 212, 246, 101, 130, 122, 182, 243, 194, 146, 36, 40, 82, 243, 90, 25, 74,\n            246, 47, 109, 37, 56, 212, 73, 43, 55, 160, 146, 76, 62, 32, 155, 81, 200, 83, 80, 74,\n            192, 236, 142, 195, 1, 233, 42, 53, 176, 191, 251, 137, 116, 19, 216, 67, 43, 219, 71,\n            199, 182, 215, 100, 56, 14, 72, 99, 39, 222, 240, 60, 93, 250, 227, 2, 137, 47, 122,\n            247, 198, 200, 127, 195, 145, 4, 36, 217, 202, 40, 14, 60, 108, 223, 105, 93, 75, 251,\n            208, 190, 162, 161, 229, 132, 42, 51, 87, 98, 80, 8, 186, 82, 88, 167, 103, 122, 13,\n            195, 77, 123, 44, 220, 155, 160, 165, 190, 158, 33, 165, 66, 242, 21, 246, 171, 168,\n            42, 84, 226, 106, 87, 18, 27, 148, 249, 170, 123, 122, 134, 21, 116, 104, 107, 61, 216,\n            241, 249, 115, 160, 104, 100, 178, 171, 179, 221, 7, 232, 125, 192, 245, 13, 131, 39,\n            207, 45, 123, 108, 196, 95, 55, 75, 104, 206, 89, 157, 39, 39, 156, 116, 100, 177, 248,\n            92, 174, 21, 189, 35, 251, 208, 238, 82, 192, 125, 223, 53, 211, 170, 49, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 201, 60, 201, 172, 185, 36,\n            197, 189, 152, 64, 89, 234, 166, 34, 61, 246, 0, 0, 0, 0, 97, 9, 131, 137, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0,\n        ];\n        let packet_body = \u0026packet_bytes[1..];\n        let (raw1, rest1) = packet_body.split_at(128);\n        let (raw2, _) = rest1.split_at(128);\n        let file_content = include_str!(\"../test_data/test_private_key.pem\");\n        let decr_expect = [\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 0, 0, 97, 100, 109, 105, 110, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 52, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 97, 100, 109, 105, 110, 0,\n            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n            0,\n        ];\n        let p_key = ScrambledRSAKeyPair::from_pem(file_content).unwrap();\n        let pub_key = p_key.to_public_key();\n        let scrambl = ScrambledRSAKeyPair::new((p_key, pub_key));\n        let decr_raw1 = scrambl.decrypt_data(raw1).unwrap();\n        let decr_raw2 = scrambl.decrypt_data(raw2).unwrap();\n        let decrypted = [decr_raw1, decr_raw2].concat();\n        assert_eq!(decrypted, decr_expect, \"Should decrypted be ok\");\n        let part1 = String::from_utf8_lossy(\u0026decrypted[0x4E..0x4E + 50]);\n        let part2 = String::from_utf8_lossy(\u0026decrypted[0xCE..0xCE + 14]);\n        let result: String = format!(\"{}{}\", part1.trim_all(), part2.trim_all());\n        assert_eq!(result.to_string(), \"admin\");\n    }\n}\n","traces":[{"line":21,"address":[2988080,2988849,2988883],"length":1,"stats":{"Line":1}},{"line":22,"address":[2988112],"length":1,"stats":{"Line":1}},{"line":24,"address":[12087334,12086594,12086659,12086987],"length":1,"stats":{"Line":2}},{"line":28,"address":[12087049,12086841,12087284,12087237],"length":1,"stats":{"Line":2}},{"line":30,"address":[12087167],"length":1,"stats":{"Line":1}},{"line":35,"address":[2988912,2989241],"length":1,"stats":{"Line":1}},{"line":36,"address":[2988989],"length":1,"stats":{"Line":1}},{"line":37,"address":[12087479,12087541],"length":1,"stats":{"Line":2}},{"line":43,"address":[12087744,12088855,12088895],"length":1,"stats":{"Line":2}},{"line":44,"address":[12380550],"length":1,"stats":{"Line":2}},{"line":45,"address":[12380696,12380766],"length":1,"stats":{"Line":4}},{"line":46,"address":[12087990],"length":1,"stats":{"Line":2}},{"line":48,"address":[12088021,12088077],"length":1,"stats":{"Line":4}},{"line":49,"address":[12381333],"length":1,"stats":{"Line":0}},{"line":51,"address":[12380992],"length":1,"stats":{"Line":2}},{"line":54,"address":[12381024],"length":1,"stats":{"Line":2}},{"line":55,"address":[12088633,12088515],"length":1,"stats":{"Line":4}},{"line":60,"address":[2990432],"length":1,"stats":{"Line":1}},{"line":61,"address":[12088945],"length":1,"stats":{"Line":1}},{"line":64,"address":[2990480],"length":1,"stats":{"Line":0}},{"line":65,"address":[12381777],"length":1,"stats":{"Line":0}},{"line":68,"address":[12089024,12090990],"length":1,"stats":{"Line":2}},{"line":69,"address":[2990551],"length":1,"stats":{"Line":2}},{"line":71,"address":[12381854,12382255,12382026,12381933],"length":1,"stats":{"Line":8}},{"line":72,"address":[12089247],"length":1,"stats":{"Line":2}},{"line":73,"address":[12382113],"length":1,"stats":{"Line":2}},{"line":77,"address":[2990996,2990699,2991126,2992489],"length":1,"stats":{"Line":8}},{"line":78,"address":[2992343],"length":1,"stats":{"Line":2}},{"line":79,"address":[12383498,12382430],"length":1,"stats":{"Line":4}},{"line":83,"address":[12089818,12089586,12089688,12090701],"length":1,"stats":{"Line":8}},{"line":84,"address":[2992090,2991346],"length":1,"stats":{"Line":4}},{"line":88,"address":[12089884,12090014,12089782,12090573],"length":1,"stats":{"Line":8}},{"line":89,"address":[12090421,12090038],"length":1,"stats":{"Line":4}},{"line":93,"address":[12090233,12090408,12089978,12090080],"length":1,"stats":{"Line":8}},{"line":94,"address":[12090257],"length":1,"stats":{"Line":2}},{"line":96,"address":[12382974],"length":1,"stats":{"Line":2}},{"line":100,"address":[12384474,12383808],"length":1,"stats":{"Line":1}},{"line":101,"address":[12383872],"length":1,"stats":{"Line":1}},{"line":102,"address":[12383899],"length":1,"stats":{"Line":1}},{"line":103,"address":[12383929],"length":1,"stats":{"Line":1}},{"line":106,"address":[12383971],"length":1,"stats":{"Line":1}},{"line":109,"address":[12091207],"length":1,"stats":{"Line":1}},{"line":110,"address":[2992787],"length":1,"stats":{"Line":1}},{"line":112,"address":[2992910,2992835],"length":1,"stats":{"Line":2}},{"line":113,"address":[2993088,2992997],"length":1,"stats":{"Line":1}},{"line":114,"address":[12091556,12091604],"length":1,"stats":{"Line":2}},{"line":117,"address":[2992920],"length":1,"stats":{"Line":1}},{"line":121,"address":[2993216,2994272],"length":1,"stats":{"Line":1}},{"line":123,"address":[12384529,12384820],"length":1,"stats":{"Line":1}},{"line":127,"address":[2993507,2993622],"length":1,"stats":{"Line":2}},{"line":128,"address":[12385523,12384987,12385276,12385402],"length":1,"stats":{"Line":0}},{"line":130,"address":[2993952,2993925,2993678,2993751],"length":1,"stats":{"Line":2}},{"line":133,"address":[12092384],"length":1,"stats":{"Line":1}},{"line":139,"address":[2994304,2994611],"length":1,"stats":{"Line":2}},{"line":140,"address":[12092832],"length":1,"stats":{"Line":2}},{"line":141,"address":[2994332],"length":1,"stats":{"Line":2}},{"line":142,"address":[2994412,2994364],"length":1,"stats":{"Line":4}},{"line":144,"address":[2994451],"length":1,"stats":{"Line":2}},{"line":145,"address":[2994513],"length":1,"stats":{"Line":2}}],"covered":55,"coverable":59},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","dto.rs"],"content":"use pnet::ipnetwork::Ipv4Network;\nuse serde::de::Error;\nuse serde::{Deserialize, Deserializer};\nuse std::net::Ipv4Addr;\nuse std::str::FromStr;\n\n#[derive(Debug, Clone, Deserialize)]\npub struct Database {\n    #[serde(rename = \"url\")]\n    pub url: String,\n    pub max_connections: u8,\n    pub min_connections: u8,\n    #[serde(default = \"default_timeout\")]\n    pub connect_timeout: u64,\n    #[serde(default = \"default_idle_timeout\")]\n    pub idle_timeout: u64,\n    #[serde(default = \"default_max_lifetime\")]\n    pub max_lifetime: u64,\n}\n#[derive(Clone, Debug)]\npub struct Player {\n    pub login_name: String,\n}\nfn default_idle_timeout() -\u003e u64 {\n    60\n}\nfn default_timeout() -\u003e u64 {\n    10\n}\nfn default_max_lifetime() -\u003e u64 {\n    60 * 60\n}\n#[derive(Debug, Clone, Deserialize)]\npub struct Runtime {\n    pub worker_threads: usize,\n}\n\n#[derive(Debug, Clone, Deserialize, Default)]\npub struct InboundConnection {\n    pub ip: String,\n    pub port: u16,\n    pub reuse_addr: bool,\n    pub reuse_port: bool,\n    pub no_delay: bool,\n}\n\n#[derive(Debug, Clone, Deserialize, Default)]\npub struct OutboundConnection {\n    pub ip: String,\n    pub port: u16,\n    pub no_delay: bool,\n}\n\n#[derive(Debug, Clone, Deserialize)]\npub struct ServerHost {\n    #[serde(deserialize_with = \"deserialize_ip\")]\n    pub ip: Ipv4Addr,\n    #[serde(deserialize_with = \"deserialize_subnet\")]\n    pub subnet: Ipv4Network,\n}\n\nfn deserialize_ip\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cIpv4Addr, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    let s: String = Deserialize::deserialize(deserializer)?;\n    Ipv4Addr::from_str(\u0026s).map_err(Error::custom)\n}\n\nfn deserialize_subnet\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cIpv4Network, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    let s: String = Deserialize::deserialize(deserializer)?;\n    Ipv4Network::from_str(\u0026s).map_err(Error::custom)\n}\n","traces":[{"line":30,"address":[12494608],"length":1,"stats":{"Line":2}},{"line":31,"address":[3060961,3060987],"length":1,"stats":{"Line":2}},{"line":62,"address":[2771406,2771008],"length":1,"stats":{"Line":0}},{"line":66,"address":[12684339,12684201],"length":1,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[12384656,12384954],"length":1,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":8},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","enums.rs"],"content":"#[repr(i32)]\n#[derive(Clone, Debug)]\npub enum CharDeletionFailReasons {\n    None,\n    Unknown,\n    PledgeMember,\n    PledgeMaster,\n    ProhibitCharDeletion,\n    Commission,\n    Mentor,\n    Mentee,\n    Mail,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","errors.rs"],"content":"use log::error;\nuse thiserror::Error;\n\n#[non_exhaustive]\n#[derive(Error, Debug)]\n#[allow(unused)]\npub enum Packet {\n    #[error(\"Failed to encrypt message\")]\n    Encryption(#[from] anyhow::Error),\n    #[error(\"Failed to write data to packet {max_size:?}\")]\n    Write { max_size: usize },\n    #[error(\"Unable to encode string in format {0}\")]\n    Encode(String),\n    #[error(\"Unable to decrypt client packet\")]\n    DecryptBlowfishError,\n    #[error(\"Unable to send packet\")]\n    SendPacketError,\n    #[error(\"Client packet not found, opcode is: {opcode:?}\")]\n    ClientPacketNotFound { opcode: usize },\n    #[error(\"Unable to send init packet to the client\")]\n    UnableToSendInit,\n    #[error(\"Unable to handle client packet: {msg:?}\")]\n    UnableToHandleClient { msg: String },\n}\n\n#[non_exhaustive]\n#[derive(Error, Debug)]\npub enum Rsa {\n    #[error(\"Unable to read pem key\")]\n    ErrorReadingPem,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","lib.rs"],"content":"use crate::dto::Database as DBConfig;\nuse argon2::password_hash::SaltString;\nuse argon2::{Argon2, PasswordHasher};\nuse rand_core::OsRng;\nuse sea_orm::{ConnectOptions, Database, DatabaseConnection};\nuse std::time::Duration;\nuse tokio::task::spawn_blocking;\nuse tracing::instrument;\n\npub mod config;\npub mod constants;\npub mod crypt;\npub mod dto;\npub mod enums;\npub mod errors;\npub mod message_broker;\npub mod network;\npub mod session;\npub mod shared_packets;\npub mod str;\npub mod traits;\n\n#[allow(clippy::missing_errors_doc, clippy::missing_panics_doc)]\npub async fn hash_password(password: \u0026str) -\u003e anyhow::Result\u003cString\u003e {\n    let pwd = password.to_owned();\n    spawn_blocking(move || {\n        let salt = SaltString::generate(\u0026mut OsRng);\n        let argon2 = Argon2::default();\n        // code here to hash the password\n        // might take a second of CPU time\n        argon2\n            .hash_password(pwd.as_bytes(), \u0026salt)\n            .expect(\"Unable to hash password\")\n            .to_string()\n    })\n    .await\n    .map_err(Into::into)\n}\n\n#[instrument]\npub async fn new_db_pool(db_config: \u0026DBConfig) -\u003e DatabaseConnection {\n    let mut opt = ConnectOptions::new(\u0026db_config.url);\n    opt.max_connections(u32::from(db_config.max_connections))\n        .min_connections(u32::from(db_config.min_connections))\n        .connect_timeout(Duration::from_secs(db_config.connect_timeout))\n        .idle_timeout(Duration::from_secs(db_config.idle_timeout))\n        .max_lifetime(Duration::from_secs(db_config.max_lifetime))\n        .sqlx_logging(false);\n\n    Database::connect(opt)\n        .await\n        .expect(\"Failed to connect to the database\")\n}\n","traces":[{"line":24,"address":[3737331,3737458,3737901,3737421,3737601,3737296],"length":1,"stats":{"Line":0}},{"line":25,"address":[3737414],"length":1,"stats":{"Line":0}},{"line":26,"address":[3737920,3737832,3737502,3737568,3737728,3738162],"length":1,"stats":{"Line":0}},{"line":27,"address":[3737952],"length":1,"stats":{"Line":0}},{"line":28,"address":[3737996],"length":1,"stats":{"Line":0}},{"line":31,"address":[3738062],"length":1,"stats":{"Line":0}},{"line":32,"address":[3738017],"length":1,"stats":{"Line":0}},{"line":36,"address":[4523700],"length":1,"stats":{"Line":0}},{"line":41,"address":[3732651],"length":1,"stats":{"Line":0}},{"line":42,"address":[3736253],"length":1,"stats":{"Line":0}},{"line":43,"address":[3736368,3736469,3736705,3736644,3736583,3736522],"length":1,"stats":{"Line":0}},{"line":44,"address":[3736485],"length":1,"stats":{"Line":0}},{"line":45,"address":[4979738],"length":1,"stats":{"Line":0}},{"line":46,"address":[3736599],"length":1,"stats":{"Line":0}},{"line":47,"address":[3736660],"length":1,"stats":{"Line":0}},{"line":50,"address":[3736821,3737022,3736739,3737154],"length":1,"stats":{"Line":0}},{"line":51,"address":[3736814,3736854,3736305,3736923,3737086],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","message_broker.rs"],"content":"use crate::shared_packets::common::SendablePacket;\nuse crate::traits::handlers::PacketSender;\nuse anyhow::Error;\nuse dashmap::DashMap;\nuse futures::future::join_all;\nuse log::error;\nuse std::fmt::Debug;\nuse std::hash::Hash;\nuse std::sync::Arc;\nuse std::time::{Duration, SystemTime};\nuse tokio::sync::mpsc::Sender;\nuse tokio::sync::{mpsc, oneshot};\nuse tokio::time::timeout;\nuse uuid::Uuid;\n\n#[derive(Debug)]\npub struct Request\u003cK, V\u003e {\n    pub response: Option\u003coneshot::Sender\u003cOption\u003c(K, V)\u003e\u003e\u003e,\n    pub body: Option\u003cBox\u003cdyn SendablePacket\u003e\u003e,\n    pub sent_at: SystemTime,\n    pub id: String,\n}\n\n#[derive(Debug)]\npub struct MessageBroker\u003cK, V\u003e {\n    pub inbox: DashMap\u003cString, Request\u003cK, V\u003e\u003e,\n    pub timeout: Duration,\n    pub sender: Sender\u003c(u8, Request\u003cK, V\u003e)\u003e,\n    pub packet_handlers: DashMap\u003cu8, Arc\u003cdyn PacketSender\u003e\u003e,\n}\n\nimpl\u003cK, V\u003e MessageBroker\u003cK, V\u003e\nwhere\n    K: Debug + Clone + Send + Sync + Eq + Hash + 'static,\n    V: Debug + Clone + Send + Sync + 'static,\n{\n    #[must_use]\n    pub fn new(timeout: Duration) -\u003e Arc\u003cSelf\u003e {\n        let (rx, mut tx) = mpsc::channel::\u003c(u8, Request\u003cK, V\u003e)\u003e(100);\n        let broker_inst = Arc::new(MessageBroker {\n            inbox: DashMap::new(),\n            timeout,\n            sender: rx,\n            packet_handlers: DashMap::new(),\n        });\n        let broker = broker_inst.clone();\n        tokio::spawn(async move {\n            loop {\n                if let Some((sender_id, mut request)) = tx.recv().await {\n                    //the message has been sent already, there is no sense to do it twice\n                    let existing_msg = broker.inbox.remove(\u0026request.id);\n                    if let Some((_, existing_msg)) = existing_msg {\n                        if let Some(resp) = existing_msg.response {\n                            let _ = resp.send(None); // ignore error, we don't care if pipe is broken\n                        }\n                    }\n                    //do a cleanup, if we have old messages, remove them\n                    let now = SystemTime::now();\n\n                    broker.inbox.retain(|_, req| {\n                        now.duration_since(req.sent_at)\n                            .is_ok_and(|elapsed| elapsed \u003c= broker.timeout)\n                    });\n                    // send packet later, now we only remember it\n                    let Some(req_body) = request.body.take() else {\n                        error!(\"No body found for message {:?}\", request);\n                        continue;\n                    };\n                    let Some(packet_sender) = broker.packet_handlers.get(\u0026sender_id) else {\n                        error!(\"No packet handler found for sender_id {:?}\", sender_id);\n                        continue;\n                    };\n                    // we are safe to send bytes first and then update messages, there is a lock.\n                    if packet_sender.send_packet(req_body).await.is_ok() {\n                        broker.inbox.insert(request.id.clone(), request);\n                    } else if let Some(resp) = request.response {\n                        //if it wasn't successful then just send back NoResponse without storing it\n                        let _ = resp.send(None);\n                    }\n                }\n            }\n        });\n        broker_inst\n    }\n\n    pub fn respond_to_message(\u0026self, receiver_id_option: Option\u003cK\u003e, message_id: \u0026str, message: V) {\n        let msg = self.inbox.remove(message_id);\n        // TODO: once combining if let will be stable, refactor it\n        if let Some((_msg_id, request)) = msg {\n            if let Some(receiver_id) = receiver_id_option {\n                if let Some(resp) = request.response {\n                    let receiver_id_clone = receiver_id.clone();\n                    if resp.send(Some((receiver_id, message))).is_err() {\n                        error!(\"Failed to send response to message {message_id}, receiver is {receiver_id_clone:?}\");\n                    }\n                }\n            }\n        }\n        //if message is missing then we just ignore it\n    }\n\n    pub fn register_packet_handler(\u0026self, receiver_id: u8, packet_sender: Arc\u003cdyn PacketSender\u003e) {\n        self.packet_handlers.insert(receiver_id, packet_sender);\n    }\n    pub fn unregister_packet_handler(\u0026self, sender_id: u8) {\n        self.packet_handlers.remove(\u0026sender_id);\n    }\n\n    pub async fn notify_all\u003cF\u003e(\u0026self, packet_factory: F) -\u003e Vec\u003canyhow::Result\u003c()\u003e\u003e\n    where\n        F: Fn() -\u003e Box\u003cdyn SendablePacket\u003e,\n    {\n        let mut tasks = vec![];\n        for ph in \u0026self.packet_handlers {\n            let task = self.notify(*ph.key(), packet_factory());\n            tasks.push(task);\n        }\n        join_all(tasks).await\n    }\n\n    ///\n    /// # Errors\n    /// - if the message was not sent\n    pub async fn notify(\n        \u0026self,\n        receiver_id: u8,\n        packet: Box\u003cdyn SendablePacket\u003e,\n    ) -\u003e anyhow::Result\u003c()\u003e {\n        let message = Request {\n            response: None,\n            body: Some(packet),\n            sent_at: SystemTime::now(),\n            id: Uuid::new_v4().to_string(),\n        };\n        self.sender.send((receiver_id, message)).await?;\n        Ok(())\n    }\n\n    pub async fn send_message_to_all\u003cF\u003e(\n        \u0026self,\n        msg_id: \u0026str,\n        packet_factory: F,\n    ) -\u003e Vec\u003canyhow::Result\u003cOption\u003c(K, V)\u003e\u003e\u003e\n    where\n        F: Fn() -\u003e Box\u003cdyn SendablePacket\u003e,\n    {\n        let mut tasks = vec![];\n        for entry in \u0026self.packet_handlers {\n            let task = self.send_message(*entry.key(), msg_id, packet_factory());\n            tasks.push(timeout(self.timeout, task));\n        }\n        join_all(tasks)\n            .await\n            .into_iter()\n            .map(|res| res.map_err(Error::from).and_then(|inner| inner))\n            .collect()\n    }\n\n    ///\n    /// # Errors\n    /// - if the message was not sent\n    /// - if there was an error awaiting a response\n    pub async fn send_message(\n        \u0026self,\n        receiver_id: u8,\n        message_id: \u0026str,\n        packet: Box\u003cdyn SendablePacket\u003e,\n    ) -\u003e anyhow::Result\u003cOption\u003c(K, V)\u003e\u003e {\n        let (resp_tx, resp_rx) = oneshot::channel();\n        let message = Request {\n            response: Some(resp_tx),\n            body: Some(packet),\n            sent_at: SystemTime::now(),\n            id: message_id.to_string(),\n        };\n        self.sender.send((receiver_id, message)).await?;\n        let k = resp_rx.await?;\n        Ok(k)\n    }\n}\n","traces":[{"line":38,"address":[4398435,4397824,4398384],"length":1,"stats":{"Line":5}},{"line":39,"address":[4397855],"length":1,"stats":{"Line":5}},{"line":40,"address":[],"length":0,"stats":{"Line":5}},{"line":41,"address":[],"length":0,"stats":{"Line":5}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":5}},{"line":44,"address":[],"length":0,"stats":{"Line":5}},{"line":46,"address":[5064247,5064301],"length":1,"stats":{"Line":10}},{"line":47,"address":[5064309,5065881,5069566,5064687,5064543,5064761,5064512],"length":1,"stats":{"Line":15}},{"line":48,"address":[],"length":0,"stats":{"Line":6}},{"line":49,"address":[4463257],"length":1,"stats":{"Line":19}},{"line":51,"address":[],"length":0,"stats":{"Line":1}},{"line":52,"address":[],"length":0,"stats":{"Line":1}},{"line":53,"address":[5067170,5067106],"length":1,"stats":{"Line":0}},{"line":54,"address":[5067204,5067293],"length":1,"stats":{"Line":0}},{"line":58,"address":[5067594,5067119],"length":1,"stats":{"Line":2}},{"line":60,"address":[4401552,4403552],"length":1,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":3}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":66,"address":[4402722,4402628,4402872],"length":1,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[5067846,5067893],"length":1,"stats":{"Line":2}},{"line":70,"address":[5068178,5068290,5068437],"length":1,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[4283432],"length":1,"stats":{"Line":4}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[5065218],"length":1,"stats":{"Line":0}},{"line":78,"address":[4399227,4399291],"length":1,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":5}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[5060224,5060359],"length":1,"stats":{"Line":2}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":3}},{"line":91,"address":[5060564,5060597,5061726],"length":1,"stats":{"Line":3}},{"line":92,"address":[4396065],"length":1,"stats":{"Line":1}},{"line":93,"address":[5060712,5061079],"length":1,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[4397696],"length":1,"stats":{"Line":1}},{"line":103,"address":[5063770],"length":1,"stats":{"Line":1}},{"line":105,"address":[4397760],"length":1,"stats":{"Line":0}},{"line":106,"address":[4397778],"length":1,"stats":{"Line":0}},{"line":109,"address":[5056840,5056704],"length":1,"stats":{"Line":0}},{"line":113,"address":[5056882],"length":1,"stats":{"Line":0}},{"line":114,"address":[5057107,5056970,5057151,5057024],"length":1,"stats":{"Line":0}},{"line":115,"address":[5057191,5057380],"length":1,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[5056925,5057206,5057539],"length":1,"stats":{"Line":0}},{"line":124,"address":[5069744],"length":1,"stats":{"Line":1}},{"line":131,"address":[5069980],"length":1,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[5070114,5070173],"length":1,"stats":{"Line":2}},{"line":135,"address":[4405017,4404443,4404272,4404570,4404855,4403995],"length":1,"stats":{"Line":2}},{"line":136,"address":[5070889],"length":1,"stats":{"Line":1}},{"line":139,"address":[5062336],"length":1,"stats":{"Line":0}},{"line":147,"address":[5062545],"length":1,"stats":{"Line":0}},{"line":148,"address":[5062687,5062633,5062770,5062814],"length":1,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[5063481,5063374,5062869,5062944],"length":1,"stats":{"Line":0}},{"line":153,"address":[4513332],"length":1,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[5057824],"length":1,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":2}},{"line":171,"address":[5058360],"length":1,"stats":{"Line":1}},{"line":172,"address":[],"length":0,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":1}},{"line":174,"address":[5058540],"length":1,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":2}},{"line":177,"address":[],"length":0,"stats":{"Line":3}},{"line":178,"address":[],"length":0,"stats":{"Line":1}}],"covered":45,"coverable":71},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","network.rs"],"content":"use crate::dto::InboundConnection;\nuse anyhow::Context;\nuse std::net::ToSocketAddrs;\nuse tokio::net::{TcpListener, TcpSocket};\n\n#[allow(clippy::missing_errors_doc)]\npub fn bind_addr(config: \u0026InboundConnection) -\u003e anyhow::Result\u003cTcpListener\u003e {\n    let addr = format!(\"{}:{}\", \u0026config.ip, \u0026config.port)\n        .to_socket_addrs()\n        .context(format!(\n            \"Failed to resolve address {}:{}\",\n            config.ip, config.port\n        ))?\n        .next()\n        .context(\"No address found for the given host and port\")?;\n    let socket = TcpSocket::new_v4()?;\n    socket.set_reuseaddr(config.reuse_addr)?;\n    socket.set_reuseport(config.reuse_port)?;\n    socket.set_nodelay(config.no_delay)?;\n    socket.bind(addr)?;\n    let listener = socket.listen(1024)?;\n    Ok(listener)\n}\n","traces":[{"line":7,"address":[12667407,12667375,12665136],"length":1,"stats":{"Line":0}},{"line":8,"address":[3035156,3035095,3034142,3034237,3034884,3034439,3034320,3034947,3035297,3036380],"length":1,"stats":{"Line":0}},{"line":10,"address":[3034747,3034657],"length":1,"stats":{"Line":0}},{"line":16,"address":[12369519,12369400],"length":1,"stats":{"Line":0}},{"line":17,"address":[12369483,12369698,12370371,12369599],"length":1,"stats":{"Line":0}},{"line":18,"address":[3035588,3036271,3035662,3035761],"length":1,"stats":{"Line":0}},{"line":19,"address":[3035926,3035799,3035725,3036269],"length":1,"stats":{"Line":0}},{"line":20,"address":[3035857,3036064,3036267,3035964],"length":1,"stats":{"Line":0}},{"line":21,"address":[3036113,3036253,3036210,3036020],"length":1,"stats":{"Line":0}},{"line":22,"address":[3036177],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":10},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","session.rs"],"content":"use rand::Rng;\n\n#[derive(Clone, Debug, Default, Eq, PartialEq)]\n#[allow(clippy::module_name_repetitions)]\npub struct SessionKey {\n    pub play_ok1: i32,\n    pub play_ok2: i32,\n    pub login_ok1: i32,\n    pub login_ok2: i32,\n}\n\nimpl SessionKey {\n    #[must_use]\n    pub fn new() -\u003e Self {\n        let mut rng = rand::thread_rng();\n        SessionKey {\n            play_ok1: rng.gen(),\n            play_ok2: rng.gen(),\n            login_ok1: rng.gen(),\n            login_ok2: rng.gen(),\n        }\n    }\n    #[must_use]\n    pub fn check_session(\u0026self, s_key_1: i32, s_key_2: i32) -\u003e bool {\n        s_key_1 == self.login_ok1 \u0026\u0026 s_key_2 == self.login_ok2\n    }\n    #[must_use]\n    pub fn equals(\u0026self, other: \u0026SessionKey, show_license: bool) -\u003e bool {\n        let is_play_ok = self.play_ok1 == other.play_ok1 \u0026\u0026 self.play_ok2 == other.play_ok2;\n        if show_license {\n            is_play_ok \u0026\u0026 self.login_ok1 == other.login_ok1 \u0026\u0026 self.login_ok2 == other.login_ok2\n        } else {\n            is_play_ok\n        }\n    }\n    #[must_use]\n    pub fn get_play_session_id(\u0026self) -\u003e i32 {\n        self.play_ok1\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::session::SessionKey;\n\n    #[test]\n    fn test_session_key_not_equals() {\n        let session_key = SessionKey::new();\n        assert!(!session_key.equals(\u0026SessionKey::new(), false));\n        assert!(!session_key.equals(\u0026SessionKey::new(), true));\n    }\n    #[test]\n    fn test_session_key_equals() {\n        let session_key = SessionKey::new();\n        let other = session_key.clone();\n        assert!(session_key.equals(\u0026other, false));\n        assert!(session_key.equals(\u0026other, true));\n    }\n}\n","traces":[{"line":14,"address":[2802484,2802288],"length":1,"stats":{"Line":2}},{"line":15,"address":[2802302],"length":1,"stats":{"Line":2}},{"line":17,"address":[2802316],"length":1,"stats":{"Line":2}},{"line":18,"address":[12462579],"length":1,"stats":{"Line":2}},{"line":19,"address":[12462599],"length":1,"stats":{"Line":2}},{"line":20,"address":[12462619],"length":1,"stats":{"Line":2}},{"line":24,"address":[2802512],"length":1,"stats":{"Line":0}},{"line":25,"address":[2802534],"length":1,"stats":{"Line":0}},{"line":28,"address":[12462784],"length":1,"stats":{"Line":1}},{"line":29,"address":[12462816],"length":1,"stats":{"Line":1}},{"line":30,"address":[2802666,2802650],"length":1,"stats":{"Line":4}},{"line":31,"address":[2802668,2802684],"length":1,"stats":{"Line":3}},{"line":33,"address":[2802656],"length":1,"stats":{"Line":2}},{"line":37,"address":[2802736],"length":1,"stats":{"Line":0}},{"line":38,"address":[2802741],"length":1,"stats":{"Line":0}}],"covered":11,"coverable":15},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","common.rs"],"content":"use super::{gs_2_ls::ReplyChars, read::ReadablePacketBuffer};\nuse crate as l2_core;\nuse crate::shared_packets::ls_2_gs::PlayerAuthResponse;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse anyhow::bail;\nuse macro_common::SendablePacketImpl;\nuse num_enum::TryFromPrimitive;\nuse std::str::FromStr;\nuse std::{fmt::Debug, net::Ipv4Addr};\n\npub trait SendablePacket: Debug + Send + Sync {\n    fn get_bytes(\u0026mut self, with_padding: bool) -\u003e \u0026mut [u8];\n}\n\npub trait ReadablePacket: Debug + Send + Sync {\n    const PACKET_ID: u8;\n    const EX_PACKET_ID: Option\u003cu16\u003e;\n    #[allow(clippy::missing_errors_doc)]\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e\n    where\n        Self: Sized + ReadablePacket;\n}\n#[repr(u8)]\n#[allow(unused)]\n#[derive(Clone, Debug)]\npub enum LoginServerOpcodes {\n    Init = 0x00,\n    LoginOk = 0x03,\n    ServerList = 0x04,\n    GgAuth = 0x0b,\n    LoginFail = 0x01,\n    AccountKicked = 0x02,\n    PlayFail = 0x06,\n    PlayOk = 0x07,\n    PiAgreementCheck = 0x11,\n    PiAgreementAck = 0x12,\n    LoginOptFail = 0x0D,\n}\n\n#[allow(unused)]\n#[derive(Debug, Clone, Copy, TryFromPrimitive)]\n#[repr(u8)]\npub enum ServerStatus {\n    Auto = 0x00,\n    Good = 0x01,\n    Normal = 0x02,\n    Full = 0x03,\n    Down = 0x04,\n    GmOnly = 0x05,\n}\n\n#[derive(Debug, Clone)]\npub struct ServerData {\n    pub ip: Ipv4Addr,\n    pub port: i32,\n    pub age_limit: i32,\n    pub pvp: bool,\n    pub current_players: i32,\n    pub max_players: i32,\n    pub brackets: bool,\n    pub clock: bool,\n    pub status: Option\u003cServerStatus\u003e,\n    pub server_id: i32,\n    pub server_type: Option\u003cServerType\u003e,\n}\n\nimpl ServerData {\n    #[must_use]\n    pub fn get_ip_octets(\u0026self) -\u003e [u8; 4] {\n        self.ip.octets()\n    }\n}\n\n#[allow(unused)]\n#[derive(Debug, Clone, Copy, TryFromPrimitive)]\n#[repr(i32)]\npub enum ServerType {\n    Normal = 0x01,\n    Relax = 0x02,\n    Test = 0x04,\n    Nolabel = 0x08,\n    CreationRestricted = 0x10,\n    Event = 0x20,\n    Free = 0x40,\n}\n\nimpl FromStr for ServerType {\n    type Err = String;\n\n    fn from_str(input: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        match input.to_lowercase().as_str() {\n            \"normal\" =\u003e Ok(ServerType::Normal),\n            \"relax\" =\u003e Ok(ServerType::Relax),\n            \"test\" =\u003e Ok(ServerType::Test),\n            \"nolabel\" =\u003e Ok(ServerType::Nolabel),\n            \"creationrestricted\" =\u003e Ok(ServerType::CreationRestricted),\n            \"event\" =\u003e Ok(ServerType::Event),\n            \"free\" =\u003e Ok(ServerType::Free),\n            _ =\u003e Err(format!(\"Invalid server type: {input}\")),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub enum PacketType {\n    ReplyChars(ReplyChars),\n    PlayerAuthResp(PlayerAuthResponse),\n}\n\n#[repr(u8)]\n#[allow(unused)]\n#[derive(Debug, Clone)]\npub enum GSLoginFailReasons {\n    None = 0x00,\n    IpBanned = 0x01,\n    IpRreserved = 0x02,\n    WrongHexId = 0x03,\n    IdReserved = 0x04,\n    NoFreeID = 0x05,\n    NotAuthed = 0x06,\n    AlreadyRegistered = 0x07,\n}\n\nimpl GSLoginFailReasons {\n    #[allow(clippy::missing_errors_doc)]\n    pub fn from_u8(reason: u8) -\u003e anyhow::Result\u003cSelf\u003e {\n        match reason {\n            0x00 =\u003e Ok(Self::None),\n            0x01 =\u003e Ok(Self::IpBanned),\n            0x02 =\u003e Ok(Self::IpRreserved),\n            0x03 =\u003e Ok(Self::WrongHexId),\n            0x04 =\u003e Ok(Self::IdReserved),\n            0x05 =\u003e Ok(Self::NoFreeID),\n            0x06 =\u003e Ok(Self::NotAuthed),\n            0x07 =\u003e Ok(Self::AlreadyRegistered),\n            _ =\u003e bail!(\"Unknown reason\"),\n        }\n    }\n}\n\n#[repr(u8)]\n#[allow(unused)]\n#[derive(Debug, Clone)]\npub enum PlayerLoginFailReasons {\n    ReasonNoMessage = 0x00,\n    ReasonSystemErrorLoginLater = 0x01,\n    /// this will close client, so user has to restart game\n    ReasonUserOrPassWrong = 0x02,\n    ReasonAccessFailedTryAgainLater = 0x04,\n    ReasonAccountInfoIncorrectContactSupport = 0x05,\n    /// maybe this is good for N tries and after N use 0x02\n    ReasonNotAuthed = 0x06,\n    ReasonAccountInUse = 0x07,\n    ReasonUnder18YearsKr = 0x0C,\n    ReasonServerOverloaded = 0x0F,\n    ReasonServerMaintenance = 0x10,\n    ReasonTempPassExpired = 0x11,\n    ReasonGameTimeExpired = 0x12,\n    ReasonNoTimeLeft = 0x13,\n    ReasonSystemError = 0x14,\n    ReasonAccessFailed = 0x15,\n    ReasonRestrictedIp = 0x16,\n    ReasonWeekUsageFinished = 0x1E,\n    ReasonSecurityCardNumberInvalid = 0x1F,\n    ReasonAgeNotVerifiedCantLogBeetween10pm6am = 0x20,\n    ReasonServerCannotBeAccessedByYourCoupon = 0x21,\n    ReasonDualBox = 0x23,\n    ReasonInactive = 0x24,\n    ReasonUserAgreementRejectedOnWebsite = 0x25,\n    ReasonGuardianConsentRequired = 0x26,\n    ReasonUserAgreementDeclinedOrWithdrawlRequest = 0x27,\n    ReasonAccountSuspendedCall = 0x28,\n    ReasonChangePasswordAndQuizOnWebsite = 0x29,\n    ReasonAlreadyLoggedInto10Accounts = 0x2A,\n    ReasonMasterAccountRestricted = 0x2B,\n    ReasonCertificationFailed = 0x2E,\n    ReasonTelephoneCertificationUnavailable = 0x2F,\n    ReasonTelephoneSignalsDelayed = 0x30,\n    ReasonCertificationFailedLineBusy = 0x31,\n    ReasonCertificationServiceNumberExpiredOrIncorrect = 0x32,\n    ReasonCertificationServiceCurrentlyBeingChecked = 0x33,\n    ReasonCertificationServiceCantBeUsedHeavyVolume = 0x34,\n    ReasonCertificationServiceExpiredGameplayBlocked = 0x35,\n    ReasonCertificationFailed3TimesGameplayBlocked30Min = 0x36,\n    ReasonCertificationDailyUseExceeded = 0x37,\n    ReasonCertificationUnderwayTryAgainLater = 0x38,\n}\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct GSLoginFail {\n    pub buffer: SendablePacketBuffer,\n    pub reason: GSLoginFailReasons,\n}\nimpl ReadablePacket for GSLoginFail {\n    const PACKET_ID: u8 = 0x01;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e\n    where\n        Self: Sized + ReadablePacket,\n    {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?; //packet id\n        let reason = buffer.read_byte()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            reason: GSLoginFailReasons::from_u8(reason)?,\n        })\n    }\n}\n\nimpl GSLoginFail {\n    #[allow(clippy::missing_errors_doc)]\n    pub fn new(reason: GSLoginFailReasons) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            reason,\n        };\n        inst.write_all()?;\n        Ok(inst)\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(GSLoginFailReasons::NotAuthed as u8)?;\n        self.buffer.write(self.reason.clone() as u8)?;\n        Ok(())\n    }\n}\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct PlayerLoginFail {\n    pub buffer: SendablePacketBuffer,\n    pub reason: PlayerLoginFailReasons,\n}\n\nimpl PlayerLoginFail {\n    #[allow(clippy::missing_errors_doc)]\n    pub fn new(reason: PlayerLoginFailReasons) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut login_ok = Self {\n            buffer: SendablePacketBuffer::new(),\n            reason,\n        };\n        login_ok.write_all()?;\n        Ok(login_ok)\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(LoginServerOpcodes::LoginFail as u8)?;\n        self.buffer.write(self.reason.clone() as u8)?;\n        Ok(())\n    }\n}\n\n#[repr(i32)]\n#[derive(Clone, Debug, Default, Copy)]\npub enum GSStatus {\n    Auto = 0x00,\n    Good = 0x01,\n    Normal = 0x02,\n    Full = 0x03,\n    #[default]\n    Down = 0x04,\n    GmOnly = 0x05,\n}\n\nimpl GSStatus {\n    #[must_use]\n    pub fn from_opcode(opcode: i32) -\u003e Option\u003cSelf\u003e {\n        match opcode {\n            0x00 =\u003e Some(Self::Auto),\n            0x01 =\u003e Some(Self::Good),\n            0x02 =\u003e Some(Self::Normal),\n            0x03 =\u003e Some(Self::Full),\n            0x04 =\u003e Some(Self::Down),\n            0x05 =\u003e Some(Self::GmOnly),\n            _ =\u003e None,\n        }\n    }\n}\n","traces":[{"line":69,"address":[12509184],"length":1,"stats":{"Line":0}},{"line":70,"address":[2824569],"length":1,"stats":{"Line":0}},{"line":90,"address":[2824608,2825622],"length":1,"stats":{"Line":1}},{"line":91,"address":[12509361,12509259],"length":1,"stats":{"Line":2}},{"line":92,"address":[2824824,2824753],"length":1,"stats":{"Line":2}},{"line":93,"address":[12212553,12212444,12212509],"length":1,"stats":{"Line":0}},{"line":94,"address":[2824877,2824942,2824986],"length":1,"stats":{"Line":0}},{"line":95,"address":[2824958,2825023,2825067],"length":1,"stats":{"Line":0}},{"line":96,"address":[2825154,2825039,2825110],"length":1,"stats":{"Line":0}},{"line":97,"address":[12509821,12509865,12509750],"length":1,"stats":{"Line":0}},{"line":98,"address":[12509908,12509837,12510022],"length":1,"stats":{"Line":0}},{"line":99,"address":[2825563,2825437],"length":1,"stats":{"Line":0}},{"line":126,"address":[12213296],"length":1,"stats":{"Line":0}},{"line":127,"address":[12510293],"length":1,"stats":{"Line":0}},{"line":128,"address":[12510384],"length":1,"stats":{"Line":0}},{"line":129,"address":[2825785],"length":1,"stats":{"Line":0}},{"line":130,"address":[12213458],"length":1,"stats":{"Line":0}},{"line":131,"address":[2825832],"length":1,"stats":{"Line":0}},{"line":132,"address":[12510478],"length":1,"stats":{"Line":0}},{"line":133,"address":[12213524],"length":1,"stats":{"Line":0}},{"line":134,"address":[2825898],"length":1,"stats":{"Line":0}},{"line":135,"address":[2825920],"length":1,"stats":{"Line":0}},{"line":136,"address":[2825702],"length":1,"stats":{"Line":0}},{"line":198,"address":[2826501,2825952],"length":1,"stats":{"Line":0}},{"line":202,"address":[12510609],"length":1,"stats":{"Line":0}},{"line":203,"address":[2825995,2826103],"length":1,"stats":{"Line":0}},{"line":204,"address":[2826186,2826142,2826051],"length":1,"stats":{"Line":0}},{"line":205,"address":[12213987],"length":1,"stats":{"Line":0}},{"line":206,"address":[12510779],"length":1,"stats":{"Line":0}},{"line":207,"address":[12213787,12214077,12213923,12213824],"length":1,"stats":{"Line":0}},{"line":214,"address":[12511184,12511482],"length":1,"stats":{"Line":0}},{"line":216,"address":[2826564],"length":1,"stats":{"Line":0}},{"line":219,"address":[12511262,12511320,12511425],"length":1,"stats":{"Line":0}},{"line":220,"address":[2826704],"length":1,"stats":{"Line":0}},{"line":222,"address":[12214528],"length":1,"stats":{"Line":0}},{"line":223,"address":[12511518,12511687],"length":1,"stats":{"Line":0}},{"line":224,"address":[12214638,12214752],"length":1,"stats":{"Line":0}},{"line":225,"address":[12511717],"length":1,"stats":{"Line":0}},{"line":237,"address":[2827369,2827088],"length":1,"stats":{"Line":0}},{"line":239,"address":[12511807],"length":1,"stats":{"Line":0}},{"line":242,"address":[12511912,12511854,12512017],"length":1,"stats":{"Line":0}},{"line":243,"address":[12214988],"length":1,"stats":{"Line":0}},{"line":245,"address":[2827392],"length":1,"stats":{"Line":0}},{"line":246,"address":[12215303,12215134],"length":1,"stats":{"Line":0}},{"line":247,"address":[12215230,12215344],"length":1,"stats":{"Line":0}},{"line":248,"address":[2827600],"length":1,"stats":{"Line":0}},{"line":266,"address":[2827648],"length":1,"stats":{"Line":0}},{"line":267,"address":[2827652],"length":1,"stats":{"Line":0}},{"line":268,"address":[2827695],"length":1,"stats":{"Line":0}},{"line":269,"address":[12215457],"length":1,"stats":{"Line":0}},{"line":270,"address":[12215475],"length":1,"stats":{"Line":0}},{"line":271,"address":[2827749],"length":1,"stats":{"Line":0}},{"line":272,"address":[2827767],"length":1,"stats":{"Line":0}},{"line":273,"address":[2827785],"length":1,"stats":{"Line":0}},{"line":274,"address":[2827685],"length":1,"stats":{"Line":0}}],"covered":3,"coverable":55},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","access_level.rs"],"content":"use crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\n\n#[derive(Clone, Debug)]\npub struct ChangeAL {\n    pub account: String,\n    pub level: i32,\n}\n\nimpl ReadablePacket for ChangeAL {\n    const PACKET_ID: u8 = 0x04;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        Ok(Self {\n            level: buffer.read_i32()?,\n            account: buffer.read_c_utf16le_string()?,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::shared_packets::common::ReadablePacket;\n    use crate::shared_packets::gs_2_ls::access_level::ChangeAL;\n\n    #[test]\n    fn test_read() {\n        let text_bytes: Vec\u003cu8\u003e = \"test\"\n            .encode_utf16()\n            .flat_map(u16::to_le_bytes) // Convert each `u16` to little-endian bytes\n            .collect();\n        let mut data = vec![0x04, 69, 0, 0, 0];\n        data.extend(text_bytes);\n        let p = ChangeAL::read(\u0026data).unwrap();\n        assert_eq!(p.account, \"test\");\n        assert_eq!(p.level, 69);\n    }\n}\n","traces":[{"line":14,"address":[2884432],"length":1,"stats":{"Line":1}},{"line":15,"address":[2884465],"length":1,"stats":{"Line":1}},{"line":16,"address":[2884587,2884475],"length":1,"stats":{"Line":1}},{"line":17,"address":[2884803],"length":1,"stats":{"Line":1}},{"line":18,"address":[2884716,2884531,2884617],"length":1,"stats":{"Line":2}},{"line":19,"address":[2884632,2884755,2884888],"length":1,"stats":{"Line":2}}],"covered":6,"coverable":6},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","auth.rs"],"content":"use crate as l2_core;\nuse crate::config::gs::GSServer;\nuse crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\nuse num_traits::ToBytes;\n\n#[derive(Clone, Debug, Default, SendablePacketImpl)]\npub struct RequestAuthGS {\n    buffer: SendablePacketBuffer,\n    pub desired_id: u8,\n    pub accept_alternative_id: bool,\n    pub host_reserved: bool,\n    pub port: u16,\n    pub max_players: u32,\n    pub hex_id: Vec\u003cu8\u003e,\n    pub hosts: Vec\u003cString\u003e,\n}\n\nimpl RequestAuthGS {\n    ///\n    /// # Errors\n    /// - if writing packet bytes is not possible, for example when packet size is too big\n    pub fn new(cfg: \u0026GSServer) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            desired_id: cfg.server_id,\n            accept_alternative_id: cfg.accept_alternative_id,\n            host_reserved: cfg.host_reserved,\n            port: cfg.listeners.clients.connection.port,\n            max_players: cfg.max_players,\n            hex_id: cfg.hex_id.to_be_bytes(),\n            hosts: cfg.get_hosts(),\n        };\n        inst.write_all()?;\n        Ok(inst)\n    }\n    #[allow(clippy::cast_possible_truncation)]\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(0x01)?; // packet id\n        self.buffer.write(self.desired_id)?;\n        self.buffer.write_bool(self.accept_alternative_id)?;\n        self.buffer.write_bool(self.host_reserved)?;\n        self.buffer.write_u16(self.port)?;\n        self.buffer.write_u32(self.max_players)?;\n        self.buffer.write_u32(self.hex_id.len() as u32)?;\n        self.buffer.write_bytes(\u0026self.hex_id)?;\n        self.buffer.write_u32((self.hosts.len() / 2) as u32)?; // we cut it by half because it's actually a pair of network/ip\n        for h in \u0026self.hosts {\n            self.buffer.write_c_utf16le_string(Some(h))?;\n        }\n        Ok(())\n    }\n}\n\n#[allow(clippy::cast_sign_loss)]\nimpl ReadablePacket for RequestAuthGS {\n    const PACKET_ID: u8 = 0x01;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer: ReadablePacketBuffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let desired_id = buffer.read_byte()?;\n        let accept_alternative_id = buffer.read_boolean()?;\n        let host_reserved = buffer.read_boolean()?;\n        let port = buffer.read_u16()?;\n        let max_players = buffer.read_u32()?;\n        let mut size = buffer.read_u32()?;\n        let hex_id = buffer.read_bytes(size as usize)?.to_vec();\n        size = buffer.read_u32()? * 2;\n        let hosts = buffer.read_n_strings(size as usize)?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            desired_id,\n            accept_alternative_id,\n            host_reserved,\n            port,\n            max_players,\n            hex_id,\n            hosts,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use crate::shared_packets::common::{ReadablePacket, SendablePacket};\n    use crate::shared_packets::gs_2_ls::RequestAuthGS;\n    use crate::shared_packets::write::SendablePacketBuffer;\n    fn get_bytes() -\u003e [u8; 74] {\n        [\n            74, 0, 1, 3, 1, 0, 58, 8, 57, 27, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 49, 0, 50, 0, 55, 0,\n            46, 0, 48, 0, 46, 0, 48, 0, 46, 0, 48, 0, 47, 0, 48, 0, 0, 0, 49, 0, 50, 0, 55, 0, 46,\n            0, 48, 0, 46, 0, 48, 0, 46, 0, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n        ]\n    }\n    #[test]\n    fn test_instantiate() {\n        let mut p = RequestAuthGS {\n            buffer: SendablePacketBuffer::new(),\n            desired_id: 3,\n            accept_alternative_id: true,\n            host_reserved: false,\n            port: 2106,\n            max_players: 6969,\n            hex_id: vec![],\n            hosts: vec![\"127.0.0.0/0\".to_string(), \"127.0.0.1\".to_string()],\n        };\n        p.write_all().unwrap();\n        let bytes = p.get_bytes(true).to_vec();\n        assert_eq!(bytes.len(), 74);\n        assert_eq!(bytes, get_bytes());\n    }\n    #[test]\n    fn test_read() {\n        let p = RequestAuthGS::read(\u0026get_bytes()[2..]).unwrap();\n        assert_eq!(p.desired_id, 3);\n        assert!(p.accept_alternative_id);\n        assert!(!p.host_reserved);\n        assert_eq!(p.port, 2106);\n        assert_eq!(p.max_players, 6969);\n        assert!(p.hex_id.is_empty());\n        assert_eq!(\n            p.hosts,\n            vec![\"127.0.0.0/0\".to_string(), \"127.0.0.1\".to_string()]\n        );\n    }\n}\n","traces":[{"line":25,"address":[12441131,12440512],"length":1,"stats":{"Line":0}},{"line":27,"address":[12440542],"length":1,"stats":{"Line":0}},{"line":28,"address":[2666752],"length":1,"stats":{"Line":0}},{"line":29,"address":[2666762],"length":1,"stats":{"Line":0}},{"line":30,"address":[2666772],"length":1,"stats":{"Line":0}},{"line":31,"address":[2666782],"length":1,"stats":{"Line":0}},{"line":32,"address":[2666791],"length":1,"stats":{"Line":0}},{"line":33,"address":[12440613],"length":1,"stats":{"Line":0}},{"line":34,"address":[2666880],"length":1,"stats":{"Line":0}},{"line":36,"address":[12440960,12441071,12440902],"length":1,"stats":{"Line":0}},{"line":37,"address":[12738026],"length":1,"stats":{"Line":0}},{"line":40,"address":[2667328],"length":1,"stats":{"Line":1}},{"line":41,"address":[12441188,12441307],"length":1,"stats":{"Line":1}},{"line":42,"address":[2667564,2667406],"length":1,"stats":{"Line":1}},{"line":43,"address":[2667503,2667665],"length":1,"stats":{"Line":1}},{"line":44,"address":[12738460,12738623],"length":1,"stats":{"Line":1}},{"line":45,"address":[12441556,12441714],"length":1,"stats":{"Line":1}},{"line":46,"address":[12738664,12738836],"length":1,"stats":{"Line":1}},{"line":47,"address":[2667898,2668081],"length":1,"stats":{"Line":1}},{"line":48,"address":[2668009,2668199],"length":1,"stats":{"Line":1}},{"line":49,"address":[2668264,2668121],"length":1,"stats":{"Line":1}},{"line":50,"address":[2668239,2668299,2668363],"length":1,"stats":{"Line":3}},{"line":51,"address":[12739257,12739377],"length":1,"stats":{"Line":1}},{"line":53,"address":[12739222],"length":1,"stats":{"Line":1}},{"line":62,"address":[2670324,2670353,2668544],"length":1,"stats":{"Line":1}},{"line":63,"address":[2668577],"length":1,"stats":{"Line":1}},{"line":64,"address":[12442572,12442460],"length":1,"stats":{"Line":1}},{"line":65,"address":[12739611,12739526,12739692],"length":1,"stats":{"Line":2}},{"line":66,"address":[12739626,12739809,12739723],"length":1,"stats":{"Line":2}},{"line":67,"address":[12442917,12442835,12442735],"length":1,"stats":{"Line":2}},{"line":68,"address":[12443033,12442951,12442855],"length":1,"stats":{"Line":2}},{"line":69,"address":[12442972,12443067,12443149],"length":1,"stats":{"Line":2}},{"line":70,"address":[12443183,12443085,12443290],"length":1,"stats":{"Line":2}},{"line":71,"address":[2669311,2669428,2669502],"length":1,"stats":{"Line":2}},{"line":72,"address":[2669595,2669490,2669725,2670351],"length":1,"stats":{"Line":2}},{"line":73,"address":[12444258,12443605,12443658,12443808],"length":1,"stats":{"Line":2}},{"line":74,"address":[2670088],"length":1,"stats":{"Line":1}},{"line":75,"address":[2669875],"length":1,"stats":{"Line":1}},{"line":81,"address":[2669992],"length":1,"stats":{"Line":1}},{"line":82,"address":[2670040],"length":1,"stats":{"Line":1}}],"covered":29,"coverable":40},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","blowfish.rs"],"content":"use crate as l2_core;\nuse crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct BlowFish {\n    buffer: SendablePacketBuffer,\n    pub encrypted_key: Vec\u003cu8\u003e,\n}\nimpl BlowFish {\n    #[must_use]\n    #[allow(clippy::missing_panics_doc)]\n    pub fn new(encrypted_key: Vec\u003cu8\u003e) -\u003e Self {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            encrypted_key,\n        };\n        inst.write_all()\n            .expect(\"Failed to write bytes while building blowfish packet.\");\n        inst\n    }\n\n    #[allow(clippy::cast_possible_truncation)]\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(0x00)?;\n        self.buffer.write_u32(self.encrypted_key.len() as u32)?;\n        self.buffer.write_bytes(\u0026self.encrypted_key)?;\n        Ok(())\n    }\n}\nimpl ReadablePacket for BlowFish {\n    const PACKET_ID: u8 = 0x00;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    #[allow(clippy::cast_sign_loss)]\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let size = buffer.read_i32()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            encrypted_key: buffer.read_bytes(size as usize)?.to_vec(),\n        })\n    }\n}\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::shared_packets::common::SendablePacket;\n    fn get_bytes() -\u003e [u8; 34] {\n        [\n            34, 0, 0, 16, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 0,\n        ]\n    }\n    #[test]\n    fn blowfish_write_and_read() {\n        let mut buffer = BlowFish::new(vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]);\n\n        let bytes = buffer.get_bytes(true);\n        assert_eq!(bytes.len(), 34);\n        assert_eq!(bytes, get_bytes());\n    }\n}\n","traces":[{"line":15,"address":[12507408,12507709],"length":1,"stats":{"Line":1}},{"line":17,"address":[3059035],"length":1,"stats":{"Line":1}},{"line":20,"address":[3059170,3059222],"length":1,"stats":{"Line":2}},{"line":22,"address":[12210705],"length":1,"stats":{"Line":1}},{"line":26,"address":[3059328],"length":1,"stats":{"Line":1}},{"line":27,"address":[12210928,12210798],"length":1,"stats":{"Line":1}},{"line":28,"address":[3059397,3059577],"length":1,"stats":{"Line":1}},{"line":29,"address":[12211081,12210966],"length":1,"stats":{"Line":1}},{"line":30,"address":[3059606],"length":1,"stats":{"Line":1}},{"line":38,"address":[3060308,3059664],"length":1,"stats":{"Line":0}},{"line":39,"address":[12211153],"length":1,"stats":{"Line":0}},{"line":40,"address":[3059707,3059810],"length":1,"stats":{"Line":0}},{"line":41,"address":[3059900,3059763,3059840],"length":1,"stats":{"Line":0}},{"line":42,"address":[3060156],"length":1,"stats":{"Line":0}},{"line":43,"address":[3059865],"length":1,"stats":{"Line":0}},{"line":44,"address":[3059986,3059888],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","change_password.rs"],"content":"use crate as l2_core;\nuse crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct ChangePassword {\n    pub account: String,\n    pub char_name: String,\n    pub current_password: String,\n    pub new_password: String,\n    buffer: SendablePacketBuffer,\n}\n\nimpl ReadablePacket for ChangePassword {\n    const PACKET_ID: u8 = 0x0B;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            account: buffer.read_c_utf16le_string()?,\n            char_name: buffer.read_c_utf16le_string()?,\n            current_password: buffer.read_c_utf16le_string()?,\n            new_password: buffer.read_c_utf16le_string()?,\n        })\n    }\n}\n","traces":[{"line":20,"address":[3241552,3243084],"length":1,"stats":{"Line":0}},{"line":21,"address":[3241585],"length":1,"stats":{"Line":0}},{"line":22,"address":[3241595,3241689],"length":1,"stats":{"Line":0}},{"line":23,"address":[3242546],"length":1,"stats":{"Line":0}},{"line":24,"address":[3241659],"length":1,"stats":{"Line":0}},{"line":25,"address":[3241677,3241906,3241775],"length":1,"stats":{"Line":0}},{"line":26,"address":[3241999,3241894,3242130],"length":1,"stats":{"Line":0}},{"line":27,"address":[3242118,3242223,3242354],"length":1,"stats":{"Line":0}},{"line":28,"address":[3242447,3242806,3242342],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":9},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","gs_status.rs"],"content":"use macro_common::SendablePacketImpl;\nuse crate::config::gs::GSServer;\nuse crate::shared_packets::common::{GSStatus, ReadablePacket};\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse crate as l2_core;\n\n#[derive(Clone, Debug, Default, SendablePacketImpl)]\npub struct GSStatusUpdate {\n    buffer: SendablePacketBuffer,\n    pub status: GSStatus,\n    pub use_square_brackets: bool,\n    pub max_players: u32,\n    pub server_type: i32,\n    pub server_age: u8,\n}\n\n#[allow(unused)]\nimpl GSStatusUpdate {\n    const SERVER_LIST_STATUS: i32 = 0x01;\n    const SERVER_TYPE: i32 = 0x02;\n    const SERVER_LIST_SQUARE_BRACKET: i32 = 0x03;\n    const MAX_PLAYERS: i32 = 0x04;\n    const TEST_SERVER: i32 = 0x05;\n    const SERVER_AGE: i32 = 0x06;\n\n    #[allow(clippy::missing_errors_doc)]\n    pub fn new(cfg: \u0026GSServer) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            status: if cfg.gm_only {\n                GSStatus::GmOnly\n            } else {\n                GSStatus::Auto\n            },\n            use_square_brackets: cfg.use_brackets,\n            max_players: cfg.max_players,\n            server_type: cfg.server_type as i32,\n            server_age: cfg.server_age,\n        };\n        inst.write_all()?;\n        Ok(inst)\n    }\n    #[allow(clippy::cast_possible_truncation, clippy::cast_possible_wrap)]\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(0x06)?;\n        let fields = [\n            (Self::SERVER_LIST_STATUS, self.status as i32),\n            (Self::SERVER_TYPE, self.server_type),\n            (\n                Self::SERVER_LIST_SQUARE_BRACKET,\n                i32::from(self.use_square_brackets),\n            ),\n            (Self::MAX_PLAYERS, self.max_players as i32),\n            (Self::SERVER_AGE, i32::from(self.server_age)),\n        ];\n        self.buffer.write_u32(fields.len() as u32)?;\n        for (f, v) in fields {\n            self.buffer.write_i32(f)?;\n            self.buffer.write_i32(v)?;\n        }\n        Ok(())\n    }\n}\n\n#[allow(clippy::cast_sign_loss, clippy::cast_possible_truncation)]\nimpl ReadablePacket for GSStatusUpdate {\n    const PACKET_ID: u8 = 0x06;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?; //packet id\n        let size = buffer.read_i32()? as usize;\n        let mut instance = Self::default();\n        for _ in 0..size {\n            let gs_type = buffer.read_i32()?;\n            let value = buffer.read_i32()?;\n\n            match gs_type {\n                Self::SERVER_LIST_STATUS =\u003e {\n                    if let Some(stat) = GSStatus::from_opcode(value) {\n                        instance.status = stat;\n                    }\n                }\n                Self::SERVER_LIST_SQUARE_BRACKET =\u003e {\n                    instance.use_square_brackets = value != 0;\n                }\n                Self::MAX_PLAYERS =\u003e {\n                    instance.max_players = value as u32;\n                }\n                Self::SERVER_TYPE =\u003e {\n                    instance.server_type = value;\n                }\n                Self::SERVER_AGE =\u003e {\n                    instance.server_age = value as u8;\n                }\n                _ =\u003e {}\n            };\n        }\n        Ok(instance)\n    }\n}\n","traces":[{"line":28,"address":[12141488,12141897],"length":1,"stats":{"Line":0}},{"line":30,"address":[12141518],"length":1,"stats":{"Line":0}},{"line":31,"address":[3217069,3217089],"length":1,"stats":{"Line":0}},{"line":36,"address":[3217107],"length":1,"stats":{"Line":0}},{"line":37,"address":[12141585],"length":1,"stats":{"Line":0}},{"line":38,"address":[12141579,12141591],"length":1,"stats":{"Line":0}},{"line":39,"address":[3217140],"length":1,"stats":{"Line":0}},{"line":41,"address":[3217364,3217203,3217257],"length":1,"stats":{"Line":0}},{"line":42,"address":[12141784],"length":1,"stats":{"Line":0}},{"line":45,"address":[3218272,3217456],"length":1,"stats":{"Line":0}},{"line":46,"address":[12432980,12433220],"length":1,"stats":{"Line":0}},{"line":47,"address":[3217591],"length":1,"stats":{"Line":0}},{"line":48,"address":[12142000],"length":1,"stats":{"Line":0}},{"line":49,"address":[3217552],"length":1,"stats":{"Line":0}},{"line":52,"address":[12142021],"length":1,"stats":{"Line":0}},{"line":54,"address":[12433081],"length":1,"stats":{"Line":0}},{"line":55,"address":[3217578],"length":1,"stats":{"Line":0}},{"line":57,"address":[12142121,12142289],"length":1,"stats":{"Line":0}},{"line":58,"address":[12142216,12142442,12142328,12142399],"length":1,"stats":{"Line":0}},{"line":59,"address":[12142508,12142474,12142591,12142773],"length":1,"stats":{"Line":0}},{"line":60,"address":[3218139,3218087],"length":1,"stats":{"Line":0}},{"line":62,"address":[3217946],"length":1,"stats":{"Line":0}},{"line":71,"address":[12433856,12434839],"length":1,"stats":{"Line":0}},{"line":72,"address":[3218337],"length":1,"stats":{"Line":0}},{"line":73,"address":[12434025,12433900],"length":1,"stats":{"Line":0}},{"line":74,"address":[12142924,12143016,12143094],"length":1,"stats":{"Line":0}},{"line":75,"address":[12143054],"length":1,"stats":{"Line":0}},{"line":76,"address":[3218659,3218546],"length":1,"stats":{"Line":0}},{"line":77,"address":[12143797,12143315,12143439,12143352],"length":1,"stats":{"Line":0}},{"line":78,"address":[12143776,12143410,12143476,12143582],"length":1,"stats":{"Line":0}},{"line":80,"address":[12143538],"length":1,"stats":{"Line":0}},{"line":82,"address":[12143623,12143771,12143714],"length":1,"stats":{"Line":0}},{"line":83,"address":[12143764],"length":1,"stats":{"Line":0}},{"line":86,"address":[12143657],"length":1,"stats":{"Line":0}},{"line":87,"address":[12143642],"length":1,"stats":{"Line":0}},{"line":89,"address":[3219122],"length":1,"stats":{"Line":0}},{"line":90,"address":[3219115],"length":1,"stats":{"Line":0}},{"line":92,"address":[3219138],"length":1,"stats":{"Line":0}},{"line":93,"address":[3219131],"length":1,"stats":{"Line":0}},{"line":95,"address":[3219154],"length":1,"stats":{"Line":0}},{"line":96,"address":[3219147],"length":1,"stats":{"Line":0}},{"line":101,"address":[3218741],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":42},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","mod.rs"],"content":"mod access_level;\nmod auth;\nmod blowfish;\nmod change_password;\nmod gs_status;\nmod player_auth_request;\nmod player_in_game;\nmod player_logout;\nmod player_tracert;\nmod reply_chars;\nmod request_temp_ban;\n\npub use self::{\n    access_level::ChangeAL as ChangeAccessLevel, auth::RequestAuthGS, blowfish::BlowFish,\n    change_password::ChangePassword, gs_status::GSStatusUpdate,\n    player_auth_request::PlayerAuthRequest, player_in_game::PlayerInGame,\n    player_logout::PlayerLogout, player_tracert::PlayerTracert, reply_chars::ReplyChars,\n    request_temp_ban::RequestTempBan\n};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","player_auth_request.rs"],"content":"use macro_common::SendablePacketImpl;\nuse crate::session::SessionKey;\nuse crate::shared_packets::common::{ReadablePacket};\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse crate as l2_core;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct PlayerAuthRequest {\n    pub session: SessionKey,\n    pub account_name: String,\n    buffer: SendablePacketBuffer,\n}\nimpl PlayerAuthRequest {\n    ///\n    /// # Errors\n    /// - packet size is too large\n    pub fn new(account_name: \u0026str, session: SessionKey) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            account_name: account_name.to_string(),\n            session,\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write(0x05)?;\n        inst.buffer.write_c_utf16le_string(Some(\u0026inst.account_name))?;\n        inst.buffer.write_i32(inst.session.play_ok1)?;\n        inst.buffer.write_i32(inst.session.play_ok2)?;\n        inst.buffer.write_i32(inst.session.login_ok1)?;\n        inst.buffer.write_i32(inst.session.login_ok2)?;\n        Ok(inst)\n    }\n}\nimpl ReadablePacket for PlayerAuthRequest {\n    const PACKET_ID: u8 = 0x05;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let account_name = buffer.read_c_utf16le_string()?;\n        let play_ok1 = buffer.read_i32()?;\n        let play_ok2 = buffer.read_i32()?;\n        let login_ok1 = buffer.read_i32()?;\n        let login_ok2 = buffer.read_i32()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            account_name,\n            session: SessionKey {\n                play_ok1,\n                play_ok2,\n                login_ok1,\n                login_ok2,\n            },\n        })\n    }\n}\n\n","traces":[{"line":18,"address":[12366247,12365008],"length":1,"stats":{"Line":1}},{"line":20,"address":[2984020],"length":1,"stats":{"Line":1}},{"line":22,"address":[2984033],"length":1,"stats":{"Line":1}},{"line":24,"address":[12365286,12365390,12366245,12365216],"length":1,"stats":{"Line":2}},{"line":25,"address":[12662568,12663219,12662320,12662418],"length":1,"stats":{"Line":2}},{"line":26,"address":[12365634,12366241,12365553,12365731],"length":1,"stats":{"Line":2}},{"line":27,"address":[12365870,12365692,12366239,12365773],"length":1,"stats":{"Line":2}},{"line":28,"address":[2984739,2984901,2985116,2984812],"length":1,"stats":{"Line":2}},{"line":29,"address":[12662946,12663195,12663027,12663145],"length":1,"stats":{"Line":2}},{"line":30,"address":[12663083],"length":1,"stats":{"Line":1}},{"line":37,"address":[12367425,12366272],"length":1,"stats":{"Line":1}},{"line":38,"address":[12366305],"length":1,"stats":{"Line":1}},{"line":39,"address":[2985195,2985332],"length":1,"stats":{"Line":1}},{"line":40,"address":[12366374,12366488,12366575],"length":1,"stats":{"Line":2}},{"line":41,"address":[12663713,12664399,12663522,12663626],"length":1,"stats":{"Line":2}},{"line":42,"address":[2985586,2986242,2985710,2985647],"length":1,"stats":{"Line":2}},{"line":43,"address":[2986240,2985822,2985698,2985759],"length":1,"stats":{"Line":2}},{"line":44,"address":[2986225,2985929,2985810,2985871],"length":1,"stats":{"Line":2}},{"line":45,"address":[2986050],"length":1,"stats":{"Line":1}},{"line":46,"address":[2985917],"length":1,"stats":{"Line":1}},{"line":47,"address":[2985983],"length":1,"stats":{"Line":1}},{"line":48,"address":[2986022],"length":1,"stats":{"Line":1}}],"covered":22,"coverable":22},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","player_in_game.rs"],"content":"use crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\nuse crate as l2_core;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct PlayerInGame {\n    buffer: SendablePacketBuffer,\n    pub accounts: Vec\u003cString\u003e,\n}\n\nimpl PlayerInGame {\n    ///\n    /// # Errors\n    /// - when packet size is too big\n    pub fn new(accounts: \u0026[String]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            accounts: accounts.to_vec(),\n        };\n        inst.write_all()?;\n        Ok(inst)\n    }\n    /// # Errors\n    /// - when packet size is too big\n    #[allow(clippy::cast_possible_truncation, clippy::cast_possible_wrap)]\n    pub fn write_all(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        self.buffer.write(0x02)?;\n        self.buffer.write_i16(self.accounts.len() as i16)?;\n        for acc in \u0026self.accounts {\n            self.buffer.write_c_utf16le_string(Some(acc))?;\n        }\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for PlayerInGame {\n    const PACKET_ID: u8 = 0x02;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let size = buffer.read_i16()?;\n        let mut accounts: Vec\u003cString\u003e = vec![];\n        for _ in 0..size {\n            let st = buffer.read_c_utf16le_string()?;\n            accounts.push(st);\n        }\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            accounts,\n        })\n    }\n}\n","traces":[{"line":17,"address":[12466624,12467036],"length":1,"stats":{"Line":1}},{"line":19,"address":[3065680],"length":1,"stats":{"Line":1}},{"line":20,"address":[3065695],"length":1,"stats":{"Line":1}},{"line":22,"address":[12466976,12466867,12466800],"length":1,"stats":{"Line":2}},{"line":23,"address":[12766315],"length":1,"stats":{"Line":1}},{"line":28,"address":[12467072],"length":1,"stats":{"Line":1}},{"line":29,"address":[12467089,12467223],"length":1,"stats":{"Line":1}},{"line":30,"address":[3066123,3066253],"length":1,"stats":{"Line":1}},{"line":31,"address":[12766768,12766656,12766710],"length":1,"stats":{"Line":3}},{"line":32,"address":[12766882,12766778],"length":1,"stats":{"Line":1}},{"line":34,"address":[12467360],"length":1,"stats":{"Line":1}},{"line":42,"address":[12468564,12467536,12468528],"length":1,"stats":{"Line":1}},{"line":43,"address":[3066529],"length":1,"stats":{"Line":1}},{"line":44,"address":[12467588,12467696],"length":1,"stats":{"Line":1}},{"line":45,"address":[12767185,12767038,12767128],"length":1,"stats":{"Line":2}},{"line":46,"address":[3066698],"length":1,"stats":{"Line":1}},{"line":47,"address":[3066681,3066721,3067434,3066827],"length":1,"stats":{"Line":4}},{"line":48,"address":[3067359,3066940,3067162],"length":1,"stats":{"Line":2}},{"line":49,"address":[3067280],"length":1,"stats":{"Line":1}},{"line":51,"address":[3067003],"length":1,"stats":{"Line":1}},{"line":52,"address":[3066920],"length":1,"stats":{"Line":1}},{"line":53,"address":[3066955],"length":1,"stats":{"Line":1}}],"covered":22,"coverable":22},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","player_logout.rs"],"content":"use crate as l2_core;\nuse crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct PlayerLogout {\n    pub acc: String,\n    pub buffer: SendablePacketBuffer,\n}\nimpl PlayerLogout {\n    #[allow(clippy::missing_errors_doc)]\n    pub fn new(acc: \u0026str) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut inst = Self {\n            acc: String::new(),\n            buffer: SendablePacketBuffer::new(),\n        };\n        inst.buffer.write(Self::PACKET_ID)?;\n        inst.buffer.write_c_utf16le_string(Some(acc))?;\n        Ok(inst)\n    }\n}\nimpl ReadablePacket for PlayerLogout {\n    const PACKET_ID: u8 = 0x03;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let acc = buffer.read_c_utf16le_string()?;\n        Ok(Self {\n            acc,\n            buffer: SendablePacketBuffer::empty(),\n        })\n    }\n}\n","traces":[{"line":14,"address":[12362904,12362320],"length":1,"stats":{"Line":1}},{"line":16,"address":[3016787],"length":1,"stats":{"Line":1}},{"line":17,"address":[3016800],"length":1,"stats":{"Line":1}},{"line":19,"address":[3016967,3017085,3016913,3017285],"length":1,"stats":{"Line":2}},{"line":20,"address":[12075608,12075399,12075499,12075655],"length":1,"stats":{"Line":2}},{"line":21,"address":[12075555],"length":1,"stats":{"Line":1}},{"line":28,"address":[3017901,3017882,3017312],"length":1,"stats":{"Line":0}},{"line":29,"address":[3017345],"length":1,"stats":{"Line":0}},{"line":30,"address":[3017497,3017363],"length":1,"stats":{"Line":0}},{"line":31,"address":[3017419,3017527,3017644],"length":1,"stats":{"Line":0}},{"line":32,"address":[3017731],"length":1,"stats":{"Line":0}},{"line":33,"address":[3017590],"length":1,"stats":{"Line":0}},{"line":34,"address":[3017632],"length":1,"stats":{"Line":0}}],"covered":6,"coverable":13},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","player_tracert.rs"],"content":"use crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse async_trait::async_trait;\n\n#[derive(Clone, Debug)]\npub struct PlayerTracert {\n    pub account: String,\n    pub pc_ip: String,\n    pub hop1: String,\n    pub hop2: String,\n    pub hop3: String,\n    pub hop4: String,\n}\n\n#[async_trait]\nimpl ReadablePacket for PlayerTracert {\n    const PACKET_ID: u8 = 0x07;\nconst EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let account_name = buffer.read_c_utf16le_string()?;\n        let pc_ip = buffer.read_c_utf16le_string()?;\n        let hop1 = buffer.read_c_utf16le_string()?;\n        let hop2 = buffer.read_c_utf16le_string()?;\n        let hop3 = buffer.read_c_utf16le_string()?;\n        let hop4 = buffer.read_c_utf16le_string()?;\n        Ok(Self {\n            account: account_name,\n            pc_ip,\n            hop1,\n            hop2,\n            hop3,\n            hop4,\n        })\n    }\n}\n","traces":[{"line":20,"address":[12429232,12431358,12431290],"length":1,"stats":{"Line":0}},{"line":21,"address":[3023905],"length":1,"stats":{"Line":0}},{"line":22,"address":[3023915,3024046],"length":1,"stats":{"Line":0}},{"line":23,"address":[3023971,3024076,3024156],"length":1,"stats":{"Line":0}},{"line":24,"address":[3024144,3025929,3024243,3024374],"length":1,"stats":{"Line":0}},{"line":25,"address":[3025914,3024467,3024598,3024362],"length":1,"stats":{"Line":0}},{"line":26,"address":[3024822,3024586,3024691,3025893],"length":1,"stats":{"Line":0}},{"line":27,"address":[3025872,3024915,3024810,3025046],"length":1,"stats":{"Line":0}},{"line":28,"address":[3025782,3025034,3025139],"length":1,"stats":{"Line":0}},{"line":29,"address":[3025469],"length":1,"stats":{"Line":0}},{"line":30,"address":[3025238],"length":1,"stats":{"Line":0}},{"line":31,"address":[3025277],"length":1,"stats":{"Line":0}},{"line":32,"address":[3025325],"length":1,"stats":{"Line":0}},{"line":33,"address":[3025373],"length":1,"stats":{"Line":0}},{"line":34,"address":[3025421],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":15},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","reply_chars.rs"],"content":"use crate as l2_core;\nuse crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse async_trait::async_trait;\nuse entities::entities::character;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Clone, Debug, SendablePacketImpl)]\npub struct ReplyChars {\n    pub buffer: SendablePacketBuffer,\n    pub account_name: String,\n    pub chars: u8,\n    pub delete_chars_len: u8,\n    pub char_deletion_timestamps: Vec\u003ci64\u003e,\n}\n\nimpl ReplyChars {\n    #[allow(clippy::cast_possible_truncation, clippy::missing_errors_doc)]\n    pub fn new(account_name: String, chars: \u0026[character::Model]) -\u003e anyhow::Result\u003cReplyChars\u003e {\n        let mut chars_to_del_list = vec![];\n        for ch in chars {\n            if let Some(del_at) = ch.delete_at {\n                chars_to_del_list.push(del_at.timestamp());\n            }\n        }\n        let mut inst = Self {\n            buffer: SendablePacketBuffer::new(),\n            account_name,\n            chars: 0,\n            delete_chars_len: 0,\n            char_deletion_timestamps: chars_to_del_list,\n        };\n        inst.buffer.write(0x08)?;\n        inst.buffer\n            .write_c_utf16le_string(Some(\u0026inst.account_name))?;\n        inst.buffer.write(inst.chars)?;\n        inst.buffer.write(inst.delete_chars_len)?;\n        for ch in \u0026inst.char_deletion_timestamps {\n            inst.buffer.write_i64(*ch)?;\n        }\n        Ok(inst)\n    }\n}\n\n#[async_trait]\nimpl ReadablePacket for ReplyChars {\n    const PACKET_ID: u8 = 0x08;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let account_name = buffer.read_c_utf16le_string()?;\n        let chars = buffer.read_byte()?;\n        let chars_to_delete = buffer.read_byte()?;\n        let mut char_list: Vec\u003ci64\u003e = vec![];\n        for _ in 0..chars_to_delete {\n            char_list.push(buffer.read_i64()?);\n        }\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            account_name,\n            chars,\n            delete_chars_len: chars_to_delete,\n            char_deletion_timestamps: char_list,\n        })\n    }\n}\n","traces":[{"line":20,"address":[12754400,12756187,12756075],"length":1,"stats":{"Line":0}},{"line":21,"address":[2810367],"length":1,"stats":{"Line":0}},{"line":22,"address":[2810552,2810651,2810467],"length":1,"stats":{"Line":0}},{"line":23,"address":[12458876,12457567],"length":1,"stats":{"Line":0}},{"line":24,"address":[12458891],"length":1,"stats":{"Line":0}},{"line":28,"address":[12754740],"length":1,"stats":{"Line":0}},{"line":34,"address":[12457875,12458844,12457979,12457799],"length":1,"stats":{"Line":0}},{"line":35,"address":[2811277,2811139,2811029,2811882],"length":1,"stats":{"Line":0}},{"line":36,"address":[12458031,12458181,12457954],"length":1,"stats":{"Line":0}},{"line":37,"address":[2811226,2811299,2811880,2811389],"length":1,"stats":{"Line":0}},{"line":38,"address":[2811353,2811878,2811427,2811518],"length":1,"stats":{"Line":0}},{"line":39,"address":[12458421,12458505,12458649],"length":1,"stats":{"Line":0}},{"line":40,"address":[2811721,2811765],"length":1,"stats":{"Line":0}},{"line":42,"address":[12755803],"length":1,"stats":{"Line":0}},{"line":51,"address":[12758317,12758330,12756976],"length":1,"stats":{"Line":0}},{"line":52,"address":[12459793],"length":1,"stats":{"Line":0}},{"line":53,"address":[12459804,12459945],"length":1,"stats":{"Line":0}},{"line":54,"address":[2812994,2812883,2813080],"length":1,"stats":{"Line":0}},{"line":55,"address":[12460037,12461112,12460233,12460141],"length":1,"stats":{"Line":0}},{"line":56,"address":[12757573,12758326,12757486,12757420],"length":1,"stats":{"Line":0}},{"line":57,"address":[2813330],"length":1,"stats":{"Line":0}},{"line":58,"address":[12460398,12460474],"length":1,"stats":{"Line":0}},{"line":59,"address":[12460577,12460924],"length":1,"stats":{"Line":0}},{"line":61,"address":[2813694],"length":1,"stats":{"Line":0}},{"line":62,"address":[2813559],"length":1,"stats":{"Line":0}},{"line":63,"address":[2813604],"length":1,"stats":{"Line":0}},{"line":66,"address":[2813646],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":27},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","gs_2_ls","request_temp_ban.rs"],"content":"use crate::shared_packets::common::ReadablePacket;\nuse crate::shared_packets::read::ReadablePacketBuffer;\n\n#[derive(Clone, Debug)]\npub struct RequestTempBan {\n    pub account: String,\n    pub ban_duration: i64,\n    pub ip: String,\n}\n\nimpl ReadablePacket for RequestTempBan {\n    const PACKET_ID: u8 = 0x0A;\nconst EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        Ok(Self {\n            account: buffer.read_c_utf16le_string()?,\n            ip: buffer.read_c_utf16le_string()?,\n            ban_duration: buffer.read_i64()?,\n        })\n    }\n}\n","traces":[{"line":15,"address":[2686857,2685888],"length":1,"stats":{"Line":0}},{"line":16,"address":[2685921],"length":1,"stats":{"Line":0}},{"line":17,"address":[2686068,2685931],"length":1,"stats":{"Line":0}},{"line":18,"address":[2686577],"length":1,"stats":{"Line":0}},{"line":19,"address":[2685987,2686187,2686098],"length":1,"stats":{"Line":0}},{"line":20,"address":[2686175,2686413,2686280],"length":1,"stats":{"Line":0}},{"line":21,"address":[2686500,2686391,2686694],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","auth_gs.rs"],"content":"use macro_common::SendablePacketImpl;\nuse crate::shared_packets::{\n    common::ReadablePacket,\n    read::ReadablePacketBuffer,\n    write::SendablePacketBuffer,\n};\nuse crate as l2_core;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct AuthGS {\n    buffer: SendablePacketBuffer,\n    pub server_id: u8,\n    pub server_name: String,\n}\n\nimpl AuthGS {\n    #[must_use]\n    pub fn new(server_id: u8, server_name: String) -\u003e AuthGS {\n        let mut gg = AuthGS {\n            buffer: SendablePacketBuffer::new(),\n            server_id,\n            server_name,\n        };\n        let _ = gg.write_all();\n        gg\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_u8(0x02)?;\n        self.buffer.write_u8(self.server_id)?;\n        self.buffer.write_c_utf16le_string(Some(\u0026self.server_name))?;\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for AuthGS {\n    const PACKET_ID: u8 = 0x02;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        let _packet_id = buffer.read_byte()?;\n        let server_id = buffer.read_byte()?;\n        let server_name = buffer.read_c_utf16le_string()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            server_id,\n            server_name,\n        })\n    }\n}\n","traces":[{"line":18,"address":[12522277,12521952],"length":1,"stats":{"Line":0}},{"line":20,"address":[2800265],"length":1,"stats":{"Line":0}},{"line":24,"address":[2800411,2800465],"length":1,"stats":{"Line":0}},{"line":25,"address":[12225273],"length":1,"stats":{"Line":0}},{"line":27,"address":[2800560],"length":1,"stats":{"Line":0}},{"line":28,"address":[12225477,12225358],"length":1,"stats":{"Line":0}},{"line":29,"address":[12225603,12225418],"length":1,"stats":{"Line":0}},{"line":30,"address":[2800726,2800852],"length":1,"stats":{"Line":0}},{"line":31,"address":[2800841],"length":1,"stats":{"Line":0}},{"line":39,"address":[12225696,12226376],"length":1,"stats":{"Line":0}},{"line":40,"address":[12225729],"length":1,"stats":{"Line":0}},{"line":41,"address":[12225740,12225855],"length":1,"stats":{"Line":0}},{"line":42,"address":[2800995,2801077,2801173],"length":1,"stats":{"Line":0}},{"line":43,"address":[2801203,2801284,2801092],"length":1,"stats":{"Line":0}},{"line":44,"address":[2801409],"length":1,"stats":{"Line":0}},{"line":45,"address":[2801272],"length":1,"stats":{"Line":0}},{"line":47,"address":[2801367],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","init_ls.rs"],"content":"use crate::constants;\nuse crate::shared_packets::common::{LoginServerOpcodes, ReadablePacket};\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\nuse crate as l2_core;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct InitLS {\n    buffer: SendablePacketBuffer,\n    pub revision: i32,\n    pub public_key: Vec\u003cu8\u003e,\n}\n\nimpl InitLS {\n    #[must_use]\n    pub fn new(public_key: Vec\u003cu8\u003e) -\u003e Self {\n        let mut init_ls = InitLS {\n            buffer: SendablePacketBuffer::new(),\n            revision: constants::PROTOCOL_REVISION,\n            public_key,\n        };\n        let _ = init_ls.write_all();\n        init_ls\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(LoginServerOpcodes::Init as u8)?;\n        self.buffer.write_i32(self.revision)?; // LS protocol revision\n        #[allow(clippy::cast_possible_wrap, clippy::cast_possible_truncation)]\n        self.buffer.write_i32(self.public_key.len() as i32)?; // key length\n        self.buffer.write_bytes(self.public_key.as_slice())?; // RSA Public Key\n        Ok(())\n    }\n}\n\n\nimpl ReadablePacket for InitLS {\n    const PACKET_ID: u8 = 0x00;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        let _packet_id = buffer.read_byte()?;\n        let revision = buffer.read_i32()?; // LS protocol revision\n        let key_size = buffer.read_i32()?; // key length\n        #[allow(clippy::cast_sign_loss)]\n        let public_key = buffer.read_bytes(key_size as usize)?.to_vec(); // RSA Public Key\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            revision,\n            public_key,\n        })\n    }\n}\n","traces":[{"line":17,"address":[12669424,12669730],"length":1,"stats":{"Line":0}},{"line":19,"address":[2822555],"length":1,"stats":{"Line":0}},{"line":23,"address":[2822698,2822750],"length":1,"stats":{"Line":0}},{"line":24,"address":[12372726],"length":1,"stats":{"Line":0}},{"line":26,"address":[2822848],"length":1,"stats":{"Line":0}},{"line":27,"address":[2823024,2822865],"length":1,"stats":{"Line":0}},{"line":28,"address":[12372922,12373094],"length":1,"stats":{"Line":0}},{"line":30,"address":[12373021,12373206],"length":1,"stats":{"Line":0}},{"line":31,"address":[12373132,12373247],"length":1,"stats":{"Line":0}},{"line":32,"address":[12373236],"length":1,"stats":{"Line":0}},{"line":41,"address":[12373296,12374062],"length":1,"stats":{"Line":0}},{"line":42,"address":[12373329],"length":1,"stats":{"Line":0}},{"line":43,"address":[12670423,12670316],"length":1,"stats":{"Line":0}},{"line":44,"address":[2823427,2823572,2823504],"length":1,"stats":{"Line":0}},{"line":45,"address":[2823691,2823519,2823602],"length":1,"stats":{"Line":0}},{"line":47,"address":[2823613,2823724,2823793],"length":1,"stats":{"Line":0}},{"line":48,"address":[2823927],"length":1,"stats":{"Line":0}},{"line":49,"address":[2823781],"length":1,"stats":{"Line":0}},{"line":51,"address":[2823879],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","kick_player.rs"],"content":"use macro_common::SendablePacketImpl;\nuse crate::shared_packets::read::ReadablePacketBuffer;\nuse crate::shared_packets::{\n    common::ReadablePacket,\n    write::SendablePacketBuffer,\n};\nuse crate as l2_core;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct KickPlayer {\n    pub buffer: SendablePacketBuffer,\n    pub account_name: String,\n}\n\nimpl KickPlayer {\n    #[must_use]\n    pub fn new(account_name: \u0026str) -\u003e Self {\n        let mut pack = Self {\n            buffer: SendablePacketBuffer::new(),\n            account_name: account_name.to_string(),\n        };\n        let _ = pack.write_all();\n        pack\n    }\n\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write(0x04)?;\n        self.buffer.write_c_utf16le_string(Some(\u0026self.account_name))?;\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for KickPlayer {\n    const PACKET_ID: u8 = 0x04;\nconst EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let account_name = buffer.read_c_utf16le_string()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            account_name,\n        })\n    }\n}\n","traces":[{"line":17,"address":[12752864,12753153],"length":1,"stats":{"Line":0}},{"line":19,"address":[2841952],"length":1,"stats":{"Line":0}},{"line":20,"address":[2841975],"length":1,"stats":{"Line":0}},{"line":22,"address":[12455877,12455822],"length":1,"stats":{"Line":0}},{"line":23,"address":[2842149],"length":1,"stats":{"Line":0}},{"line":26,"address":[12455968],"length":1,"stats":{"Line":0}},{"line":27,"address":[2842366,2842222],"length":1,"stats":{"Line":0}},{"line":28,"address":[12456042,12456171],"length":1,"stats":{"Line":0}},{"line":29,"address":[2842395],"length":1,"stats":{"Line":0}},{"line":37,"address":[2842448,2842985],"length":1,"stats":{"Line":0}},{"line":38,"address":[12456257],"length":1,"stats":{"Line":0}},{"line":39,"address":[2842622,2842491],"length":1,"stats":{"Line":0}},{"line":40,"address":[2842547,2842652,2842727],"length":1,"stats":{"Line":0}},{"line":41,"address":[2842842],"length":1,"stats":{"Line":0}},{"line":42,"address":[2842715],"length":1,"stats":{"Line":0}},{"line":43,"address":[2842803],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","mod.rs"],"content":"mod auth_gs;\nmod init_ls;\nmod kick_player;\nmod player_auth_response;\nmod request_chars;\n\npub use self::{\n    auth_gs::AuthGS, init_ls::InitLS, kick_player::KickPlayer,\n    player_auth_response::PlayerAuthResponse, request_chars::RequestChars,\n};\n\n#[repr(i32)]\n#[derive(Clone, Debug)]\npub enum PlayerKickedReasons {\n    DataStealer = 0x01,\n    GenericViolation = 0x08,\n    SevenDaysSuspended = 0x10,\n    PermanentlyBanned = 0x20,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","player_auth_response.rs"],"content":"use crate::shared_packets::{\n    common::ReadablePacket,\n    read::ReadablePacketBuffer,\n    write::SendablePacketBuffer,\n};\nuse macro_common::SendablePacketImpl;\nuse crate as l2_core;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct PlayerAuthResponse {\n    pub buffer: SendablePacketBuffer,\n    pub account: String,\n    pub is_ok: bool,\n}\n\nimpl PlayerAuthResponse {\n    #[must_use]\n    pub fn new(account: \u0026str, is_ok: bool) -\u003e PlayerAuthResponse {\n        let mut gg = PlayerAuthResponse {\n            buffer: SendablePacketBuffer::new(),\n            account: account.to_string(),\n            is_ok,\n        };\n        let _ = gg.write_all();\n        gg\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_u8(0x03)?;\n        self.buffer.write_c_utf16le_string(Some(\u0026self.account))?;\n        self.buffer.write_u8(u8::from(self.is_ok))?;\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for PlayerAuthResponse {\n    const PACKET_ID: u8 = 0x03;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        let _packet_id = buffer.read_byte()?;\n        let account = buffer.read_c_utf16le_string()?;\n        let is_ok = buffer.read_boolean()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            is_ok,\n            account,\n        })\n    }\n}\n","traces":[{"line":18,"address":[3248395,3248096],"length":1,"stats":{"Line":1}},{"line":20,"address":[3248159],"length":1,"stats":{"Line":1}},{"line":21,"address":[3248182],"length":1,"stats":{"Line":1}},{"line":24,"address":[12482346,12482399],"length":1,"stats":{"Line":2}},{"line":25,"address":[3248367],"length":1,"stats":{"Line":1}},{"line":27,"address":[12482496],"length":1,"stats":{"Line":1}},{"line":28,"address":[12778718,12778868],"length":1,"stats":{"Line":1}},{"line":29,"address":[3248504,3248699],"length":1,"stats":{"Line":1}},{"line":30,"address":[12482811,12482698,12482719],"length":1,"stats":{"Line":2}},{"line":31,"address":[12482800],"length":1,"stats":{"Line":1}},{"line":39,"address":[12483569,12482864],"length":1,"stats":{"Line":0}},{"line":40,"address":[12482897],"length":1,"stats":{"Line":0}},{"line":41,"address":[12483043,12482908],"length":1,"stats":{"Line":0}},{"line":42,"address":[3248883,3249068,3248988],"length":1,"stats":{"Line":0}},{"line":43,"address":[3249056,3249155,3249220],"length":1,"stats":{"Line":0}},{"line":44,"address":[3249301],"length":1,"stats":{"Line":0}},{"line":45,"address":[3249208],"length":1,"stats":{"Line":0}},{"line":47,"address":[3249262],"length":1,"stats":{"Line":0}}],"covered":10,"coverable":18},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","ls_2_gs","request_chars.rs"],"content":"use macro_common::SendablePacketImpl;\nuse crate::shared_packets::{\n    common::ReadablePacket,\n    read::ReadablePacketBuffer,\n    write::SendablePacketBuffer,\n};\nuse crate as l2_core;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct RequestChars {\n    pub buffer: SendablePacketBuffer,\n    pub account_name: String,\n}\n\nimpl RequestChars {\n    #[must_use]\n    pub fn new(account_name: \u0026str) -\u003e RequestChars {\n        let mut gg = RequestChars {\n            buffer: SendablePacketBuffer::new(),\n            account_name: account_name.to_string(),\n        };\n        let _ = gg.write_all(); // safe to ignore\n        gg\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_u8(0x05)?;\n        self.buffer.write_c_utf16le_string(Some(\u0026self.account_name))?;\n        Ok(())\n    }\n}\n\nimpl ReadablePacket for RequestChars {\n    const PACKET_ID: u8 = 0x05;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        buffer.read_byte()?;\n        let account_name = buffer.read_c_utf16le_string()?;\n        Ok(Self {\n            buffer: SendablePacketBuffer::empty(),\n            account_name,\n        })\n    }\n}\n","traces":[{"line":17,"address":[12671664,12671953],"length":1,"stats":{"Line":0}},{"line":19,"address":[2687392],"length":1,"stats":{"Line":0}},{"line":20,"address":[2687415],"length":1,"stats":{"Line":0}},{"line":22,"address":[12374718,12374773],"length":1,"stats":{"Line":0}},{"line":23,"address":[2687589],"length":1,"stats":{"Line":0}},{"line":25,"address":[12374864],"length":1,"stats":{"Line":0}},{"line":26,"address":[2687662,2687806],"length":1,"stats":{"Line":0}},{"line":27,"address":[12374938,12375067],"length":1,"stats":{"Line":0}},{"line":28,"address":[2687835],"length":1,"stats":{"Line":0}},{"line":36,"address":[2688425,2687888],"length":1,"stats":{"Line":0}},{"line":37,"address":[12375153],"length":1,"stats":{"Line":0}},{"line":38,"address":[2688062,2687931],"length":1,"stats":{"Line":0}},{"line":39,"address":[2687987,2688092,2688167],"length":1,"stats":{"Line":0}},{"line":40,"address":[2688282],"length":1,"stats":{"Line":0}},{"line":41,"address":[2688155],"length":1,"stats":{"Line":0}},{"line":42,"address":[2688243],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","mod.rs"],"content":"pub mod common;\npub mod gs_2_ls;\npub mod ls_2_gs;\npub mod read;\npub mod write;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","read.rs"],"content":"use anyhow::{anyhow, bail, Result};\nuse encoding::all::UTF_16LE;\nuse encoding::{DecoderTrap, Encoding};\n\n#[derive(Debug, Clone)]\npub struct ReadablePacketBuffer\u003c'a\u003e {\n    bytes: \u0026'a [u8],\n    position: usize,\n}\n\nimpl\u003c'a\u003e ReadablePacketBuffer\u003c'a\u003e {\n    #[must_use]\n    pub fn new(bytes: \u0026'a [u8]) -\u003e Self {\n        ReadablePacketBuffer { bytes, position: 0 }\n    }\n\n    // Helper method to check buffer bounds and advance position\n    fn check_and_advance(\u0026mut self, length: usize) -\u003e Result\u003c()\u003e {\n        if self.position + length \u003e self.bytes.len() {\n            bail!(\n                \"Not enough bytes available. Requested: {}, Remaining: {}\",\n                length,\n                self.bytes.len() - self.position\n            );\n        }\n        self.position += length;\n        Ok(())\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_boolean(\u0026mut self) -\u003e Result\u003cbool\u003e {\n        Ok(self.read_byte()? != 0)\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_c_utf16le_string(\u0026mut self) -\u003e Result\u003cString\u003e {\n        let mut result = String::new();\n        let bytes = \u0026self.bytes[self.position..];\n        let mut i = 0;\n        while i + 1 \u003c bytes.len() {\n            let utf16_value = u16::from_le_bytes([bytes[i], bytes[i + 1]]);\n            i += 2;\n            if utf16_value == 0 {\n                break;\n            }\n            if let Some(ch) = char::from_u32(u32::from(utf16_value)) {\n                result.push(ch);\n            } else {\n                result.push('\\u{FFFD}'); // Unicode replacement character\n            }\n        }\n        self.position += i;\n        Ok(result)\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_n_strings(\u0026mut self, count: usize) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        (0..count).map(|_| self.read_c_utf16le_string()).collect()\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    #[allow(clippy::cast_sign_loss)]\n    pub fn read_sized_string(\u0026mut self) -\u003e Result\u003cString\u003e {\n        let length = self.read_i16()? as usize;\n        let bytes = self.read_bytes(length * 2)?;\n        UTF_16LE\n            .decode(bytes, DecoderTrap::Replace)\n            .map_err(|e| anyhow!(\"Can not decode string from bytes {e}\"))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_bytes(\u0026mut self, length: usize) -\u003e Result\u003c\u0026[u8]\u003e {\n        self.check_and_advance(length)?;\n        Ok(\u0026self.bytes[self.position - length..self.position])\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_byte(\u0026mut self) -\u003e Result\u003cu8\u003e {\n        let byte = self\n            .bytes\n            .get(self.position)\n            .copied()\n            .ok_or_else(|| anyhow!(\"Buffer underflow\"))?;\n        self.position += 1;\n        Ok(byte)\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_i16(\u0026mut self) -\u003e Result\u003ci16\u003e {\n        self.check_and_advance(2)?;\n        let chunk = \u0026self.bytes[self.position - 2..self.position]; // Slice access\n        Ok(i16::from_le_bytes(\n            chunk\n                .try_into()\n                .map_err(|_| anyhow!(\"Invalid i16 byte slice\"))?,\n        ))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_u16(\u0026mut self) -\u003e Result\u003cu16\u003e {\n        self.check_and_advance(2)?;\n        let chunk = \u0026self.bytes[self.position - 2..self.position]; // Slice access\n        Ok(u16::from_le_bytes(\n            chunk\n                .try_into()\n                .map_err(|_| anyhow!(\"Invalid u16 byte slice\"))?,\n        ))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_i32(\u0026mut self) -\u003e Result\u003ci32\u003e {\n        self.check_and_advance(4)?;\n        let chunk = \u0026self.bytes[self.position - 4..self.position]; // Slice access\n        Ok(i32::from_le_bytes(\n            chunk\n                .try_into()\n                .map_err(|_| anyhow!(\"Invalid i32 byte slice\"))?,\n        ))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_u32(\u0026mut self) -\u003e Result\u003cu32\u003e {\n        self.check_and_advance(4)?;\n        let chunk = \u0026self.bytes[self.position - 4..self.position]; // Slice access\n        Ok(u32::from_le_bytes(\n            chunk\n                .try_into()\n                .map_err(|_| anyhow!(\"Invalid u32 byte slice\"))?,\n        ))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    pub fn read_i64(\u0026mut self) -\u003e Result\u003ci64\u003e {\n        self.check_and_advance(8)?;\n        let chunk = \u0026self.bytes[self.position - 8..self.position]; // Slice access\n        Ok(i64::from_le_bytes(\n            chunk\n                .try_into()\n                .map_err(|_| anyhow!(\"Invalid i64 byte slice\"))?,\n        ))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    #[allow(clippy::cast_sign_loss)]\n    pub fn read_f32(\u0026mut self) -\u003e Result\u003cf32\u003e {\n        Ok(f32::from_bits(self.read_i32()? as u32))\n    }\n\n    /// # Errors\n    /// - it's not enough bytes\n    #[allow(clippy::cast_sign_loss)]\n    pub fn read_f64(\u0026mut self) -\u003e Result\u003cf64\u003e {\n        Ok(f64::from_bits(self.read_i64()? as u64))\n    }\n\n    #[must_use]\n    pub fn get_remaining_length(\u0026self) -\u003e usize {\n        self.bytes.len() - self.position\n    }\n\n    #[must_use]\n    pub fn get_length(\u0026self) -\u003e usize {\n        self.bytes.len()\n    }\n}\n\n#[cfg(test)]\nmod test {\n    use super::*;\n\n    #[test]\n    fn test_all() {\n        let bytes = [\n            84, 0, 101, 0, 115, 0, 116, 0, 0, 0, 4, 0, 84, 0, 101, 0, 115, 0, 116, 0, 0, 1, 11, 11,\n            0, 11, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,\n            0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 205, 204, 92, 64, 154, 153, 153, 153, 153, 153, 11, 64,\n            0, 0, 0, 0, 0, 0,\n        ];\n        let mut packet = ReadablePacketBuffer::new(\u0026bytes);\n        let s1 = packet.read_c_utf16le_string().unwrap();\n        let s2 = packet.read_sized_string().unwrap();\n        let s3 = packet.read_byte().unwrap();\n        let s4 = packet.read_boolean().unwrap();\n        let s5 = packet.read_byte().unwrap(); //this was actually i8\n        let s6 = packet.read_i16().unwrap();\n        let s7 = packet.read_i32().unwrap();\n        let s8 = packet.read_i64().unwrap();\n        let s9 = packet.read_i16().unwrap();\n        let s10 = packet.read_i32().unwrap();\n        let s11 = packet.read_i64().unwrap();\n        let s12 = packet.read_byte().unwrap();\n        let s13 = packet.read_u16().unwrap();\n        let s14 = packet.read_u32().unwrap();\n        let s15 = packet.read_bytes(4).unwrap().to_vec();\n        let s16 = packet.read_f32().unwrap();\n        let s17 = packet.read_f64().unwrap();\n        assert_eq!(s1, \"Test\");\n        assert_eq!(s2, \"Test\");\n        assert_eq!(s3, 0);\n        assert!(s4);\n        assert_eq!(s5, 11);\n        assert_eq!(s6, 11);\n        assert_eq!(s7, 11);\n        assert_eq!(s8, 11);\n        assert_eq!(s9, 1);\n        assert_eq!(s10, 1);\n        assert_eq!(s11, 1);\n        assert_eq!(s12, 0);\n        assert_eq!(s13, 0);\n        assert_eq!(s14, 0);\n        assert_eq!(s15, [0, 1, 2, 3]);\n        assert_eq!(s16.to_bits(), 3.45f32.to_bits());\n        assert_eq!(s17.to_bits(), 3.45f64.to_bits());\n    }\n}\n","traces":[{"line":13,"address":[2803392],"length":1,"stats":{"Line":5}},{"line":18,"address":[12431984],"length":1,"stats":{"Line":4}},{"line":19,"address":[12432009],"length":1,"stats":{"Line":4}},{"line":20,"address":[2803983,2803848],"length":1,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[2803681,2803507,2803696],"length":1,"stats":{"Line":8}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":32,"address":[12729520],"length":1,"stats":{"Line":1}},{"line":33,"address":[12432685,12432610],"length":1,"stats":{"Line":1}},{"line":38,"address":[2805017,2804160],"length":1,"stats":{"Line":2}},{"line":39,"address":[12432755],"length":1,"stats":{"Line":2}},{"line":40,"address":[12729693,12729809],"length":1,"stats":{"Line":4}},{"line":41,"address":[2804337],"length":1,"stats":{"Line":2}},{"line":42,"address":[12432909],"length":1,"stats":{"Line":2}},{"line":43,"address":[12729937],"length":1,"stats":{"Line":2}},{"line":44,"address":[12730228,12730176],"length":1,"stats":{"Line":2}},{"line":45,"address":[12730216],"length":1,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[2804914],"length":1,"stats":{"Line":2}},{"line":49,"address":[2804983,2805007],"length":1,"stats":{"Line":4}},{"line":51,"address":[2805012,2805000],"length":1,"stats":{"Line":0}},{"line":54,"address":[12730291,12730377,12729901],"length":1,"stats":{"Line":4}},{"line":55,"address":[12730295],"length":1,"stats":{"Line":2}},{"line":60,"address":[12730528],"length":1,"stats":{"Line":1}},{"line":61,"address":[12469077,12469056],"length":1,"stats":{"Line":3}},{"line":67,"address":[2805104],"length":1,"stats":{"Line":1}},{"line":68,"address":[12433710,12433797],"length":1,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[12730874],"length":1,"stats":{"Line":1}},{"line":71,"address":[12730862],"length":1,"stats":{"Line":1}},{"line":72,"address":[3200640,3200739],"length":1,"stats":{"Line":0}},{"line":77,"address":[2805472],"length":1,"stats":{"Line":1}},{"line":78,"address":[2805525,2805627],"length":1,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":4}},{"line":84,"address":[12434544],"length":1,"stats":{"Line":2}},{"line":85,"address":[12731631,12731510,12731499],"length":1,"stats":{"Line":4}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[12434578],"length":1,"stats":{"Line":2}},{"line":89,"address":[12434693],"length":1,"stats":{"Line":0}},{"line":90,"address":[2806087,2806155,2806167],"length":1,"stats":{"Line":4}},{"line":91,"address":[12731669],"length":1,"stats":{"Line":2}},{"line":96,"address":[2806208],"length":1,"stats":{"Line":2}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[2806397,2806297,2806644,2806801],"length":1,"stats":{"Line":6}},{"line":99,"address":[12435410],"length":1,"stats":{"Line":2}},{"line":100,"address":[2806906,2806660,2806817],"length":1,"stats":{"Line":4}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[12732404],"length":1,"stats":{"Line":0}},{"line":108,"address":[12732448],"length":1,"stats":{"Line":1}},{"line":109,"address":[12732588,12732483],"length":1,"stats":{"Line":1}},{"line":110,"address":[12436120,12435958,12435610,12435711],"length":1,"stats":{"Line":3}},{"line":111,"address":[12733074],"length":1,"stats":{"Line":1}},{"line":112,"address":[12732902,12733064,12733153],"length":1,"stats":{"Line":2}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[12768884,12768880],"length":1,"stats":{"Line":0}},{"line":120,"address":[12733184],"length":1,"stats":{"Line":4}},{"line":121,"address":[12436291,12436396],"length":1,"stats":{"Line":4}},{"line":122,"address":[12733274,12733375,12733622,12733781],"length":1,"stats":{"Line":12}},{"line":123,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":8}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[12768944,12768948],"length":1,"stats":{"Line":0}},{"line":132,"address":[12436976],"length":1,"stats":{"Line":2}},{"line":133,"address":[2808539,2808435],"length":1,"stats":{"Line":2}},{"line":134,"address":[2808489,2808589,2808836,2808990],"length":1,"stats":{"Line":6}},{"line":135,"address":[2809014],"length":1,"stats":{"Line":2}},{"line":136,"address":[],"length":0,"stats":{"Line":4}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[12734585],"length":1,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":1}},{"line":145,"address":[2809239,2809140],"length":1,"stats":{"Line":1}},{"line":146,"address":[12734699,12734805,12735052,12735128],"length":1,"stats":{"Line":3}},{"line":147,"address":[12438226],"length":1,"stats":{"Line":1}},{"line":148,"address":[2809717,2809562,2809636],"length":1,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[12769076,12769072],"length":1,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":1}},{"line":158,"address":[12438370,12438441],"length":1,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":1}},{"line":165,"address":[12438512,12438587],"length":1,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[12438633,12438667],"length":1,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}}],"covered":63,"coverable":86},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","shared_packets","write.rs"],"content":"use crate::errors::Packet;\nuse anyhow::Result as Res;\nuse bytes::{BufMut, BytesMut};\nuse encoding::all::UTF_16LE;\nuse encoding::{EncoderTrap, Encoding};\n\n#[derive(Debug, Clone, Default)]\npub struct SendablePacketBuffer {\n    data: BytesMut,\n}\n\n#[allow(unused, clippy::cast_possible_truncation, clippy::missing_errors_doc)]\nimpl SendablePacketBuffer {\n    #[must_use]\n    pub fn empty() -\u003e Self {\n        Self {\n            data: BytesMut::with_capacity(0),\n        }\n    }\n    #[must_use]\n    pub fn new() -\u003e Self {\n        let mut data = BytesMut::with_capacity(256);\n        data.put_i16_le(0); // first 2 bytes are reserved for storing packet length\n        Self { data }\n    }\n\n    pub fn write(\u0026mut self, value: u8) -\u003e Res\u003c()\u003e {\n        self.data.put_u8(value);\n        Ok(())\n    }\n    pub fn write_bytes(\u0026mut self, value: \u0026[u8]) -\u003e Res\u003c()\u003e {\n        self.data.put_slice(value);\n        Ok(())\n    }\n    pub fn write_c_utf16le_string(\u0026mut self, value: Option\u003c\u0026str\u003e) -\u003e Res\u003c()\u003e {\n        if let Some(st) = value {\n            self.write_bytes(\n                \u0026UTF_16LE\n                    .encode(st, EncoderTrap::Strict)\n                    .map_err(|_| Packet::Encode(\"UTF_16LE\".to_owned()))?,\n            )?;\n        }\n        self.write_i16(0) //null char for C-like strings\n    }\n    #[allow(clippy::cast_possible_wrap, clippy::cast_possible_truncation)]\n    pub fn write_sized_c_utf16le_string(\u0026mut self, value: Option\u003c\u0026str\u003e) -\u003e Res\u003c()\u003e {\n        if let Some(st) = value {\n            self.write_i16((st.len() \u0026 0xff) as i16)?;\n            self.write_bytes(\n                \u0026UTF_16LE\n                    .encode(st, EncoderTrap::Strict)\n                    .map_err(|_| Packet::Encode(\"UTF_16LE\".to_owned()))?,\n            )?;\n        } else {\n            self.write_i16(0)?; // null char for C-like strings\n        }\n        Ok(())\n    }\n\n    #[allow(clippy::cast_sign_loss)]\n    pub fn write_i8(\u0026mut self, value: i8) -\u003e Res\u003c()\u003e {\n        self.write(value as u8)\n    }\n\n    pub fn write_u8(\u0026mut self, value: u8) -\u003e Res\u003c()\u003e {\n        self.write(value)\n    }\n\n    pub fn write_bool(\u0026mut self, value: bool) -\u003e Res\u003c()\u003e {\n        self.write_u8(u8::from(value))\n    }\n\n    pub fn write_i16(\u0026mut self, value: i16) -\u003e Res\u003c()\u003e {\n        self.data.put_i16_le(value);\n        Ok(())\n    }\n\n    pub fn write_u16(\u0026mut self, value: u16) -\u003e Res\u003c()\u003e {\n        self.data.put_u16_le(value);\n        Ok(())\n    }\n    pub fn write_i16_from_bool(\u0026mut self, value: bool) -\u003e Res\u003c()\u003e {\n        self.write_i16(i16::from(value))\n    }\n\n    pub fn write_i32(\u0026mut self, value: i32) -\u003e Res\u003c()\u003e {\n        self.data.put_i32_le(value);\n        Ok(())\n    }\n\n    pub fn write_u32(\u0026mut self, value: u32) -\u003e Res\u003c()\u003e {\n        self.data.put_u32_le(value);\n        Ok(())\n    }\n    pub fn write_i32_from_bool(\u0026mut self, value: bool) -\u003e Res\u003c()\u003e {\n        self.write_i32(i32::from(value))\n    }\n\n    #[allow(clippy::cast_sign_loss)]\n    pub fn write_i64(\u0026mut self, value: i64) -\u003e Res\u003c()\u003e {\n        self.data.put_i64_le(value);\n        Ok(())\n    }\n    pub fn write_i64_from_bool(\u0026mut self, value: bool) -\u003e Res\u003c()\u003e {\n        self.write_i64(i64::from(value))\n    }\n\n    pub fn write_f32(\u0026mut self, value: f32) -\u003e Res\u003c()\u003e {\n        self.data.put_f32_le(value);\n        Ok(())\n    }\n\n    pub fn write_f64(\u0026mut self, value: f64) -\u003e Res\u003c()\u003e {\n        self.data.put_f64_le(value);\n        Ok(())\n    }\n\n    #[must_use]\n    pub fn get_size(\u0026self) -\u003e usize {\n        self.data.len() // also substract first 2 bytes to store the length\n    }\n\n    pub fn get_data_mut(\u0026mut self, with_padding: bool) -\u003e \u0026mut [u8] {\n        // Add size info at start (unsigned short - max size 65535).\n        if with_padding {\n            self.write_padding();\n        }\n        self.write_packet_size();\n        self.data.as_mut()\n    }\n\n    pub fn write_packet_size(\u0026mut self) {\n        let size = self.get_size();\n        self.data[0] = (size \u0026 0xff) as u8;\n        self.data[1] = ((size \u003e\u003e 8) \u0026 0xffff) as u8;\n    }\n\n    pub fn write_padding(\u0026mut self) -\u003e Res\u003c()\u003e {\n        self.write_i32(0)?;\n        let padding = (self.data.len() - 2) % 8;\n        if padding != 0 {\n            for _ in padding..8 {\n                self.write_u8(0)?;\n            }\n        }\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    #[test]\n    fn test_write_packet() {\n        let mut packet = SendablePacketBuffer::new();\n        packet.write_c_utf16le_string(Some(\"Test\")).unwrap();\n        packet.write_sized_c_utf16le_string(Some(\"Test\")).unwrap();\n        packet.write(0).unwrap();\n        packet.write_bool(true).unwrap();\n        packet.write_i8(11).unwrap();\n        packet.write_i16(11).unwrap();\n        packet.write_i32(11).unwrap();\n        packet.write_i64(11).unwrap();\n        packet.write_i16_from_bool(true).unwrap();\n        packet.write_i32_from_bool(true).unwrap();\n        packet.write_i64_from_bool(true).unwrap();\n        packet.write_u8(0).unwrap();\n        packet.write_u16(0).unwrap();\n        packet.write_u32(0).unwrap();\n        packet.write_bytes(\u0026[0, 1, 2, 3]).unwrap();\n        packet.write_f32(3.45).unwrap();\n        packet.write_f64(3.45).unwrap();\n        let bytes = packet.get_data_mut(true);\n        assert_eq!(\n            bytes,\n            \u0026[\n                82, 0, 84, 0, 101, 0, 115, 0, 116, 0, 0, 0, 4, 0, 84, 0, 101, 0, 115, 0, 116, 0, 0,\n                1, 11, 11, 0, 11, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0,\n                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 205, 204, 92, 64, 154, 153, 153, 153,\n                153, 153, 11, 64, 0, 0, 0, 0, 0, 0\n            ]\n        );\n    }\n}\n","traces":[{"line":15,"address":[2690512],"length":1,"stats":{"Line":4}},{"line":17,"address":[12447134],"length":1,"stats":{"Line":4}},{"line":21,"address":[2690592,2690764],"length":1,"stats":{"Line":5}},{"line":22,"address":[12447228],"length":1,"stats":{"Line":5}},{"line":23,"address":[12150262],"length":1,"stats":{"Line":6}},{"line":27,"address":[12150416],"length":1,"stats":{"Line":6}},{"line":28,"address":[12447408],"length":1,"stats":{"Line":6}},{"line":29,"address":[12150441],"length":1,"stats":{"Line":6}},{"line":31,"address":[12150464],"length":1,"stats":{"Line":3}},{"line":32,"address":[2690851],"length":1,"stats":{"Line":3}},{"line":33,"address":[12150489],"length":1,"stats":{"Line":3}},{"line":35,"address":[12448096,12447488],"length":1,"stats":{"Line":2}},{"line":36,"address":[12150542],"length":1,"stats":{"Line":2}},{"line":37,"address":[12151065,12150963],"length":1,"stats":{"Line":2}},{"line":38,"address":[12150610,12150734,12150876],"length":1,"stats":{"Line":4}},{"line":39,"address":[12150598],"length":1,"stats":{"Line":2}},{"line":40,"address":[12414368,12414386],"length":1,"stats":{"Line":0}},{"line":43,"address":[12447692],"length":1,"stats":{"Line":2}},{"line":46,"address":[12448931,12448128],"length":1,"stats":{"Line":1}},{"line":47,"address":[2691534],"length":1,"stats":{"Line":1}},{"line":48,"address":[12448220,12448487],"length":1,"stats":{"Line":1}},{"line":49,"address":[12151887,12151788,12151926],"length":1,"stats":{"Line":1}},{"line":50,"address":[2692046,2691892,2691752],"length":1,"stats":{"Line":2}},{"line":51,"address":[2691740],"length":1,"stats":{"Line":1}},{"line":52,"address":[12414546,12414528],"length":1,"stats":{"Line":0}},{"line":55,"address":[12448953,12448295],"length":1,"stats":{"Line":0}},{"line":57,"address":[12448886],"length":1,"stats":{"Line":1}},{"line":61,"address":[12152016],"length":1,"stats":{"Line":2}},{"line":62,"address":[2692368],"length":1,"stats":{"Line":2}},{"line":65,"address":[12152048],"length":1,"stats":{"Line":2}},{"line":66,"address":[12152064],"length":1,"stats":{"Line":2}},{"line":69,"address":[2692416],"length":1,"stats":{"Line":2}},{"line":70,"address":[12449088],"length":1,"stats":{"Line":2}},{"line":73,"address":[2692464],"length":1,"stats":{"Line":2}},{"line":74,"address":[2692481],"length":1,"stats":{"Line":2}},{"line":75,"address":[12152154],"length":1,"stats":{"Line":2}},{"line":78,"address":[12449152],"length":1,"stats":{"Line":1}},{"line":79,"address":[12449169],"length":1,"stats":{"Line":1}},{"line":80,"address":[12449178],"length":1,"stats":{"Line":1}},{"line":82,"address":[12152224],"length":1,"stats":{"Line":1}},{"line":83,"address":[2692595],"length":1,"stats":{"Line":1}},{"line":86,"address":[12449264],"length":1,"stats":{"Line":5}},{"line":87,"address":[12152301],"length":1,"stats":{"Line":5}},{"line":88,"address":[12449283],"length":1,"stats":{"Line":5}},{"line":91,"address":[12152336],"length":1,"stats":{"Line":2}},{"line":92,"address":[2692669],"length":1,"stats":{"Line":2}},{"line":93,"address":[2692675],"length":1,"stats":{"Line":2}},{"line":95,"address":[12449360],"length":1,"stats":{"Line":1}},{"line":96,"address":[12449395],"length":1,"stats":{"Line":1}},{"line":100,"address":[12152432],"length":1,"stats":{"Line":1}},{"line":101,"address":[12152446],"length":1,"stats":{"Line":1}},{"line":102,"address":[12449428],"length":1,"stats":{"Line":1}},{"line":104,"address":[12152480],"length":1,"stats":{"Line":1}},{"line":105,"address":[12152517],"length":1,"stats":{"Line":1}},{"line":108,"address":[12152528],"length":1,"stats":{"Line":1}},{"line":109,"address":[12152543],"length":1,"stats":{"Line":1}},{"line":110,"address":[12449525],"length":1,"stats":{"Line":1}},{"line":113,"address":[12152576],"length":1,"stats":{"Line":1}},{"line":114,"address":[12152591],"length":1,"stats":{"Line":1}},{"line":115,"address":[2692917],"length":1,"stats":{"Line":1}},{"line":119,"address":[12152624],"length":1,"stats":{"Line":5}},{"line":120,"address":[12152629],"length":1,"stats":{"Line":5}},{"line":123,"address":[12152640],"length":1,"stats":{"Line":5}},{"line":125,"address":[12152666],"length":1,"stats":{"Line":5}},{"line":126,"address":[12152704],"length":1,"stats":{"Line":1}},{"line":128,"address":[2692995],"length":1,"stats":{"Line":5}},{"line":129,"address":[12449665],"length":1,"stats":{"Line":6}},{"line":132,"address":[2693056],"length":1,"stats":{"Line":5}},{"line":133,"address":[2693070],"length":1,"stats":{"Line":5}},{"line":134,"address":[2693090,2693192],"length":1,"stats":{"Line":5}},{"line":135,"address":[2693235,2693145,2693222],"length":1,"stats":{"Line":10}},{"line":138,"address":[12449920],"length":1,"stats":{"Line":1}},{"line":139,"address":[12152958,12153036],"length":1,"stats":{"Line":1}},{"line":140,"address":[2693391,2693329,2693412],"length":1,"stats":{"Line":2}},{"line":141,"address":[2693404],"length":1,"stats":{"Line":1}},{"line":142,"address":[2693443],"length":1,"stats":{"Line":1}},{"line":143,"address":[2693498,2693556],"length":1,"stats":{"Line":1}},{"line":146,"address":[2693428],"length":1,"stats":{"Line":1}}],"covered":75,"coverable":78},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","str.rs"],"content":"pub trait StringTrim {\n    fn trim_all(self) -\u003e String;\n}\n\npub trait Trim {\n    fn trim_all(\u0026self) -\u003e \u0026str;\n}\n\nimpl StringTrim for String {\n    ///this function is needed to trim also null bytes from a String\n    /// # Example\n    ///\n    ///```\n    /// use l2_core::str::StringTrim;\n    /// let mut s = \" ggg \\0\\0\\0\".to_string();\n    /// s = s.trim_all();\n    ///\n    /// assert_eq!(s, \"ggg\");\n    /// ```\n    fn trim_all(self) -\u003e String {\n        String::from(self.trim_matches(|c: char| c.is_ascii_whitespace() || c == '\\0'))\n    }\n}\n\nimpl Trim for str {\n    ///this function is needed to trim also null bytes from a str slice\n    /// # Example\n    ///\n    ///```\n    /// use l2_core::str::Trim;\n    /// let mut s:\u0026'static str = \" ggg \\0\\0\\0\";\n    /// s = s.trim_all();\n    ///\n    /// assert_eq!(s, \"ggg\");\n    /// ```\n    fn trim_all(\u0026self) -\u003e \u0026str {\n        self.trim_matches(|c: char| c.is_ascii_whitespace() || c == '\\0')\n    }\n}\n","traces":[{"line":20,"address":[3020624,3020480],"length":1,"stats":{"Line":0}},{"line":21,"address":[2768141,2768128],"length":1,"stats":{"Line":0}},{"line":36,"address":[3241216],"length":1,"stats":{"Line":1}},{"line":37,"address":[2768205,2768192],"length":1,"stats":{"Line":3}}],"covered":2,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","traits","handlers.rs"],"content":"use crate::dto;\nuse crate::shared_packets::common::SendablePacket;\nuse crate::traits::Shutdown;\nuse anyhow::{bail, Error};\nuse async_trait::async_trait;\nuse entities::DBPool;\nuse std::fmt::Debug;\nuse std::net::Ipv4Addr;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::io::{AsyncRead, AsyncReadExt, AsyncWrite, AsyncWriteExt};\nuse tokio::sync::Mutex;\nuse tokio::time::sleep;\nuse tracing::{info, instrument};\n\npub const PACKET_SIZE_BYTES: usize = 2;\n\npub trait InboundHandler {\n    type ConfigType;\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026dto::InboundConnection;\n}\n\npub trait OutboundHandler {\n    type ConfigType;\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026dto::OutboundConnection;\n}\n#[async_trait]\npub trait PacketSender: Send + Sync + Debug {\n    async fn send_packet(\u0026self, mut packet: Box\u003cdyn SendablePacket\u003e) -\u003e Result\u003c(), Error\u003e {\n        self.send_bytes(packet.get_bytes(self.is_encryption_enabled()))\n            .await?;\n        Ok(())\n    }\n    async fn send_bytes(\u0026self, bytes: \u0026mut [u8]) -\u003e Result\u003c(), Error\u003e {\n        if self.is_encryption_enabled() {\n            self.encrypt(bytes).await?;\n        }\n        self.get_stream_writer_mut()\n            .await\n            .lock()\n            .await\n            .write_all(bytes)\n            .await?;\n        Ok(())\n    }\n\n    #[allow(clippy::missing_errors_doc)]\n    async fn encrypt(\u0026self, bytes: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e;\n    fn is_encryption_enabled(\u0026self) -\u003e bool;\n    async fn get_stream_writer_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncWrite + Send + Unpin\u003e\u003e;\n}\n#[async_trait]\npub trait PacketHandler: PacketSender + Shutdown + Send + Sync + Debug {\n    type ConfigType;\n    type ControllerType;\n\n    fn get_handler_name() -\u003e \u0026'static str;\n    fn get_controller(\u0026self) -\u003e \u0026Arc\u003cSelf::ControllerType\u003e;\n    fn new\u003cR, W\u003e(\n        read: R,\n        write: W,\n        ip: Ipv4Addr,\n        db_pool: DBPool,\n        lc: Arc\u003cSelf::ControllerType\u003e,\n    ) -\u003e Self\n    where\n        R: AsyncRead + Unpin + Send + 'static,\n        W: AsyncWrite + Unpin + Send + 'static;\n\n    async fn on_connect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e;\n    async fn on_disconnect(\u0026mut self);\n    fn get_stream_reader_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e;\n\n    fn get_timeout(\u0026self) -\u003e Option\u003cu64\u003e;\n\n    fn get_db_pool(\u0026self) -\u003e \u0026DBPool;\n\n    async fn on_receive_bytes(\u0026mut self, packet_size: usize, bytes: \u0026mut [u8])\n        -\u003e Result\u003c(), Error\u003e;\n\n    #[instrument(skip(self))]\n    async fn read_packet(\u0026mut self) -\u003e anyhow::Result\u003c(usize, Vec\u003cu8\u003e)\u003e {\n        let mut size_buf = [0; PACKET_SIZE_BYTES];\n        let mut socket = self.get_stream_reader_mut().lock().await;\n        if socket.read_exact(\u0026mut size_buf).await.is_err() {\n            // at this stage, client wanted to disconnect\n            return Ok((0, vec![]));\n        }\n        let size = (u16::from_le_bytes(size_buf) as usize) - PACKET_SIZE_BYTES;\n        // Read the body of the packet based on the size\n        let mut body = vec![0; size];\n        socket.read_exact(\u0026mut body).await?;\n        Ok((size, body))\n    }\n\n    #[instrument(skip(self))]\n    async fn handle_client(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        self.on_connect().await?;\n        let shutdown_listener = self.get_shutdown_listener(); //shutdown listener must be cloned only once before the loop\n        loop {\n            let timeout_future = if let Some(t_out) = self.get_timeout() {\n                sleep(Duration::from_secs(t_out))\n            } else {\n                sleep(Duration::MAX) // Use a long sleep for no timeout\n            };\n            let read_future = self.read_packet();\n            tokio::select! {\n                read_result = read_future =\u003e{\n                    match read_result {\n                        Ok((0, _)) =\u003e {\n                            self.on_disconnect().await;\n                            // it's okay that we received 0 bytes, client wants to close socket\n                            break;\n                        }\n                        Ok((bytes_read, mut data)) =\u003e {\n                            if let Err(e) = self.on_receive_bytes(bytes_read, \u0026mut data).await {\n                                self.on_disconnect().await;\n                                bail!(\"Error receiving packet: {}\", e);\n                            }\n                        }\n                        Err(e) =\u003e {\n                            self.on_disconnect().await;\n                            bail!(\"Error receiving packet: {}\", e);\n                        }\n                    }\n                }\n                // Handle timeout event separately\n                () = timeout_future =\u003e {\n                    info!(\n                        \"{}: No data received within timeout. Dropping connection.\",\n                        Self::get_handler_name()\n                    );\n                    self.on_disconnect().await;\n                    break;\n                }\n                // Handle shutdown notification (or other task notifications)\n                () = shutdown_listener.notified() =\u003e {\n                    info!(\"{}: Received shutdown notification. Dropping connection.\", Self::get_handler_name());\n                    self.on_disconnect().await;\n                    break;\n                }\n            }\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":29,"address":[3738739],"length":1,"stats":{"Line":8}},{"line":30,"address":[],"length":0,"stats":{"Line":13}},{"line":31,"address":[4288833,4292769,4296817],"length":1,"stats":{"Line":8}},{"line":32,"address":[5190400,5189248],"length":1,"stats":{"Line":2}},{"line":34,"address":[3814015],"length":1,"stats":{"Line":6}},{"line":35,"address":[5046712,5046170,5043962,5044504,5048378,5048920],"length":1,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[5050029,5046209,5047085,5045685,5049358,5047736,5050101,5048417,5047451,5049544,5049796,5046992,5044784,5049766,5049944,5044001,5045528,5044877,5047150,5045350,5045740,5044942,5047588,5047821,5045128,5049293,5047948,5049659,5047336,5045613,5045243,5044600,5047558,5050156,5045380,5046808,5047893,5049200,5049016],"length":1,"stats":{"Line":26}},{"line":39,"address":[5184951,5187265,5186332,5187397,5185057,5184124,5185189,5187208,5185000,5187159],"length":1,"stats":{"Line":7}},{"line":41,"address":[5184145,5187527,5187591,5185560,5186353,5185319,5187564,5185356,5185383,5187768],"length":1,"stats":{"Line":8}},{"line":42,"address":[5049742,5047534,5045326],"length":1,"stats":{"Line":3}},{"line":43,"address":[],"length":0,"stats":{"Line":8}},{"line":44,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[5197819,5199247,5195282,5196639,5199683,5196759,5199367,5197315,5199923,5197075,5199200,5192322,5200427,5196592],"length":1,"stats":{"Line":10}},{"line":83,"address":[5199749,5197141],"length":1,"stats":{"Line":2}},{"line":84,"address":[5197155,5197347,5199763,5199397,5199955,5196789],"length":1,"stats":{"Line":4}},{"line":85,"address":[5197703,5196810,5200216,5200311,5200444,5197836,5199418,5197608],"length":1,"stats":{"Line":9}},{"line":87,"address":[5201136,5198528],"length":1,"stats":{"Line":1}},{"line":89,"address":[5198125,5200733,5198260,5200868],"length":1,"stats":{"Line":3}},{"line":91,"address":[5063808,5061200],"length":1,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":7}},{"line":93,"address":[5201543,5198935],"length":1,"stats":{"Line":1}},{"line":97,"address":[5071250,5066454,5070544,5083872,5069334,5084076,5084578,5070748,5085058,5084371,5071730,5083918,5071043,5070590],"length":1,"stats":{"Line":15}},{"line":98,"address":[4304191,4301535],"length":1,"stats":{"Line":5}},{"line":99,"address":[5221923,5208595,5208692,5222020],"length":1,"stats":{"Line":7}},{"line":100,"address":[5222915,5209587],"length":1,"stats":{"Line":1}},{"line":101,"address":[],"length":0,"stats":{"Line":6}},{"line":102,"address":[],"length":0,"stats":{"Line":6}},{"line":104,"address":[5209729,5209855,5223057,5223183],"length":1,"stats":{"Line":0}},{"line":106,"address":[5223148,5209942,5223270,5209820],"length":1,"stats":{"Line":6}},{"line":107,"address":[],"length":0,"stats":{"Line":5}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":1}}],"covered":30,"coverable":54},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","traits","mod.rs"],"content":"pub mod handlers;\npub mod server;\n\nuse std::sync::Arc;\nuse tokio::sync::Notify;\nuse crate::dto::{Database, Runtime};\n\npub trait IpBan {\n    fn is_ip_banned(\u0026self, ip: \u0026str) -\u003e bool;\n}\n\npub trait Shutdown {\n    fn get_shutdown_listener(\u0026self) -\u003e Arc\u003cNotify\u003e;\n    fn shutdown(\u0026self) {\n        self.get_shutdown_listener().notify_one();\n    }\n}\n\npub trait ServerConfig {\n    fn load(path: \u0026str) -\u003e Self;\n    fn from_string(content: \u0026str) -\u003e Self;\n    fn runtime(\u0026self) -\u003e Option\u003c\u0026Runtime\u003e;\n    fn database(\u0026self) -\u003e \u0026Database;\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","runner","work","L2Shablya","L2Shablya","l2-core","src","traits","server.rs"],"content":"use crate::network::bind_addr;\nuse crate::new_db_pool;\nuse crate::traits::handlers::{InboundHandler, OutboundHandler, PacketHandler};\nuse crate::traits::{IpBan, ServerConfig};\nuse async_trait::async_trait;\nuse dotenvy::dotenv;\nuse entities::DBPool;\nuse sqlx::any::install_default_drivers;\nuse std::future::Future;\nuse std::net::IpAddr;\nuse std::num::NonZero;\nuse std::sync::Arc;\nuse std::thread;\nuse tokio::net::TcpStream;\nuse tokio::task::JoinHandle;\nuse tracing::{error, info, instrument};\n\n#[async_trait]\npub trait Server {\n    type ConfigType: ServerConfig + Send + Sync + 'static;\n    type ControllerType: IpBan + Send + Sync + 'static;\n    fn bootstrap\u003cF, Fut\u003e(path: \u0026str, start: F)\n    where\n        F: Fn(Arc\u003cSelf::ConfigType\u003e, DBPool) -\u003e Fut + Send + 'static,\n        Fut: Future\u003cOutput = ()\u003e + Send + 'static,\n    {\n        let config = Arc::new(Self::ConfigType::load(path));\n        let mut worker_count = thread::available_parallelism()\n            .map(NonZero::get)\n            .unwrap_or(1);\n        if let Some(wrk_cnt) = config.runtime() {\n            worker_count = wrk_cnt.worker_threads;\n        }\n        info!(\"Runtime: Worker count {worker_count}\");\n        let rt = tokio::runtime::Builder::new_multi_thread()\n            .enable_all()\n            .thread_name(\"worker\")\n            .worker_threads(worker_count)\n            .build()\n            .expect(\"Failed to build tokio runtime.\");\n        install_default_drivers();\n        dotenv().ok();\n        rt.block_on(async {\n            let pool = new_db_pool(config.database()).await;\n            start(config, pool).await;\n        });\n    }\n\n    fn listener_loop\u003cT\u003e(\n        config: Arc\u003cSelf::ConfigType\u003e,\n        controller: Arc\u003cSelf::ControllerType\u003e,\n        pool: DBPool,\n    ) -\u003e JoinHandle\u003c()\u003e\n    where\n        T: PacketHandler\u003cConfigType = Self::ConfigType, ControllerType = Self::ControllerType\u003e\n            + InboundHandler\u003cConfigType = Self::ConfigType\u003e\n            + Send\n            + Sync\n            + 'static,\n    {\n        tokio::spawn(async move {\n            let conn_cfg = T::get_connection_config(\u0026config);\n            let listener = bind_addr(conn_cfg)\n                .unwrap_or_else(|e| panic!(\"{e}:Can not bind socket {conn_cfg:?}\"));\n            info!(\n                \"{} listening on {}\",\n                T::get_handler_name(),\n                \u0026listener\n                    .local_addr()\n                    .expect(\"Cannot get socket local address\"),\n            );\n            loop {\n                match listener.accept().await {\n                    Ok((socket, addr)) =\u003e {\n                        match addr.ip() {\n                            IpAddr::V4(ipv4_addr) =\u003e {\n                                // Skip banned IP addresses\n                                if controller.is_ip_banned(\u0026ipv4_addr.to_string()) {\n                                    error!(\"IP is banned, skipping connection from {:?}\", addr);\n                                    continue;\n                                }\n\n                                info!(\n                                    \"Incoming connection from {:?} ({})\",\n                                    ipv4_addr,\n                                    T::get_handler_name()\n                                );\n\n                                let (r, w) = socket.into_split();\n                                let mut handler =\n                                    T::new(r, w, ipv4_addr, pool.clone(), controller.clone());\n                                tokio::spawn(async move {\n                                    if let Err(err) = handler.handle_client().await {\n                                        error!(\n                                            \"Closing handler {} with error: {err}\",\n                                            T::get_handler_name()\n                                        );\n                                    }\n                                });\n                            }\n                            IpAddr::V6(ip) =\u003e {\n                                error!(\"IPv6 connections are not supported, skipping connection from {ip:?}\");\n                                continue;\n                            }\n                        }\n                    }\n                    Err(e) =\u003e {\n                        error!(\"Failed to accept connection: {e}\");\n                        continue;\n                    }\n                }\n            }\n        })\n    }\n    #[instrument]\n    async fn get_stream(address: \u0026str) -\u003e TcpStream {\n        loop {\n            match TcpStream::connect(address).await {\n                Ok(s) =\u003e break s, // Exit the loop when connection succeeds\n                Err(e) =\u003e {\n                    error!(\"Failed to connect: {e}. Retrying in 5 seconds...\");\n                    tokio::time::sleep(tokio::time::Duration::from_secs(5)).await;\n                }\n            }\n        }\n    }\n    fn connector_loop\u003cT\u003e(\n        config: Arc\u003cSelf::ConfigType\u003e,\n        controller: Arc\u003cSelf::ControllerType\u003e,\n        pool: DBPool,\n    ) -\u003e JoinHandle\u003c()\u003e\n    where\n        T: PacketHandler\u003cConfigType = Self::ConfigType, ControllerType = Self::ControllerType\u003e\n            + OutboundHandler\u003cConfigType = Self::ConfigType\u003e\n            + Send\n            + Sync\n            + 'static,\n    {\n        tokio::spawn(async move {\n            let conn_cfg = T::get_connection_config(\u0026config);\n            let address = format!(\"{}:{}\", conn_cfg.ip, conn_cfg.port);\n            info!(\"Connecting to {} on: {}\", T::get_handler_name(), \u0026address);\n            loop {\n                let stream = Self::get_stream(\u0026address).await;\n                stream\n                    .set_nodelay(conn_cfg.no_delay)\n                    .expect(\"Set nodelay failed\");\n                let IpAddr::V4(ip) = stream.peer_addr().expect(\"Cannot get peer address\").ip()\n                else {\n                    error!(\"IP v6 is not supported\");\n                    break;\n                };\n                let (r, w) = stream.into_split();\n                let mut handler = T::new(r, w, ip, pool.clone(), controller.clone());\n                if let Err(err) = handler.handle_client().await {\n                    error!(\n                        \"Closing handler {}, with error: {err}\",\n                        T::get_handler_name()\n                    );\n                }\n                error!(\"Lost connection to login server, trying again in 5 seconds...\");\n                tokio::time::sleep(tokio::time::Duration::from_secs(5)).await;\n            }\n        })\n    }\n}\n","traces":[{"line":22,"address":[4142480,4143981,4142566,4146192],"length":1,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[4142812],"length":1,"stats":{"Line":0}},{"line":32,"address":[4142915],"length":1,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[4145810,4144097,4145847,4145737],"length":1,"stats":{"Line":0}},{"line":38,"address":[4007689],"length":1,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[4146014],"length":1,"stats":{"Line":0}},{"line":43,"address":[4742336,4742406,4742491,4742704,4743073,4743250],"length":1,"stats":{"Line":0}},{"line":44,"address":[4163606,4163684,4163824,4163544],"length":1,"stats":{"Line":0}},{"line":45,"address":[4321592],"length":1,"stats":{"Line":0}},{"line":49,"address":[4004112,4004224],"length":1,"stats":{"Line":0}},{"line":61,"address":[4004135,4004247],"length":1,"stats":{"Line":0}},{"line":62,"address":[4699386,4699227],"length":1,"stats":{"Line":0}},{"line":63,"address":[4699440,4699486],"length":1,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[4115628,4114155,4147831,4114432,4155812,4113671,4114746,4147988,4155655,4113959,4115273,4132011,4133308,4131152,4132505,4131351,4132426,4133756,4131835,4131639,4113804,4132112,4113472,4132953,4113056,4116076,4114331,4130736,4131484,4114825],"length":1,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[4114909,4115712,4133392,4132589],"length":1,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[4699321,4700772,4703049,4703019,4716641],"length":1,"stats":{"Line":0}},{"line":74,"address":[4116657,4134337],"length":1,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[4116996,4134676],"length":1,"stats":{"Line":0}},{"line":78,"address":[4134902,4134690,4117222,4117010],"length":1,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[4704841,4704642,4705377,4706050,4707123,4705971,4704226,4704974,4705129,4717540,4705556,4717383,4705657,4706764,4706409],"length":1,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[4706958,4706244],"length":1,"stats":{"Line":0}},{"line":89,"address":[4705284,4707392],"length":1,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[4138976,4151599,4151900,4155447,4121207,4155508,4157084,4121296,4160631,4156752,4151703,4156887,4156783,4138887,4151568,4160692],"length":1,"stats":{"Line":0}},{"line":93,"address":[4486557,4486381],"length":1,"stats":{"Line":0}},{"line":94,"address":[4152415,4159658,4153163,4154063,4159314,4160334,4163060,4153030,4158347,4153318,4153502,4158214,4162484,4158862,4152831,4154474,4155150,4157599,4162903,4158502,4153678,4153779,4159992,4158686,4158963,4159247,4154808,4162327,4154130,4158015],"length":1,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[4134720,4117040],"length":1,"stats":{"Line":0}},{"line":102,"address":[4713577,4718116,4713383,4712850,4711109,4712457,4712012,4711724,4712177,4713044,4712356,4717959,4712771,4711525,4711857],"length":1,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[4134451,4116771],"length":1,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[4107744,4106184,4108080,4108160,4111825,4107893,4107791],"length":1,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[4108127,4108192,4108527,4107923],"length":1,"stats":{"Line":0}},{"line":119,"address":[4108854],"length":1,"stats":{"Line":0}},{"line":120,"address":[4695603],"length":1,"stats":{"Line":0}},{"line":121,"address":[4695779,4696682,4698740,4697050,4697484,4696874,4696195,4696394,4697663,4696527,4697151,4698583,4697981,4697417,4698160],"length":1,"stats":{"Line":0}},{"line":122,"address":[4468289],"length":1,"stats":{"Line":0}},{"line":127,"address":[4142352],"length":1,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[4297996],"length":1,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[4740820,4738923,4737964,4740663,4738119,4737632,4737831,4738307,4737216,4738483,4738584,4738856,4739298],"length":1,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[4737116,4730168],"length":1,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":80},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","client_thread","handler.rs"],"content":"use crate::controller::LoginController;\nuse crate::packet::cp_factory::build_client_packet;\nuse crate::packet::to_client::Init;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::DBPool;\nuse l2_core::config::login::LoginServer;\nuse l2_core::crypt::login::Encryption;\nuse l2_core::crypt::{generate_blowfish_key, rsa};\nuse l2_core::dto::InboundConnection;\nuse l2_core::errors::Packet;\nuse l2_core::session::SessionKey;\nuse l2_core::traits::handlers::{InboundHandler, PacketHandler, PacketSender};\nuse l2_core::traits::Shutdown;\nuse std::fmt;\nuse std::net::Ipv4Addr;\nuse std::sync::Arc;\nuse tokio::io::{AsyncRead, AsyncWrite, AsyncWriteExt};\nuse tokio::sync::{Mutex, Notify};\nuse tracing::{info, instrument};\n\n#[derive(Clone)]\npub struct Client {\n    blowfish_key: Vec\u003cu8\u003e,\n    pub ip: Ipv4Addr,\n    tcp_reader: Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e,\n    tcp_writer: Arc\u003cMutex\u003cdyn AsyncWrite + Send + Unpin\u003e\u003e,\n    pub account_name: Option\u003cString\u003e,\n    db_pool: DBPool,\n    session_id: i32,\n    shutdown_notifier: Arc\u003cNotify\u003e,\n    lc: Arc\u003cLoginController\u003e,\n    encryption: Encryption,\n    timeout: u8,\n    session_key: SessionKey,\n    rsa_key_pair: rsa::ScrambledRSAKeyPair,\n}\nimpl fmt::Debug for Client {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        f.debug_struct(\"Client\")\n            .field(\"ip\", \u0026self.ip)\n            .field(\"session_id\", \u0026self.session_id)\n            .finish_non_exhaustive()\n    }\n}\n\n/// # This function called each time when there is a new connection.\n/// ## Arguments\n/// - stream - `TcpStream` to send/receive `shared_packets`\n/// - lc - `LoginClient` object is needed to store some client related data\n///\n/// # The whole login process looks like the following:\n/// 1. send init ()\n/// 2. wait request `AuthGG`\n/// 3. `AuthGG::new(session_id);` // send `AuthGG` OK\n/// 4. wait request auth login\n/// 5. `LoginOk::new(session_key);` //send `AuthOk`\n/// 6. wait for `RequestServerList`\n/// 7. Respond with `ServerList::new()`\n///\nimpl Client {\n    pub fn check_session(\u0026self, s_key1: i32, s_key2: i32) -\u003e anyhow::Result\u003c()\u003e {\n        if !self.session_key.check_session(s_key1, s_key2) {\n            bail!(\"Session key check failed\");\n        }\n        Ok(())\n    }\n    pub fn get_session_id(\u0026self) -\u003e i32 {\n        self.session_id\n    }\n    pub fn get_session_key(\u0026self) -\u003e \u0026SessionKey {\n        \u0026self.session_key\n    }\n}\n\nimpl Shutdown for Client {\n    fn get_shutdown_listener(\u0026self) -\u003e Arc\u003cNotify\u003e {\n        self.shutdown_notifier.clone()\n    }\n}\n\n#[async_trait]\nimpl PacketHandler for Client {\n    type ConfigType = LoginServer;\n    type ControllerType = LoginController;\n    fn get_handler_name() -\u003e \u0026'static str {\n        \"Login client handler\"\n    }\n\n    fn get_controller(\u0026self) -\u003e \u0026Arc\u003cSelf::ControllerType\u003e {\n        \u0026self.lc\n    }\n\n    fn new\u003cR, W\u003e(\n        reader: R,\n        writer: W,\n        ip: Ipv4Addr,\n        db_pool: DBPool,\n        lc: Arc\u003cSelf::ControllerType\u003e,\n    ) -\u003e Self\n    where\n        R: AsyncRead + Unpin + Send + 'static,\n        W: AsyncWrite + Unpin + Send + 'static,\n    {\n        let blowfish_key = generate_blowfish_key(None);\n        let encryption = Encryption::new(\u0026blowfish_key.clone());\n        let session_id = LoginController::generate_session_id();\n        let timeout = lc.get_config().client.timeout;\n        Self {\n            tcp_reader: Arc::new(Mutex::new(reader)),\n            tcp_writer: Arc::new(Mutex::new(writer)),\n            db_pool,\n            ip,\n            shutdown_notifier: Arc::new(Notify::new()),\n            encryption,\n            session_id,\n            session_key: SessionKey::new(),\n            account_name: None,\n            rsa_key_pair: lc.get_random_rsa_key_pair(),\n            blowfish_key,\n            timeout,\n            lc,\n        }\n    }\n\n    #[instrument(skip(self))]\n    async fn on_connect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        info!(\"Client connected: {:?}\", self.ip);\n        let mut init = Init::new(\n            self.session_id,\n            self.rsa_key_pair.get_scrambled_modulus(),\n            self.blowfish_key.clone(),\n        )?;\n        self.tcp_writer\n            .lock()\n            .await\n            .write_all(init.buffer.get_data_mut(false))\n            .await\n            .map_err(|_| Packet::UnableToSendInit)?;\n        Ok(())\n    }\n\n    async fn on_disconnect(\u0026mut self) {\n        info!(\"Player disconnected: {:?}\", self.session_id);\n    }\n\n    fn get_stream_reader_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e {\n        \u0026self.tcp_reader\n    }\n\n    fn get_timeout(\u0026self) -\u003e Option\u003cu64\u003e {\n        Some(u64::from(self.timeout))\n    }\n\n    fn get_db_pool(\u0026self) -\u003e \u0026DBPool {\n        \u0026self.db_pool\n    }\n\n    #[instrument(skip(self, data))]\n    async fn on_receive_bytes(\u0026mut self, _: usize, data: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n        self.encryption.decrypt(data)?;\n        let handler = build_client_packet(data, \u0026self.rsa_key_pair)?;\n        handler.handle(self).await\n    }\n}\n\n#[async_trait]\nimpl PacketSender for Client {\n    async fn encrypt(\u0026self, _: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n        Ok(())\n    }\n    fn is_encryption_enabled(\u0026self) -\u003e bool {\n        false\n    }\n\n    async fn get_stream_writer_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncWrite + Send + Unpin\u003e\u003e {\n        \u0026self.tcp_writer\n    }\n}\n\nimpl InboundHandler for Client {\n    type ConfigType = LoginServer;\n\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026InboundConnection {\n        \u0026cfg.listeners.clients.connection\n    }\n}\n\n#[cfg(test)]\nmod test {\n    use super::*;\n    use l2_core::config::login::LoginServer;\n    use test_utils::utils::get_test_db;\n    use l2_core::traits::ServerConfig;\n    use ntest::timeout;\n    use tokio::io::{split, AsyncReadExt};\n    use tracing::error;\n\n    #[tokio::test]\n    #[timeout(2000)]\n    async fn test_init_packet_sent() {\n        // Create a listener on a local port\n        let db_pool = get_test_db().await;\n        let (mut client, server) = tokio::io::duplex(1024);\n        let cfg = LoginServer::from_string(include_str!(\"../test_data/test_config.yaml\"));\n        let lc = Arc::new(LoginController::new(Arc::new(cfg)));\n        let cloned_lc = lc.clone();\n        // Spawn a server task to handle a single connection\n        tokio::spawn(async move {\n            let ip = Ipv4Addr::new(127, 0, 0, 1);\n            let (r, w) = split(server);\n            let mut ch = Client::new(r, w, ip, db_pool, cloned_lc);\n            if let Err(err) = ch.handle_client().await {\n                error!(\n                    \"Closed client {} with error: {err:?}\",\n                    Client::get_handler_name()\n                );\n            }\n        });\n        // Create a client to connect to the server\n        // Read the response from the server\n        let mut init_packet = vec![0; 1024];\n        let _ = client.read(\u0026mut init_packet).await.unwrap();\n        client.shutdown().await.unwrap();\n        let packet_size = u16::from_le_bytes(init_packet[..2].try_into().unwrap());\n        let packet_id = init_packet[2];\n        let revision = i32::from_le_bytes(init_packet[7..11].try_into().unwrap());\n        assert_eq!(packet_size, 172);\n        assert_eq!(packet_id, 0);\n        assert_eq!(revision, 0x0000_c621);\n    }\n}\n","traces":[{"line":39,"address":[3998992],"length":1,"stats":{"Line":0}},{"line":40,"address":[3999010,3999044,3999088],"length":1,"stats":{"Line":0}},{"line":41,"address":[3999037],"length":1,"stats":{"Line":0}},{"line":42,"address":[3999081],"length":1,"stats":{"Line":0}},{"line":62,"address":[3999136],"length":1,"stats":{"Line":0}},{"line":63,"address":[3999153],"length":1,"stats":{"Line":0}},{"line":64,"address":[3999170],"length":1,"stats":{"Line":0}},{"line":66,"address":[3999210],"length":1,"stats":{"Line":0}},{"line":68,"address":[3999232],"length":1,"stats":{"Line":0}},{"line":69,"address":[3999237],"length":1,"stats":{"Line":0}},{"line":71,"address":[3999248],"length":1,"stats":{"Line":0}},{"line":72,"address":[3999256],"length":1,"stats":{"Line":0}},{"line":77,"address":[3999264],"length":1,"stats":{"Line":1}},{"line":78,"address":[3999269],"length":1,"stats":{"Line":1}},{"line":90,"address":[4000464],"length":1,"stats":{"Line":0}},{"line":91,"address":[4000472],"length":1,"stats":{"Line":0}},{"line":94,"address":[4166336,4169269,4167754,4167888,4169358,4167847],"length":1,"stats":{"Line":1}},{"line":105,"address":[4167955,4166424],"length":1,"stats":{"Line":1}},{"line":106,"address":[],"length":0,"stats":{"Line":2}},{"line":107,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":2}},{"line":114,"address":[],"length":0,"stats":{"Line":2}},{"line":117,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[4175232,4174026,4175263,4179150,4175527,4175358],"length":1,"stats":{"Line":3}},{"line":128,"address":[4178036,4180360,4176855,4177516,4177031,4175753,4180203,4177440,4176368,4177129,4178220,4176498,4176169,4176650,4177700],"length":1,"stats":{"Line":5}},{"line":130,"address":[4176813],"length":1,"stats":{"Line":1}},{"line":131,"address":[4178516,4176826],"length":1,"stats":{"Line":2}},{"line":132,"address":[4178524],"length":1,"stats":{"Line":1}},{"line":134,"address":[4179023,4179591,4180043,4178895,4179435,4179053,4179778,4179320,4179957,4179873,4179621],"length":1,"stats":{"Line":9}},{"line":136,"address":[4179083,4179191,4179368,4179046,4175388],"length":1,"stats":{"Line":3}},{"line":137,"address":[4179528],"length":1,"stats":{"Line":1}},{"line":138,"address":[4179686,4175409,4179614,4179809],"length":1,"stats":{"Line":2}},{"line":139,"address":[4180051,4180112,4179906,4179464,4180096],"length":1,"stats":{"Line":1}},{"line":140,"address":[4179987],"length":1,"stats":{"Line":1}},{"line":143,"address":[4000489],"length":1,"stats":{"Line":0}},{"line":144,"address":[4171406,4171902,4170987,4172082,4170460,4171342,4170811,4180779,4180936,4170612,4170131,4171085,4169715,4170330,4171587],"length":1,"stats":{"Line":0}},{"line":147,"address":[4000608],"length":1,"stats":{"Line":1}},{"line":148,"address":[4000616],"length":1,"stats":{"Line":1}},{"line":151,"address":[4000624],"length":1,"stats":{"Line":1}},{"line":152,"address":[4000629],"length":1,"stats":{"Line":1}},{"line":155,"address":[4000672],"length":1,"stats":{"Line":0}},{"line":156,"address":[4000680],"length":1,"stats":{"Line":0}},{"line":160,"address":[4184816,4185602,4185046,4184841,4184916,4183222,4185647],"length":1,"stats":{"Line":0}},{"line":161,"address":[4185249,4185634,4185128],"length":1,"stats":{"Line":0}},{"line":162,"address":[4185331,4185448,4185221,4185616],"length":1,"stats":{"Line":0}},{"line":163,"address":[4185538,4185417,4185679,4184943],"length":1,"stats":{"Line":0}},{"line":169,"address":[4185936,4186003,4186097,4185950,4186166],"length":1,"stats":{"Line":0}},{"line":170,"address":[4186145],"length":1,"stats":{"Line":0}},{"line":172,"address":[4001168],"length":1,"stats":{"Line":0}},{"line":176,"address":[4001193],"length":1,"stats":{"Line":0}},{"line":177,"address":[4186311],"length":1,"stats":{"Line":0}},{"line":184,"address":[3999296],"length":1,"stats":{"Line":0}},{"line":185,"address":[3999304],"length":1,"stats":{"Line":0}}],"covered":27,"coverable":56},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","client_thread","mod.rs"],"content":"mod handler;\npub use handler::Client as ClientHandler;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","controller","data.rs"],"content":"use crate::dto::game_server::GSInfo;\nuse crate::dto::player;\nuse dashmap::DashMap;\nuse l2_core::config::login;\nuse l2_core::crypt::rsa::{generate_rsa_key_pair, ScrambledRSAKeyPair};\nuse l2_core::message_broker::MessageBroker;\nuse l2_core::shared_packets::common::PacketType;\nuse rand::Rng;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tracing::info;\n\n#[derive(Debug)]\npub struct LoginController {\n    key_pairs: Vec\u003cScrambledRSAKeyPair\u003e,\n    pub(super) config: Arc\u003clogin::LoginServer\u003e,\n    pub(super) game_servers: DashMap\u003cu8, GSInfo\u003e,\n    pub(super) ip_ban_list: DashMap\u003cString, i64\u003e,\n    pub(super) players: DashMap\u003cString, player::Info\u003e,\n    pub message_broker: Arc\u003cMessageBroker\u003cu8, PacketType\u003e\u003e,\n}\n\nimpl LoginController {\n    pub fn new(config: Arc\u003clogin::LoginServer\u003e) -\u003e Self {\n        info!(\"Loading LoginController...\");\n        let threshold =\n            Duration::from_secs(u64::from(config.listeners.game_servers.messages.timeout));\n        Self {\n            key_pairs: Self::generate_rsa_key_pairs(10),\n            config,\n            ip_ban_list: DashMap::new(),\n            players: DashMap::new(),\n            game_servers: DashMap::new(),\n            message_broker: MessageBroker::new(threshold),\n        }\n    }\n    pub fn get_config(\u0026self) -\u003e \u0026login::LoginServer {\n        \u0026self.config\n    }\n    pub fn get_game_server(\u0026self, gs_id: u8) -\u003e Option\u003cGSInfo\u003e {\n        self.game_servers.get(\u0026gs_id).map(|gs| gs.clone())\n    }\n    pub fn get_random_rsa_key_pair(\u0026self) -\u003e ScrambledRSAKeyPair {\n        let mut rng = rand::thread_rng();\n        let random_number: usize = rng.gen_range(0..=9);\n        // safe to unwrap as we 100% sure that we load all keys when booting the application\n        self.key_pairs\n            .get(random_number)\n            .expect(\"Can't access generated keys, seems like app is not properly booted\")\n            .clone()\n    }\n\n    fn generate_rsa_key_pairs(count: u8) -\u003e Vec\u003cScrambledRSAKeyPair\u003e {\n        let mut key_pairs: Vec\u003cScrambledRSAKeyPair\u003e = vec![];\n        for _ in 0..count {\n            let rsa_pair = generate_rsa_key_pair();\n            let scrumbled = ScrambledRSAKeyPair::new(rsa_pair);\n            key_pairs.push(scrumbled);\n        }\n        info!(\"Generated {count} RSA key pairs\");\n        key_pairs\n    }\n}\n","traces":[{"line":24,"address":[4630078,4626928,4628067,4630105],"length":1,"stats":{"Line":1}},{"line":25,"address":[4627785,4629252,4628429,4627170,4627915,4628525,4626959,4628880,4628816,4628255,4627586,4628069],"length":1,"stats":{"Line":6}},{"line":26,"address":[4629567,4628191,4629590],"length":1,"stats":{"Line":3}},{"line":29,"address":[4629657],"length":1,"stats":{"Line":1}},{"line":31,"address":[4629696],"length":1,"stats":{"Line":1}},{"line":32,"address":[4629751],"length":1,"stats":{"Line":1}},{"line":33,"address":[4629803],"length":1,"stats":{"Line":1}},{"line":34,"address":[4629856],"length":1,"stats":{"Line":1}},{"line":37,"address":[4630144],"length":1,"stats":{"Line":1}},{"line":38,"address":[4630149],"length":1,"stats":{"Line":1}},{"line":40,"address":[4630160],"length":1,"stats":{"Line":0}},{"line":41,"address":[4630184],"length":1,"stats":{"Line":0}},{"line":43,"address":[4630240,4630502],"length":1,"stats":{"Line":1}},{"line":44,"address":[4630267],"length":1,"stats":{"Line":1}},{"line":45,"address":[4630281,4630351],"length":1,"stats":{"Line":2}},{"line":47,"address":[4630381],"length":1,"stats":{"Line":1}},{"line":53,"address":[4633661,4630528],"length":1,"stats":{"Line":1}},{"line":54,"address":[4630569],"length":1,"stats":{"Line":1}},{"line":55,"address":[4630574,4630663,4631836],"length":1,"stats":{"Line":2}},{"line":56,"address":[4630910],"length":1,"stats":{"Line":1}},{"line":57,"address":[4633599],"length":1,"stats":{"Line":1}},{"line":58,"address":[4633626],"length":1,"stats":{"Line":1}},{"line":60,"address":[4632057,4631355,4631838,4631684,4632327,4630939,4632588,4632652,4632843,4633158,4633349,4632231,4631554],"length":1,"stats":{"Line":5}},{"line":61,"address":[4631968],"length":1,"stats":{"Line":1}}],"covered":22,"coverable":24},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","controller","gs_management.rs"],"content":"use super::data::LoginController;\nuse crate::dto::game_server::GSInfo;\nuse l2_core::shared_packets::common::{GSLoginFailReasons, ServerData, ServerStatus};\nuse std::net::Ipv4Addr;\n\nimpl LoginController {\n    pub fn get_server_list(\u0026self, client_ip: Ipv4Addr) -\u003e Vec\u003cServerData\u003e {\n        let mut servers = Vec::new();\n        for s in \u0026self.game_servers {\n            servers.push(ServerData {\n                ip: s.get_host_ip(client_ip),\n                port: i32::from(s.get_port()),\n                age_limit: i32::from(s.get_age_limit()),\n                pvp: s.is_pvp(),\n                current_players: 0,               //todo: implement me\n                max_players: s.get_max_players(), //allow wrapping\n                brackets: s.show_brackets(),\n                clock: false, //todo: implement me\n                status: ServerStatus::try_from(s.get_status()).ok(),\n                server_id: i32::from(s.get_id()),\n                server_type: s.get_server_type(),\n            });\n        }\n        servers\n    }\n\n    pub fn with_gs\u003cF\u003e(\u0026self, gs_id: u8, f: F) -\u003e bool\n    where\n        F: Fn(\u0026mut GSInfo),\n    {\n        if let Some(mut gs) = self.game_servers.get_mut(\u0026gs_id) {\n            f(\u0026mut gs);\n            true\n        } else {\n            false\n        }\n    }\n    fn generate_sequential_key(\u0026self) -\u003e anyhow::Result\u003cu8, GSLoginFailReasons\u003e {\n        (0..=u8::MAX)\n            .find(|key| !\u0026self.game_servers.contains_key(key))\n            .ok_or(GSLoginFailReasons::NoFreeID)\n    }\n    pub fn register_gs(\u0026self, gs_info: GSInfo) -\u003e anyhow::Result\u003cu8, GSLoginFailReasons\u003e {\n        let id = gs_info.get_id();\n        if let Some(allowed_gs) = \u0026self.config.allowed_gs {\n            if !allowed_gs.contains(\u0026gs_info.hex_int()) {\n                return Err(GSLoginFailReasons::WrongHexId);\n            }\n        }\n        if self.game_servers.contains_key(\u0026gs_info.get_id()) {\n            if gs_info.accept_alternative_id() {\n                return self.generate_sequential_key();\n            }\n            return Err(GSLoginFailReasons::AlreadyRegistered);\n        }\n        self.game_servers.insert(gs_info.get_id(), gs_info);\n        Ok(id)\n    }\n\n    pub fn remove_gs(\u0026self, server_id: u8) {\n        self.game_servers.remove(\u0026server_id);\n    }\n}\n","traces":[{"line":7,"address":[4633696,4634787],"length":1,"stats":{"Line":0}},{"line":8,"address":[4633764],"length":1,"stats":{"Line":0}},{"line":9,"address":[4633777,4633922,4633966,4633836],"length":1,"stats":{"Line":0}},{"line":10,"address":[4634636],"length":1,"stats":{"Line":0}},{"line":11,"address":[4634006,4634128],"length":1,"stats":{"Line":0}},{"line":12,"address":[4634213],"length":1,"stats":{"Line":0}},{"line":13,"address":[4634270],"length":1,"stats":{"Line":0}},{"line":14,"address":[4634324],"length":1,"stats":{"Line":0}},{"line":16,"address":[4634360],"length":1,"stats":{"Line":0}},{"line":17,"address":[4634396],"length":1,"stats":{"Line":0}},{"line":19,"address":[4634432],"length":1,"stats":{"Line":0}},{"line":20,"address":[4634518],"length":1,"stats":{"Line":0}},{"line":21,"address":[4634572],"length":1,"stats":{"Line":0}},{"line":24,"address":[4634037],"length":1,"stats":{"Line":0}},{"line":27,"address":[5079568,5079813,5079617],"length":1,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[4634816],"length":1,"stats":{"Line":0}},{"line":39,"address":[4634899,4634830],"length":1,"stats":{"Line":0}},{"line":40,"address":[4030014,4030000],"length":1,"stats":{"Line":0}},{"line":41,"address":[4634894],"length":1,"stats":{"Line":0}},{"line":43,"address":[4634928,4635722,4635385],"length":1,"stats":{"Line":0}},{"line":44,"address":[4635043,4634966],"length":1,"stats":{"Line":0}},{"line":45,"address":[4635050],"length":1,"stats":{"Line":0}},{"line":46,"address":[4635132,4635215],"length":1,"stats":{"Line":0}},{"line":47,"address":[4635346],"length":1,"stats":{"Line":0}},{"line":50,"address":[4635159,4635403],"length":1,"stats":{"Line":0}},{"line":51,"address":[4635474,4635643],"length":1,"stats":{"Line":0}},{"line":52,"address":[4635683],"length":1,"stats":{"Line":0}},{"line":54,"address":[4635649],"length":1,"stats":{"Line":0}},{"line":56,"address":[4635502,4635449],"length":1,"stats":{"Line":0}},{"line":57,"address":[4635614],"length":1,"stats":{"Line":0}},{"line":60,"address":[4635760],"length":1,"stats":{"Line":0}},{"line":61,"address":[4635778],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","controller","mod.rs"],"content":"mod data;\nmod gs_management;\nmod player_management;\nmod security;\n\npub use data::LoginController;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","controller","player_management.rs"],"content":"use super::data::LoginController;\nuse l2_core::shared_packets::common::{PacketType, PlayerLoginFailReasons};\nuse l2_core::shared_packets::ls_2_gs::{KickPlayer, RequestChars};\nuse crate::dto::player;\nuse crate::dto::player::GSCharsInfo;\nuse rand::{\n    distributions::{Distribution, Standard},\n    Rng,\n};\nuse tracing::info;\n\nimpl LoginController {\n    pub async fn on_player_login(\n        \u0026self,\n        mut player_info: player::Info,\n    ) -\u003e anyhow::Result\u003c(), PlayerLoginFailReasons\u003e {\n        let account_name = player_info.account_name.clone();\n        self.check_player_in_game(\u0026account_name).await?;\n        let mut task_results = self.message_broker\n            .send_message_to_all(\u0026account_name, || Box::new(RequestChars::new(\u0026account_name)))\n            .await\n            .into_iter();\n\n        while let Some(Ok(resp)) = task_results.next() {\n            if let Some((gs_id, PacketType::ReplyChars(p))) = resp {\n                player_info.chars_on_servers.insert(\n                    gs_id,\n                    GSCharsInfo {\n                        char_deletion_timestamps: p.char_deletion_timestamps,\n                        chars_to_delete: p.delete_chars_len,\n                        total_chars: p.chars,\n                    },\n                );\n            }\n            // ignore all the tasks that are timed out\n        }\n        self.players.insert(account_name, player_info); // if player exists it will drop\n        Ok(())\n    }\n\n    async fn check_player_in_game(\n        \u0026self,\n        account_name: \u0026str,\n    ) -\u003e anyhow::Result\u003c(), PlayerLoginFailReasons\u003e {\n        if let Some(player_in_game) = self.players.remove(account_name) {\n            if let Some(gs) = player_in_game.1.game_server {\n                let _ = self.message_broker\n                    .notify(gs, Box::new(KickPlayer::new(account_name)))\n                    .await;\n            } else {\n                let _ = self.message_broker\n                    .notify_all(|| Box::new(KickPlayer::new(account_name)))\n                    .await;\n            }\n            return Err(PlayerLoginFailReasons::ReasonAccountInUse);\n        }\n        Ok(())\n    }\n\n    pub fn on_player_logout(\u0026self, account_name: \u0026str) {\n        info!(\"Player logged out: {account_name}\");\n        self.remove_player(account_name);\n    }\n\n    pub fn get_player(\u0026self, account_name: \u0026str) -\u003e Option\u003cplayer::Info\u003e {\n        self.players.get(account_name).map(|i| i.clone())\n    }\n    pub fn with_player\u003cF\u003e(\u0026self, account_name: \u0026str, f: F) -\u003e bool\n    where\n        F: FnOnce(\u0026mut player::Info) -\u003e bool,\n    {\n        if let Some(mut player) = self.players.get_mut(account_name) {\n            f(\u0026mut player)\n        } else {\n            false\n        }\n    }\n    pub fn remove_player(\u0026self, account_name: \u0026str) {\n        self.players.remove(account_name);\n    }\n\n    pub fn remove_all_gs_players(\u0026self, gs_id: u8) {\n        let accounts_to_remove: Vec\u003c_\u003e = self\n            .players\n            .iter()\n            .filter(|entry| entry.value().game_server == Some(gs_id))\n            .map(|entry| entry.key().clone())\n            .collect();\n        for acc in accounts_to_remove {\n            self.remove_player(\u0026acc);\n        }\n    }\n\n    pub fn on_players_in_game(\u0026self, gs_id: u8, account_name: \u0026[String]) {\n        for acc_name in account_name {\n            let op_success = self.with_player(acc_name, |pl| {\n                pl.game_server = Some(gs_id);\n                pl.is_joined_gs = true;\n                true\n            });\n            if !op_success {\n                let pl = player::Info {\n                    game_server: Some(gs_id),\n                    account_name: acc_name.clone(),\n                    is_joined_gs: true,\n                    is_authed: true,\n                    ..player::Info::default()\n                };\n                self.players.insert(acc_name.clone(), pl);\n            }\n        }\n    }\n\n    pub fn generate_session_id\u003cT\u003e() -\u003e T\n    where\n        Standard: Distribution\u003cT\u003e,\n    {\n        let mut rng = rand::thread_rng();\n        rng.gen()\n    }\n}\n","traces":[{"line":13,"address":[4635824],"length":1,"stats":{"Line":0}},{"line":17,"address":[3842539,3842687],"length":1,"stats":{"Line":0}},{"line":18,"address":[4470155],"length":1,"stats":{"Line":0}},{"line":19,"address":[3843651,3843144,3843747,3843275,3843305],"length":1,"stats":{"Line":0}},{"line":20,"address":[3845264,3845407,3843211,3845273],"length":1,"stats":{"Line":0}},{"line":21,"address":[3842617,3843683,3843335,3843298,3843544],"length":1,"stats":{"Line":0}},{"line":24,"address":[3843819,3843772,3843907],"length":1,"stats":{"Line":0}},{"line":25,"address":[3844062,3843941],"length":1,"stats":{"Line":0}},{"line":26,"address":[3844175,3844295,3844055],"length":1,"stats":{"Line":0}},{"line":28,"address":[3844233],"length":1,"stats":{"Line":0}},{"line":29,"address":[3844187],"length":1,"stats":{"Line":0}},{"line":30,"address":[3844226],"length":1,"stats":{"Line":0}},{"line":31,"address":[3844219],"length":1,"stats":{"Line":0}},{"line":37,"address":[3844905],"length":1,"stats":{"Line":0}},{"line":38,"address":[3845150],"length":1,"stats":{"Line":0}},{"line":41,"address":[4635904],"length":1,"stats":{"Line":0}},{"line":45,"address":[3845574,3845705],"length":1,"stats":{"Line":0}},{"line":46,"address":[3845835,3845781],"length":1,"stats":{"Line":0}},{"line":47,"address":[3845860,3846138,3846567,3846186],"length":1,"stats":{"Line":0}},{"line":48,"address":[3845983],"length":1,"stats":{"Line":0}},{"line":49,"address":[3846453,3845624,3846219,3846591,3846179],"length":1,"stats":{"Line":0}},{"line":51,"address":[3845884,3846274,3846304,3846836],"length":1,"stats":{"Line":0}},{"line":52,"address":[3847001,3847131,3846992],"length":1,"stats":{"Line":0}},{"line":53,"address":[4472260],"length":1,"stats":{"Line":0}},{"line":55,"address":[3846670],"length":1,"stats":{"Line":0}},{"line":57,"address":[3846369],"length":1,"stats":{"Line":0}},{"line":60,"address":[4637269,4635952],"length":1,"stats":{"Line":0}},{"line":61,"address":[3847611,3847768],"length":1,"stats":{"Line":0}},{"line":62,"address":[4637369],"length":1,"stats":{"Line":0}},{"line":65,"address":[4638272],"length":1,"stats":{"Line":0}},{"line":66,"address":[4638301],"length":1,"stats":{"Line":0}},{"line":68,"address":[5080212,5080270,5079872,5080709,5080651,5080288],"length":1,"stats":{"Line":0}},{"line":72,"address":[5080336,5079993,5080410,5079919,5080520,5080081],"length":1,"stats":{"Line":0}},{"line":73,"address":[5080471,5080649,5080210,5080049,5080083,5080522],"length":1,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[4638352],"length":1,"stats":{"Line":0}},{"line":79,"address":[4638392],"length":1,"stats":{"Line":0}},{"line":82,"address":[4638432,4638891],"length":1,"stats":{"Line":0}},{"line":83,"address":[4638461],"length":1,"stats":{"Line":0}},{"line":86,"address":[3847280,3847310],"length":1,"stats":{"Line":0}},{"line":87,"address":[3847360,3847390],"length":1,"stats":{"Line":0}},{"line":89,"address":[4638691,4638748,4638537],"length":1,"stats":{"Line":0}},{"line":90,"address":[4638862,4638788],"length":1,"stats":{"Line":0}},{"line":94,"address":[4638928,4639710,4639735],"length":1,"stats":{"Line":0}},{"line":95,"address":[4639067,4638993],"length":1,"stats":{"Line":0}},{"line":96,"address":[3847488],"length":1,"stats":{"Line":0}},{"line":97,"address":[3847498],"length":1,"stats":{"Line":0}},{"line":98,"address":[3847531],"length":1,"stats":{"Line":0}},{"line":101,"address":[4639705,4639120],"length":1,"stats":{"Line":0}},{"line":103,"address":[4639129],"length":1,"stats":{"Line":0}},{"line":104,"address":[4639148],"length":1,"stats":{"Line":0}},{"line":109,"address":[4639491],"length":1,"stats":{"Line":0}},{"line":114,"address":[5080826,5080736],"length":1,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":119,"address":[],"length":0,"stats":{"Line":1}}],"covered":3,"coverable":55},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","controller","security.rs"],"content":"use super::data::LoginController;\nuse l2_core::traits::IpBan;\nuse chrono::Utc;\n\nimpl LoginController {\n    pub fn update_ip_ban_list(\u0026self, ip: \u0026str, ban_duration: i64) {\n        let _ = self.ip_ban_list.remove(ip);\n        self.ip_ban_list.insert(ip.to_string(), ban_duration);\n    }\n}\nimpl IpBan for LoginController {\n    fn is_ip_banned(\u0026self, ip: \u0026str) -\u003e bool {\n        if let Some(res) = self.ip_ban_list.get(ip) {\n            let now = Utc::now().timestamp();\n            if now \u003c *res {\n                return true;\n            }\n            self.ip_ban_list.remove(ip);\n        }\n        false\n    }\n}\n","traces":[{"line":6,"address":[4639744],"length":1,"stats":{"Line":0}},{"line":7,"address":[4639806],"length":1,"stats":{"Line":0}},{"line":8,"address":[4639845],"length":1,"stats":{"Line":0}},{"line":12,"address":[4639904,4640300],"length":1,"stats":{"Line":0}},{"line":13,"address":[4639959],"length":1,"stats":{"Line":0}},{"line":14,"address":[4640043,4640131],"length":1,"stats":{"Line":0}},{"line":15,"address":[4640170],"length":1,"stats":{"Line":0}},{"line":16,"address":[4640231],"length":1,"stats":{"Line":0}},{"line":18,"address":[4640212,4640264],"length":1,"stats":{"Line":0}},{"line":20,"address":[4640340],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":10},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","dto","game_server.rs"],"content":"use l2_core::dto::ServerHost;\nuse l2_core::shared_packets::common::ServerType;\nuse anyhow::bail;\nuse num::BigInt;\nuse pnet::ipnetwork::Ipv4Network;\nuse std::net::Ipv4Addr;\nuse std::str::FromStr;\n\n#[allow(clippy::struct_excessive_bools)]\n#[derive(Debug, Clone)]\npub struct GSInfo {\n    id: u8,\n    accept_alternative_id: bool,\n    host_reserved: bool,\n    port: u16,\n    is_authed: bool,\n    status: i32,\n    is_pvp: bool,\n    server_type: i32,\n    age_limit: u8,\n    show_brackets: bool,\n    max_players: u32,\n    hex_id: Vec\u003cu8\u003e,\n    hosts: Vec\u003cServerHost\u003e,\n}\n#[allow(\n    clippy::cast_sign_loss,\n    clippy::cast_possible_wrap,\n    clippy::cast_possible_truncation\n)]\nimpl GSInfo {\n    #[allow(clippy::too_many_arguments, clippy::fn_params_excessive_bools)]\n    pub fn new(\n        id: u8,\n        accept_alternative_id: bool,\n        host_reserved: bool,\n        port: u16,\n        is_authed: bool,\n        status: i32,\n        is_pvp: bool,\n        server_type: i32,\n        age_limit: u8,\n        show_brackets: bool,\n        max_players: u32,\n        hex_id: Vec\u003cu8\u003e,\n        hosts: \u0026[String],\n    ) -\u003e anyhow::Result\u003cSelf\u003e {\n        let validated_hosts = Self::validate_server_hosts(hosts)?;\n        Ok(GSInfo {\n            id,\n            accept_alternative_id,\n            host_reserved,\n            port,\n            is_authed,\n            status,\n            is_pvp,\n            server_type,\n            age_limit,\n            show_brackets,\n            max_players,\n            hex_id,\n            hosts: validated_hosts,\n        })\n    }\n\n    pub fn get_host_ip(\u0026self, client_ip: Ipv4Addr) -\u003e Ipv4Addr {\n        for s in \u0026self.hosts {\n            if s.subnet.contains(client_ip) {\n                return s.ip;\n            }\n        }\n        Ipv4Addr::new(127, 0, 0, 1)\n    }\n    pub fn hex(\u0026self) -\u003e String {\n        BigInt::from_signed_bytes_be(\u0026self.hex_id).to_str_radix(16)\n    }\n    pub fn hex_int(\u0026self) -\u003e BigInt {\n        BigInt::from_signed_bytes_be(\u0026self.hex_id)\n    }\n\n    pub fn get_id(\u0026self) -\u003e u8 {\n        self.id\n    }\n    pub fn accept_alternative_id(\u0026self) -\u003e bool {\n        self.accept_alternative_id\n    }\n    pub fn is_host_reserved(\u0026self) -\u003e bool {\n        self.host_reserved\n    }\n    pub fn get_port(\u0026self) -\u003e u16 {\n        self.port\n    }\n    pub fn is_authed(\u0026self) -\u003e bool {\n        self.is_authed\n    }\n    pub fn get_status(\u0026self) -\u003e u8 {\n        self.status as u8\n    }\n    pub fn is_pvp(\u0026self) -\u003e bool {\n        self.is_pvp\n    }\n    pub fn get_server_type(\u0026self) -\u003e Option\u003cServerType\u003e {\n        ServerType::try_from(self.server_type).ok()\n    }\n    pub fn get_age_limit(\u0026self) -\u003e u8 {\n        self.age_limit\n    }\n    pub fn show_brackets(\u0026self) -\u003e bool {\n        self.show_brackets\n    }\n    pub fn get_max_players(\u0026self) -\u003e i32 {\n        self.max_players as i32\n    }\n    pub fn set_max_players(\u0026mut self, max_players: u32) {\n        self.max_players = max_players;\n    }\n    pub fn set_age_limit(\u0026mut self, age_limit: u8) {\n        self.age_limit = age_limit;\n    }\n    pub fn use_square_brackets(\u0026mut self, is_square_brackets: bool) {\n        self.show_brackets = is_square_brackets;\n    }\n    pub fn set_server_type(\u0026mut self, server_type: i32) {\n        self.server_type = server_type;\n    }\n    pub fn set_server_status(\u0026mut self, status: i32) {\n        self.status = status;\n    }\n    pub fn get_hex_id(\u0026self) -\u003e Vec\u003cu8\u003e {\n        self.hex_id.clone()\n    }\n    pub fn get_hosts(\u0026self) -\u003e Vec\u003cServerHost\u003e {\n        self.hosts.clone()\n    }\n    ///\n    /// This function takes as an input an iterable of strings and try to compile a list of pairs:\n    /// Subnet / Ip\n    ///\n    /// ```\n    /// let hosts = vec![\"127.0.0.5/32\", \"127.0.0.5\"];\n    /// let validated = GSInfo::validate_server_hosts(hosts);\n    /// assert!(validated.is_ok());\n    /// ```\n    ///\n    fn validate_server_hosts\u003cI, T\u003e(hosts: I) -\u003e anyhow::Result\u003cVec\u003cServerHost\u003e\u003e\n    where\n        I: IntoIterator\u003cItem = T\u003e,\n        T: AsRef\u003cstr\u003e,\n    {\n        let mut validated_hosts = Vec::new();\n        let mut iter = hosts.into_iter();\n\n        loop {\n            // Attempt to get the subnet and IP as a pair\n            let Some(subnet_str) = iter.next() else { break };\n            let Some(ip_str) = iter.next() else {\n                bail!(\n                    \"Incorrect host data: Subnet provided but IP is missing {:?}\",\n                    subnet_str.as_ref()\n                )\n            };\n            let subnet = Ipv4Network::from_str(subnet_str.as_ref())?;\n            let ip = Ipv4Addr::from_str(ip_str.as_ref())?;\n            if !subnet.contains(ip) {\n                bail!(\"Subnet \\\"{subnet}\\\" doesn't contain IP \\\"{ip}\\\". Check game server configuration.\")\n            }\n            validated_hosts.push(ServerHost { ip, subnet });\n        }\n        Ok(validated_hosts)\n    }\n}\n\n#[cfg(test)]\nmod test {\n    use crate::dto::game_server::GSInfo;\n    #[test]\n    fn test_validated_hosts_error() {\n        let hosts = vec![\"127.0.0.1\"];\n        let validated = GSInfo::validate_server_hosts(hosts);\n        assert!(validated.is_err());\n    }\n    #[test]\n    fn test_validated_hosts_error_invalid_subnet() {\n        let hosts = vec![\"127.0.0.1\", \"127.0.0.2\"];\n        let validated = GSInfo::validate_server_hosts(hosts);\n        assert!(validated.is_err());\n    }\n    #[test]\n    fn test_validated_hosts_err_wrong_subnet_range() {\n        let hosts = vec![\"127.0.0.1/32\", \"127.0.0.5\"];\n        let validated = GSInfo::validate_server_hosts(hosts);\n        assert!(validated.is_err());\n    }\n    #[test]\n    fn test_validated_hosts_ok() {\n        let hosts = vec![\"127.0.0.5/32\", \"127.0.0.5\"];\n        let validated = GSInfo::validate_server_hosts(hosts);\n        assert!(validated.is_ok());\n    }\n}\n","traces":[{"line":33,"address":[4852576,4853338],"length":1,"stats":{"Line":0}},{"line":48,"address":[4852830,4853277,4852888],"length":1,"stats":{"Line":0}},{"line":49,"address":[4853060],"length":1,"stats":{"Line":0}},{"line":61,"address":[4853025],"length":1,"stats":{"Line":0}},{"line":66,"address":[4853360],"length":1,"stats":{"Line":0}},{"line":67,"address":[4853381,4853475],"length":1,"stats":{"Line":0}},{"line":68,"address":[4853490],"length":1,"stats":{"Line":0}},{"line":69,"address":[4853585],"length":1,"stats":{"Line":0}},{"line":72,"address":[4853442],"length":1,"stats":{"Line":0}},{"line":74,"address":[4853732,4853600],"length":1,"stats":{"Line":0}},{"line":75,"address":[4853630],"length":1,"stats":{"Line":0}},{"line":77,"address":[4853760],"length":1,"stats":{"Line":0}},{"line":78,"address":[4853792],"length":1,"stats":{"Line":0}},{"line":81,"address":[4853824],"length":1,"stats":{"Line":0}},{"line":82,"address":[4853829],"length":1,"stats":{"Line":0}},{"line":84,"address":[4853840],"length":1,"stats":{"Line":0}},{"line":85,"address":[4853845],"length":1,"stats":{"Line":0}},{"line":87,"address":[4853856],"length":1,"stats":{"Line":0}},{"line":88,"address":[4853861],"length":1,"stats":{"Line":0}},{"line":90,"address":[4853872],"length":1,"stats":{"Line":0}},{"line":91,"address":[4853877],"length":1,"stats":{"Line":0}},{"line":93,"address":[4853888],"length":1,"stats":{"Line":0}},{"line":94,"address":[4853893],"length":1,"stats":{"Line":0}},{"line":96,"address":[4853904],"length":1,"stats":{"Line":0}},{"line":97,"address":[4853909],"length":1,"stats":{"Line":0}},{"line":99,"address":[4853920],"length":1,"stats":{"Line":0}},{"line":100,"address":[4853925],"length":1,"stats":{"Line":0}},{"line":102,"address":[4853936],"length":1,"stats":{"Line":0}},{"line":103,"address":[4853941],"length":1,"stats":{"Line":0}},{"line":105,"address":[4853968],"length":1,"stats":{"Line":0}},{"line":106,"address":[4853973],"length":1,"stats":{"Line":0}},{"line":108,"address":[4853984],"length":1,"stats":{"Line":0}},{"line":109,"address":[4853989],"length":1,"stats":{"Line":0}},{"line":111,"address":[4854000],"length":1,"stats":{"Line":0}},{"line":112,"address":[4854005],"length":1,"stats":{"Line":0}},{"line":114,"address":[4854016],"length":1,"stats":{"Line":0}},{"line":115,"address":[4854025],"length":1,"stats":{"Line":0}},{"line":117,"address":[4854032],"length":1,"stats":{"Line":0}},{"line":118,"address":[4854044],"length":1,"stats":{"Line":0}},{"line":120,"address":[4854048],"length":1,"stats":{"Line":0}},{"line":121,"address":[4854065],"length":1,"stats":{"Line":0}},{"line":123,"address":[4854080],"length":1,"stats":{"Line":0}},{"line":124,"address":[4854089],"length":1,"stats":{"Line":0}},{"line":126,"address":[4854096],"length":1,"stats":{"Line":0}},{"line":127,"address":[4854105],"length":1,"stats":{"Line":0}},{"line":129,"address":[4854112],"length":1,"stats":{"Line":0}},{"line":130,"address":[4854129],"length":1,"stats":{"Line":0}},{"line":132,"address":[4854160],"length":1,"stats":{"Line":0}},{"line":133,"address":[4854177],"length":1,"stats":{"Line":0}},{"line":145,"address":[5045451,5045482,5040912,5043168,5043134],"length":1,"stats":{"Line":3}},{"line":150,"address":[],"length":0,"stats":{"Line":3}},{"line":151,"address":[],"length":0,"stats":{"Line":6}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":7}},{"line":156,"address":[5043553,5041322,5043624,5041264],"length":1,"stats":{"Line":6}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":1}},{"line":162,"address":[],"length":0,"stats":{"Line":4}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":5}},{"line":165,"address":[],"length":0,"stats":{"Line":2}},{"line":167,"address":[],"length":0,"stats":{"Line":1}},{"line":169,"address":[],"length":0,"stats":{"Line":1}}],"covered":13,"coverable":63},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","dto","mod.rs"],"content":"pub mod game_server;\npub mod player;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","dto","player.rs"],"content":"use l2_core::session::SessionKey;\nuse std::collections::HashMap;\nuse std::net::IpAddr;\n\n#[derive(Debug, Clone, Default)]\npub struct GSCharsInfo {\n    pub total_chars: u8,\n    pub chars_to_delete: u8,\n    pub char_deletion_timestamps: Vec\u003ci64\u003e,\n}\n#[derive(Debug, Clone, Default)]\npub struct Info {\n    pub session: Option\u003cSessionKey\u003e,\n    pub account_name: String,\n    pub login_time: Option\u003cbool\u003e,\n    pub is_authed: bool,\n    pub is_joined_gs: bool,\n    pub ip_address: Option\u003cIpAddr\u003e,\n    pub chars_on_servers: HashMap\u003cu8, GSCharsInfo\u003e,\n    pub game_server: Option\u003cu8\u003e,\n}\n\nimpl Info {\n    pub fn new() -\u003e Self {\n        Info {\n            is_authed: false,\n            is_joined_gs: false,\n            ..Info::default()\n        }\n    }\n}\n","traces":[{"line":24,"address":[4600736],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","gs_thread","enums.rs"],"content":"use l2_core::shared_packets::common::GSLoginFailReasons;\nuse strum::Display;\n\n#[derive(Debug, Clone, Display)]\npub enum GS {\n    Initial,\n    Connected,\n    BfConnected,\n    Authed,\n}\n\nimpl GS {\n    pub fn transition_to(\u0026mut self, desired_state: \u0026GS) -\u003e Result\u003c(), GSLoginFailReasons\u003e {\n        match (\u0026self, desired_state) {\n            (Self::Initial, Self::Connected) =\u003e *self = Self::Connected,\n            (Self::Connected, Self::BfConnected) =\u003e *self = Self::BfConnected,\n            (Self::BfConnected, Self::Authed) =\u003e *self = Self::Authed,\n            _ =\u003e {\n                return Err(GSLoginFailReasons::NotAuthed);\n            }\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[4619582,4619520],"length":1,"stats":{"Line":0}},{"line":14,"address":[4619584,4619535],"length":1,"stats":{"Line":0}},{"line":15,"address":[4619645],"length":1,"stats":{"Line":0}},{"line":16,"address":[4619668],"length":1,"stats":{"Line":0}},{"line":17,"address":[4619686],"length":1,"stats":{"Line":0}},{"line":19,"address":[4619630],"length":1,"stats":{"Line":0}},{"line":22,"address":[4619661],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","gs_thread","handler.rs"],"content":"use crate::controller::LoginController;\nuse crate::gs_thread::enums;\nuse crate::packet::gs_factory::build_gs_packet;\nuse anyhow::{anyhow, bail, Error};\nuse async_trait::async_trait;\nuse entities::DBPool;\nuse l2_core::config::login::LoginServer;\nuse l2_core::crypt::login::Encryption;\nuse l2_core::crypt::rsa::ScrambledRSAKeyPair;\nuse l2_core::dto::InboundConnection;\nuse l2_core::shared_packets::common::GSLoginFail;\nuse l2_core::shared_packets::ls_2_gs::InitLS;\nuse l2_core::traits::handlers::{InboundHandler, PacketHandler, PacketSender};\nuse l2_core::traits::Shutdown;\nuse std::fmt;\nuse std::net::Ipv4Addr;\nuse std::sync::Arc;\nuse tokio::io::{AsyncRead, AsyncWrite};\nuse tokio::sync::{Mutex, Notify};\nuse tracing::{info, instrument};\nuse macro_common::LoginPacketSenderImpl;\n\n#[allow(clippy::module_name_repetitions)]\n#[derive(Clone, LoginPacketSenderImpl)]\npub struct GameServer {\n    ///\n    /// `tcp_reader` and `tcp_writer` are wrapped into Arc\u003cMutex\u003e because we need to share the handler\n    /// across two tokio threads:\n    /// 1. Main thread to accept and answer `shared_packets`\n    /// 2. Listen for messages from Client login thread if we need info about logging in Player\n    tcp_reader: Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e,\n    tcp_writer: Arc\u003cMutex\u003cdyn AsyncWrite + Send + Unpin\u003e\u003e,\n    shutdown_listener: Arc\u003cNotify\u003e,\n    lc: Arc\u003cLoginController\u003e,\n    db_pool: DBPool,\n    ip: Ipv4Addr,\n    key_pair: ScrambledRSAKeyPair,\n    blowfish: Encryption,\n    connection_state: enums::GS,\n    pub server_id: Option\u003cu8\u003e,\n}\nimpl fmt::Debug for GameServer {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        f.debug_struct(\"Client\")\n            .field(\"ip\", \u0026self.ip)\n            .field(\"connection_state\", \u0026self.connection_state)\n            .field(\"server_id\", \u0026self.server_id)\n            .finish_non_exhaustive()\n    }\n}\nimpl GameServer {\n    pub fn set_blowfish_key(\u0026mut self, new_bf_key: \u0026[u8]) {\n        self.blowfish = Encryption::from_u8_key(new_bf_key);\n    }\n    pub fn try_get_server_id(\u0026self) -\u003e anyhow::Result\u003cu8\u003e {\n        self.server_id\n            .ok_or_else(|| anyhow!(\"Possible cheating: No server ID set\"))\n    }\n    pub async fn set_connection_state(\u0026mut self, state: \u0026enums::GS) -\u003e anyhow::Result\u003c()\u003e {\n        if let Err(err) = self.connection_state.transition_to(state) {\n            let err_msg = format!(\"Connection state transition failed {err:?}\");\n            self.send_packet(Box::new(GSLoginFail::new(err)?)).await?;\n            bail!(err_msg);\n        }\n        Ok(())\n    }\n\n    pub fn decrypt_rsa(\u0026self, data: \u0026mut [u8]) -\u003e anyhow::Result\u003cVec\u003cu8\u003e\u003e {\n        self.key_pair.decrypt_data(data)\n    }\n}\n\nimpl Shutdown for GameServer {\n    fn get_shutdown_listener(\u0026self) -\u003e Arc\u003cNotify\u003e {\n        self.shutdown_listener.clone()\n    }\n}\n\n#[async_trait]\nimpl PacketHandler for GameServer {\n    type ConfigType = LoginServer;\n    type ControllerType = LoginController;\n    fn get_handler_name() -\u003e \u0026'static str {\n        \"Game server handler\"\n    }\n    fn get_controller(\u0026self) -\u003e \u0026Arc\u003cSelf::ControllerType\u003e {\n        \u0026self.lc\n    }\n\n    fn new\u003cR, W\u003e(r: R, w: W, ip: Ipv4Addr, db_pool: DBPool, lc: Arc\u003cSelf::ControllerType\u003e) -\u003e Self\n    where\n        R: AsyncRead + Unpin + Send + 'static,\n        W: AsyncWrite + Unpin + Send + 'static,\n    {\n        let cfg = lc.get_config();\n        Self {\n            tcp_reader: Arc::new(Mutex::new(r)),\n            tcp_writer: Arc::new(Mutex::new(w)),\n            db_pool,\n            ip,\n            shutdown_listener: Arc::new(Notify::new()),\n            key_pair: lc.get_random_rsa_key_pair(),\n            blowfish: Encryption::from_u8_key(cfg.blowfish_key.as_bytes()),\n            connection_state: enums::GS::Initial,\n            lc,\n            server_id: None,\n        }\n    }\n\n    #[instrument(skip(self))]\n    async fn on_connect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e {\n        info!(\"Game server connected: {:?}\", self.ip);\n        self.connection_state = enums::GS::Connected;\n        let init_packet = Box::new(InitLS::new(self.key_pair.get_modulus()));\n        self.send_packet(init_packet).await?;\n        Ok(())\n    }\n\n    async fn on_disconnect(\u0026mut self) {\n        info!(\n            \"Game server disconnected: ID ({:})\",\n            self.server_id.unwrap_or_default()\n        );\n        if let Some(server_id) = self.server_id {\n            let lc = self.get_controller();\n            lc.remove_gs(server_id);\n            lc.message_broker.unregister_packet_handler(server_id);\n            lc.remove_all_gs_players(server_id);\n        }\n    }\n\n    fn get_stream_reader_mut(\u0026self) -\u003e \u0026Arc\u003cMutex\u003cdyn AsyncRead + Send + Unpin\u003e\u003e {\n        \u0026self.tcp_reader\n    }\n\n    fn get_timeout(\u0026self) -\u003e Option\u003cu64\u003e {\n        None\n    }\n    fn get_db_pool(\u0026self) -\u003e \u0026DBPool {\n        \u0026self.db_pool\n    }\n\n    #[instrument(skip(self, bytes))]\n    async fn on_receive_bytes(\u0026mut self, _: usize, bytes: \u0026mut [u8]) -\u003e Result\u003c(), Error\u003e {\n        self.blowfish.decrypt(bytes)?;\n        if !Encryption::verify_checksum(bytes) {\n            bail!(\"Can not verify check sum.\")\n        }\n        let handler = build_gs_packet(bytes)?;\n        handler.handle(self).await\n    }\n}\n\nimpl InboundHandler for GameServer {\n    type ConfigType = LoginServer;\n\n    fn get_connection_config(cfg: \u0026Self::ConfigType) -\u003e \u0026InboundConnection {\n        \u0026cfg.listeners.game_servers.connection\n    }\n}\n","traces":[{"line":43,"address":[4807632],"length":1,"stats":{"Line":0}},{"line":44,"address":[4807728,4807767,4807650,4807684],"length":1,"stats":{"Line":0}},{"line":45,"address":[4807677],"length":1,"stats":{"Line":0}},{"line":46,"address":[4807721],"length":1,"stats":{"Line":0}},{"line":47,"address":[4807760],"length":1,"stats":{"Line":0}},{"line":52,"address":[4807808],"length":1,"stats":{"Line":0}},{"line":53,"address":[4807855],"length":1,"stats":{"Line":0}},{"line":55,"address":[4807904],"length":1,"stats":{"Line":0}},{"line":56,"address":[4807924],"length":1,"stats":{"Line":0}},{"line":57,"address":[3814912,3814916],"length":1,"stats":{"Line":0}},{"line":59,"address":[4807968,4807981],"length":1,"stats":{"Line":0}},{"line":60,"address":[3815134,3815252],"length":1,"stats":{"Line":0}},{"line":61,"address":[3815575,3815302,3815458],"length":1,"stats":{"Line":0}},{"line":62,"address":[3815682,3815587,3816070,3816534,3816752,3816197,3815910,3815185],"length":1,"stats":{"Line":0}},{"line":63,"address":[3816576,3816451],"length":1,"stats":{"Line":0}},{"line":65,"address":[3815402],"length":1,"stats":{"Line":0}},{"line":68,"address":[4808000],"length":1,"stats":{"Line":0}},{"line":69,"address":[4808027],"length":1,"stats":{"Line":0}},{"line":74,"address":[4808048],"length":1,"stats":{"Line":0}},{"line":75,"address":[4808053],"length":1,"stats":{"Line":0}},{"line":86,"address":[4809264],"length":1,"stats":{"Line":0}},{"line":87,"address":[4809272],"length":1,"stats":{"Line":0}},{"line":90,"address":[3817552,3818659,3818566],"length":1,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[3828807,3824943,3825030,3824912,3825181,3828423,3823682],"length":1,"stats":{"Line":0}},{"line":112,"address":[3826725,3826549,3826823,3827210,3825855,3827712,3828875,3826184,3827134,3829032,3827893,3826054,3826336,3825439,3827391],"length":1,"stats":{"Line":0}},{"line":113,"address":[3826499],"length":1,"stats":{"Line":0}},{"line":114,"address":[3828143,3826520,3828311],"length":1,"stats":{"Line":0}},{"line":115,"address":[4477398],"length":1,"stats":{"Line":0}},{"line":116,"address":[3828717],"length":1,"stats":{"Line":0}},{"line":119,"address":[4809289],"length":1,"stats":{"Line":0}},{"line":120,"address":[3819756,3829451,3821300,3820744,3829608,3820378,3820680,3819427,3820280,3820982,3819908,3819626,3820104,3821538,3819011],"length":1,"stats":{"Line":0}},{"line":124,"address":[3821796,3820071],"length":1,"stats":{"Line":0}},{"line":125,"address":[3821813,3821867],"length":1,"stats":{"Line":0}},{"line":126,"address":[3821875],"length":1,"stats":{"Line":0}},{"line":127,"address":[3821911],"length":1,"stats":{"Line":0}},{"line":128,"address":[3821971],"length":1,"stats":{"Line":0}},{"line":132,"address":[4809408],"length":1,"stats":{"Line":0}},{"line":133,"address":[4809416],"length":1,"stats":{"Line":0}},{"line":136,"address":[4809424],"length":1,"stats":{"Line":0}},{"line":137,"address":[4809429],"length":1,"stats":{"Line":0}},{"line":139,"address":[4809456],"length":1,"stats":{"Line":0}},{"line":140,"address":[4809464],"length":1,"stats":{"Line":0}},{"line":144,"address":[3833488,3831894,3834391,3834436,3833588,3833730,3833513],"length":1,"stats":{"Line":0}},{"line":145,"address":[3833928,3833812,3834423],"length":1,"stats":{"Line":0}},{"line":146,"address":[3833998,3833900],"length":1,"stats":{"Line":0}},{"line":147,"address":[3834066,3834004],"length":1,"stats":{"Line":0}},{"line":149,"address":[3834120,3834030,3834237,3834405],"length":1,"stats":{"Line":0}},{"line":150,"address":[3833615,3834468,3834327,3834206],"length":1,"stats":{"Line":0}},{"line":157,"address":[4808080],"length":1,"stats":{"Line":0}},{"line":158,"address":[4808088],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":56},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","gs_thread","mod.rs"],"content":"pub mod enums;\nmod handler;\n\npub use handler::GameServer as GSHandler;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","main.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::controller::LoginController;\nuse crate::gs_thread::GSHandler;\nuse l2_core::config::login;\nuse l2_core::traits::server::Server;\nuse std::sync::Arc;\nuse tracing::error;\n\nmod client_thread;\nmod controller;\nmod dto;\nmod gs_thread;\nmod packet;\npub struct LoginServer;\n\nimpl Server for LoginServer {\n    type ConfigType = login::LoginServer;\n    type ControllerType = LoginController;\n}\n///\n/// # Panics\n/// - when can't open a socket\n/// - when config file not found\n/// - when DB is not accessible\n/// - when can't run migrations\n///\npub fn main() {\n    tracing_subscriber::fmt()\n        .compact()\n        .with_file(true)\n        .with_line_number(true)\n        .with_thread_ids(true)\n        .with_target(false)\n        .init();\n    LoginServer::bootstrap(\"config/login.yaml\", |cfg, db_pool| async move {\n        let lc = Arc::new(LoginController::new(cfg.clone()));\n        let mut clients_handle =\n            LoginServer::listener_loop::\u003cClientHandler\u003e(cfg.clone(), lc.clone(), db_pool.clone());\n\n        let mut gs_handle =\n            LoginServer::listener_loop::\u003cGSHandler\u003e(cfg.clone(), lc.clone(), db_pool.clone());\n\n        tokio::select! {\n            _ = \u0026mut clients_handle =\u003e {\n                error!(\"Client handler exited unexpectedly\");\n            }\n            _ = \u0026mut gs_handle =\u003e {\n                error!(\"Game server handler exited unexpectedly\");\n            }\n        }\n        if !clients_handle.is_finished() {\n            clients_handle.abort();\n        }\n        if !gs_handle.is_finished() {\n            gs_handle.abort();\n        }\n    });\n}\n","traces":[{"line":27,"address":[4356656],"length":1,"stats":{"Line":0}},{"line":28,"address":[4356663],"length":1,"stats":{"Line":0}},{"line":35,"address":[4008296,4015372,4008144,4009547,4008093,4008080,4008175,4009655],"length":1,"stats":{"Line":0}},{"line":36,"address":[4008237,4008399],"length":1,"stats":{"Line":0}},{"line":38,"address":[4008468,4009605],"length":1,"stats":{"Line":0}},{"line":41,"address":[4008822,4009537,4009564],"length":1,"stats":{"Line":0}},{"line":43,"address":[4009695,4015456,4009284,4008326,4009176,4015568,4009254,4010193,4011329],"length":1,"stats":{"Line":0}},{"line":44,"address":[4009257],"length":1,"stats":{"Line":0}},{"line":45,"address":[4016603,4016760,4011166,4012403,4011620,4010685,4010884,4011931,4011522,4012007,4011346,4011014,4010269],"length":1,"stats":{"Line":0}},{"line":47,"address":[4009272],"length":1,"stats":{"Line":0}},{"line":48,"address":[4014062,4013338,4012723,4013620,4013785,4013139,4013964,4014325,4013468,4014389,4017179,4014761,4017336],"length":1,"stats":{"Line":0}},{"line":51,"address":[4015068],"length":1,"stats":{"Line":0}},{"line":52,"address":[4015143,4015101],"length":1,"stats":{"Line":0}},{"line":54,"address":[4015120,4015149,4015174],"length":1,"stats":{"Line":0}},{"line":55,"address":[4015155],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":15},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","cp_factory.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packet::from_client::{\n    RequestAuthCMDLogin, RequestAuthGG, RequestAuthLogin, RequestGSLogin, RequestServerList,\n};\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse l2_core::crypt::rsa::ScrambledRSAKeyPair;\nuse l2_core::shared_packets::common::ReadablePacket;\n\n/// Client Packet Factory\npub fn build_client_packet(\n    data: \u0026[u8],\n    key_pair: \u0026ScrambledRSAKeyPair,\n) -\u003e anyhow::Result\u003cBox\u003cdyn HandleablePacket\u003cHandlerType = ClientHandler\u003e\u003e\u003e {\n    if data.is_empty() {\n        bail!(\"Empty packet\");\n    }\n    let (opcode, packet_body) = data.split_at(1);\n    match opcode[0] {\n        RequestAuthLogin::PACKET_ID =\u003e {\n            let (raw1, rest) = packet_body.split_at(128);\n            let decr_raw1 = key_pair.decrypt_data(raw1)?;\n            let mut decrypted = decr_raw1;\n            let mut is_new_auth = false;\n            if packet_body.len() \u003e= 256 {\n                let (raw2, _) = rest.split_at(128);\n                let decr_raw2 = key_pair.decrypt_data(raw2)?;\n                decrypted = [decrypted, decr_raw2].concat();\n                is_new_auth = true;\n            }\n            decrypted.push(u8::from(is_new_auth));\n            Ok(Box::new(RequestAuthLogin::read(\u0026decrypted)?))\n        }\n        RequestAuthGG::PACKET_ID =\u003e Ok(Box::new(RequestAuthGG::read(packet_body)?)),\n        RequestAuthCMDLogin::PACKET_ID =\u003e Ok(Box::new(RequestAuthLogin::read(packet_body)?)), //cmd login\n        RequestGSLogin::PACKET_ID =\u003e Ok(Box::new(RequestGSLogin::read(packet_body)?)),\n        RequestServerList::PACKET_ID =\u003e Ok(Box::new(RequestServerList::read(packet_body)?)),\n        // 0x0E =\u003e Some(LoginClientOpcodes::RequestPiAgreementCheck),\n        // 0x0F =\u003e Some(LoginClientOpcodes::RequestPiAgreement),\n        _ =\u003e {\n            bail!(\"Unknown Client packet ID:0x{:02X}\", data[0]);\n        }\n    }\n}\n","traces":[{"line":11,"address":[3837560,3835152],"length":1,"stats":{"Line":0}},{"line":15,"address":[3835245],"length":1,"stats":{"Line":0}},{"line":16,"address":[3835430],"length":1,"stats":{"Line":0}},{"line":18,"address":[3835299],"length":1,"stats":{"Line":0}},{"line":19,"address":[3835421,3835507],"length":1,"stats":{"Line":0}},{"line":21,"address":[3835616],"length":1,"stats":{"Line":0}},{"line":22,"address":[3835724,3836121,3836315],"length":1,"stats":{"Line":0}},{"line":23,"address":[3836225],"length":1,"stats":{"Line":0}},{"line":24,"address":[3836289],"length":1,"stats":{"Line":0}},{"line":25,"address":[3836297,3837015],"length":1,"stats":{"Line":0}},{"line":26,"address":[3836468,3836388],"length":1,"stats":{"Line":0}},{"line":27,"address":[3836500,3836833],"length":1,"stats":{"Line":0}},{"line":28,"address":[3836653,3836874],"length":1,"stats":{"Line":0}},{"line":29,"address":[3836999],"length":1,"stats":{"Line":0}},{"line":31,"address":[3837024,3836348],"length":1,"stats":{"Line":0}},{"line":32,"address":[3837358,3837468,3837053],"length":1,"stats":{"Line":0}},{"line":34,"address":[3835819,3837732,3837868],"length":1,"stats":{"Line":0}},{"line":35,"address":[3837928,3838112,3835891],"length":1,"stats":{"Line":0}},{"line":36,"address":[3838172,3835985,3838296],"length":1,"stats":{"Line":0}},{"line":37,"address":[3838356,3838492,3836057],"length":1,"stats":{"Line":0}},{"line":41,"address":[3838646,3838910,3839058,3835584],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":21},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","from_client","mod.rs"],"content":"mod req_auth_gg;\nmod req_auth_login;\nmod req_server_list;\nmod request_gs_login;\n\npub use self::{\n    req_auth_gg::RequestAuthGG, req_auth_login::RequestAuthLogin,req_auth_login::RequestAuthCMDLogin,\n    req_server_list::RequestServerList, request_gs_login::RequestGSLogin,\n};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","from_client","req_auth_gg.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packet::to_client::AuthGG;\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::{PlayerLoginFail, PlayerLoginFailReasons, ReadablePacket};\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::PacketSender;\n\n#[derive(Clone, Debug)]\npub struct RequestAuthGG {\n    pub session_id: i32,\n    ///unused data from the packet\n    _data1: i32,\n    _data2: i32,\n    _data3: i32,\n    _data4: i32,\n}\n\nimpl ReadablePacket for RequestAuthGG {\n    const PACKET_ID: u8 = 0x07;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        if buffer.get_remaining_length() \u003e 20 {\n            let session_id = buffer.read_i32()?;\n            let data1 = buffer.read_i32()?;\n            let data2 = buffer.read_i32()?;\n            let data3 = buffer.read_i32()?;\n            let data4 = buffer.read_i32()?;\n            return Ok(Self {\n                session_id,\n                _data1: data1,\n                _data2: data2,\n                _data3: data3,\n                _data4: data4,\n            });\n        }\n        bail!(\"Not enough data to read packet\");\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for RequestAuthGG {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, ch: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        if self.session_id != ch.get_session_id() {\n            ch.send_packet(Box::new(PlayerLoginFail::new(\n                PlayerLoginFailReasons::ReasonAccessFailed,\n            )?))\n            .await?;\n            bail!(format!(\"Wrong session id {}\", self.session_id));\n        }\n        ch.send_packet(Box::new(AuthGG::new(ch.get_session_id())))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":24,"address":[4030064],"length":1,"stats":{"Line":0}},{"line":25,"address":[4030097],"length":1,"stats":{"Line":0}},{"line":26,"address":[4030108],"length":1,"stats":{"Line":0}},{"line":27,"address":[4030244,4030187,4030308],"length":1,"stats":{"Line":0}},{"line":28,"address":[4030259,4030335,4030405],"length":1,"stats":{"Line":0}},{"line":29,"address":[4030435,4030511,4030350],"length":1,"stats":{"Line":0}},{"line":30,"address":[4030625,4030450,4030544],"length":1,"stats":{"Line":0}},{"line":31,"address":[4030679,4030779,4030561],"length":1,"stats":{"Line":0}},{"line":32,"address":[4030693],"length":1,"stats":{"Line":0}},{"line":40,"address":[4030125],"length":1,"stats":{"Line":0}},{"line":47,"address":[4031217],"length":1,"stats":{"Line":0}},{"line":48,"address":[5076024],"length":1,"stats":{"Line":0}},{"line":49,"address":[5076895,5077144,5077318,5076475,5077714,5076115,5076844,5076735,5077051,5076143],"length":1,"stats":{"Line":0}},{"line":50,"address":[5076135],"length":1,"stats":{"Line":0}},{"line":52,"address":[4470616,4470497,4470532],"length":1,"stats":{"Line":0}},{"line":53,"address":[5077465,5077202,5077344],"length":1,"stats":{"Line":0}},{"line":55,"address":[5076081,5076188,5076341,5077934,5078041,5077841,5076426],"length":1,"stats":{"Line":0}},{"line":56,"address":[4470513],"length":1,"stats":{"Line":0}},{"line":57,"address":[5077992],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","from_client","req_auth_login.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::dto::player;\nuse crate::packet::to_client::LoginOk;\nuse crate::packet::to_client::ServerList;\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse entities::entities::user;\nuse l2_core::hash_password;\nuse l2_core::shared_packets::common::{PlayerLoginFail, PlayerLoginFailReasons, ReadablePacket};\nuse l2_core::str::Trim;\nuse l2_core::traits::handlers::{PacketHandler, PacketSender};\nuse sea_orm::{ActiveModelTrait, ActiveValue};\nuse std::fmt::Debug;\n\ntrait AuthRequest: Debug {\n    fn username(\u0026self) -\u003e \u0026str;\n    fn password(\u0026self) -\u003e \u0026str;\n    fn is_cmd_login(\u0026self) -\u003e bool;\n}\nimpl AuthRequest for RequestAuthLogin {\n    fn username(\u0026self) -\u003e \u0026str {\n        \u0026self.username\n    }\n\n    fn password(\u0026self) -\u003e \u0026str {\n        \u0026self.password\n    }\n\n    fn is_cmd_login(\u0026self) -\u003e bool {\n        self.is_cmd_login\n    }\n}\n\nimpl AuthRequest for RequestAuthCMDLogin {\n    fn username(\u0026self) -\u003e \u0026str {\n        \u0026self.username\n    }\n\n    fn password(\u0026self) -\u003e \u0026str {\n        \u0026self.password\n    }\n\n    fn is_cmd_login(\u0026self) -\u003e bool {\n        self.is_cmd_login\n    }\n}\n\n#[derive(Clone, Debug)]\n#[allow(unused)]\npub struct RequestAuthLogin {\n    pub username: String,\n    pub password: String,\n    is_new_auth: bool,\n    pub is_cmd_login: bool,\n}\n\n#[derive(Clone, Debug)]\n#[allow(unused)]\npub struct RequestAuthCMDLogin {\n    pub username: String,\n    pub password: String,\n    pub is_cmd_login: bool,\n}\n\nimpl ReadablePacket for RequestAuthCMDLogin {\n    const PACKET_ID: u8 = 0x0B;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let is_cmd_login = true;\n        let (username, password, _) = read_bytes(data, is_cmd_login)?;\n        Ok(Self {\n            username,\n            password,\n            is_cmd_login,\n        })\n    }\n}\n\nimpl ReadablePacket for RequestAuthLogin {\n    const PACKET_ID: u8 = 0x00;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let is_cmd_login = false;\n        let (username, password, is_new_auth) = read_bytes(data, is_cmd_login)?;\n        Ok(Self {\n            username,\n            password,\n            is_new_auth,\n            is_cmd_login,\n        })\n    }\n}\n#[async_trait]\nimpl\u003cT: AuthRequest + Send + Sync + 'static\u003e HandleablePacket for T {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, ch: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let cfg = ch.get_controller().get_config();\n        let show_license = cfg.client.show_licence;\n        let pool = ch.get_db_pool();\n        let user_option = user::Model::find_some_by_username(pool, self.username()).await?;\n        if self.is_cmd_login() \u0026\u0026 !cfg.client.enable_cmdline_login {\n            bail!(\"cmd_login disabled\");\n        }\n        if let Some(user) = user_option {\n            if !user.verify_password(self.password()).await {\n                ch.send_packet(Box::new(PlayerLoginFail::new(\n                    PlayerLoginFailReasons::ReasonUserOrPassWrong,\n                )?))\n                .await?;\n                bail!(format!(\"Login Fail, tried user: {}\", self.username()));\n            }\n        } else if cfg.client.auto_create_accounts {\n            let password_hash = hash_password(self.password()).await?;\n            let user_record = user::ActiveModel {\n                id: ActiveValue::NotSet,\n                username: ActiveValue::Set(self.username().to_string()),\n                password: ActiveValue::Set(password_hash),\n                access_level: ActiveValue::Set(0),\n                ban_duration: ActiveValue::NotSet,\n                ban_ip: ActiveValue::NotSet,\n            };\n            user_record.save(pool).await?;\n        }\n\n        ch.account_name = Some(self.username().to_string());\n        let player_info = player::Info {\n            is_authed: true,\n            session: Some(ch.get_session_key().clone()),\n            account_name: self.username().to_string(),\n            ..Default::default()\n        };\n\n        let lc = ch.get_controller();\n        if let Err(err) = lc.on_player_login(player_info).await {\n            let err_msg = format!(\"Player login failed: {err:?}\");\n            ch.send_packet(Box::new(PlayerLoginFail::new(err)?)).await?;\n            bail!(err_msg);\n        }\n\n        if show_license {\n            ch.send_packet(Box::new(LoginOk::new(ch.get_session_key())))\n                .await?;\n        } else {\n            let s_list = ServerList::new(ch, self.username());\n            ch.send_packet(Box::new(s_list)).await?;\n        }\n        Ok(())\n    }\n}\n\npub fn read_bytes(data: \u0026[u8], is_cmd_login: bool) -\u003e anyhow::Result\u003c(String, String, bool)\u003e {\n    let mut is_new_auth = false;\n    if data.len() \u003e= 256 {\n        is_new_auth = true;\n    }\n    let username: String;\n    let password: String;\n    if is_cmd_login {\n        if data.len() \u003c 128 {\n            bail!(\"Invalid length fot CMD login\");\n        }\n        username = String::from_utf8_lossy(\u0026data[0x44..0x44 + 14])\n            .trim_all()\n            .to_string();\n        password = String::from_utf8_lossy(\u0026data[0x64..0x64 + 16])\n            .trim_all()\n            .to_string();\n    } else if is_new_auth {\n        let part1 = String::from_utf8_lossy(\u0026data[0x4E..0x4E + 50]);\n        let part2 = String::from_utf8_lossy(\u0026data[0xCE..0xCE + 14]);\n        username = format!(\"{}{}\", part1.trim_all(), part2.trim_all());\n        password = String::from_utf8_lossy(\u0026data[0xDC..0xDC + 16])\n            .trim_all()\n            .to_string();\n    } else {\n        username = String::from_utf8_lossy(\u0026data[0x5E..0x5E + 14])\n            .trim_all()\n            .to_string();\n        password = String::from_utf8_lossy(\u0026data[0x6C..0x6C + 16])\n            .trim_all()\n            .to_string();\n    }\n    Ok((username, password, is_new_auth))\n}\n","traces":[{"line":22,"address":[4578608],"length":1,"stats":{"Line":0}},{"line":23,"address":[4578613],"length":1,"stats":{"Line":0}},{"line":26,"address":[4578624],"length":1,"stats":{"Line":0}},{"line":27,"address":[4578629],"length":1,"stats":{"Line":0}},{"line":30,"address":[4578640],"length":1,"stats":{"Line":0}},{"line":31,"address":[4578645],"length":1,"stats":{"Line":0}},{"line":36,"address":[4578656],"length":1,"stats":{"Line":0}},{"line":37,"address":[4578661],"length":1,"stats":{"Line":0}},{"line":40,"address":[4578672],"length":1,"stats":{"Line":0}},{"line":41,"address":[4578677],"length":1,"stats":{"Line":0}},{"line":44,"address":[4578688],"length":1,"stats":{"Line":0}},{"line":45,"address":[4578693],"length":1,"stats":{"Line":0}},{"line":70,"address":[4578704],"length":1,"stats":{"Line":0}},{"line":71,"address":[4578737],"length":1,"stats":{"Line":0}},{"line":72,"address":[4578745,4579034],"length":1,"stats":{"Line":0}},{"line":73,"address":[4578923],"length":1,"stats":{"Line":0}},{"line":85,"address":[4579072],"length":1,"stats":{"Line":0}},{"line":86,"address":[4579105],"length":1,"stats":{"Line":0}},{"line":87,"address":[4579427,4579113],"length":1,"stats":{"Line":0}},{"line":88,"address":[4579307],"length":1,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[4472626],"length":1,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[4472647],"length":1,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[4022460,4022233,4022172,4022643,4022307,4019154],"length":1,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[4024788,4021777,4022281,4020920],"length":1,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[4021167,4024817],"length":1,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[4019217,4025672,4025992],"length":1,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[4028216,4028350],"length":1,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[4579472,4581208,4584674],"length":1,"stats":{"Line":0}},{"line":155,"address":[4579545],"length":1,"stats":{"Line":0}},{"line":156,"address":[4579569,4579599],"length":1,"stats":{"Line":0}},{"line":157,"address":[4579591],"length":1,"stats":{"Line":0}},{"line":161,"address":[4579585],"length":1,"stats":{"Line":0}},{"line":162,"address":[4579621],"length":1,"stats":{"Line":0}},{"line":163,"address":[4583412,4584575],"length":1,"stats":{"Line":0}},{"line":165,"address":[4583887,4583384,4583754],"length":1,"stats":{"Line":0}},{"line":167,"address":[4583833,4583973],"length":1,"stats":{"Line":0}},{"line":168,"address":[4584310,4584443,4583992],"length":1,"stats":{"Line":0}},{"line":170,"address":[4584529,4584389],"length":1,"stats":{"Line":0}},{"line":171,"address":[4579601],"length":1,"stats":{"Line":0}},{"line":172,"address":[4579666,4581536],"length":1,"stats":{"Line":0}},{"line":173,"address":[4582026,4581592,4581945],"length":1,"stats":{"Line":0}},{"line":174,"address":[4582140,4582666,4582045,4582309,4582529],"length":1,"stats":{"Line":0}},{"line":175,"address":[4583075,4582722,4583226],"length":1,"stats":{"Line":0}},{"line":177,"address":[4583324,4583166],"length":1,"stats":{"Line":0}},{"line":179,"address":[4579638,4580207,4580093,4580016],"length":1,"stats":{"Line":0}},{"line":181,"address":[4580147,4580305],"length":1,"stats":{"Line":0}},{"line":182,"address":[4580324,4580669,4580820],"length":1,"stats":{"Line":0}},{"line":184,"address":[4580760,4580918],"length":1,"stats":{"Line":0}},{"line":186,"address":[4580945],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":75},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","from_client","req_server_list.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packet::to_client::ServerList;\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::{PlayerLoginFail, PlayerLoginFailReasons, ReadablePacket};\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::PacketSender;\n\n#[derive(Clone, Debug)]\n#[allow(unused)]\npub struct RequestServerList {\n    pub login_ok_1: i32,\n    pub login_ok_2: i32,\n}\n\nimpl ReadablePacket for RequestServerList {\n    const PACKET_ID: u8 = 0x05;\n    const EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            login_ok_1: buffer.read_i32()?,\n            login_ok_2: buffer.read_i32()?,\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for RequestServerList {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, ch: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        if let Some(ref acc_name) = ch.account_name {\n            ch.send_packet(Box::new(ServerList::new(ch, acc_name)))\n                .await?;\n            Ok(())\n        } else {\n            ch.send_packet(Box::new(PlayerLoginFail::new(\n                PlayerLoginFailReasons::ReasonUserOrPassWrong,\n            )?))\n            .await?;\n            bail!(format!(\"Login Fail, tried user: {:?}\", ch.account_name));\n        }\n    }\n}\n","traces":[{"line":21,"address":[4564464],"length":1,"stats":{"Line":0}},{"line":22,"address":[4564491],"length":1,"stats":{"Line":0}},{"line":23,"address":[4564655],"length":1,"stats":{"Line":0}},{"line":24,"address":[4564502,4564608],"length":1,"stats":{"Line":0}},{"line":25,"address":[4564674,4564559,4564644],"length":1,"stats":{"Line":0}},{"line":33,"address":[4564897],"length":1,"stats":{"Line":0}},{"line":34,"address":[4736764],"length":1,"stats":{"Line":0}},{"line":35,"address":[4737131,4737943,4736978,4737850,4738050,4736837,4737216],"length":1,"stats":{"Line":0}},{"line":36,"address":[4474001],"length":1,"stats":{"Line":0}},{"line":37,"address":[4738001],"length":1,"stats":{"Line":0}},{"line":39,"address":[4738211,4737265,4737691,4738304,4736916,4738484,4736888,4738871,4737525,4737637],"length":1,"stats":{"Line":0}},{"line":40,"address":[4736908],"length":1,"stats":{"Line":0}},{"line":42,"address":[4474017,4474068],"length":1,"stats":{"Line":0}},{"line":43,"address":[4738510,4738362,4738631],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","from_client","request_gs_login.rs"],"content":"use crate::client_thread::ClientHandler;\nuse crate::packet::to_client::PlayOk;\nuse crate::packet::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::common::ReadablePacket;\nuse l2_core::shared_packets::read::ReadablePacketBuffer;\nuse l2_core::traits::handlers::PacketSender;\n\n#[derive(Clone, Debug)]\n#[allow(unused)]\npub struct RequestGSLogin {\n    pub s_key_1: i32,\n    pub s_key_2: i32,\n    pub server_id: u8,\n}\n\nimpl ReadablePacket for RequestGSLogin {\n    const PACKET_ID: u8 = 0x02;\nconst EX_PACKET_ID: Option\u003cu16\u003e = None;\n\n    fn read(data: \u0026[u8]) -\u003e anyhow::Result\u003cSelf\u003e {\n        let mut buffer = ReadablePacketBuffer::new(data);\n        Ok(Self {\n            s_key_1: buffer.read_i32()?,\n            s_key_2: buffer.read_i32()?,\n            server_id: buffer.read_byte()?,\n        })\n    }\n}\n\n#[async_trait]\nimpl HandleablePacket for RequestGSLogin {\n    type HandlerType = ClientHandler;\n    async fn handle(\u0026self, ch: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        ch.check_session(self.s_key_1, self.s_key_2)?;\n        ch.send_packet(Box::new(PlayOk::new(ch.get_session_key())?))\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":21,"address":[4839408],"length":1,"stats":{"Line":0}},{"line":22,"address":[4839441],"length":1,"stats":{"Line":0}},{"line":23,"address":[4839721],"length":1,"stats":{"Line":0}},{"line":24,"address":[4839558,4839452],"length":1,"stats":{"Line":0}},{"line":25,"address":[4839509,4839668,4839588],"length":1,"stats":{"Line":0}},{"line":26,"address":[4839707,4839602,4839762],"length":1,"stats":{"Line":0}},{"line":34,"address":[4790453,4789206,4789357,4789088,4790071,4789119],"length":1,"stats":{"Line":0}},{"line":35,"address":[4790058,4789455,4789582],"length":1,"stats":{"Line":0}},{"line":36,"address":[4790214,4789878,4790307,4789553,4789637,4790040,4789992,4790414],"length":1,"stats":{"Line":0}},{"line":37,"address":[4473794,4473686],"length":1,"stats":{"Line":0}},{"line":38,"address":[4790365],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","gs_factory.rs"],"content":"use anyhow::bail;\nuse crate::gs_thread::GSHandler;\nuse l2_core::shared_packets::{\n    common::ReadablePacket,\n    gs_2_ls::{\n        BlowFish, ChangeAccessLevel, ChangePassword, GSStatusUpdate, PlayerAuthRequest,\n        PlayerInGame, PlayerLogout, PlayerTracert, ReplyChars, RequestAuthGS, RequestTempBan,\n    },\n};\nuse crate::packet::HandleablePacket;\n\npub fn build_gs_packet(data: \u0026[u8]) -\u003e anyhow::Result\u003cBox\u003cdyn HandleablePacket\u003cHandlerType = GSHandler\u003e\u003e\u003e {\n    if data.is_empty() {\n        bail!(\"GSFactory: data too short\");\n    }\n    match data[0] {\n        BlowFish::PACKET_ID =\u003e Ok(Box::new(BlowFish::read(data)?)),\n        RequestAuthGS::PACKET_ID =\u003e Ok(Box::new(RequestAuthGS::read(data)?)),\n        PlayerInGame::PACKET_ID =\u003e Ok(Box::new(PlayerInGame::read(data)?)),\n        PlayerLogout::PACKET_ID =\u003e Ok(Box::new(PlayerLogout::read(data)?)),\n        ChangeAccessLevel::PACKET_ID =\u003e Ok(Box::new(ChangeAccessLevel::read(data)?)),\n        PlayerAuthRequest::PACKET_ID =\u003e Ok(Box::new(PlayerAuthRequest::read(data)?)),\n        GSStatusUpdate::PACKET_ID =\u003e Ok(Box::new(GSStatusUpdate::read(data)?)),\n        PlayerTracert::PACKET_ID =\u003e Ok(Box::new(PlayerTracert::read(data)?)),\n        ReplyChars::PACKET_ID =\u003e Ok(Box::new(ReplyChars::read(data)?)),\n        RequestTempBan::PACKET_ID =\u003e Ok(Box::new(RequestTempBan::read(data)?)),\n        ChangePassword::PACKET_ID =\u003e Ok(Box::new(ChangePassword::read(data)?)),\n        // 0x0B =\u003e Some(), //cmd login\n        // 0x02 =\u003e Some(LoginClientOpcodes::RequestServerLogin),\n        // 0x0E =\u003e Some(LoginClientOpcodes::RequestPiAgreementCheck),\n        // 0x0F =\u003e Some(LoginClientOpcodes::RequestPiAgreement),\n        _ =\u003e {\n            bail!(\"Unknown GS packet ID:0x{:02X}\", data[0]);\n        }\n    }\n}\n","traces":[{"line":12,"address":[3615440],"length":1,"stats":{"Line":0}},{"line":13,"address":[3615517],"length":1,"stats":{"Line":0}},{"line":14,"address":[3615544],"length":1,"stats":{"Line":0}},{"line":16,"address":[3615621,3615535],"length":1,"stats":{"Line":0}},{"line":17,"address":[3615724,3616743,3616931],"length":1,"stats":{"Line":0}},{"line":18,"address":[3617219,3615819,3616999],"length":1,"stats":{"Line":0}},{"line":19,"address":[3617279,3617467,3615914],"length":1,"stats":{"Line":0}},{"line":20,"address":[3617527,3617715,3616009],"length":1,"stats":{"Line":0}},{"line":21,"address":[3617955,3616104,3617775],"length":1,"stats":{"Line":0}},{"line":22,"address":[3616199,3618219,3618015],"length":1,"stats":{"Line":0}},{"line":23,"address":[3618451,3616294,3618279],"length":1,"stats":{"Line":0}},{"line":24,"address":[3618544,3616379,3618670],"length":1,"stats":{"Line":0}},{"line":25,"address":[3618950,3616474,3618730],"length":1,"stats":{"Line":0}},{"line":26,"address":[3619198,3619010,3616569],"length":1,"stats":{"Line":0}},{"line":27,"address":[3616664,3619258,3619510],"length":1,"stats":{"Line":0}},{"line":33,"address":[3615692,3620076,3619928,3619664],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_blowfish.rs"],"content":"use crate::gs_thread::{enums, GSHandler};\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::{\n    common::{PlayerLoginFail, PlayerLoginFailReasons},\n    gs_2_ls::BlowFish,\n};\nuse l2_core::traits::handlers::PacketSender;\n\n#[async_trait]\nimpl HandleablePacket for BlowFish {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let mut key = self.encrypted_key.clone();\n        if let Ok(mut decrypted) = gs.decrypt_rsa(\u0026mut key) {\n            // there are nulls before the key we must remove them\n            if let Some(index) = decrypted.iter().position(|\u0026x| x != 0) {\n                decrypted.drain(..index);\n            }\n            gs.set_connection_state(\u0026enums::GS::BfConnected).await?;\n            gs.set_blowfish_key(\u0026decrypted);\n        } else {\n            gs.send_packet(Box::new(PlayerLoginFail::new(\n                PlayerLoginFailReasons::ReasonNotAuthed,\n            )?))\n            .await?;\n            bail!(\"Unable to decrypt GS blowfish key\");\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[3889638,3887375,3887643,3887474,3889051,3887344],"length":1,"stats":{"Line":0}},{"line":15,"address":[3887710],"length":1,"stats":{"Line":0}},{"line":16,"address":[3887736,3887863],"length":1,"stats":{"Line":0}},{"line":18,"address":[3888130,3890208,3890218,3887969],"length":1,"stats":{"Line":0}},{"line":19,"address":[3888279,3888344],"length":1,"stats":{"Line":0}},{"line":21,"address":[3888310,3889083,3889604,3888379,3889390,3887504],"length":1,"stats":{"Line":0}},{"line":22,"address":[3889447,3889348],"length":1,"stats":{"Line":0}},{"line":24,"address":[3888941,3888008,3888551,3889758,3888811,3889851,3888036,3889951,3890025,3888995],"length":1,"stats":{"Line":0}},{"line":25,"address":[3888028],"length":1,"stats":{"Line":0}},{"line":27,"address":[3889647,3888902,3888957,3889779,3889935,3887525],"length":1,"stats":{"Line":0}},{"line":28,"address":[3889909,3889982],"length":1,"stats":{"Line":0}},{"line":30,"address":[3889528],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_change_al.rs"],"content":"use entities::entities::user;\nuse l2_core::{\n    shared_packets::gs_2_ls::ChangeAccessLevel,\n    traits::handlers::PacketHandler,\n};\nuse crate::gs_thread::GSHandler;\nuse async_trait::async_trait;\nuse sea_orm::{ActiveModelTrait, ActiveValue};\nuse tracing::{info, instrument};\nuse crate::packet::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for ChangeAccessLevel {\n    type HandlerType = GSHandler;\n\n    #[instrument(skip(self, gs))]\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let db_pool = gs.get_db_pool();\n        //ignore error updating an account\n        let user_model = user::Model::find_by_username(db_pool, \u0026self.account).await?;\n        let user_id = user_model.id;\n        let mut active_model: user::ActiveModel = user_model.into();\n        active_model.access_level = ActiveValue::Set(self.level);\n        active_model.save(db_pool).await?;\n        info!(\"[change access level] OK {user_id:?}\");\n        Ok(())\n    }\n}\n","traces":[{"line":17,"address":[3775872,3776517,3774648,3776186,3776017,3775918,3777595],"length":1,"stats":{"Line":0}},{"line":18,"address":[3776248],"length":1,"stats":{"Line":0}},{"line":20,"address":[3776415,3776047,3776306,3776549,3777230,3777570],"length":1,"stats":{"Line":0}},{"line":21,"address":[3777070],"length":1,"stats":{"Line":0}},{"line":22,"address":[3777088],"length":1,"stats":{"Line":0}},{"line":23,"address":[3777320],"length":1,"stats":{"Line":0}},{"line":24,"address":[3777416,3777604,3780843,3776068],"length":1,"stats":{"Line":0}},{"line":25,"address":[3779495,3779914,3780939,3779319,3778631,3778215,3779593,3779850,3780586,3779112,3778960,3781096,3778830,3780408,3780093],"length":1,"stats":{"Line":0}},{"line":26,"address":[3779267],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":9},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_change_password.rs"],"content":"use crate::gs_thread::GSHandler;\nuse async_trait::async_trait;\nuse l2_core::shared_packets::gs_2_ls::ChangePassword;\nuse crate::packet::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for ChangePassword {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        todo!()\n    }\n}\n","traces":[{"line":9,"address":[3805504,3805653,3805733,3805571,3805518],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_reply_chars.rs"],"content":"use async_trait::async_trait;\n\nuse crate::gs_thread::GSHandler;\nuse crate::packet::HandleablePacket;\nuse l2_core::shared_packets::{common::PacketType, gs_2_ls::ReplyChars};\nuse l2_core::traits::handlers::PacketHandler;\n\n#[async_trait]\nimpl HandleablePacket for ReplyChars {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let controller = gs.get_controller();\n        controller.message_broker.respond_to_message(\n            gs.server_id,\n            \u0026self.account_name,\n            PacketType::ReplyChars(self.clone()),\n        );\n        Ok(())\n    }\n}\n","traces":[{"line":11,"address":[3803118],"length":1,"stats":{"Line":0}},{"line":12,"address":[3886132],"length":1,"stats":{"Line":0}},{"line":13,"address":[3886410,3886166],"length":1,"stats":{"Line":0}},{"line":14,"address":[3886207],"length":1,"stats":{"Line":0}},{"line":15,"address":[3886236],"length":1,"stats":{"Line":0}},{"line":16,"address":[3886285],"length":1,"stats":{"Line":0}},{"line":18,"address":[3886434],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_request_auth.rs"],"content":"use crate::packet::HandleablePacket;\nuse crate::{\n    dto::game_server::GSInfo,\n    gs_thread::{enums, GSHandler},\n};\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::constants::try_get_server_name_by_id;\nuse l2_core::traits::handlers::PacketSender;\nuse l2_core::{\n    shared_packets::{\n        common::GSLoginFail,\n        gs_2_ls::RequestAuthGS,\n        ls_2_gs::AuthGS,\n    },\n    traits::handlers::PacketHandler,\n};\n\n#[async_trait]\nimpl HandleablePacket for RequestAuthGS {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let gsi = GSInfo::new(\n            self.desired_id,\n            self.accept_alternative_id,\n            self.host_reserved,\n            self.port,\n            true,\n            0,\n            true,\n            0,\n            0,\n            false,\n            self.max_players,\n            self.hex_id.clone(),\n            \u0026self.hosts,\n        )?;\n        match gs.get_controller().register_gs(gsi) {\n            Ok(desired_id) =\u003e {\n                gs.set_connection_state(\u0026enums::GS::Authed).await?;\n                let server_name = try_get_server_name_by_id(desired_id)?;\n                gs.server_id = Some(desired_id);\n                gs.send_packet(Box::new(AuthGS::new(desired_id, server_name)))\n                    .await\n            }\n            Err(e) =\u003e {\n                let err_msg = format!(\n                    \"Failed to register game server with id {:}, fail reason {:?}\",\n                    self.desired_id, e\n                );\n                gs.send_packet(Box::new(GSLoginFail::new(e)?)).await?;\n                bail!(err_msg)\n            }\n        }\n    }\n}\n","traces":[{"line":22,"address":[5049375,5051968,5049502,5049344,5049692],"length":1,"stats":{"Line":0}},{"line":24,"address":[5049766],"length":1,"stats":{"Line":0}},{"line":25,"address":[5049776],"length":1,"stats":{"Line":0}},{"line":26,"address":[5049786],"length":1,"stats":{"Line":0}},{"line":27,"address":[5049796],"length":1,"stats":{"Line":0}},{"line":34,"address":[5049808],"length":1,"stats":{"Line":0}},{"line":35,"address":[5049818,5049887],"length":1,"stats":{"Line":0}},{"line":36,"address":[5049895],"length":1,"stats":{"Line":0}},{"line":38,"address":[5050575,5050418],"length":1,"stats":{"Line":0}},{"line":39,"address":[5050768],"length":1,"stats":{"Line":0}},{"line":40,"address":[4488399],"length":1,"stats":{"Line":0}},{"line":41,"address":[5052588,5052922,5052373,5052298],"length":1,"stats":{"Line":0}},{"line":42,"address":[5052471],"length":1,"stats":{"Line":0}},{"line":43,"address":[5052783,5052868,5052538,5053091],"length":1,"stats":{"Line":0}},{"line":44,"address":[4488414],"length":1,"stats":{"Line":0}},{"line":46,"address":[5050828],"length":1,"stats":{"Line":0}},{"line":47,"address":[5050846,5051063,5051161,5051294],"length":1,"stats":{"Line":0}},{"line":51,"address":[4488519,4488658,4488429],"length":1,"stats":{"Line":0}},{"line":52,"address":[5053605,5053480],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_request_temp_ban.rs"],"content":"use entities::entities::user;\nuse l2_core::{\n    shared_packets::gs_2_ls::RequestTempBan,\n    traits::handlers::PacketHandler,\n};\nuse crate::{\n    gs_thread::GSHandler,\n};\nuse async_trait::async_trait;\nuse sea_orm::{ActiveModelTrait, ActiveValue};\nuse tracing::{info, instrument};\nuse crate::packet::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for RequestTempBan {\n    type HandlerType = GSHandler;\n    #[instrument(skip(self, gs))]\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let db_pool = gs.get_db_pool();\n        //ignore error updating an account\n        let user_model = user::Model::find_by_username(db_pool, \u0026self.account).await?;\n        let mut active_record: user::ActiveModel = user_model.into();\n        active_record.ban_duration = ActiveValue::Set(Some(self.ban_duration));\n        active_record.ban_ip = ActiveValue::Set(Some(self.ip.clone()));\n        active_record.save(db_pool).await?;\n        info!(\"[Account banned] OK: {:?}\", self.account);\n        let lc = gs.get_controller();\n        lc.update_ip_ban_list(\u0026self.ip, self.ban_duration);\n        lc.remove_player(\u0026self.account);\n        Ok(())\n    }\n}\n","traces":[{"line":18,"address":[3634937,3633544,3634768,3635437,3636959,3635106,3634814],"length":1,"stats":{"Line":0}},{"line":19,"address":[3635168],"length":1,"stats":{"Line":0}},{"line":21,"address":[3634967,3635226,3636934,3635335,3635469,3636136],"length":1,"stats":{"Line":0}},{"line":22,"address":[3636250,3635990],"length":1,"stats":{"Line":0}},{"line":23,"address":[3636274],"length":1,"stats":{"Line":0}},{"line":24,"address":[3636470,3636391],"length":1,"stats":{"Line":0}},{"line":25,"address":[3636708,3634988,3636968,3640476],"length":1,"stats":{"Line":0}},{"line":26,"address":[3640872,3639247,3638948,3638001,3639311,3638674,3639982,3638330,3639489,3640715,3638482,3637585,3639804,3638850,3638200],"length":1,"stats":{"Line":0}},{"line":27,"address":[3640240,3638637],"length":1,"stats":{"Line":0}},{"line":28,"address":[3640248],"length":1,"stats":{"Line":0}},{"line":29,"address":[3640337],"length":1,"stats":{"Line":0}},{"line":30,"address":[3640399],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","gs_status.rs"],"content":"use crate::gs_thread::GSHandler;\nuse crate::packet::HandleablePacket;\nuse anyhow::bail;\nuse async_trait::async_trait;\nuse l2_core::constants::try_get_server_name_by_id;\nuse l2_core::traits::handlers::PacketSender;\nuse l2_core::{\n    shared_packets::{\n        common::{PlayerLoginFail, PlayerLoginFailReasons},\n        gs_2_ls::GSStatusUpdate,\n    },\n    traits::handlers::PacketHandler,\n};\nuse std::sync::Arc;\nuse tracing::{info, instrument};\n\n#[async_trait]\nimpl HandleablePacket for GSStatusUpdate {\n    type HandlerType = GSHandler;\n\n    #[instrument(skip_all)]\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let lc = gs.get_controller();\n        let mut updated = false;\n        if let Some(server_id) = gs.server_id {\n            updated = lc.with_gs(server_id, |gsi| {\n                gsi.set_max_players(self.max_players);\n                gsi.set_age_limit(self.server_age);\n                gsi.use_square_brackets(self.use_square_brackets);\n                gsi.set_server_type(self.server_type);\n                gsi.set_server_status(self.status as i32);\n            });\n            info!(\n                \"Game server registered: {:}({server_id})\",\n                try_get_server_name_by_id(server_id)?\n            );\n        }\n        if !updated {\n            gs.send_packet(Box::new(PlayerLoginFail::new(\n                PlayerLoginFailReasons::ReasonAccessFailed,\n            )?))\n            .await?;\n            bail!(\"Server was not found, GS id {:?}\", gs.server_id);\n        }\n        lc.message_broker\n            .register_packet_handler(gs.try_get_server_id()?, Arc::new(gs.clone()));\n        Ok(())\n    }\n}\n","traces":[{"line":22,"address":[3899677,3894677,3894544,3894828,3897882,3893218,3894590],"length":1,"stats":{"Line":0}},{"line":23,"address":[3894934],"length":1,"stats":{"Line":0}},{"line":24,"address":[3894977],"length":1,"stats":{"Line":0}},{"line":25,"address":[3894985],"length":1,"stats":{"Line":0}},{"line":26,"address":[3900304,3895047,3895097],"length":1,"stats":{"Line":0}},{"line":27,"address":[3900341],"length":1,"stats":{"Line":0}},{"line":28,"address":[3900362],"length":1,"stats":{"Line":0}},{"line":29,"address":[3900384],"length":1,"stats":{"Line":0}},{"line":30,"address":[3900410],"length":1,"stats":{"Line":0}},{"line":31,"address":[3900431],"length":1,"stats":{"Line":0}},{"line":33,"address":[3898381,3897899,3898874,3897398,3897097,3898080],"length":1,"stats":{"Line":0}},{"line":38,"address":[3895062],"length":1,"stats":{"Line":0}},{"line":39,"address":[3900285,3898968,3899379,3900093,3899328,3899820,3899228,3899913,3898915,3898887],"length":1,"stats":{"Line":0}},{"line":40,"address":[3898907],"length":1,"stats":{"Line":0}},{"line":42,"address":[3900077,3899301,3899344,3899709,3894707,3899841],"length":1,"stats":{"Line":0}},{"line":43,"address":[3899971,3900119,3900240],"length":1,"stats":{"Line":0}},{"line":45,"address":[3899400,3898950,3899609],"length":1,"stats":{"Line":0}},{"line":46,"address":[3899419,3899664],"length":1,"stats":{"Line":0}},{"line":47,"address":[3899626],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","mod.rs"],"content":"mod gs_change_al;\nmod gs_request_auth;\nmod gs_blowfish;\nmod gs_change_password;\nmod player_auth_request;\nmod gs_status;\nmod player_in_game;\nmod player_logout;\nmod player_tracert;\nmod gs_reply_chars;\nmod gs_request_temp_ban;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","player_auth_request.rs"],"content":"use crate::gs_thread::GSHandler;\nuse crate::packet::HandleablePacket;\nuse async_trait::async_trait;\nuse l2_core::traits::handlers::PacketSender;\nuse l2_core::{\n    shared_packets::{\n        gs_2_ls::PlayerAuthRequest,\n        ls_2_gs::PlayerAuthResponse,\n    },\n    traits::handlers::PacketHandler,\n};\n\n#[async_trait]\nimpl HandleablePacket for PlayerAuthRequest {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let lc = gs.get_controller();\n        let show_license = lc.get_config().client.show_licence;\n        let operation_ok = lc.with_player(\u0026self.account_name, |pl| {\n            if let Some(session) = \u0026pl.session {\n                if session.equals(\u0026self.session, show_license) {\n                    pl.game_server = gs.server_id;\n                    return true;\n                }\n            }\n            false // operation wasn't successful\n        });\n        gs.send_packet(Box::new(PlayerAuthResponse::new(\n            \u0026self.account_name,\n            operation_ok,\n        )))\n        .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[3652126],"length":1,"stats":{"Line":0}},{"line":17,"address":[4565432],"length":1,"stats":{"Line":0}},{"line":18,"address":[4565475],"length":1,"stats":{"Line":0}},{"line":19,"address":[4565549,4566416],"length":1,"stats":{"Line":0}},{"line":20,"address":[4566435],"length":1,"stats":{"Line":0}},{"line":21,"address":[4566475],"length":1,"stats":{"Line":0}},{"line":22,"address":[4566520],"length":1,"stats":{"Line":0}},{"line":23,"address":[4566538],"length":1,"stats":{"Line":0}},{"line":26,"address":[4566503],"length":1,"stats":{"Line":0}},{"line":28,"address":[4565758,4566248,4566159,4566355,4565710,4565982,4565921],"length":1,"stats":{"Line":0}},{"line":29,"address":[4565727],"length":1,"stats":{"Line":0}},{"line":32,"address":[4495126],"length":1,"stats":{"Line":0}},{"line":33,"address":[4566306],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":13},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","player_in_game.rs"],"content":"use async_trait::async_trait;\n\nuse crate::gs_thread::GSHandler;\nuse crate::packet::HandleablePacket;\nuse l2_core::{shared_packets::gs_2_ls::PlayerInGame, traits::handlers::PacketHandler};\n\n#[async_trait]\nimpl HandleablePacket for PlayerInGame {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let lc = gs.get_controller();\n        lc.on_players_in_game(gs.try_get_server_id()?, \u0026self.accounts);\n        Ok(())\n    }\n}\n","traces":[{"line":10,"address":[3902068,3902227,3902550,3902121,3902048],"length":1,"stats":{"Line":0}},{"line":11,"address":[3902292],"length":1,"stats":{"Line":0}},{"line":12,"address":[3902326,3902537],"length":1,"stats":{"Line":0}},{"line":13,"address":[3902506],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","player_logout.rs"],"content":"use async_trait::async_trait;\n\nuse crate::gs_thread::GSHandler;\nuse crate::packet::HandleablePacket;\nuse l2_core::{shared_packets::gs_2_ls::PlayerLogout, traits::handlers::PacketHandler};\n\n#[async_trait]\nimpl HandleablePacket for PlayerLogout {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, gs: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        let lc = gs.get_controller();\n        lc.on_player_logout(\u0026self.acc);\n        Ok(())\n    }\n}\n","traces":[{"line":10,"address":[3839520,3839537,3839590,3839858,3839687],"length":1,"stats":{"Line":0}},{"line":11,"address":[3839746],"length":1,"stats":{"Line":0}},{"line":12,"address":[3839780],"length":1,"stats":{"Line":0}},{"line":13,"address":[3839834],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","handlable","player_tracert.rs"],"content":"use async_trait::async_trait;\n\nuse crate::gs_thread::GSHandler;\nuse l2_core::shared_packets::gs_2_ls::PlayerTracert;\nuse crate::packet::HandleablePacket;\n\n#[async_trait]\nimpl HandleablePacket for PlayerTracert {\n    type HandlerType = GSHandler;\n    async fn handle(\u0026self, _: \u0026mut Self::HandlerType) -\u003e anyhow::Result\u003c()\u003e {\n        Ok(())\n    }\n}\n","traces":[{"line":10,"address":[4018342,4018179,4018126,4018112,4018273],"length":1,"stats":{"Line":0}},{"line":11,"address":[4018321],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","mod.rs"],"content":"use std::fmt::Debug;\nuse async_trait::async_trait;\n\npub mod from_client;\npub mod handlable;\npub mod gs_factory;\npub mod cp_factory;\npub mod to_client;\n\n\n#[async_trait]\npub trait HandleablePacket: Debug + Send {\n    type HandlerType;\n    async fn handle(\n        \u0026self,\n        ch: \u0026mut Self::HandlerType,\n    ) -\u003e anyhow::Result\u003c()\u003e;\n}","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","auth_gg.rs"],"content":"use l2_core::shared_packets::{\n    common::LoginServerOpcodes,\n    write::SendablePacketBuffer,\n};\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, SendablePacketImpl)]\npub struct AuthGG {\n    pub buffer: SendablePacketBuffer,\n    session_id: i32,\n}\n\nimpl AuthGG {\n    pub fn new(session_id: i32) -\u003e AuthGG {\n        let mut gg = AuthGG {\n            buffer: SendablePacketBuffer::new(),\n            session_id,\n        };\n        let _ = gg.write_all();\n        gg\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_i8(LoginServerOpcodes::GgAuth as i8)?;\n        self.buffer.write_i32(self.session_id)?;\n        self.buffer.write_i32(0)?;\n        self.buffer.write_i32(0)?;\n        self.buffer.write_i32(0)?;\n        self.buffer.write_i32(0)?;\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[4361164,4360992],"length":1,"stats":{"Line":0}},{"line":16,"address":[4361016],"length":1,"stats":{"Line":0}},{"line":19,"address":[4361063,4361111],"length":1,"stats":{"Line":0}},{"line":20,"address":[4361136],"length":1,"stats":{"Line":0}},{"line":22,"address":[4361184],"length":1,"stats":{"Line":0}},{"line":23,"address":[4361345,4361200],"length":1,"stats":{"Line":0}},{"line":24,"address":[4361294,4361435],"length":1,"stats":{"Line":0}},{"line":25,"address":[4361385,4361522],"length":1,"stats":{"Line":0}},{"line":26,"address":[4361609,4361472],"length":1,"stats":{"Line":0}},{"line":27,"address":[4361693,4361559],"length":1,"stats":{"Line":0}},{"line":28,"address":[4361734,4361643],"length":1,"stats":{"Line":0}},{"line":29,"address":[4361723],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","init.rs"],"content":"use l2_core::shared_packets::{\n    common::LoginServerOpcodes,\n    write::SendablePacketBuffer,\n};\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, SendablePacketImpl)]\npub struct Init {\n    pub buffer: SendablePacketBuffer,\n    session_id: i32,\n    public_key: Vec\u003cu8\u003e,\n    blowfish_key: Vec\u003cu8\u003e,\n}\n\nimpl Init {\n    pub fn new(session_id: i32, public_key: Vec\u003cu8\u003e, blowfish_key: Vec\u003cu8\u003e) -\u003e anyhow::Result\u003cInit\u003e {\n        let mut init = Init {\n            buffer: SendablePacketBuffer::new(),\n            session_id,\n            public_key,\n            blowfish_key,\n        };\n        init.write_all()?;\n        Ok(init)\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_i8(LoginServerOpcodes::Init as i8)?;\n        self.buffer.write_i32(self.session_id)?; // session id\n        self.buffer.write_i32(0x0000_c621)?; // protocol revision\n        self.buffer.write_bytes(self.public_key.as_slice())?; // RSA Public Key\n                                                              // unk GG related?\n        self.buffer.write_i32(0x29DD_954E)?;\n        self.buffer.write_i32(0x77C3_9CFC)?;\n        #[allow(clippy::cast_possible_wrap)]\n        self.buffer.write_i32(0x97AD_B620_u32 as i32)?; // 0x97ADB620 this overflows i32\n        self.buffer.write_i32(0x07BD_E0F7)?;\n        self.buffer.write_bytes(self.blowfish_key.as_slice())?; // BlowFish key\n        self.buffer.write(0)?; // null termination ;)\n        Ok(())\n    }\n}\n","traces":[{"line":16,"address":[4642256,4642812,4642775],"length":1,"stats":{"Line":1}},{"line":18,"address":[4642326],"length":1,"stats":{"Line":1}},{"line":23,"address":[4642720,4642609,4642555],"length":1,"stats":{"Line":2}},{"line":24,"address":[4642667],"length":1,"stats":{"Line":1}},{"line":26,"address":[4642848],"length":1,"stats":{"Line":1}},{"line":27,"address":[4642868,4643031],"length":1,"stats":{"Line":1}},{"line":28,"address":[4642973,4643129],"length":1,"stats":{"Line":1}},{"line":29,"address":[4643072,4643244],"length":1,"stats":{"Line":1}},{"line":30,"address":[4643342,4643170],"length":1,"stats":{"Line":1}},{"line":32,"address":[4643285,4643440],"length":1,"stats":{"Line":1}},{"line":33,"address":[4643383,4643538],"length":1,"stats":{"Line":1}},{"line":35,"address":[4643481,4643636],"length":1,"stats":{"Line":1}},{"line":36,"address":[4643579,4643753],"length":1,"stats":{"Line":1}},{"line":37,"address":[4643848,4643677],"length":1,"stats":{"Line":1}},{"line":38,"address":[4643794,4643892],"length":1,"stats":{"Line":1}},{"line":39,"address":[4643881],"length":1,"stats":{"Line":1}}],"covered":16,"coverable":16},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","login_ok.rs"],"content":"use l2_core::session::SessionKey;\nuse l2_core::shared_packets::common::LoginServerOpcodes;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, SendablePacketImpl)]\npub struct LoginOk {\n    pub buffer: SendablePacketBuffer,\n    login_ok1: i32,\n    login_ok2: i32,\n}\n\nimpl LoginOk {\n    pub fn new(session_key: \u0026SessionKey) -\u003e LoginOk {\n        let mut login_ok = Self {\n            buffer: SendablePacketBuffer::new(),\n            login_ok1: session_key.login_ok1,\n            login_ok2: session_key.login_ok2,\n        };\n        // it is safe to unwrap result, as we know hoe many bytes are written\n        let _ = login_ok.write_all();\n        login_ok\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_i8(LoginServerOpcodes::LoginOk as i8)?;\n        self.buffer.write_i32(self.login_ok1)?;\n        self.buffer.write_i32(self.login_ok2)?;\n        self.buffer.write_i32(0x00)?;\n        self.buffer.write_i32(0x00)?;\n        self.buffer.write_i32(0x0000_03ea)?;\n        self.buffer.write_i32(0x00)?;\n        self.buffer.write_i32(0x00)?;\n        self.buffer.write_i32(0x00)?;\n        self.buffer.write_bytes(vec![0; 16].as_slice())?;\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[4876825,4876640],"length":1,"stats":{"Line":0}},{"line":16,"address":[4876666],"length":1,"stats":{"Line":0}},{"line":17,"address":[4876685],"length":1,"stats":{"Line":0}},{"line":18,"address":[4876688],"length":1,"stats":{"Line":0}},{"line":21,"address":[4876724,4876772],"length":1,"stats":{"Line":0}},{"line":22,"address":[4876797],"length":1,"stats":{"Line":0}},{"line":24,"address":[4876848,4878047],"length":1,"stats":{"Line":0}},{"line":25,"address":[4877015,4876868],"length":1,"stats":{"Line":0}},{"line":26,"address":[4876964,4877107],"length":1,"stats":{"Line":0}},{"line":27,"address":[4877056,4877198],"length":1,"stats":{"Line":0}},{"line":28,"address":[4877148,4877289],"length":1,"stats":{"Line":0}},{"line":29,"address":[4877383,4877239],"length":1,"stats":{"Line":0}},{"line":30,"address":[4877474,4877330],"length":1,"stats":{"Line":0}},{"line":31,"address":[4877424,4877571],"length":1,"stats":{"Line":0}},{"line":32,"address":[4877668,4877515],"length":1,"stats":{"Line":0}},{"line":33,"address":[4877612,4877769],"length":1,"stats":{"Line":0}},{"line":34,"address":[4877971,4877707,4878026,4877808],"length":1,"stats":{"Line":0}},{"line":35,"address":[4877960],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":18},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","mod.rs"],"content":"mod auth_gg;\nmod init;\nmod login_ok;\nmod play_ok;\nmod server_list;\n\npub use self::{\n    auth_gg::AuthGG, init::Init, login_ok::LoginOk, play_ok::PlayOk, server_list::ServerList,\n};\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","play_ok.rs"],"content":"use l2_core::session::SessionKey;\nuse l2_core::shared_packets::common::LoginServerOpcodes;\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct PlayOk {\n    pub buffer: SendablePacketBuffer,\n    play_ok1: i32,\n    play_ok2: i32,\n}\n\nimpl PlayOk {\n    pub fn new(session_key: \u0026SessionKey) -\u003e anyhow::Result\u003cPlayOk\u003e {\n        let mut login_ok = PlayOk {\n            buffer: SendablePacketBuffer::new(),\n            play_ok1: session_key.play_ok1,\n            play_ok2: session_key.play_ok2,\n        };\n        login_ok.write_all()?;\n        Ok(login_ok)\n    }\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        self.buffer.write_i8(LoginServerOpcodes::PlayOk as i8)?;\n        self.buffer.write_i32(self.play_ok1)?;\n        self.buffer.write_i32(self.play_ok2)?;\n        Ok(())\n    }\n}\n","traces":[{"line":14,"address":[4311520,4311827],"length":1,"stats":{"Line":0}},{"line":16,"address":[4311550],"length":1,"stats":{"Line":0}},{"line":17,"address":[4311569],"length":1,"stats":{"Line":0}},{"line":18,"address":[4311571],"length":1,"stats":{"Line":0}},{"line":20,"address":[4311661,4311607,4311772],"length":1,"stats":{"Line":0}},{"line":21,"address":[4311719],"length":1,"stats":{"Line":0}},{"line":23,"address":[4311856],"length":1,"stats":{"Line":0}},{"line":24,"address":[4311869,4312014],"length":1,"stats":{"Line":0}},{"line":25,"address":[4312099,4311963],"length":1,"stats":{"Line":0}},{"line":26,"address":[4312140,4312048],"length":1,"stats":{"Line":0}},{"line":27,"address":[4312129],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","runner","work","L2Shablya","L2Shablya","login","src","packet","to_client","server_list.rs"],"content":"use l2_core::shared_packets::common::{\n    LoginServerOpcodes, ServerData, ServerStatus,\n};\nuse l2_core::shared_packets::write::SendablePacketBuffer;\nuse l2_core::traits::handlers::PacketHandler;\nuse crate::client_thread::ClientHandler;\nuse crate::dto::player::GSCharsInfo;\nuse std::collections::HashMap;\nuse macro_common::SendablePacketImpl;\n\n#[derive(Debug, Clone, SendablePacketImpl)]\npub struct ServerList {\n    pub buffer: SendablePacketBuffer,\n    servers: Vec\u003cServerData\u003e,\n    last_server: i32,\n    chars_on_server: Option\u003cHashMap\u003cu8, GSCharsInfo\u003e\u003e,\n}\n\nimpl ServerList {\n    pub fn new(ch: \u0026ClientHandler, username: \u0026str) -\u003e ServerList {\n        let lc = ch.get_controller();\n        let servers = lc.get_server_list(ch.ip);\n        let player_option = lc.get_player(username);\n        let mut chars_on_server = None;\n        if let Some(player) = player_option {\n            chars_on_server = Some(player.chars_on_servers);\n        }\n        let mut sl = Self {\n            buffer: SendablePacketBuffer::new(),\n            servers,\n            last_server: 0, //todo: implement me\n            chars_on_server,\n        };\n        let _ = sl.write_all();\n        sl\n    }\n\n    #[allow(clippy::cast_possible_truncation, clippy::cast_sign_loss)]\n    fn write_all(\u0026mut self) -\u003e Result\u003c(), anyhow::Error\u003e {\n        {\n            self.buffer.write(LoginServerOpcodes::ServerList as u8)?;\n            self.buffer.write(self.servers.len() as u8)?;\n            self.buffer.write(self.last_server as u8)?;\n        }\n        for server in \u0026self.servers {\n            self.buffer.write(server.server_id as u8)?;\n            let ip_octets = server.get_ip_octets();\n            #[allow(clippy::cast_possible_wrap)]\n            {\n                self.buffer.write(ip_octets[0])?;\n                self.buffer.write(ip_octets[1])?;\n                self.buffer.write(ip_octets[2])?;\n                self.buffer.write(ip_octets[3])?;\n            }\n\n            self.buffer.write_i32(server.port)?;\n            self.buffer.write(server.age_limit as u8)?; // Age Limit 0, 15, 18\n            if server.pvp {\n                self.buffer.write(0x01)?;\n            } else {\n                self.buffer.write(0x00)?;\n            }\n            self.buffer.write_i16(server.current_players as i16)?;\n            self.buffer.write_i16(server.max_players as i16)?;\n            if let Some(status) = server.status {\n                self.buffer\n                    .write_bool(!matches!(status, ServerStatus::Down))?;\n            } else {\n                self.buffer.write_bool(false)?;\n            }\n            self.buffer.write_i32(1024)?; // 1: Normal, 2: Relax, 4: Public Test, 8: No Label, 16: Character Creation Restricted, 32: Event, 64: Free\n            self.buffer.write_bool(server.brackets)?;\n        }\n        self.buffer.write_i16(0xA4)?; //unknown\n        if let Some(ref servers) = self.chars_on_server {\n            for (server_id, info) in servers {\n                self.buffer.write(*server_id)?;\n                // todo: here should be real count of chars on server\n                self.buffer.write(info.total_chars)?;\n            }\n        }\n        Ok(())\n    }\n}","traces":[{"line":20,"address":[4100284,4100793,4099488],"length":1,"stats":{"Line":0}},{"line":21,"address":[4099552],"length":1,"stats":{"Line":0}},{"line":22,"address":[4099597],"length":1,"stats":{"Line":0}},{"line":23,"address":[4099661,4099734],"length":1,"stats":{"Line":0}},{"line":24,"address":[4099749],"length":1,"stats":{"Line":0}},{"line":25,"address":[4099769],"length":1,"stats":{"Line":0}},{"line":26,"address":[4099935,4100165,4100068],"length":1,"stats":{"Line":0}},{"line":29,"address":[4100046],"length":1,"stats":{"Line":0}},{"line":34,"address":[4100514,4100571],"length":1,"stats":{"Line":0}},{"line":35,"address":[4100603],"length":1,"stats":{"Line":0}},{"line":39,"address":[4100832],"length":1,"stats":{"Line":0}},{"line":41,"address":[4100852,4101030],"length":1,"stats":{"Line":0}},{"line":42,"address":[4101132,4100957],"length":1,"stats":{"Line":0}},{"line":43,"address":[4101071,4101190],"length":1,"stats":{"Line":0}},{"line":45,"address":[4101226,4101340,4101173],"length":1,"stats":{"Line":0}},{"line":46,"address":[4101358,4101973],"length":1,"stats":{"Line":0}},{"line":47,"address":[4101887],"length":1,"stats":{"Line":0}},{"line":50,"address":[4102077,4101916],"length":1,"stats":{"Line":0}},{"line":51,"address":[4102014,4102181],"length":1,"stats":{"Line":0}},{"line":52,"address":[4102288,4102118],"length":1,"stats":{"Line":0}},{"line":53,"address":[4102398,4102225],"length":1,"stats":{"Line":0}},{"line":56,"address":[4102337,4102511],"length":1,"stats":{"Line":0}},{"line":57,"address":[4102447,4102563],"length":1,"stats":{"Line":0}},{"line":58,"address":[4102555],"length":1,"stats":{"Line":0}},{"line":59,"address":[4102852,4102675],"length":1,"stats":{"Line":0}},{"line":61,"address":[4102607,4102813],"length":1,"stats":{"Line":0}},{"line":63,"address":[4102965,4102746],"length":1,"stats":{"Line":0}},{"line":64,"address":[4102901,4103035],"length":1,"stats":{"Line":0}},{"line":65,"address":[4103084,4103009],"length":1,"stats":{"Line":0}},{"line":66,"address":[4103327,4103094,4103111],"length":1,"stats":{"Line":0}},{"line":67,"address":[4103098,4103311],"length":1,"stats":{"Line":0}},{"line":69,"address":[4103182,4103350],"length":1,"stats":{"Line":0}},{"line":71,"address":[4103245,4103469],"length":1,"stats":{"Line":0}},{"line":72,"address":[4103399,4103508],"length":1,"stats":{"Line":0}},{"line":74,"address":[4101455,4101272],"length":1,"stats":{"Line":0}},{"line":75,"address":[4101499,4101428],"length":1,"stats":{"Line":0}},{"line":76,"address":[4101511,4101566],"length":1,"stats":{"Line":0}},{"line":77,"address":[4101665,4101799],"length":1,"stats":{"Line":0}},{"line":79,"address":[4101835,4101733],"length":1,"stats":{"Line":0}},{"line":82,"address":[4101552],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["/","home","runner","work","L2Shablya","L2Shablya","macro-common","src","lib.rs"],"content":"extern crate proc_macro;\nmod utils;\n\nuse crate::utils::ConfigAttributes;\nuse proc_macro::TokenStream;\nuse quote::quote;\nuse syn::{parse_macro_input, DeriveInput, Item, ItemStruct};\n\n#[allow(clippy::missing_panics_doc)]\n#[proc_macro_attribute]\npub fn config_file(attr: TokenStream, item: TokenStream) -\u003e TokenStream {\n    // Parse the attribute argument (e.g., a `\u0026'static str`)\n    let mut attrs = ConfigAttributes::new();\n    let parser = syn::meta::parser(|meta| attrs.parse(\u0026meta));\n    // Parse the item (e.g., a struct)\n    let item = parse_macro_input!(item as Item);\n    parse_macro_input!(attr with parser);\n    // Generate the `post_load` method if `post_load_message` is provided\n    let post_load_method = attrs.post_load_method_code_gen();\n    // Generate the implementation of `Loadable`\n    let expanded = match item {\n        Item::Struct(item_struct) =\u003e {\n            let name = \u0026item_struct.ident;\n            utils::generate_code_for_config_file(\n                attrs.post_load,\n                \u0026item_struct,\n                name,\n                \u0026post_load_method,\n                \u0026attrs.path,\n            )\n        }\n        Item::Enum(item_enum) =\u003e {\n            let name = \u0026item_enum.ident;\n            utils::generate_code_for_config_file(\n                attrs.post_load,\n                \u0026item_enum,\n                name,\n                \u0026post_load_method,\n                \u0026attrs.path,\n            )\n        }\n        _ =\u003e panic!(\"`#[loadable]` can only be applied to structs or enums\"),\n    };\n\n    // Return the generated code as a token stream\n    TokenStream::from(expanded)\n}\n#[proc_macro_attribute]\npub fn config_dir(attr: TokenStream, item: TokenStream) -\u003e TokenStream {\n    let mut attrs = ConfigAttributes::new();\n    let parser = syn::meta::parser(|meta| attrs.parse(\u0026meta));\n    // Parse the item (e.g., a struct)\n    parse_macro_input!(attr with parser);\n    // Generate the `post_load` method if `post_load_message` is provided\n    let post_load_method = attrs.post_load_method_code_gen();\n    let path = attrs.path.clone();\n    // Parse the item (e.g., a struct)\n    let item = parse_macro_input!(item as ItemStruct);\n\n    // Get the name of the struct\n    let name = \u0026item.ident;\n\n    // Generate the implementation of `Loadable`\n    let expanded = if attrs.post_load {\n        quote! {\n            #item\n            impl l2_core::config::traits::ConfigDirLoader for #name {\n                const DATA_DIR: \u0026'static str = #path;\n            }\n        }\n    } else {\n        quote! {\n            #item\n\n            impl l2_core::config::traits::Loadable for #name {\n                #post_load_method\n            }\n            impl l2_core::config::traits::ConfigDirLoader for #name {\n                const DATA_DIR: \u0026'static str = #path;\n            }\n        }\n    };\n\n    // Return the generated code as a token stream\n    TokenStream::from(expanded)\n}\n\n#[proc_macro_derive(SendablePacketImpl)]\npub fn derive_sendable(input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as DeriveInput);\n\n    let name = \u0026input.ident;\n\n    // Generate the implementation\n    let expanded = quote! {\n        impl l2_core::shared_packets::common::SendablePacket for #name {\n            fn get_bytes(\u0026mut self, with_padding:bool) -\u003e \u0026mut [u8] {\n                self.buffer.get_data_mut(with_padding)\n            }\n        }\n    };\n\n    TokenStream::from(expanded)\n}\n\n#[proc_macro_derive(LoginPacketSenderImpl)]\npub fn derive_login_packet_sender(input: TokenStream) -\u003e TokenStream {\n    let input = parse_macro_input!(input as DeriveInput);\n\n    let name = \u0026input.ident;\n\n    // Generate the implementation\n    let expanded = quote! {\n        #[async_trait]\n        impl l2_core::traits::handlers::PacketSender for #name {\n            async fn encrypt(\u0026self, bytes: \u0026mut [u8]) -\u003e anyhow::Result\u003c()\u003e {\n                let size = bytes.len();\n                l2_core::crypt::login::Encryption::append_checksum(\u0026mut bytes[2..size]);\n                self.blowfish.encrypt(\u0026mut bytes[2..size]);\n                Ok(())\n            }\n        \n            fn is_encryption_enabled(\u0026self) -\u003e bool {\n                true\n            }\n        \n            async fn get_stream_writer_mut(\u0026self) -\u003e \u0026std::sync::Arc\u003ctokio::sync::Mutex\u003cdyn tokio::io::AsyncWrite + Send + Unpin\u003e\u003e {\n                \u0026self.tcp_writer\n            }\n        }\n    };\n\n    TokenStream::from(expanded)\n}\n","traces":[{"line":11,"address":[281888,282506,280816],"length":1,"stats":{"Line":0}},{"line":13,"address":[280831],"length":1,"stats":{"Line":0}},{"line":14,"address":[275296,275317],"length":1,"stats":{"Line":0}},{"line":16,"address":[282351,281170,280996],"length":1,"stats":{"Line":0}},{"line":17,"address":[281374,281319,282111,281140],"length":1,"stats":{"Line":0}},{"line":19,"address":[281367],"length":1,"stats":{"Line":0}},{"line":21,"address":[281436],"length":1,"stats":{"Line":0}},{"line":22,"address":[281626],"length":1,"stats":{"Line":0}},{"line":23,"address":[281674],"length":1,"stats":{"Line":0}},{"line":32,"address":[281523],"length":1,"stats":{"Line":0}},{"line":33,"address":[281571],"length":1,"stats":{"Line":0}},{"line":42,"address":[281494,282083],"length":1,"stats":{"Line":0}},{"line":46,"address":[281833,281961],"length":1,"stats":{"Line":0}},{"line":49,"address":[285663,282544,284482],"length":1,"stats":{"Line":0}},{"line":50,"address":[282559],"length":1,"stats":{"Line":0}},{"line":51,"address":[275392,275413],"length":1,"stats":{"Line":0}},{"line":53,"address":[282708,282784,285495],"length":1,"stats":{"Line":0}},{"line":55,"address":[282777],"length":1,"stats":{"Line":0}},{"line":56,"address":[282828,282898],"length":1,"stats":{"Line":0}},{"line":58,"address":[282974,283083,282906,285351],"length":1,"stats":{"Line":0}},{"line":61,"address":[283052],"length":1,"stats":{"Line":0}},{"line":64,"address":[285257,283074],"length":1,"stats":{"Line":0}},{"line":65,"address":[284491,283164],"length":1,"stats":{"Line":0}},{"line":72,"address":[283230,283145],"length":1,"stats":{"Line":0}},{"line":85,"address":[285266,284424],"length":1,"stats":{"Line":0}},{"line":89,"address":[285696,287544],"length":1,"stats":{"Line":0}},{"line":90,"address":[287566,285853,285712],"length":1,"stats":{"Line":0}},{"line":92,"address":[285818],"length":1,"stats":{"Line":0}},{"line":95,"address":[285956,285834],"length":1,"stats":{"Line":0}},{"line":103,"address":[287490],"length":1,"stats":{"Line":0}},{"line":107,"address":[287664,292904],"length":1,"stats":{"Line":0}},{"line":108,"address":[287821,287680,292926],"length":1,"stats":{"Line":0}},{"line":110,"address":[287786],"length":1,"stats":{"Line":0}},{"line":113,"address":[287802,287924],"length":1,"stats":{"Line":0}},{"line":133,"address":[292850],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["/","home","runner","work","L2Shablya","L2Shablya","macro-common","src","utils.rs"],"content":"use proc_macro2::{Ident, Span, TokenStream};\nuse quote::{quote, ToTokens};\nuse syn::meta::ParseNestedMeta;\nuse syn::parse::Result;\nuse syn::LitStr;\n\npub struct ConfigAttributes {\n    pub path: LitStr,\n    pub post_load: bool,\n    pub post_load_message: Option\u003cLitStr\u003e,\n}\n\nimpl ConfigAttributes {\n    pub fn new() -\u003e Self {\n        Self {\n            path: LitStr::new(\"\", Span::call_site()),\n            post_load: false,\n            post_load_message: None,\n        }\n    }\n    pub fn post_load_method_code_gen(\u0026self) -\u003e TokenStream {\n        if let Some(ref message) = self.post_load_message {\n            quote! {\n                fn post_load(\u0026self) {\n                    tracing::info!(#message);\n                }\n            }\n        } else {\n            quote! {}\n        }\n    }\n    pub fn parse(\u0026mut self, meta: \u0026ParseNestedMeta) -\u003e Result\u003c()\u003e {\n        if meta.path.is_ident(\"path\") {\n            self.path = meta.value()?.parse()?;\n            if self.path.value().is_empty() {\n                return Err(meta.error(\"Please specify path to configuration\"));\n            }\n            Ok(())\n        } else if meta.path.is_ident(\"msg\") {\n            self.post_load_message = meta.value()?.parse()?;\n            Ok(())\n        } else if meta.path.is_ident(\"post_load\") {\n            self.post_load = true;\n            Ok(())\n        } else {\n            Err(meta.error(\"unsupported property\"))\n        }\n    }\n}\n\npub fn generate_code_for_config_file\u003cT: ToTokens, K: ToTokens\u003e(\n    post_load: bool,\n    item: \u0026T,\n    name: \u0026Ident,\n    post_load_method: \u0026K,\n    path: \u0026LitStr,\n) -\u003e TokenStream {\n    if post_load {\n        quote! {\n            #item\n            impl l2_core::config::traits::ConfigFileLoader for #name {\n                const DATA_FILE: \u0026'static str = #path;\n            }\n        }\n    } else {\n        quote! {\n            #item\n            impl l2_core::config::traits::Loadable for #name {\n                #post_load_method\n            }\n            impl l2_core::config::traits::ConfigFileLoader for #name {\n                const DATA_FILE: \u0026'static str = #path;\n            }\n        }\n    }\n}\n","traces":[{"line":14,"address":[293200],"length":1,"stats":{"Line":0}},{"line":16,"address":[293213],"length":1,"stats":{"Line":0}},{"line":21,"address":[293280,294096],"length":1,"stats":{"Line":0}},{"line":22,"address":[293310],"length":1,"stats":{"Line":0}},{"line":23,"address":[293349,293410],"length":1,"stats":{"Line":0}},{"line":29,"address":[293399],"length":1,"stats":{"Line":0}},{"line":32,"address":[294128,294896,295429],"length":1,"stats":{"Line":0}},{"line":33,"address":[295335,294179],"length":1,"stats":{"Line":0}},{"line":34,"address":[294909,294235],"length":1,"stats":{"Line":0}},{"line":35,"address":[295213,295340],"length":1,"stats":{"Line":0}},{"line":36,"address":[295359],"length":1,"stats":{"Line":0}},{"line":38,"address":[295322],"length":1,"stats":{"Line":0}},{"line":39,"address":[294891,294206],"length":1,"stats":{"Line":0}},{"line":40,"address":[294346,294533],"length":1,"stats":{"Line":0}},{"line":41,"address":[294878],"length":1,"stats":{"Line":0}},{"line":42,"address":[294313,294491],"length":1,"stats":{"Line":0}},{"line":43,"address":[294503],"length":1,"stats":{"Line":0}},{"line":44,"address":[294507],"length":1,"stats":{"Line":0}},{"line":46,"address":[294426],"length":1,"stats":{"Line":0}},{"line":51,"address":[273813,271845,272528,270560],"length":1,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":31},{"path":["/","home","runner","work","L2Shablya","L2Shablya","macro-common","tests","config_loader.rs"],"content":"#[cfg(test)]\npub mod l2_core {\n    pub mod config {\n        pub mod traits {\n            pub trait Loadable {}\n            pub trait ConfigFileLoader: Loadable {\n                const DATA_FILE: \u0026'static str;\n                fn load(\u0026self) {}\n            }\n        }\n    }\n}\n#[cfg(test)]\nmod test {\n    use super::*;\n    use crate::l2_core::config::traits::ConfigFileLoader;\n    use macro_common::config_file;\n\n    #[config_file(path = \"different_path\")]\n    struct TestLoader {\n        h: i32,\n    }\n    impl TestLoader {\n        fn test(\u0026self) -\u003e i32 {\n            self.h\n        }\n    }\n\n    #[config_file(path = \"enum_path\")]\n    enum ConfigLoader {\n        One,\n        Two,\n    }\n\n    #[test]\n    fn case_struct() {\n        let k = TestLoader { h: 1 };\n        k.load();\n        assert_eq!(k.test(), 1);\n        assert_eq!(TestLoader::DATA_FILE, \"different_path\");\n    }\n    #[test]\n    fn case_enum() {\n        let k = ConfigLoader::One;\n        let l = ConfigLoader::Two;\n        k.load();\n        l.load();\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","macro-common","tests","sendable_packet.rs"],"content":"#[cfg(test)]\npub mod l2_core {\n    pub mod shared_packets {\n        pub mod common {\n            pub trait SendablePacket {\n                fn get_bytes(\u0026mut self, with_padding: bool) -\u003e \u0026mut [u8];\n            }\n        }\n        pub mod write {\n            use bytes::BytesMut;\n\n            #[derive(Debug, Default)]\n            pub struct SendablePacketBuffer {\n                buffer: BytesMut,\n            }\n            impl SendablePacketBuffer {\n                #[must_use]\n                pub fn new() -\u003e Self {\n                    Self {\n                        buffer: BytesMut::new(),\n                    }\n                }\n                pub fn get_data_mut(\u0026mut self, _: bool) -\u003e \u0026mut [u8] {\n                    self.buffer.as_mut()\n                }\n            }\n        }\n    }\n}\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::l2_core::shared_packets::common::SendablePacket;\n    use crate::l2_core::shared_packets::write::SendablePacketBuffer;\n    use macro_common::SendablePacketImpl;\n\n    #[derive(SendablePacketImpl, Debug)]\n    struct PacketA {\n        buffer: SendablePacketBuffer,\n    }\n    #[derive(SendablePacketImpl, Debug)]\n    struct PacketB {\n        buffer: SendablePacketBuffer,\n    }\n    #[test]\n    fn packet_a() {\n        let mut a = PacketA {\n            buffer: SendablePacketBuffer::new(),\n        };\n        let p = a.get_bytes(false);\n        assert_eq!(p, \u0026[0u8; 0]);\n    }\n    #[test]\n    fn packet_b() {\n        let mut b = PacketB {\n            buffer: SendablePacketBuffer::new(),\n        };\n        let p = b.get_bytes(false);\n        assert_eq!(p, \u0026[0u8; 0]);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","migration","src","lib.rs"],"content":"pub use sea_orm_migration::prelude::*;\n\nmod m20220101_000001_create_user;\nmod m20241213_210106_create_char;\nmod m20250103_134559_create_items;\n\npub struct Migrator;\n\n#[async_trait::async_trait]\nimpl MigratorTrait for Migrator {\n    fn migrations() -\u003e Vec\u003cBox\u003cdyn MigrationTrait\u003e\u003e {\n        vec![\n            Box::new(m20220101_000001_create_user::Migration),\n            Box::new(m20241213_210106_create_char::Migration),\n            Box::new(m20250103_134559_create_items::Migration),\n        ]\n    }\n}\n","traces":[{"line":11,"address":[3804998,3804432],"length":1,"stats":{"Line":4}},{"line":12,"address":[3804674,3804977,3804459,3804813,3804538],"length":1,"stats":{"Line":4}},{"line":13,"address":[3804588],"length":1,"stats":{"Line":4}},{"line":14,"address":[3804724],"length":1,"stats":{"Line":4}}],"covered":4,"coverable":4},{"path":["/","home","runner","work","L2Shablya","L2Shablya","migration","src","m20220101_000001_create_user.rs"],"content":"use sea_orm_migration::{\n    prelude::*,\n    schema::{integer, pk_auto, string, string_null},\n};\nuse sea_orm_migration::schema::big_integer_null;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(User::Table)\n                    .if_not_exists()\n                    .col(pk_auto(User::Id))\n                    .col(string(User::Username))\n                    .col(integer(User::AccessLevel))\n                    .col(string_null(User::BanIp))\n                    .col(string(User::Password))\n                    .col(big_integer_null(User::BanDuration))\n                    .to_owned(),\n            )\n            .await?;\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_username\") // Name of the index\n                    .table(User::Table)\n                    .col(User::Username)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(User::Table).to_owned())\n            .await\n    }\n}\n\n#[derive(DeriveIden)]\npub enum User {\n    Table,\n    Id,\n    Username,\n    AccessLevel,\n    BanDuration,\n    BanIp,\n    Password\n}\n","traces":[{"line":12,"address":[2730951],"length":1,"stats":{"Line":15}},{"line":13,"address":[5579106,5579673,5579727,5580189,5580047,5579921],"length":1,"stats":{"Line":23}},{"line":15,"address":[5909652,5909716,5909324,5909404,5909460,5909283,5909524,5909588,5909780],"length":1,"stats":{"Line":45}},{"line":16,"address":[2718928],"length":1,"stats":{"Line":5}},{"line":18,"address":[5909420],"length":1,"stats":{"Line":5}},{"line":19,"address":[3870012],"length":1,"stats":{"Line":5}},{"line":20,"address":[3870076],"length":1,"stats":{"Line":5}},{"line":21,"address":[5579452],"length":1,"stats":{"Line":5}},{"line":22,"address":[3870204],"length":1,"stats":{"Line":5}},{"line":23,"address":[5579580],"length":1,"stats":{"Line":5}},{"line":26,"address":[2682625,2682663],"length":1,"stats":{"Line":21}},{"line":27,"address":[5580713,5580226,5580503,5580449],"length":1,"stats":{"Line":13}},{"line":29,"address":[2720112,2719967,2720079],"length":1,"stats":{"Line":12}},{"line":31,"address":[3871039],"length":1,"stats":{"Line":5}},{"line":32,"address":[5580388],"length":1,"stats":{"Line":4}},{"line":35,"address":[2718676,2720200,2720240,2720306,2720537],"length":1,"stats":{"Line":12}},{"line":38,"address":[5581274,5581125,5581998,5581043,5581585,5581008],"length":1,"stats":{"Line":0}},{"line":39,"address":[5581535,5581722,5581481,5581337],"length":1,"stats":{"Line":0}},{"line":40,"address":[5581351,5581457],"length":1,"stats":{"Line":0}},{"line":41,"address":[3847031],"length":1,"stats":{"Line":0}}],"covered":16,"coverable":20},{"path":["/","home","runner","work","L2Shablya","L2Shablya","migration","src","m20241213_210106_create_char.rs"],"content":"use sea_orm::JsonValue;\nuse crate::m20220101_000001_create_user as previous;\nuse sea_orm_migration::schema::{big_unsigned, big_unsigned_null, boolean, boolean_null, double, integer_null, json_binary, small_unsigned, small_unsigned_null, string_len_null, timestamp_with_time_zone_null, tiny_unsigned, tiny_unsigned_null, unsigned, unsigned_null};\nuse sea_orm_migration::{\n    prelude::*,\n    schema::{integer, pk_auto, string},\n};\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[allow(clippy::too_many_lines)]\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Character::Table)\n                    .if_not_exists()\n                    .col(pk_auto(Character::Id))\n                    .col(string(Character::Name))\n                    .col(tiny_unsigned(Character::Level))\n                    .col(timestamp_with_time_zone_null(Character::DeleteAt))\n                    .col(integer(Character::UserId))\n                    .col(double(Character::MaxHP).default(0))\n                    .col(double(Character::CurHP).default(0))\n                    .col(double(Character::MaxCP).default(0))\n                    .col(double(Character::CurCP).default(0))\n                    .col(double(Character::CurMP).default(0))\n                    .col(double(Character::MaxMP).default(0))\n                    .col(tiny_unsigned(Character::Face))\n                    .col(tiny_unsigned(Character::HairStyle))\n                    .col(tiny_unsigned(Character::HairColor))\n                    .col(boolean(Character::IsFemale))\n                    .col(integer_null(Character::Heading))\n                    .col(integer(Character::X))\n                    .col(integer(Character::Y))\n                    .col(integer(Character::Z))\n                    .col(big_unsigned(Character::Exp).default(0))\n                    .col(big_unsigned_null(Character::ExpBeforeDeath).default(0))\n                    .col(big_unsigned(Character::SP).default(0))\n                    .col(integer(Character::Reputation).default(0))\n                    .col(unsigned(Character::Fame).default(0))\n                    .col(unsigned(Character::RbPoints).default(0))\n                    .col(unsigned(Character::PvpKills).default(0))\n                    .col(unsigned(Character::PkKills).default(0))\n                    .col(tiny_unsigned(Character::RaceId))\n                    .col(tiny_unsigned(Character::ClassId).default(0))\n                    .col(tiny_unsigned(Character::BaseClassId).default(0))\n                    .col(small_unsigned(Character::TransformId))\n                    .col(boolean_null(Character::CanCraft))\n                    .col(string_len_null(Character::Title, 21))\n                    .col(unsigned_null(Character::TitleColor).default(15_530_402))\n                    .col(unsigned(Character::AccessLevel).default(0))\n                    .col(tiny_unsigned_null(Character::Online))\n                    .col(unsigned_null(Character::OnlineTime))\n                    .col(tiny_unsigned_null(Character::CharSlot))\n                    .col(timestamp_with_time_zone_null(Character::LastAccess))\n                    .col(unsigned_null(Character::ClanPrivs).default(0))\n                    .col(tiny_unsigned_null(Character::WantsPeace).default(0))\n                    .col(tiny_unsigned_null(Character::PowerGrade))\n                    .col(boolean(Character::Nobless).default(0))\n                    .col(small_unsigned_null(Character::SubPledge).default(0))\n                    .col(tiny_unsigned(Character::LvlJoinedAcademy).default(0))\n                    .col(unsigned(Character::Apprentice).default(0))\n                    .col(unsigned(Character::Sponsor).default(0))\n                    .col(timestamp_with_time_zone_null(Character::ClanJoinExpiryTime))\n                    .col(json_binary(Character::Variables).default(JsonValue::default()))\n                    .col(timestamp_with_time_zone_null(\n                        Character::ClanCreateExpiryTime,\n                    ))\n                    .col(small_unsigned(Character::BookmarkSlot).default(0))\n                    .col(unsigned(Character::VitalityPoints).default(0))\n                    .col(timestamp_with_time_zone_null(Character::CreatedAt))\n                    .col(string_len_null(Character::Language, 2))\n                    .col(tiny_unsigned(Character::Faction).default(0))\n                    .col(integer(Character::PcCafePoints).default(0))\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_char_user_id\")\n                            .from(Character::Table, Character::UserId)\n                            .to(previous::User::Table, previous::User::Id),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_name\") // Name of the index\n                    .table(Character::Table)\n                    .col(Character::Name)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Character::Table).to_owned())\n            .await\n    }\n}\n\n#[derive(DeriveIden)]\npub enum Character {\n    Table,\n    Id,\n    Name,\n    UserId,\n    Level,\n    MaxHP,\n    CurHP,\n    MaxCP,\n    CurCP,\n    MaxMP,\n    CurMP,\n    Face,\n    HairStyle,\n    HairColor,\n    IsFemale,\n    Heading,\n    X,\n    Y,\n    Z,\n    Exp,\n    ExpBeforeDeath,\n    SP,\n    Reputation,\n    Fame,\n    RbPoints,\n    PvpKills,\n    PkKills,\n    //ClanId,\n    RaceId,\n    ClassId,\n    BaseClassId,\n    TransformId,\n    DeleteAt,\n    CanCraft,\n    Title,\n    TitleColor,\n    AccessLevel,\n    Online,\n    OnlineTime,\n    CharSlot,\n    LastAccess,\n    ClanPrivs,\n    WantsPeace,\n    PowerGrade,\n    Nobless,\n    SubPledge,\n    LvlJoinedAcademy,\n    Apprentice,\n    Sponsor,\n    ClanJoinExpiryTime,\n    ClanCreateExpiryTime,\n    BookmarkSlot,\n    VitalityPoints,\n    CreatedAt,\n    Language,\n    Faction,\n    PcCafePoints,\n    Variables\n}\n","traces":[{"line":15,"address":[3807354,3807642,3807451,3817456,3815031,3807232],"length":1,"stats":{"Line":9}},{"line":16,"address":[3815171,3815442,3814915,3807708,3815300,3814969],"length":1,"stats":{"Line":13}},{"line":18,"address":[3809180,3808360,3809312,3809732,3811512,3810232,3811582,3814463,3810560,3809016,3808057,3812058,3808524,3808852,3809522,3814303,3810888,3813166,3813768,3807769,3813002,3814228,3811996,3812838,3808127,3807917,3812604,3814002,3807728,3807987,3808688,3809242,3807855,3811450,3808197,3811052,3810724,3812440,3809592,3809904,3813556,3812666,3811832,3810396,3814867,3814166,3809662,3809382,3810068,3812268,3813494,3811286,3814615,3813830,3809452,3811114,3811657,3812198,3813330,3812128],"length":1,"stats":{"Line":203}},{"line":19,"address":[3807761],"length":1,"stats":{"Line":3}},{"line":21,"address":[2691290],"length":1,"stats":{"Line":3}},{"line":22,"address":[2691356],"length":1,"stats":{"Line":3}},{"line":23,"address":[5917390],"length":1,"stats":{"Line":3}},{"line":24,"address":[3808084],"length":1,"stats":{"Line":3}},{"line":25,"address":[3808154],"length":1,"stats":{"Line":3}},{"line":26,"address":[5587440],"length":1,"stats":{"Line":3}},{"line":27,"address":[3808379],"length":1,"stats":{"Line":3}},{"line":28,"address":[3808543],"length":1,"stats":{"Line":3}},{"line":29,"address":[2692079],"length":1,"stats":{"Line":3}},{"line":30,"address":[5918247],"length":1,"stats":{"Line":3}},{"line":31,"address":[3809035],"length":1,"stats":{"Line":3}},{"line":32,"address":[5588415],"length":1,"stats":{"Line":3}},{"line":33,"address":[5588485],"length":1,"stats":{"Line":3}},{"line":34,"address":[5588555],"length":1,"stats":{"Line":3}},{"line":35,"address":[3809409],"length":1,"stats":{"Line":3}},{"line":36,"address":[2692811],"length":1,"stats":{"Line":3}},{"line":37,"address":[2692877],"length":1,"stats":{"Line":3}},{"line":38,"address":[3809619],"length":1,"stats":{"Line":3}},{"line":39,"address":[5588905],"length":1,"stats":{"Line":3}},{"line":40,"address":[5919135],"length":1,"stats":{"Line":3}},{"line":41,"address":[3809923],"length":1,"stats":{"Line":3}},{"line":42,"address":[5589303],"length":1,"stats":{"Line":3}},{"line":43,"address":[2693543],"length":1,"stats":{"Line":3}},{"line":44,"address":[2693699],"length":1,"stats":{"Line":3}},{"line":45,"address":[2693855],"length":1,"stats":{"Line":3}},{"line":46,"address":[3810743],"length":1,"stats":{"Line":3}},{"line":47,"address":[3810907],"length":1,"stats":{"Line":3}},{"line":48,"address":[5590287],"length":1,"stats":{"Line":3}},{"line":49,"address":[2694389],"length":1,"stats":{"Line":3}},{"line":50,"address":[3811305],"length":1,"stats":{"Line":3}},{"line":51,"address":[5920845],"length":1,"stats":{"Line":3}},{"line":52,"address":[2694767],"length":1,"stats":{"Line":3}},{"line":53,"address":[2694833],"length":1,"stats":{"Line":3}},{"line":54,"address":[2694904],"length":1,"stats":{"Line":3}},{"line":55,"address":[5591067],"length":1,"stats":{"Line":2}},{"line":56,"address":[5591231],"length":1,"stats":{"Line":2}},{"line":57,"address":[5591301],"length":1,"stats":{"Line":2}},{"line":58,"address":[5921531],"length":1,"stats":{"Line":2}},{"line":59,"address":[3812225],"length":1,"stats":{"Line":2}},{"line":60,"address":[3812295],"length":1,"stats":{"Line":2}},{"line":61,"address":[5591675],"length":1,"stats":{"Line":2}},{"line":62,"address":[5921999],"length":1,"stats":{"Line":2}},{"line":63,"address":[5591909],"length":1,"stats":{"Line":2}},{"line":64,"address":[5592073],"length":1,"stats":{"Line":2}},{"line":65,"address":[5922397],"length":1,"stats":{"Line":2}},{"line":66,"address":[3813185],"length":1,"stats":{"Line":2}},{"line":67,"address":[5592565],"length":1,"stats":{"Line":2}},{"line":68,"address":[3813513],"length":1,"stats":{"Line":2}},{"line":69,"address":[2696853,2696707],"length":1,"stats":{"Line":6}},{"line":70,"address":[2696911],"length":1,"stats":{"Line":5}},{"line":71,"address":[5593003],"length":1,"stats":{"Line":5}},{"line":73,"address":[5923233],"length":1,"stats":{"Line":5}},{"line":74,"address":[5593237],"length":1,"stats":{"Line":5}},{"line":75,"address":[5593401],"length":1,"stats":{"Line":5}},{"line":76,"address":[5593471],"length":1,"stats":{"Line":3}},{"line":77,"address":[5593543],"length":1,"stats":{"Line":3}},{"line":78,"address":[5593695],"length":1,"stats":{"Line":3}},{"line":80,"address":[2697840,2697703,2697889],"length":1,"stats":{"Line":9}},{"line":82,"address":[5593972],"length":1,"stats":{"Line":3}},{"line":83,"address":[3814809],"length":1,"stats":{"Line":3}},{"line":87,"address":[2682913,2682954],"length":1,"stats":{"Line":17}},{"line":88,"address":[2699322,2699579,2700589,2699529],"length":1,"stats":{"Line":14}},{"line":90,"address":[3816452,3816299,3816415],"length":1,"stats":{"Line":6}},{"line":92,"address":[3816407],"length":1,"stats":{"Line":4}},{"line":93,"address":[5925820],"length":1,"stats":{"Line":4}},{"line":96,"address":[5586718,5596921,5596681,5595808,5595748],"length":1,"stats":{"Line":12}},{"line":99,"address":[3831335],"length":1,"stats":{"Line":0}},{"line":100,"address":[5597417,5597802,5597561,5597615],"length":1,"stats":{"Line":0}},{"line":101,"address":[2701329,2701219],"length":1,"stats":{"Line":0}},{"line":102,"address":[3818372,3818481,3818426,3818714,3818016],"length":1,"stats":{"Line":0}}],"covered":70,"coverable":74},{"path":["/","home","runner","work","L2Shablya","L2Shablya","migration","src","m20250103_134559_create_items.rs"],"content":"use crate::m20241213_210106_create_char::Character;\nuse sea_orm::JsonValue;\nuse sea_orm_migration::prelude::*;\nuse sea_orm_migration::schema::{big_unsigned, decimal_len, integer, json_binary, pk_auto, string};\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Item::Table)\n                    .if_not_exists()\n                    .col(pk_auto(Item::Id))\n                    .col(integer(Item::Owner))\n                    .col(integer(Item::ItemId))\n                    .col(big_unsigned(Item::Count).default(0))\n                    .col(integer(Item::EnchantLevel).default(0))\n                    .col(string(Item::Loc))\n                    .col(json_binary(Item::Variables).default(JsonValue::default()))\n                    .col(json_binary(Item::Variations).default(JsonValue::default()))\n                    .col(integer(Item::LocData))\n                    .col(integer(Item::TimeOfUse))\n                    .col(integer(Item::CustomType1).default(0))\n                    .col(integer(Item::CustomType2).default(0))\n                    .col(decimal_len(Item::ManaLeft, 5, 0).default(-1))\n                    .col(decimal_len(Item::Time, 13, 0).default(0))\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_owner_char_id\")\n                            .from(Item::Table, Item::Owner)\n                            .to(Character::Table, Character::Id),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_loc\") // Name of the index\n                    .table(Item::Table)\n                    .col(Item::Loc)\n                    .to_owned(),\n            )\n            .await?;\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_owner_loc\") // Name of the index\n                    .table(Item::Table)\n                    .col(Item::Owner)\n                    .col(Item::Loc)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Item::Table).to_owned())\n            .await\n    }\n}\n\n#[derive(DeriveIden)]\n#[allow(clippy::enum_variant_names)]\npub enum Item {\n    Table,\n    Id,\n    Owner,\n    ItemId,\n    Count,\n    EnchantLevel,\n    Loc,\n    LocData,\n    TimeOfUse,\n    CustomType1,\n    CustomType2,\n    ManaLeft,\n    Time,\n    Variables,\n    Variations,\n}\n","traces":[{"line":11,"address":[3854159,3856826,3854371,3858107,3853952,3854059],"length":1,"stats":{"Line":7}},{"line":12,"address":[3854437,3856764,3857237,3856710,3856966,3857095],"length":1,"stats":{"Line":15}},{"line":14,"address":[5564425,5565035,5565716,5563896,5565545,5564098,5564028,5564261,5564903,5565207,5564965,5563810,5564487,5565371,5565974,5563769,5563958,5564699],"length":1,"stats":{"Line":54}},{"line":15,"address":[3854490],"length":1,"stats":{"Line":3}},{"line":17,"address":[3854603],"length":1,"stats":{"Line":3}},{"line":18,"address":[5894145],"length":1,"stats":{"Line":3}},{"line":19,"address":[5564055],"length":1,"stats":{"Line":3}},{"line":20,"address":[2673337],"length":1,"stats":{"Line":3}},{"line":21,"address":[5564280],"length":1,"stats":{"Line":3}},{"line":22,"address":[5894604],"length":1,"stats":{"Line":3}},{"line":23,"address":[3855202,3855344],"length":1,"stats":{"Line":6}},{"line":24,"address":[2673902,2674048],"length":1,"stats":{"Line":6}},{"line":25,"address":[5895082],"length":1,"stats":{"Line":3}},{"line":26,"address":[5564992],"length":1,"stats":{"Line":3}},{"line":27,"address":[5565062],"length":1,"stats":{"Line":3}},{"line":28,"address":[5895386],"length":1,"stats":{"Line":3}},{"line":29,"address":[3856078],"length":1,"stats":{"Line":3}},{"line":30,"address":[2674708],"length":1,"stats":{"Line":3}},{"line":32,"address":[5565876,5565929,5565735],"length":1,"stats":{"Line":9}},{"line":34,"address":[2674992],"length":1,"stats":{"Line":3}},{"line":35,"address":[3856601],"length":1,"stats":{"Line":3}},{"line":39,"address":[3846081,3846156],"length":1,"stats":{"Line":18}},{"line":40,"address":[2676876,2676178,2675921,2676737,2676612,2676128],"length":1,"stats":{"Line":15}},{"line":42,"address":[5566834,5566987,5566950],"length":1,"stats":{"Line":9}},{"line":44,"address":[2676042],"length":1,"stats":{"Line":3}},{"line":45,"address":[5566979],"length":1,"stats":{"Line":3}},{"line":48,"address":[2685842,2685140],"length":1,"stats":{"Line":15}},{"line":49,"address":[5898315,5898261,5898001,5898513],"length":1,"stats":{"Line":12}},{"line":51,"address":[3858736,3858699,3858662,3858546],"length":1,"stats":{"Line":12}},{"line":53,"address":[2677034],"length":1,"stats":{"Line":3}},{"line":54,"address":[2677067],"length":1,"stats":{"Line":3}},{"line":55,"address":[5568040],"length":1,"stats":{"Line":3}},{"line":58,"address":[3858816,3858876,3854231,3858930,3859169],"length":1,"stats":{"Line":12}},{"line":61,"address":[2657031],"length":1,"stats":{"Line":0}},{"line":62,"address":[5569370,5569183,5569129,5568985],"length":1,"stats":{"Line":0}},{"line":63,"address":[5569105,5568999],"length":1,"stats":{"Line":0}},{"line":64,"address":[3847383],"length":1,"stats":{"Line":0}}],"covered":33,"coverable":37},{"path":["/","home","runner","work","L2Shablya","L2Shablya","migration","src","main.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[async_std::main]\nasync fn main() {\n    cli::run_cli(migration::Migrator).await;\n}\n","traces":[{"line":5,"address":[3747603,3747637,3747707,3747786],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","runner","work","L2Shablya","L2Shablya","test-utils","src","lib.rs"],"content":"pub mod utils;","traces":[],"covered":0,"coverable":0},{"path":["/","home","runner","work","L2Shablya","L2Shablya","test-utils","src","utils.rs"],"content":"use migration::{Migrator, MigratorTrait};\nuse sea_orm::{ConnectOptions, Database, DatabaseConnection};\n\npub type DBPool = DatabaseConnection;\n\nasync fn setup_test_db() -\u003e DBPool {\n    let opt = ConnectOptions::new(\"sqlite::memory:\");\n\n    let conn = Database::connect(opt)\n        .await\n        .expect(\"Failed to connect to the database\");\n    Migrator::up(\u0026conn, None)\n        .await\n        .expect(\"Failed to migrate the database\");\n    conn\n}\n\npub async fn get_test_db() -\u003e DBPool {\n    setup_test_db().await\n}\n","traces":[{"line":6,"address":[5536048,5536051],"length":1,"stats":{"Line":10}},{"line":7,"address":[4354465],"length":1,"stats":{"Line":3}},{"line":9,"address":[4981499,4981706,4981819,4981529],"length":1,"stats":{"Line":10}},{"line":10,"address":[4354874,4354626,4354716,4354516,4354660],"length":1,"stats":{"Line":10}},{"line":12,"address":[4354966,4355099,4355350,4355237],"length":1,"stats":{"Line":10}},{"line":13,"address":[4981430,4982008,4982040,4981968,4982197],"length":1,"stats":{"Line":10}},{"line":15,"address":[4355398],"length":1,"stats":{"Line":5}},{"line":18,"address":[119616,119619],"length":1,"stats":{"Line":10}},{"line":19,"address":[4354071,4353993,4353923,4353877],"length":1,"stats":{"Line":7}}],"covered":9,"coverable":9}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>